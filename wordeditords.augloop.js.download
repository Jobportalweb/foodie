/*
 Microsoft Corporation. All rights reserved.
*/
(globalThis.dullscriptWebpackJsonp=globalThis.dullscriptWebpackJsonp||[]).push([[1],{29725:function(ia,Ua,v){function ya(fe){function Ld(Wf){mg[Wf]=fe[Wf]&&function(Kf){return new Promise(function(Ci,cj){Kf=fe[Wf](Kf);ze(Ci,cj,Kf.done,Kf.value)})}}function ze(Wf,Kf,Ci,cj){Promise.resolve(cj).then(function(di){Wf({value:di,done:Ci})},Kf)}if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var kf=fe[Symbol.asyncIterator],mg;return kf?kf.call(fe):(fe="function"===typeof __values?
__values(fe):fe[Symbol.iterator](),mg={},Ld("next"),Ld("throw"),Ld("return"),mg[Symbol.asyncIterator]=function(){return this},mg)}function ja(fe,Ld,ze){function kf(bn){cj[bn]&&(di[bn]=function(lo){return new Promise(function(as,sk){1<rj.push([bn,lo,as,sk])||mg(bn,lo)})})}function mg(bn,lo){try{var as=cj[bn](lo);as.value instanceof oa?Promise.resolve(as.value.v).then(Wf,Kf):Ci(rj[0][2],as)}catch(sk){Ci(rj[0][3],sk)}}function Wf(bn){mg("next",bn)}function Kf(bn){mg("throw",bn)}function Ci(bn,lo){(bn(lo),
rj.shift(),rj.length)&&mg(rj[0][0],rj[0][1])}if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var cj=ze.apply(fe,Ld||[]),di,rj=[];return di={},kf("next"),kf("throw"),kf("return"),di[Symbol.asyncIterator]=function(){return this},di}function oa(fe){return this instanceof oa?(this.v=fe,this):new oa(fe)}function z(fe,Ld,ze,kf){function mg(Wf){return Wf instanceof ze?Wf:new ze(function(Kf){Kf(Wf)})}return new (ze||(ze=Promise))(function(Wf,Kf){function Ci(rj){try{di(kf.next(rj))}catch(bn){Kf(bn)}}
function cj(rj){try{di(kf["throw"](rj))}catch(bn){Kf(bn)}}function di(rj){rj.done?Wf(rj.value):mg(rj.value).then(Ci,cj)}di((kf=kf.apply(fe,Ld||[])).next())})}function D(fe,Ld,ze,kf){function mg(Wf){return Wf instanceof ze?Wf:new ze(function(Kf){Kf(Wf)})}return new (ze||(ze=Promise))(function(Wf,Kf){function Ci(rj){try{di(kf.next(rj))}catch(bn){Kf(bn)}}function cj(rj){try{di(kf["throw"](rj))}catch(bn){Kf(bn)}}function di(rj){rj.done?Wf(rj.value):mg(rj.value).then(Ci,cj)}di((kf=kf.apply(fe,Ld||[])).next())})}
function d(fe,Ld,ze,kf){function mg(Wf){return Wf instanceof ze?Wf:new ze(function(Kf){Kf(Wf)})}return new (ze||(ze=Promise))(function(Wf,Kf){function Ci(rj){try{di(kf.next(rj))}catch(bn){Kf(bn)}}function cj(rj){try{di(kf["throw"](rj))}catch(bn){Kf(bn)}}function di(rj){rj.done?Wf(rj.value):mg(rj.value).then(Ci,cj)}di((kf=kf.apply(fe,Ld||[])).next())})}function t(fe,Ld,ze,kf){function mg(Wf){return Wf instanceof ze?Wf:new ze(function(Kf){Kf(Wf)})}return new (ze||(ze=Promise))(function(Wf,Kf){function Ci(rj){try{di(kf.next(rj))}catch(bn){Kf(bn)}}
function cj(rj){try{di(kf["throw"](rj))}catch(bn){Kf(bn)}}function di(rj){rj.done?Wf(rj.value):mg(rj.value).then(Ci,cj)}di((kf=kf.apply(fe,Ld||[])).next())})}function k(fe,Ld,ze,kf){function mg(Wf){return Wf instanceof ze?Wf:new ze(function(Kf){Kf(Wf)})}return new (ze||(ze=Promise))(function(Wf,Kf){function Ci(rj){try{di(kf.next(rj))}catch(bn){Kf(bn)}}function cj(rj){try{di(kf["throw"](rj))}catch(bn){Kf(bn)}}function di(rj){rj.done?Wf(rj.value):mg(rj.value).then(Ci,cj)}di((kf=kf.apply(fe,Ld||[])).next())})}
function r(fe,Ld,ze,kf){function mg(Wf){return Wf instanceof ze?Wf:new ze(function(Kf){Kf(Wf)})}return new (ze||(ze=Promise))(function(Wf,Kf){function Ci(rj){try{di(kf.next(rj))}catch(bn){Kf(bn)}}function cj(rj){try{di(kf["throw"](rj))}catch(bn){Kf(bn)}}function di(rj){rj.done?Wf(rj.value):mg(rj.value).then(Ci,cj)}di((kf=kf.apply(fe,Ld||[])).next())})}function x(fe,Ld,ze){function kf(bn){cj[bn]&&(di[bn]=function(lo){return new Promise(function(as,sk){1<rj.push([bn,lo,as,sk])||mg(bn,lo)})})}function mg(bn,
lo){try{var as=cj[bn](lo);as.value instanceof u?Promise.resolve(as.value.v).then(Wf,Kf):Ci(rj[0][2],as)}catch(sk){Ci(rj[0][3],sk)}}function Wf(bn){mg("next",bn)}function Kf(bn){mg("throw",bn)}function Ci(bn,lo){(bn(lo),rj.shift(),rj.length)&&mg(rj[0][0],rj[0][1])}if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var cj=ze.apply(fe,Ld||[]),di,rj=[];return di={},kf("next"),kf("throw"),kf("return"),di[Symbol.asyncIterator]=function(){return this},di}function u(fe){return this instanceof
u?(this.v=fe,this):new u(fe)}function w(fe,Ld,ze,kf){function mg(Wf){return Wf instanceof ze?Wf:new ze(function(Kf){Kf(Wf)})}return new (ze||(ze=Promise))(function(Wf,Kf){function Ci(rj){try{di(kf.next(rj))}catch(bn){Kf(bn)}}function cj(rj){try{di(kf["throw"](rj))}catch(bn){Kf(bn)}}function di(rj){rj.done?Wf(rj.value):mg(rj.value).then(Ci,cj)}di((kf=kf.apply(fe,Ld||[])).next())})}function C(fe,Ld,ze,kf){function mg(Wf){return Wf instanceof ze?Wf:new ze(function(Kf){Kf(Wf)})}return new (ze||(ze=Promise))(function(Wf,
Kf){function Ci(rj){try{di(kf.next(rj))}catch(bn){Kf(bn)}}function cj(rj){try{di(kf["throw"](rj))}catch(bn){Kf(bn)}}function di(rj){rj.done?Wf(rj.value):mg(rj.value).then(Ci,cj)}di((kf=kf.apply(fe,Ld||[])).next())})}function B(fe,Ld,ze,kf){function mg(Wf){return Wf instanceof ze?Wf:new ze(function(Kf){Kf(Wf)})}return new (ze||(ze=Promise))(function(Wf,Kf){function Ci(rj){try{di(kf.next(rj))}catch(bn){Kf(bn)}}function cj(rj){try{di(kf["throw"](rj))}catch(bn){Kf(bn)}}function di(rj){rj.done?Wf(rj.value):
mg(rj.value).then(Ci,cj)}di((kf=kf.apply(fe,Ld||[])).next())})}function G(fe,Ld,ze,kf){function mg(Wf){return Wf instanceof ze?Wf:new ze(function(Kf){Kf(Wf)})}return new (ze||(ze=Promise))(function(Wf,Kf){function Ci(rj){try{di(kf.next(rj))}catch(bn){Kf(bn)}}function cj(rj){try{di(kf["throw"](rj))}catch(bn){Kf(bn)}}function di(rj){rj.done?Wf(rj.value):mg(rj.value).then(Ci,cj)}di((kf=kf.apply(fe,Ld||[])).next())})}function H(fe,Ld,ze,kf){function mg(Wf){return Wf instanceof ze?Wf:new ze(function(Kf){Kf(Wf)})}
return new (ze||(ze=Promise))(function(Wf,Kf){function Ci(rj){try{di(kf.next(rj))}catch(bn){Kf(bn)}}function cj(rj){try{di(kf["throw"](rj))}catch(bn){Kf(bn)}}function di(rj){rj.done?Wf(rj.value):mg(rj.value).then(Ci,cj)}di((kf=kf.apply(fe,Ld||[])).next())})}function I(fe,Ld,ze,kf){function mg(Wf){return Wf instanceof ze?Wf:new ze(function(Kf){Kf(Wf)})}return new (ze||(ze=Promise))(function(Wf,Kf){function Ci(rj){try{di(kf.next(rj))}catch(bn){Kf(bn)}}function cj(rj){try{di(kf["throw"](rj))}catch(bn){Kf(bn)}}
function di(rj){rj.done?Wf(rj.value):mg(rj.value).then(Ci,cj)}di((kf=kf.apply(fe,Ld||[])).next())})}function M(fe){var Ld=["AugLoop_Excel_Session_Protocol_","AugLoop_Powerpoint_Session_Protocol_","AugLoop_Session_Protocol_"];let ze;for(const kf of Ld)if(0===fe.indexOf(kf)){ze=kf;break}if(!ze)return"MalformedMessageName";Ld=fe.indexOf("Message",fe.length-7)===fe.length-7;return fe.slice(ze.length,Ld?-7:void 0)}function J(fe,Ld,ze){fe=new ih.Request(fe,Ld);return zj.add(fe,ze)}function O(fe,Ld,ze){return new Promise((kf,
mg)=>{const Wf=setTimeout(()=>{mg(Error("Request timed out"))},Ld);(0,ih.fetch)(fe,ze?ze:{}).then(Kf=>{clearTimeout(Wf);kf(Kf)}).catch(Kf=>{clearTimeout(Wf);mg(Kf)})})}function K(fe,Ld,ze=!1){let kf={firstDiffLeft:0,firstDiffRight:Ld.length};if(fe.length<Ld.length){var mg=fe;var Wf=Ld}else mg=Ld,Wf=fe;0===Wf.indexOf(mg)?(kf.firstDiffLeft=mg.length,kf.firstDiffRight=0):Wf.endsWith(mg)?(kf.firstDiffLeft=0,kf.firstDiffRight=mg.length):(kf=R(fe,Ld,ze),kf.firstDiffLeft+kf.firstDiffRight>mg.length&&(kf.firstDiffRight=
mg.length-kf.firstDiffLeft));ze=kf;0<ze.firstDiffLeft&&(mg=ze.firstDiffLeft<fe.length&&X(fe,ze.firstDiffLeft),Wf=ze.firstDiffLeft<Ld.length&&X(Ld,ze.firstDiffLeft),(mg||Wf)&&--ze.firstDiffLeft);1<ze.firstDiffRight&&(fe=ze.firstDiffRight<fe.length&&X(fe,fe.length-ze.firstDiffRight),Ld=ze.firstDiffRight<Ld.length&&X(Ld,Ld.length-ze.firstDiffRight),(fe||Ld)&&--ze.firstDiffRight);return kf}function R(fe,Ld,ze=!1){const kf={firstDiffLeft:0,firstDiffRight:Ld.length};let mg;for(mg=0;mg<fe.length&&mg<Ld.length;mg+=
1){var Wf=fe.charCodeAt(mg),Kf=Ld.charCodeAt(mg);if(!(Wf===Kf||E(Wf,ze)&&E(Kf,ze)))break}kf.firstDiffLeft=mg;for(mg=0;mg<fe.length&&mg<Ld.length&&(Wf=fe.charCodeAt(fe.length-mg-1),Kf=Ld.charCodeAt(Ld.length-mg-1),Wf===Kf||E(Wf,ze)&&E(Kf,ze));mg+=1);kf.firstDiffRight=mg;return kf}function E(fe,Ld=!1){switch(fe){case 12288:case 8197:case 32:case 11:case 9:case 160:return!0;case 13:case 10:case 65532:return!Ld}return!1}function X(fe,Ld){return 56320<=fe.charCodeAt(Ld)&&57343>=fe.charCodeAt(Ld)}function U(fe,
Ld){const ze=[];(fe=la(fe,Ld))&&ze.push(fe);return ze}function Q(fe,Ld){const ze=[];var kf=la(fe,Ld);kf&&ze.push(kf);var mg;a:{var Wf,Kf,Ci,cj,di;if((null===fe||void 0===fe?void 0:fe.ipPosition)!==(null===Ld||void 0===Ld?void 0:Ld.ipPosition)||(null===fe||void 0===fe?void 0:fe.isColdIp)!==(null===Ld||void 0===Ld?void 0:Ld.isColdIp)){if((null===fe||void 0===fe?void 0:fe.isColdIp)===(null===Ld||void 0===Ld?void 0:Ld.isColdIp)&&kf)if(kf.deltaType===ki.a.Add){if((null===Ld||void 0===Ld?void 0:Ld.ipPosition)===
(null!==(mg=kf.position)&&void 0!==mg?mg:0)+(null!==(Wf=kf.length)&&void 0!==Wf?Wf:0)){mg=void 0;break a}}else if(kf.deltaType===ki.a.Update){if((null===Ld||void 0===Ld?void 0:Ld.ipPosition)===(null!==(Kf=kf.position)&&void 0!==Kf?Kf:0)+(null!==(cj=null===(Ci=kf.content)||void 0===Ci?void 0:Ci.length)&&void 0!==cj?cj:0)){mg=void 0;break a}}else if(kf.deltaType===ki.a.Delete&&(null===Ld||void 0===Ld?void 0:Ld.ipPosition)===(null!==(di=kf.position)&&void 0!==di?di:0)){mg=void 0;break a}mg=new Vk.a({deltaType:ki.a.CursorUpdate,
cursorData:{ipPosition:null===Ld||void 0===Ld?void 0:Ld.ipPosition,isColdIp:null===Ld||void 0===Ld?void 0:Ld.isColdIp}})}else mg=void 0}mg&&ze.push(mg);(mg=h(fe,Ld,kf))&&ze.push(mg);(kf=W(fe,Ld,kf))&&ze.push(kf);{let rj;kf={};mg=!1;for(rj in Ld)-1!==["ipPosition","isColdIp","content","formattedRanges","attributionRanges"].indexOf(rj)||yc()(Ld[rj],fe[rj])||(mg=!0,kf[rj]=Ld[rj]);fe=mg?new Vk.a({deltaType:ki.a.OtherNonContentUpdate,otherNonContentData:kf}):void 0}fe&&ze.push(fe);return ze}function la(fe,
Ld){fe=fe.content;const ze=Ld.content;var kf=K(fe,ze);Ld=kf.firstDiffLeft;const mg=fe.length-kf.firstDiffRight,Wf=ze.length-kf.firstDiffRight;kf=ki.a.Update;let Kf=void 0;if(fe.length!==ze.length)mg===Ld?(kf=ki.a.Add,Kf=fe[fe.length-1]):Wf===Ld&&(kf=ki.a.Delete,Kf=ze[ze.length-1]);else if(fe===ze)return;let Ci=0,cj;switch(kf){case ki.a.Update:Ci=mg-Ld;cj=ze.substring(Ld,Wf);break;case ki.a.Add:cj=ze.substring(Ld,Wf);break;case ki.a.Delete:Ci=mg-Ld,cj=fe.substring(Ld,mg)}fe=ma(cj,Kf);if(void 0!==fe)return new Vk.a({content:kf!==
ki.a.Delete?cj:void 0,deltaType:kf,unit:fe,position:Ld,length:kf!==ki.a.Add?Ci:0})}function h(fe,Ld,ze){var kf,mg,Wf,Kf,Ci,cj,di;if((null===(kf=Ld.formattedRanges)||void 0===kf?void 0:kf.length)<=(null===(mg=fe.formattedRanges)||void 0===mg?void 0:mg.length))if(ze){kf=fe.formattedRanges?[...fe.formattedRanges]:[];mg=(fe=ba(fe.formattedRanges,ze,ze.position))?kf.indexOf(fe):-1;-1!==mg&&(fe.length=ze.position+(ze.length||0)>fe.start+fe.length?ze.position+(null!==(Wf=ze.content)&&void 0!==Wf?Wf:"").length-
fe.start:fe.length+((null!==(Kf=ze.content)&&void 0!==Kf?Kf:"").length-(ze.length||0)),kf[mg]=fe);if(0<kf.length){for(const rj of kf.slice(mg+1))rj.start<ze.position||(ze.position+(ze.length||0)>rj.start?(rj.length=rj.start+rj.length-(ze.position+(ze.length||0)),rj.start=ze.position+(null!==(Ci=ze.content)&&void 0!==Ci?Ci:"").length):rj.start+=(null!==(cj=ze.content)&&void 0!==cj?cj:"").length-(ze.length||0));kf=kf.filter(rj=>0<rj.length)}ze=null!==(di=null===Ld||void 0===Ld?void 0:Ld.formattedRanges)&&
void 0!==di?di:[];if(yc()(kf,ze)||0===kf.length&&0===ze.length)return}else if(yc()(null===fe||void 0===fe?void 0:fe.formattedRanges,null===Ld||void 0===Ld?void 0:Ld.formattedRanges))return;return new Vk.a({deltaType:ki.a.FormattingUpdate,formattedRanges:null===Ld||void 0===Ld?void 0:Ld.formattedRanges})}function W(fe,Ld,ze){var kf;if(((null===fe||void 0===fe?0:fe.attributionRanges)||Ld.attributionRanges||(null===(kf=null===ze||void 0===ze?void 0:ze.attributionData)||void 0===kf?0:kf.ranges))&&!yc()(null===
fe||void 0===fe?void 0:fe.attributionRanges,null===Ld||void 0===Ld?void 0:Ld.attributionRanges)){if(fe.attributionRanges&&Ld.attributionRanges){ze=[];for(const mg of Ld.attributionRanges)fe.attributionRanges.some(Wf=>yc()(Wf,mg))||ze.push(mg);return 0===ze.length?void 0:new Vk.a({deltaType:ki.a.AttributionUpdate,attributionData:{ranges:ze}})}return new Vk.a({deltaType:ki.a.AttributionUpdate,attributionData:{ranges:null===Ld||void 0===Ld?void 0:Ld.attributionRanges}})}}function ba(fe,Ld,ze){if(fe){if(Ld.deltaType===
ki.a.Add){if(Ld=fe.find(kf=>kf.start===ze&&0===kf.length))return Ld;ze=Math.max(ze-1,0)}return fe.find(kf=>0===kf.length?kf.start===ze:kf.start<=ze&&ze<kf.start+kf.length)}}function ma(fe,Ld){const ze=Array.from(fe.matchAll(Ij));Ij.lastIndex=0;if(0===ze.length)return ki.b.Chars;if(1===ze.length){if(0===ze[0].index)return Ld&&ik.test(Ld)?ki.b.Sentence:Ld&&!Ij.test(Ld)?ki.b.Word:ki.b.Chars;if(ze[0].index+1===fe.length)return ik.test(fe[ze[0].index-1])?ki.b.Sentence:Ij.test(fe[ze[0].index-1])?ki.b.Chars:
ki.b.Word;if(fe[ze[0].index-1]){fe=fe[ze[0].index-1];if(ik.test(fe))return ki.b.Sentence;if(Ij.test(fe))return ki.b.Chars}return ki.b.Word}Ld=Array.from(fe.matchAll(ik));ik.lastIndex=0;if(0===Ld.length)return ki.b.PartialSentence;if(1<Ld.length)return ki.b.Paragraph;if(Ld[0].index+1<=fe.length)return Ij.test(fe[Ld[0].index+1])?ki.b.Sentence:ki.b.Paragraph}function qa(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,fe=>{const Ld=16*Math.random()|0;return("x"===fe?Ld:Ld&3|8).toString(16)})}
function ea(fe,Ld){return C(this,void 0,void 0,function*(){var ze=fe.sessionUrl;const kf=Ld.body;ze=yield(0,ih.fetch)(Ld.rMj||ze,{method:Ld.method,headers:Object.assign({Authorization:`Bearer ${fe.authToken}`,"x-origin":fe.origin,"x-correlationid":Ld.cv},Ld.headers),body:kf});if(200!==ze.status)throw Error(`Unexpected status code: ${ze.status}`);return ze})}function Ga(fe,Ld,ze,kf){let mg;ea(fe,{headers:{"Content-Type":"application/jsond"},body:ol.serialize(Ld),cv:ze.cv,method:"POST"}).then(Wf=>Wf.json()).catch(Wf=>
{mg=new Ub.l({messageId:Ld.messageId,error:Wf.message})}).then(Wf=>{om(ze,mg?mg.error:void 0);kf(mg,Wf)})}function da(fe,Ld,ze,kf){let mg;ea(fe,{headers:{"Content-Type":"application/octet-stream"},body:Ld,cv:ze.cv,method:"POST",rMj:`${fe.sessionUrl}/blob`}).then(Wf=>Wf.json()).catch(Wf=>{mg=new Ub.l({error:Wf.message})}).then(Wf=>{om(ze,mg?mg.error:void 0);kf(mg,Wf)})}function ra(fe,Ld,ze,kf){const mg=fe.sessionUrl;let Wf;ea(fe,{cv:kf.cv,method:"GET",rMj:Ld.refType===Bc.a.AlCodedLocation?`${mg}/blob/${Ld.value}`:
Ld.value}).then(Kf=>Kf.arrayBuffer()).then(Kf=>new Uint8Array(Kf)).catch(Kf=>{Wf=Kf}).then(Kf=>{om(kf,Wf?Wf.message:void 0);ze(Wf,Kf)})}function Ka(fe,Ld){const ze=(new Za({operationName:"ApplyTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0})).start();try{if(Ld)if(pf.a.getTypeNameFor(Ld)!==ho.b.getTypeName())ze.success=!1,ze.resultDescription=`Unable to apply text tile delta, parent tile is not proper type: expected ${Vk.b.getTypeName()}, received ${pf.a.getTypeNameFor(Ld)}`,tb.info(538798174,
Oc.CoreDefault,ze.stop());else{var kf=Ld.content;Ld="";if(void 0===fe.position||0>fe.position)ze.success=!1,ze.resultDescription="Unable to apply text tile delta, invalid text tile position",tb.info(538798175,Oc.CoreDefault,ze.stop());else{switch(fe.deltaType){case ki.a.Add:Ld=fe.position<kf.length?`${kf.slice(0,fe.position)}${fe.content}${kf.slice(fe.position,kf.length)}`:kf+fe.content;break;case ki.a.Update:fe.content||fe.unit!==ki.b.Sentence||(ze.dimension0="1");Ld=`${kf.slice(0,fe.position)}${fe.content}${kf.slice(fe.position+
(fe.length||0),kf.length)}`;break;case ki.a.Delete:Ld=`${kf.slice(0,fe.position)}${kf.slice(fe.position+(fe.length||0),kf.length)}`}tb.info(538837071,Oc.CoreDefault,ze.stop());return new ho.b({content:Ld})}}else ze.success=!1,ze.resultDescription="Unable to apply text tile delta, parent tile is undefined",tb.info(538798173,Oc.CoreDefault,ze.stop())}catch(mg){ze.success=!1,ze.resultDescription=`Error applying text tile delta: ${mg}`,tb.info(538798176,Oc.CoreDefault,ze.stop())}}function Pa(fe,Ld){var ze,
kf,mg,Wf;const Kf=Ba(fe.formattedRanges,Ld.deltaType,Ld.position);fe=fe.formattedRanges?[...fe.formattedRanges]:[];const Ci=Kf?fe.indexOf(Kf):-1;-1!==Ci&&(Kf.length=Ld.position+(Ld.length||0)>Kf.start+Kf.length?Ld.position+(null!==(ze=Ld.content)&&void 0!==ze?ze:"").length-Kf.start:Kf.length+((null!==(kf=Ld.content)&&void 0!==kf?kf:"").length-(Ld.length||0)),fe[Ci]=Kf);for(const cj of fe.slice(Ci+1))cj.start<Ld.position||(Ld.position+(Ld.length||0)>cj.start?(cj.length=cj.start+cj.length-(Ld.position+
(Ld.length||0)),cj.start=Ld.position+(null!==(mg=Ld.content)&&void 0!==mg?mg:"").length):cj.start+=(null!==(Wf=Ld.content)&&void 0!==Wf?Wf:"").length-(Ld.length||0));return fe=fe.filter(cj=>0<cj.length)}function Da(fe,Ld){var ze,kf,mg,Wf,Kf;const Ci=(null===(ze=Ld.attributionData)||void 0===ze?void 0:ze.ranges)||Ld.attributionRanges;if((null===(kf=Ld.attributionData)||void 0===kf?0:kf.isFullUpdate)||Ld.deltaType!==ki.a.AttributionUpdate&&void 0!==Ci)return Ci;if(!(null!==(mg=fe.attributionRanges)&&
void 0!==mg&&mg.length||Ci)||Ld.deltaType===ki.a.Update&&0===Ld.length)return fe.attributionRanges;let cj=fe.attributionRanges?[...fe.attributionRanges]:[];if(Ld.deltaType!==ki.a.AttributionUpdate){var di=(fe=Ba(fe.attributionRanges,Ld.deltaType,Ld.position))?cj.indexOf(fe):-1;-1!==di&&(fe.length=Ld.position-fe.start);fe=(null!==(Wf=Ld.content)&&void 0!==Wf?Wf:"").length;Wf=null!==(Kf=Ld.length)&&void 0!==Kf?Kf:0;Kf=Ld.position+Wf;ze=Ld.position+fe;for(var rj of cj.slice(di+1))rj.start<Ld.position||
(di=rj.start+rj.length,Kf>rj.start&&(rj.length=di-Kf),rj.start=Math.max(rj.start+fe-Wf,ze));return cj=cj.filter(lo=>0<lo.length)}const bn=[];for(const lo of Ci)0===bn.length?bn.push({start:lo.start,length:lo.length}):bn[bn.length-1].start+bn[bn.length-1].length>=lo.start?bn[bn.length-1].length=lo.start+lo.length-bn[bn.length-1].start:bn.push({start:lo.start,length:lo.length});cj=cj.filter(lo=>{var as;if(as=0<lo.length){a:{for(const sk of bn)if(sk.start<=lo.start&&sk.start+sk.length>=lo.start+lo.length){lo=
!0;break a}lo=!1}as=!lo}return as});null===Ci||void 0===Ci||Ci.forEach(lo=>{cj.push(lo)});cj.sort((lo,as)=>lo.start-as.start);Ld=[];for(di of cj)(rj=0<Ld.length?Ld[Ld.length-1]:void 0)&&rj.start+rj.length>di.start&&(rj.length=Math.max(di.start-rj.start,0)),!rj||rj.attribution.userId!==di.attribution.userId||rj.attribution.timestamp!==di.attribution.timestamp||rj.attribution.dataSource!==di.attribution.dataSource||di.start>rj.start+rj.length?Ld.push(di):rj.length+=Math.max(di.start+di.length-(rj.start+
rj.length),0);return Ld}function Ra(fe,Ld,ze){var kf,mg,Wf;const Kf=(new Za({operationName:"ApplyFormattedTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0})).start();Kf.clientFlights=ze;try{if(Ld)if(pf.a.getTypeNameFor(Ld)!==ho.a.getTypeName())Kf.success=!1,Kf.resultDescription=`Unable to apply formatted text tile delta, parent tile is not proper type: expected ${ho.a.getTypeName()}, received ${pf.a.getTypeNameFor(Ld)}`,tb.info(538798178,Oc.CoreDefault,Kf.stop());else{var Ci=Ld.content;ze=
"";if((void 0===fe.position||0>fe.position)&&!Ia(fe.deltaType))Kf.success=!1,Kf.resultDescription="Unable to apply formatted text tile delta, invalid text tile position",tb.info(538798179,Oc.CoreDefault,Kf.stop());else if(void 0!==fe.content||Ia(fe.deltaType))if(fe.deltaType===ki.a.Add&&0!==fe.length?tb.info(538798209,Oc.CoreDefault,new Za({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta add operation with delta length, expected length 0",success:!0})):Ia(fe.deltaType)&&
void 0!==fe.content&&tb.info(538798210,Oc.CoreDefault,new Za({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta delete or non-content related operation with content defined, expected undefined",success:!0})),-1!==Dr.indexOf(fe.deltaType)){if(fe.deltaType===ki.a.CursorUpdate)return new ho.a(Object.assign(Object.assign({},Ld),{ipPosition:null===(mg=fe.cursorData)||void 0===mg?void 0:mg.ipPosition,isColdIp:null===(Wf=fe.cursorData)||void 0===Wf?void 0:Wf.isColdIp}));
if(fe.deltaType===ki.a.FormattingUpdate)return new ho.a(Object.assign(Object.assign({},Ld),{formattedRanges:fe.formattedRanges}));if(fe.deltaType===ki.a.OtherNonContentUpdate){let di;var cj={};for(di in fe.otherNonContentData)cj[di]=fe.otherNonContentData[di];return new ho.a(Object.assign(Object.assign({},Ld),cj))}if(fe.deltaType===ki.a.AttributionUpdate)return new ho.a(Object.assign(Object.assign({},Ld),{attributionRanges:Da(Ld,fe)}))}else{const di=Pa(Ld,fe),rj=Da(Ld,fe);let bn=Ld.ipPosition;switch(fe.deltaType){case ki.a.Add:ze=
fe.position<Ci.length?`${Ci.slice(0,fe.position)}${fe.content}${Ci.slice(fe.position,Ci.length)}`:Ci+fe.content;bn=fe.position+fe.length;break;case ki.a.Update:fe.content||fe.unit!==ki.b.Sentence||(Kf.dimension0="1");ze=`${Ci.slice(0,fe.position)}${fe.content}${Ci.slice(fe.position+(null!==(cj=fe.length)&&void 0!==cj?cj:0),Ci.length)}`;bn=fe.position+fe.content.length;break;case ki.a.Delete:ze=`${Ci.slice(0,fe.position)}${Ci.slice(fe.position+(null!==(kf=fe.length)&&void 0!==kf?kf:0),Ci.length)}`,
bn=fe.position}const lo=new ho.a(Object.assign(Object.assign({},Ld),{ipPosition:bn,content:ze,formattedRanges:di,attributionRanges:rj,queryRange:fe.queryRange}));tb.info(538837073,Oc.CoreDefault,Kf.stop());return lo}else Kf.success=!1,Kf.resultDescription="Unable to apply formatted text tile delta, non-delete, non-formatting, non-other-non-content-update and non-cursor-update operation without content defined",tb.info(538798208,Oc.CoreDefault,Kf.stop())}else Kf.success=!1,Kf.resultDescription="Unable to apply formatted text tile delta, parent tile is undefined",
tb.info(538798177,Oc.CoreDefault,Kf.stop())}catch(di){Kf.success=!1,Kf.resultDescription=`Error applying formatted text tile delta: ${di}`,tb.info(538798211,Oc.CoreDefault,Kf.stop())}}function Ba(fe,Ld,ze){const kf=new Za({operationName:"FindRangeForDelta",success:!0});kf.start();if(fe){if(Ld===ki.a.Add){if(Ld=fe.find(mg=>mg.start===ze&&0===mg.length))return kf.resultDescription=`Found a zero-length formatted range for add operation with start ${Ld.start}.`,tb.info(538798213,Oc.CoreDefault,kf.stop()),
Ld;ze=Math.max(ze-1,0)}(fe=fe.find(mg=>0===mg.length?mg.start===ze:mg.start<=ze&&ze<mg.start+mg.length))?(kf.resultDescription=`Updating formatted range for operation with start: ${fe.start} and length: ${fe.length}`,tb.info(538798214,Oc.CoreDefault,kf.stop())):(kf.resultDescription=`Unable to find formatted range for operation at position ${ze}, skipping.`,tb.info(538798215,Oc.CoreDefault,kf.stop()));return fe}kf.resultDescription="No formatted ranges found within the tile, skipping.";tb.info(538798212,
Oc.CoreDefault,kf.stop())}function Ia(fe){return-1!==Dr.indexOf(fe)||ki.a.Delete===fe}function ta(fe){if(!fe)return new vf([],new Set,new Map,new Map);fe=fe.split(";");const Ld=new Set,ze=new Map,kf=new Map;for(const Kf of fe){var mg=Kf.trim();if(""===mg)continue;Ld.add(vf.normalizeName(mg));const [Ci,...cj]=mg.split(":");var Wf=cj.join(":");if(mg=vf.normalizeName(Ci))ze.set(mg,Wf),(Wf=vf.parseName(mg))&&Wf!==mg&&kf.set(Wf,mg)}return new vf(fe,Ld,ze,kf)}function Ca(fe){const Ld=new Promise((ze,kf)=>
{const mg=()=>{fe.removeEventListener("success",Wf);fe.removeEventListener("error",Kf)},Wf=()=>{ze(sa(fe.result));mg()},Kf=()=>{kf(fe.error);mg()};fe.addEventListener("success",Wf);fe.addEventListener("error",Kf)});Ld.then(ze=>{ze instanceof IDBCursor&&Gp.set(ze,fe)}).catch(()=>{});an.set(Ld,fe);return Ld}function za(fe){if(!cq.has(fe)){var Ld=new Promise((ze,kf)=>{const mg=()=>{fe.removeEventListener("complete",Wf);fe.removeEventListener("error",Kf);fe.removeEventListener("abort",Kf)},Wf=()=>{ze();
mg()},Kf=()=>{kf(fe.error||new DOMException("AbortError","AbortError"));mg()};fe.addEventListener("complete",Wf);fe.addEventListener("error",Kf);fe.addEventListener("abort",Kf)});cq.set(fe,Ld)}}function pa(fe){return fe!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(af||(af=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(fe)?function(...Ld){fe.apply(an.get(this),Ld);return sa(Gp.get(this))}:function(...Ld){return sa(fe.apply(an.get(this),
Ld))}:function(Ld,...ze){ze=fe.call(an.get(this),Ld,...ze);dq.set(ze,Ld.sort?Ld.sort():[Ld]);return sa(ze)}}function sa(fe){if(fe instanceof IDBRequest)return Ca(fe);if($n.has(fe))return $n.get(fe);if("function"===typeof fe)var Ld=pa(fe);else fe instanceof IDBTransaction&&za(fe),Ld=qp(fe,Yq||(Yq=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(fe,eq):fe;Ld!==fe&&($n.set(fe,Ld),an.set(Ld,fe));return Ld}function Aa(fe,Ld,{zol:ze,upgrade:kf,Ulq:mg,FGp:Wf}={}){const Kf=indexedDB.open(fe,
Ld);fe=sa(Kf);kf&&Kf.addEventListener("upgradeneeded",Ci=>{kf(sa(Kf.result),Ci.oldVersion,Ci.newVersion,sa(Kf.transaction))});ze&&Kf.addEventListener("blocked",()=>ze());fe.then(Ci=>{Wf&&Ci.addEventListener("close",()=>Wf());mg&&Ci.addEventListener("versionchange",()=>mg())}).catch(()=>{});return fe}function ka(fe,Ld){if(fe instanceof IDBDatabase&&!(Ld in fe)&&"string"===typeof Ld){if(Ih.get(Ld))return Ih.get(Ld);var ze=Ld.replace(/FromIndex$/,""),kf=Ld!==ze,mg=rp.includes(ze);if(ze in(kf?IDBIndex:
IDBObjectStore).prototype&&(mg||Uj.includes(ze)))return fe=async function(Wf,...Kf){Wf=this.transaction(Wf,mg?"readwrite":"readonly");let Ci=Wf.store;kf&&(Ci=Ci.index(Kf.shift()));return(await Promise.all([Ci[ze](...Kf),mg&&Wf.done]))[0]},Ih.set(Ld,fe),fe}}function ha(fe){let Ld="";if("undefined"!=typeof navigator&&navigator.userAgent){const ze=navigator.userAgent;!ze.indexOf||0<ze.indexOf("MSIE ")||0<ze.indexOf("Trident/")?Ld="Error: IE lacks necessary support":"undefined"==typeof Promise?Ld="Error: Promise is not supported":
"undefined"==typeof WebAssembly&&(Ld="Error: WASM is not supported")}else Ld="Error: No window userAgent";if(""==Ld)return!1;fe.resultDescription=Ld;tb.info(540406806,Oc.CoreDefault,fe.stop());return!0}function mb(){globalThis&&!globalThis.top&&(globalThis.top={});return null===globalThis||void 0===globalThis?void 0:globalThis.top}function na(fe,Ld){fe.src=Ld}function va(fe,Ld,ze,kf,mg){const Wf=new Za({operationName:"CreateOnnxInferenceService",success:!0,resultDescription:""});Wf.start();return ha(Wf)?
(Wf.success=!1,Wf.resultDescription="Browser lacks necessary support for inference service",tb.info(540406803,Oc.CoreDefault,Wf.stop()),Promise.reject(Error("Browser lacks necessary support for inference service"))):(new Promise((Kf,Ci)=>{if("undefined"!==typeof document){const cj=document.createElement("script");(mg?mg:na)(cj,fe);cj.onload=()=>{Cb(Ld,ze)?(kf&&(Ld()[ze].env.j2p.l2p=kf),Kf()):(cj.remove(),Ci(Error("ort.Tensor and/or ort.InferenceSession are undefined")))};cj.onerror=Ci;document.body.appendChild(cj)}else globalThis.importScripts?
(globalThis.importScripts(fe),globalThis[ze]=self[ze],Cb(Ld,ze)?(kf&&(Ld()[ze].env.j2p.l2p=kf),Kf()):Ci(Error("ort.Tensor and/or ort.InferenceSession are undefined"))):Ci(Error("Unexpected lack of document and importScripts"))})).then(()=>{tb.info(540406804,Oc.CoreDefault,Wf.stop())}).catch(Kf=>{Wf.success=!1;Wf.resultDescription=Kf.message;tb.info(509871835,Oc.CoreDefault,Wf.stop());throw Kf;})}function Cb(fe,Ld){const ze=globalThis[Ld];return ze&&ze.UUg&&ze.Tensor?((fe=fe())&&!fe[Ld]&&(fe[Ld]=ze),
!0):!1}v.r(Ua);v.d(Ua,{ALFactoryGlobal:function(){return Xk},Alignment:function(){return zb},AugLoopFactory:function(){return Id},AugLoopRuntimeManager:function(){return Xd},AugLoopStandardSchema:function(){return Zc},AuthTokenResponseError:function(){return dg},CapsType:function(){return bi},CrudAugLoopStandardSchema:function(){return Yd},DataObject:function(){return mc},FontWeight:function(){return Z},FormattedSpan:function(){return nf},IdentityProvider:function(){return Ee},Lambda:function(){return Qb},
LambdaException:function(){return gc},ListType:function(){return $a},ServerAuthenticationState:function(){return Fc.a},TextTile:function(){return Pf},Tile:function(){return mh},Tile$1:function(){return Rl},TileType:function(){return rk},UnderlineType:function(){return Bi}});var wb;(function(fe){fe[fe.error=0]="error";fe[fe.warn=1]="warn";fe[fe.info=3]="info";fe[fe.metric=4]="metric";fe[fe.verbose=5]="verbose";fe[fe.debug=6]="debug";fe[fe.disabled=7]="disabled"})(wb||(wb={}));var gb={default:{}};gb["default"]||
(gb["default"]={});var Wa=function(){function fe(Ld){if(Ld)for(var ze in Ld)null!=Ld[ze]&&(this[ze]=Ld[ze])}fe.prototype.count=0;fe.prototype.cv="";fe.prototype.serviceName="";fe.prototype.sessionKey="";fe.prototype.traceId="";fe.prototype.durationMs=0;fe.prototype.success=!1;fe.prototype.resultDescription="";fe.prototype.resultJSON="";fe.prototype.resultSignature="";fe.prototype.operationName="";fe.prototype.resourceId="";fe.prototype.dimension0="";fe.prototype.dimension1="";fe.prototype.dimension2=
"";fe.prototype.dimension3="";fe.prototype.clientAppName="";fe.prototype.clientAppPlatform="";fe.prototype.clientRuntimeVersion="";fe.prototype.clientAppVersion="";fe.prototype.clientReleaseAudienceGroup="";fe.prototype.clientReleaseChannel="";fe.prototype.clientReleaseFork="";fe.prototype.clientSessionId="";fe.prototype.clientFlights="";fe.prototype.clientIPRange="";fe.prototype.clientDocSessionId="";fe.prototype.clientDeviceId="";fe.prototype.clientUserAgent="";fe.prototype.userType="";fe.prototype.userId=
"";fe.prototype.userTenantId="";fe.prototype.joinContextId="";fe.prototype.ariaTenant="";fe.prototype.ariaNamespace="";fe.prototype.dataFields="";fe.getTypeUrl=function(Ld){void 0===Ld&&(Ld="type.googleapis.com");return Ld+"/OperationEvent"};return fe}();const vb=(()=>"undefined"!=typeof process&&process.Kin?()=>{const fe=process.Kin();return 1E3*fe[0]+fe[1]/1E6}:"undefined"!=typeof performance&&performance.now?()=>performance.now():()=>Date.now())();class Za extends Wa{constructor(fe,Ld){super(fe);
this.eventName="Operation";this.options=Ld;this.durationMs=null===fe||void 0===fe?void 0:fe.durationMs;fe&&void 0!=fe.count||(this.count=1)}setClientMetadata(fe,Ld){fe&&(this.clientAppName=fe.appName,this.clientAppPlatform=fe.appPlatform,this.clientAppVersion=fe.appVersion,void 0!=Ld&&Ld||(this.clientFlights=fe.flights),this.clientReleaseAudienceGroup=fe.releaseAudienceGroup,this.clientReleaseChannel=fe.releaseChannel,this.clientReleaseFork=fe.releaseFork,this.clientRuntimeVersion=fe.runtimeVersion,
this.clientSessionId=fe.sessionId,this.clientDocSessionId=fe.docSessionId,this.clientDeviceId=fe.deviceId,this.clientUserAgent=fe.userAgent);return this}setUserContext(fe){fe&&(this.userId=fe.puid||fe.oid,this.userType=fe.userType&&fe.userType.toString(),this.userTenantId=fe.tid);return this}setMetricCustomDimensions(fe,Ld){if(!this.options)throw Error(`Attempting to set custom dimensions ${fe} to operation ${this.operationName} without activating MetricCount or MetricDuration`);this.options.metricCustomDimensions=
this.options.metricCustomDimensions||{};this.options.metricCustomDimensions[fe]=Ld}setDataField(fe,Ld){if(void 0!==Ld&&null!==Ld){var ze=this.dataFields?JSON.parse(this.dataFields):{};ze[fe]=Ld;this.dataFields=JSON.stringify(ze)}}setDataFields(fe){this.dataFields=this.dataFields?JSON.stringify(Object.assign(Object.assign({},JSON.parse(this.dataFields)),fe)):JSON.stringify(fe)}start(){this.startTime=vb();return this}recordStep(fe){this.setDataField(fe,Math.floor(vb()-this.startTime));return this}stop(){const fe=
vb();this.durationMs=Math.round(fe-this.startTime);return this}getMetrics(fe){var Ld,ze;const kf={};if(this.operationName)switch(this.operationName){case "SessionHealthOrphanedEventsWithoutProperSessionKey":case "SessionHealthOrphanedSessions":case "WorkflowActivationState":kf[this.operationName+".CountV2"]={dimensionNames:Za.getOrphanedSessionHealthDimensionNames.bind(Za),dimensionValues:this.getOrphanedSessionHealthDimensionValues(),value:this.count};break;case "MarkUnhealthySession":case "MarkHealthWarningSession":kf[this.operationName+
".Reason"]={dimensionNames:Za.getSessionHealthDimensionNames.bind(Za),dimensionValues:this.getSessionHealthDimensionValues(),value:1};break;default:"matchmaker_timer"===this.operationName&&(kf["Workflow.DurationMs"]={dimensionNames:Za.getWorkflowDimensionNames.bind(Za),dimensionValues:this.getWorkflowDimensionValues(),value:this.durationMs||0},kf["Workflow.Count"]={dimensionNames:Za.getWorkflowDimensionNames.bind(Za),dimensionValues:this.getWorkflowDimensionValues(),value:1});if(void 0!==this.durationMs){const mg=
`${this.operationName}.DurationMsV2`;if((null===(Ld=this.options)||void 0===Ld?0:Ld.metricDuration)||0<=fe.indexOf(mg))kf[mg]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.durationMs}}Ld=`${this.operationName}.CountV2`;if((null===(ze=this.options)||void 0===ze?0:ze.metricCount)||0<=fe.indexOf(Ld))kf[Ld]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.count}}return kf}getDimensionNames(){var fe,
Ld;let ze=Za.dimensionNames;if(null===(fe=this.options)||void 0===fe?0:fe.metricCustomDimensions){ze=ze.slice();for(const kf in null===(Ld=this.options)||void 0===Ld?void 0:Ld.metricCustomDimensions)ze.push(kf)}return ze}getDimensionValues(){var fe,Ld;const ze=[this.success,this.clientAppName,this.clientAppPlatform,this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3];if(null===(fe=this.options)||void 0===fe?0:fe.metricCustomDimensions)for(const kf in null===(Ld=this.options)||
void 0===Ld?void 0:Ld.metricCustomDimensions)ze.push(this.options.metricCustomDimensions[kf]);return ze}static getOrphanedSessionHealthDimensionNames(){return this.orphanedSessionHealthDimensionNames}getOrphanedSessionHealthDimensionValues(){return[this.success,this.clientAppName,this.clientAppPlatform,this.clientReleaseAudienceGroup,this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}static getSessionHealthDimensionNames(){return this.sessionHealthDimensionNames}getSessionHealthDimensionValues(){return[this.resultSignature,
this.clientAppName,this.clientAppPlatform,this.clientAppVersion,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}static getWorkflowDimensionNames(){return this.workflowDimensionNames}getWorkflowDimensionValues(){return[this.resultSignature,this.resourceId,this.resourceId,this.success]}}Za.dimensionNames="Success ClientAppName ClientAppPlatform ResourceId Dimension0 Dimension1 Dimension2 Dimension3".split(" ");Za.orphanedSessionHealthDimensionNames="Success ClientAppName ClientAppPlatform ClientReleaseAudienceGroup ResourceId Dimension0 Dimension1 Dimension2 Dimension3".split(" ");
Za.sessionHealthDimensionNames="Reason ClientAppName ClientAppPlatform ClientAppVersion Dimension0 Dimension1 Dimension2 Dimension3".split(" ");Za.workflowDimensionNames=["ResultSignature","WorkflowId","ResourceId","Success"];var Sa;(Sa||(Sa={})).Log="Log";const ub="undefined"!=typeof process&&process.env?process.env.feq:"client",ab={97:0,98:1,99:2,100:3,101:4,102:5,103:6,104:7,105:8,106:9,107:10,108:11,109:12,110:13,111:14,112:15,113:16,114:17,115:18,116:19,117:20,118:21,119:22,120:23,121:24,122:25,
48:26,49:27,50:28,51:29,52:30,53:31,54:32,55:33,56:34,57:35};let Ya=[],jb=[],kb,hb=()=>null,Bb=()=>{};const cc=new Map,rc=new Map,sb=new Map,qb=new Map;var tb;(function(fe){fe.defineCoreLogCategory=Ld=>({root:"Core",name:Ld});fe.defineWorkflowLogCategory=Ld=>({root:"Workflow",name:Ld});fe.clearLoggers=()=>{Ya=[];jb=[];rc.clear();sb.clear()};fe.clearAggregators=()=>{cc.clear()};fe.addLogger=Ld=>{-1===Ya.indexOf(Ld)&&(Ya.push(Ld),yb(rc,Ld))};fe.addDecidingLogger=Ld=>{-1===jb.indexOf(Ld)&&(jb.push(Ld),
yb(sb,Ld))};fe.setCorrelationContextCallback=Ld=>{kb=Ld};fe.setStartPerformanceEventCallback=Ld=>{hb=Ld};fe.setStopPerformanceEventCallback=Ld=>{Bb=Ld};fe.addAggregator=Ld=>{Ld.init((ze,kf)=>{pc(ze,kf)});cc.has(Ld.eventName)?cc.get(Ld.eventName).push(Ld):cc.set(Ld.eventName,[Ld])};fe.flushAggregators=Ld=>{cc.forEach(ze=>{ze.forEach(kf=>kf.flush(Ld))})};fe.setTagLevelOverride=(Ld,ze)=>{qb.set(Ld&&5===Ld.length?ab[Ld.charCodeAt(0)]<<24|ab[Ld.charCodeAt(1)]<<18|ab[Ld.charCodeAt(2)]<<12|ab[Ld.charCodeAt(3)]<<
6|ab[Ld.charCodeAt(4)]:-1,ze)};fe.resetTagLevelOverrides=()=>{qb.clear()};fe.error=(Ld,ze,kf,mg,Wf,Kf,Ci,cj,di,rj)=>{sc(Ld,ze,wb.error,kf,mg,Wf,Kf,Ci,cj,di,rj)};fe.warn=(Ld,ze,kf,mg,Wf,Kf,Ci,cj,di,rj)=>{sc(Ld,ze,wb.warn,kf,mg,Wf,Kf,Ci,cj,di,rj)};fe.info=(Ld,ze,kf,mg,Wf,Kf,Ci,cj,di,rj)=>{sc(Ld,ze,wb.info,kf,mg,Wf,Kf,Ci,cj,di,rj)};fe.verbose=(Ld,ze,kf,mg,Wf,Kf,Ci,cj,di,rj)=>{sc(Ld,ze,wb.verbose,kf,mg,Wf,Kf,Ci,cj,di,rj)};fe.debug=(Ld,ze,kf,mg,Wf,Kf,Ci,cj,di,rj)=>{sc(Ld,ze,wb.debug,kf,mg,Wf,Kf,Ci,cj,
di,rj)};fe.metric=(Ld,ze,kf,mg,Wf,Kf,Ci,cj,di,rj)=>{sc(Ld,ze,wb.metric,kf,mg,Wf,Kf,Ci,cj,di,rj)};fe.formatMetric=(Ld,ze,kf,mg)=>{const Wf={};Wf[Ld]={dimensionNames:kf,dimensionValues:mg,value:ze};return Wf};fe.dynamic=Ld=>{pc(Ld)}})(tb||(tb={}));const yb=(fe,Ld)=>{const ze=Ld.level;Object.keys(wb).map(kf=>wb[kf]).filter(kf=>"string"!==typeof kf).filter(kf=>kf<=ze).forEach(kf=>{fe.has(kf)?fe.get(kf).push(Ld):fe.set(kf,[Ld])})},$b=(fe,Ld,ze,kf,mg,Wf,Kf,Ci)=>{if(void 0===Ld&&("string"===typeof fe||"object"===
typeof fe))return fe;if(void 0===Ld&&"function"===typeof fe)return fe();const cj=[];for(const di of[fe,Ld,ze,kf,mg,Wf,Kf,Ci])void 0!==di&&cj.push("function"===typeof di?di():di);return cj},ac=fe=>{if("string"===typeof fe)return fe;let Ld="";for(let ze=0;ze<fe.length;ze++){0<ze&&(Ld+=" ");const kf=fe[ze];Ld=kf instanceof Error?Ld+JSON.stringify({message:kf.message,name:kf.name,stack:kf.stack}):"object"===typeof kf?Ld+JSON.stringify(kf):Ld+kf}return Ld},ob=[],Db=["Level","Tag"],ec=["Level","Tag","Workflow"],
Ic=fe=>void 0!==fe?rc.get(fe)||ob:Ya,fd=(fe,Ld)=>(void 0!==fe?sb.get(fe)||[]:jb).filter(ze=>ze.shouldLog(Ld)),sc=(fe,Ld,ze,kf,mg,Wf,Kf,Ci,cj,di,rj)=>{ze=qb.get(fe)||ze;var bn=Ic(ze),lo=fd(ze,kf);if(0!=bn.length||0!=lo.length){var as=hb(Sa.Log),sk="abcdefghijklmnopqrstuvwxyz0123456789"[fe>>24&63]+"abcdefghijklmnopqrstuvwxyz0123456789"[fe>>18&63]+"abcdefghijklmnopqrstuvwxyz0123456789"[fe>>12&63]+"abcdefghijklmnopqrstuvwxyz0123456789"[fe>>6&63]+"abcdefghijklmnopqrstuvwxyz0123456789"[fe>>0&63],jf=$b(kf,
mg,Wf,Kf,Ci,cj,di,rj);if(Ld.name===Oc.WorkflowMetricsOnly.name&&Ld.root===Oc.WorkflowMetricsOnly.root)!Array.isArray(jf)&&"object"===typeof jf&&pc({eventName:"Metrics",tagId:sk,category:`${Ld.root}.${Ld.name}`,traceLevel:ze,message:"",getMetrics:()=>jf},!1,bn,lo);else if(Array.isArray(jf)||"object"!==typeof jf)pc({eventName:"Log",tagId:sk,category:`${Ld.root}.${Ld.name}`,traceLevel:ze,message:ac(jf),getMetrics:()=>{var yk;return"Core"===Ld.root?{Zfq:{dimensionNames:()=>Db,dimensionValues:[String(ze),
sk],value:1}}:{$gq:{dimensionNames:()=>ec,dimensionValues:[String(ze),sk,kb?null===(yk=kb())||void 0===yk?void 0:yk.workflow:""],value:1}}}},!1,bn,lo);else if(jf.tagId=sk,jf.category=`${Ld.root}.${Ld.name}`,"Operation"===jf.eventName&&"Workflow"===Ld.root&&(jf.eventName="WorkflowOperation",kb&&(jf.joinContextId=kb().joinContextId,jf.workflow=kb().workflow)),jf.traceLevel=ze,fe=cc.get(jf.eventName))for(bn=0;bn<fe.length&&(!(lo=fe[bn])||!lo.add(jf,bn===fe.length-1));++bn);else pc(jf,!1,bn,lo);Bb(as)}},
pc=(fe,Ld=!1,ze,kf)=>{var mg,Wf,Kf,Ci,cj,di,rj,bn,lo,as,sk,jf,yk,pq;null==ze&&(ze=Ic(fe.traceLevel));kf=kf||ob;let bs;if(0<ze.length||0<kf.length){fe.serviceName=ub;!Ld&&kb&&(Ld=kb())&&(bs={disableLogging:Ld.disableLogging,userDataBoundaryType:null===(Wf=null===(mg=Ld.sessionDescriptor)||void 0===mg?void 0:mg.userContext)||void 0===Wf?void 0:Wf.userDataBoundaryType},fe.cv=fe.cv?fe.cv:Ld.cv.toString(),fe.sessionKey=fe.sessionKey?fe.sessionKey:Ld.sessionKey,fe.userTenantId=fe.userTenantId?fe.userTenantId:
Ld.userTenantId,fe.workflow=fe.workflow?fe.workflow:Ld.workflow,fe.clientAppName=fe.clientAppName?fe.clientAppName:null===(Kf=Ld.clientMetadata)||void 0===Kf?void 0:Kf.appName,fe.clientAppPlatform=fe.clientAppPlatform?fe.clientAppPlatform:null===(Ci=Ld.clientMetadata)||void 0===Ci?void 0:Ci.appPlatform,fe.clientAppVersion=fe.clientAppVersion?fe.clientAppVersion:null===(cj=Ld.clientMetadata)||void 0===cj?void 0:cj.appVersion,fe.clientDeviceId=fe.clientDeviceId?fe.clientDeviceId:null===(di=Ld.clientMetadata)||
void 0===di?void 0:di.deviceId,fe.clientDocSessionId=fe.clientDocSessionId?fe.clientDocSessionId:null===(rj=Ld.clientMetadata)||void 0===rj?void 0:rj.docSessionId,fe.clientReleaseAudienceGroup=fe.clientReleaseAudienceGroup?fe.clientReleaseAudienceGroup:null===(bn=Ld.clientMetadata)||void 0===bn?void 0:bn.releaseAudienceGroup,fe.clientReleaseChannel=fe.clientReleaseChannel?fe.clientReleaseChannel:null===(lo=Ld.clientMetadata)||void 0===lo?void 0:lo.releaseChannel,fe.clientReleaseFork=fe.clientReleaseFork?
fe.clientReleaseFork:null===(as=Ld.clientMetadata)||void 0===as?void 0:as.releaseFork,fe.clientRuntimeVersion=fe.clientRuntimeVersion?fe.clientRuntimeVersion:null===(sk=Ld.clientMetadata)||void 0===sk?void 0:sk.runtimeVersion,fe.clientSessionId=fe.clientSessionId?fe.clientSessionId:null===(jf=Ld.clientMetadata)||void 0===jf?void 0:jf.sessionId,fe.clientUserAgent=fe.clientUserAgent?fe.clientUserAgent:null===(yk=Ld.clientMetadata)||void 0===yk?void 0:yk.userAgent,fe.traceId=fe.traceId||Ld.traceId,fe.isClientTelemetrySampled=
fe.isClientTelemetrySampled?fe.isClientTelemetrySampled:null===(pq=Ld.clientMetadata)||void 0===pq?void 0:pq.isClientTelemetrySampled);for(const Uq of ze)Uq.log(fe,bs);for(const Uq of kf)Uq.log(fe)}};class Oc{}Oc.CoreDefault=tb.defineCoreLogCategory("Default");Oc.CoreSystem=tb.defineCoreLogCategory("System");Oc.CoreUnsampled=tb.defineCoreLogCategory("Unsampled");Oc.WorkflowDefault=tb.defineWorkflowLogCategory("Default");Oc.WorkflowUnsampled=tb.defineWorkflowLogCategory("Unsampled");Oc.WorkflowMetricsOnly=
tb.defineWorkflowLogCategory("MetricsOnly");Oc.PrivacyGuardEvent=tb.defineCoreLogCategory("PrivacyGuardEvent");var jd;(function(fe){fe[fe.ProductServiceUsage=2]="ProductServiceUsage";fe[fe.ProductServicePerformance=4]="ProductServicePerformance"})(jd||(jd={}));var Wd;(function(fe){fe[fe.BasicEvent=10]="BasicEvent";fe[fe.FullEvent=100]="FullEvent";fe[fe.RequiredServiceDataEvent=110]="RequiredServiceDataEvent"})(Wd||(Wd={}));const se=/\|~/g;class Zb{constructor(){this.count=0;this.qpe=new Map}}class Cc{constructor(fe,
Ld,ze,kf,mg){this.buckets=new Map;this.init=Wf=>{this.log=Wf};this.add=(Wf,Kf=!0)=>{if(!this.condition||!this.condition(Wf))return!0===Kf&&this.log(Wf,!1),!1;Kf=[];for(var Ci of this.dimensions)if(void 0===Wf[Ci]||null===Wf[Ci])Kf.push(null);else{let cj="";"boolean"==typeof Wf[Ci]?cj="b~":"number"==typeof Wf[Ci]&&(cj="n~");Kf.push(`${cj}${Wf[Ci].toString().replace(se,"_")}`)}Ci=Kf.join("|");Kf=this.buckets.get(Ci);if(!Kf){Kf=new Zb;Kf.traceLevel=Wf.traceLevel;for(const cj of this.avgMeasures)Kf.qpe.set(cj,
0);this.buckets.set(Ci,Kf)}Kf.count++;for(const cj of this.avgMeasures)Wf[cj]&&Kf.qpe.set(cj,Kf.qpe.get(cj)+Wf[cj]);return!0};this.flush=(Wf=!1)=>{this.buckets.forEach((Kf,Ci)=>{const cj={traceLevel:Kf.traceLevel,eventName:this.eventName,count:Kf.count};Ci=Ci.split("|");for(let di=0;di<this.dimensions.length;di++){const rj=this.dimensions[di],bn=Ci[di];0===bn.indexOf("b~")?cj[rj]="b~true"===bn:0===bn.indexOf("n~")?cj[rj]=parseInt(bn.slice(2),10):cj[rj]=bn}for(const di of this.avgMeasures)cj[di]=Math.round(Kf.qpe.get(di)/
Kf.count);this.log(cj,!0)});this.buckets.clear();Wf&&(this.condition=null,clearInterval(this.interval))};this.eventName=fe;this.condition=Ld;this.dimensions=ze;this.avgMeasures=kf;0<mg&&(this.interval=setInterval(this.flush,1E3*mg))}}const ed="cloud.dev.microsoft officeppe.com cloud.microsoft office.com office365.us ic.gov microsoft.scloud microsoftonline.cn".split(" "),le=(fe,Ld,ze,kf)=>new Cc(fe,mg=>mg.success&&0<=ze.indexOf(mg[Ld]),[Ld,"ariaNamespace","resourceId","success","resultSignature","clientDocSessionId",
"dimension0","dimension1","dimension2","dimension3"],["durationMs"],kf),Yb=fe=>{if(!fe)return fe;for(const Ld of ed)if(0<=fe.indexOf(Ld))return fe;return"**redacted**"};class bc{constructor(fe){this.level=wb.info;this.hostCallbacks=fe}log(fe){if(null!=this.hostCallbacks&&null!=this.hostCallbacks.sendTelemetryEvent){var Ld=(kf,mg,Wf,Kf,Ci)=>{mg=mg.charAt(0).toUpperCase()+mg.slice(1);let cj={DocSessionId:kf.clientDocSessionId,ResourceId:kf.resourceId,ResultDescription:kf.resultDescription,ResultSignature:kf.resultSignature,
Dimension0:kf.dimension0,Dimension1:kf.dimension1,Dimension2:kf.dimension2,Dimension3:kf.dimension3,JoinContextId:kf.joinContextId,ServerSessionKey:this.serverSessionKey};Wf&&(cj=Object.assign(Object.assign({},cj),JSON.parse(Wf)));Wf=Kf?Kf:bc.augLoopAriaTenantToken;Ci=Ci||Wf!=bc.augLoopAriaTenantToken?Ci:bc.augLoopAriaNamespace;mg=mg?mg:bc.operationNamePlaceholder;this.hostCallbacks.sendTelemetryEvent(Wf,Ci?`${Ci}_${mg}`:mg,cj,"Office.System.Activity",{CV:kf.cv,Duration:1E3*(kf.durationMs||0),Count:kf.count,
C5p:2,Success:kf.success},!1,jd.ProductServiceUsage|jd.ProductServicePerformance,Wd.RequiredServiceDataEvent)},ze=(kf,mg,Wf)=>{this.hostCallbacks.sendDiagnosticTrace&&this.hostCallbacks.sendDiagnosticTrace(kf,mg,Wf)};"Workflow.MetricsOnly"!=fe.category&&("Operation"===fe.eventName?Ld(fe,fe.operationName,fe.dataFields,void 0,fe.ariaNamespace):"SessionHealth"===fe.eventName?Ld(fe,fe.sessionHealthEventName):"WorkflowOperation"===fe.eventName?Ld(fe,fe.operationName,fe.dataFields,fe.ariaTenant,fe.ariaNamespace):
"Log"===fe.eventName&&ze(fe.tagId,fe.traceLevel,fe.message))}}setServerSessionKey(fe){this.serverSessionKey=fe}}bc.augLoopAriaTenantToken="3de4087d4de34817b1c376e3d1e6e293-983c4292-5ba9-485a-ab10-9797863c788b-6770";bc.augLoopAriaNamespace="Office_AugLoop_Client";bc.operationNamePlaceholder="OperationNameNotProvided";var pd=null;"undefined"!==typeof WebSocket?pd=WebSocket:"undefined"!==typeof MozWebSocket?pd=MozWebSocket:"undefined"!==typeof v.g?pd=v.g.WebSocket||v.g.vVg:"undefined"!==typeof window?
pd=window.WebSocket||window.vVg:"undefined"!==typeof self&&(pd=self.WebSocket||self.vVg);const Vb=pd,zc="object"===typeof process&&"object"===typeof process.versions&&"undefined"!==typeof process.versions.node;class $c{constructor(fe){this.networkOverrideOptions=fe;this.isClosing=this.hadEgressError=!1;this.pendingEgress=[]}init(fe,Ld,ze,kf,mg){var Wf,Kf;this.clientMetadata=mg;if(zc){const Ci={Gmd:null===(Wf=this.networkOverrideOptions)||void 0===Wf?void 0:Wf.hostHeader,headers:(null===(Kf=this.networkOverrideOptions)||
void 0===Kf?0:Kf.hostHeader)?{host:this.networkOverrideOptions.hostHeader}:void 0};this.ws=new Vb(fe,Ci)}else this.ws=new Vb(fe);this.logOp=(new Za({operationName:$c.className,success:!0})).start();this.logOp.setClientMetadata(mg,!0);this.ingressByteCountOp=new Za({operationName:"WSIngressByteOrderOfMagnitude",success:!0});this.ingressByteCountOp.setClientMetadata(mg,!0);this.ws.addEventListener("open",()=>{ze();this.logOp.resourceId="OnOpen";this.logOp.resultDescription="";this.logOp.success=!0;
this.logOp.dimension0=this.pendingEgress.length.toString();tb.info(508843801,Oc.CoreDefault,this.logOp.stop())});this.ws.addEventListener("message",Ci=>{this.logIngressCount(Ci.data);Ld(Ci.data)});this.ws.addEventListener("error",Ci=>{this.errorMessage=Ci.message;this.logOp.resourceId="OnError";this.logOp.resultDescription=this.errorMessage;this.logOp.success=!1;tb.info(508843800,Oc.CoreDefault,this.logOp.stop());this.ws?this.ws.close():this.logWsUndefinedError("error event handler")});this.ws.addEventListener("close",
Ci=>{this.logOp.resourceId="OnClose";this.logOp.resultDescription=Ci?`code: ${Ci.code}. reason: ${Ci.reason}`:"";this.logOp.success=!0;tb.info(508843799,Oc.CoreDefault,this.logOp.stop());kf(this.errorMessage);this.isClosing=!1})}egress(fe){this.ws.send(fe.obj,Ld=>{Ld&&!this.hadEgressError&&(this.hadEgressError=!0,this.logOp.resourceId="OnEgressError",this.logOp.resultDescription=Ld.message,this.logOp.success=!1,tb.info(508843797,Oc.CoreDefault,this.logOp.stop()))})}close(){this.isClosing||(this.isClosing=
!0,this.ws?this.ws.close():this.logWsUndefinedError("close"))}logIngressCount(fe){fe=fe.length;1E5<fe&&(this.ingressByteCountOp.start(),this.ingressByteCountOp.dimension2=fe.toString().length.toString(),tb.info(508843794,Oc.CoreDefault,this.ingressByteCountOp.stop()))}logWsUndefinedError(fe){const Ld=(new Za({operationName:$c.className,success:!1})).start();Ld.setClientMetadata(this.clientMetadata,!0);Ld.resourceId="webSocketUndefined";Ld.resultDescription=fe+": this.ws null or undefined";tb.info(506566722,
Oc.CoreDefault,Ld.stop())}}$c.className="WebSocketWorker";class rd{constructor(fe){this.childCount=0;if(!fe){for(fe=0;22>fe;fe++)Sc[fe]=fc[Math.floor(Math.random()*fc.length)];fe=Sc.join("")}this.id=fe}static fromString(fe,Ld){if(!fe)throw Error("Received invalid correlation vector string");fe=fe.endsWith(".0")?new rd(fe.substring(0,fe.length-2)):new rd(fe);Ld&&(fe.childCount=Ld);return fe}newChild(){++this.childCount;return new rd(this.id+"."+this.childCount.toString())}toString(){return 127<this.id.length?
this.id.substring(0,127)+"!":this.id}}const fc="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),Sc=Array(22);var qc={default:{}};qc["default"]||(qc["default"]={});var gd=function(){function fe(Ld){if(Ld)for(var ze in Ld)null!=Ld[ze]&&(this[ze]=Ld[ze])}fe.prototype.cv="";fe.prototype.serviceName="";fe.prototype.sessionKey="";fe.prototype.traceId="";fe.prototype.clientAppName="";fe.prototype.clientAppPlatform="";fe.prototype.clientRuntimeVersion="";fe.prototype.clientAppVersion=
"";fe.prototype.clientReleaseAudienceGroup="";fe.prototype.clientReleaseChannel="";fe.prototype.clientReleaseFork="";fe.prototype.clientSessionId="";fe.prototype.clientFlights="";fe.prototype.clientIPRange="";fe.prototype.clientDocSessionId="";fe.prototype.clientDeviceId="";fe.prototype.clientUserAgent="";fe.prototype.userType="";fe.prototype.userId="";fe.prototype.userTenantId="";fe.prototype.sessionHealthEventName="";fe.prototype.source="";fe.prototype.reason="";fe.prototype.reasonDependency="";
fe.prototype.subReason="";fe.prototype.impact="";fe.prototype.success=!1;fe.prototype.durationMs=0;fe.prototype.count=0;fe.prototype.message="";fe.prototype.affectedWorkflows="";fe.prototype.resourceId="";fe.prototype.dimension0="";fe.prototype.dimension1="";fe.prototype.dimension2="";fe.prototype.dimension3="";fe.prototype.resultDescription="";fe.prototype.resultSignature="";fe.prototype.joinContextId="";fe.getTypeUrl=function(Ld){void 0===Ld&&(Ld="type.googleapis.com");return Ld+"/SessionHealthEvent"};
return fe}(),Oe;(function(fe){fe[fe.Unknown=0]="Unknown";fe[fe.Core=1]="Core";fe[fe.Workflow=2]="Workflow";fe[fe.SessionExtension=3]="SessionExtension";fe[fe.Client=4]="Client";fe[fe.ClientRuntime=5]="ClientRuntime"})(Oe||(Oe={}));var Re;(function(fe){fe[fe.Unknown=0]="Unknown";fe[fe.Core=1]="Core";fe[fe.Workflow=2]="Workflow";fe[fe.SessionExtension=3]="SessionExtension";fe[fe.Client=4]="Client";fe[fe.Network=5]="Network";fe[fe.AugLoopDependency=6]="AugLoopDependency";fe[fe.WorkflowDependency=7]=
"WorkflowDependency";fe[fe.ClientRuntime=8]="ClientRuntime"})(Re||(Re={}));var sd;(function(fe){fe[fe.Unknown=0]="Unknown";fe[fe.None=1]="None";fe[fe.MissingInput=2]="MissingInput";fe[fe.MissingOutput=3]="MissingOutput"})(sd||(sd={}));class Gc extends gd{constructor(fe,Ld){var ze,kf;super({source:Oe[fe.source],reason:Re[fe.reason],reasonDependency:fe.reasonDependency,subReason:fe.subReason,sessionHealthEventName:fe.sessionHealthEventName,impact:sd[fe.impact],success:fe.success,durationMs:null!==(ze=
fe.durationMs)&&void 0!==ze?ze:0,count:"number"===typeof fe.count?fe.count:1,message:fe.message,affectedWorkflows:(null!==(kf=fe.affectedWorkflows)&&void 0!==kf?kf:[]).join(","),resourceId:fe.resourceId,dimension0:fe.dimension0,dimension1:fe.dimension1,dimension2:fe.dimension2,dimension3:fe.dimension3,cv:fe.cv,resultSignature:fe.resultSignature,resultDescription:fe.resultDescription,joinContextId:fe.joinContextId});this.eventName="SessionHealth";Ld&&this.setClientMetadata(Ld);this.metricCount=fe.metricCount;
this.metricDuration=fe.metricDuration}getMetrics(){const fe={};if(void 0===this.metricCount||this.metricCount)fe[`${this.sessionHealthEventName}.CountV2`]={dimensionNames:()=>Gc.dimensionNames,dimensionValues:this.getDimensionValues(),value:this.count};if(void 0===this.metricDuration||this.metricDuration)fe[`${this.sessionHealthEventName}.DurationMsV2`]={dimensionNames:()=>Gc.dimensionNames,dimensionValues:this.getDimensionValues(),value:this.durationMs};return fe}setClientMetadata(fe){fe&&(this.clientAppName=
fe.appName,this.clientAppPlatform=fe.appPlatform,this.clientAppVersion=fe.appVersion,this.clientFlights=fe.flights,this.clientReleaseAudienceGroup=fe.releaseAudienceGroup,this.clientReleaseChannel=fe.releaseChannel,this.clientReleaseFork=fe.releaseFork,this.clientRuntimeVersion=fe.runtimeVersion,this.clientSessionId=fe.sessionId,this.clientDocSessionId=fe.docSessionId,this.clientUserAgent=fe.userAgent,this.clientDeviceId=fe.deviceId);return this}setUserContext(fe){fe&&(this.userId=fe.puid||fe.oid,
this.userType=fe.userType&&fe.userType.toString(),this.userTenantId=fe.tid);return this}setReason(fe){this.reason=Re[fe];return this}setSource(fe){this.source=Oe[fe];return this}setImpact(fe){this.impact=sd[fe];return this}setAffectedWorkflows(fe){this.affectedWorkflows=(null!==fe&&void 0!==fe?fe:[]).join(",");return this}getAffectedWorkflows(){return this.affectedWorkflows.split(",")}start(){this.startTime=vb();return this}stop(){const fe=vb();this.durationMs=Math.round(fe-this.startTime);return this}getDimensionValues(){var fe;
return[this.clientAppName,this.clientAppPlatform,this.clientAppVersion,this.success?"1":"0",`${this.reason}_${this.reasonDependency}`,this.impact,null!==(fe=this.getAffectedWorkflows()[0])&&void 0!==fe?fe:"",this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}}Gc.dimensionNames="ClientAppName ClientAppPlatform ClientAppVersion Success Reason Impact FirstAffectedWorkflow ResourceId Dimension0 Dimension1 Dimension2 Dimension3".split(" ");var xc=v(67798),yc=v.n(xc);class dd{constructor(){this.listeners=
new Map;this.lastId=0}addListener(fe){if(!fe)throw Error("No callback provided for data listener");this.listeners.set(this.lastId,fe);return this.lastId++}removeListener(fe){this.listeners.delete(fe)}notifyListeners(fe){this.listeners.forEach(Ld=>{Ld(fe)})}}var Kc;(function(fe){fe.Add="Add";fe.Remove="Remove";fe.Set="Set";fe.Delete="Delete"})(Kc||(Kc={}));class ud{static applyECSPatchOperation(fe,Ld){let ze=!1;if("object"===typeof Ld||Array.isArray(Ld))switch(fe.operation){case Kc.Add:case Kc.Remove:ze=
ud.applyAddOrRemoveOperation(fe.path,Ld,fe.value,fe.operation);break;case Kc.Set:ze=ud.applySetOperation(fe.path,Ld,fe.value);break;case Kc.Delete:ze=ud.applyDeleteOperation(fe.path,Ld,fe.value)}ze?tb.verbose(505956121,Oc.CoreDefault,`PATCH operation succeeded for ${fe.operation} on ${fe.settingName} with path: ${fe.path}.`):tb.error(505956122,Oc.CoreDefault,`PATCH operation failed for ${fe.operation} on ${fe.settingName} with path: ${fe.path}`);return ze}static applyAddOrRemoveOperation(fe,Ld,ze,
kf){let mg=!1;try{let Wf=[];"object"!==typeof Ld||Array.isArray(Ld)?Array.isArray(Ld)&&(Wf=Ld):Wf=fe.reduce((Kf,Ci)=>Kf&&Kf[Ci],Ld);if(Array.isArray(Wf))if(kf===Kc.Add)Wf.push(ze),mg=!0;else if(kf===Kc.Remove){const Kf=Wf.indexOf(ze);0<=Kf&&(Wf.splice(Kf,1),mg=!0)}}catch(Wf){tb.info(505968832,Oc.CoreDefault,`Exception thrown while applying operation type: ${kf} for an array. Error: ${Wf}`),mg=!1}return mg}static applySetOperation(fe,Ld,ze){let kf=!1;try{const mg=fe.slice(0,-1),Wf=fe[fe.length-1];
fe={};"object"!==typeof Ld||Array.isArray(Ld)||(fe=mg.reduce((Kf,Ci)=>Kf&&Kf[Ci],Ld),"object"!==typeof fe||Array.isArray(fe)||(fe[Wf]=ze,kf=!0))}catch(mg){tb.info(505968802,Oc.CoreDefault,`Exception thrown while applying set operation. Error: ${mg}`),kf=!1}return kf}static applyDeleteOperation(fe,Ld,ze){let kf=!1;try{let mg={};"object"!==typeof Ld||Array.isArray(Ld)||(mg=fe.reduce((Wf,Kf)=>Wf&&Wf[Kf],Ld),"object"===typeof mg&&!Array.isArray(mg)&&"string"===typeof ze&&mg.hasOwnProperty(ze)&&(delete mg[ze],
kf=!0))}catch(mg){tb.info(505968801,Oc.CoreDefault,`Exception thrown while applying delete operation. Error: ${mg}`),kf=!1}return kf}}var Tc=ud;ud.parseECSOperation=(fe,Ld)=>{if(!Ld.hasOwnProperty("operationType")||!Ld.hasOwnProperty("path")||!Ld.hasOwnProperty("value"))throw Error(`Invalid format for PATCH operation on setting: ${fe}`);const ze=Tc.convertToConfigPatchOperationType(Ld.operationType.toLowerCase()),kf=Ld.path?Ld.path.split("."):[];return{settingName:fe,path:kf,operation:ze,value:Ld.value}};
ud.convertToConfigPatchOperationType=fe=>{switch(fe){case "add":return Kc.Add;case "remove":return Kc.Remove;case "set":return Kc.Set;case "delete":return Kc.Delete;default:throw Error(`Invalid operation type: ${fe}`);}};class Ed extends dd{constructor(fe){super();this.name=fe}static initEcsSettingsProvider(fe){tb.info(505999498,Oc.CoreDefault,"Initializing ECS settings provider.");Ed.ecsSettingsProvider=fe}static enableEcsPatchConfig(fe){Ed.ecsPatchConfigEnabled=fe}static getInstance(fe){let Ld=
this.allSettings.get(fe);if(!Ld){Ld=new Ed(fe);const ze=Ed.tryGetConfigProperty(Ed.currentConfig,fe);ze.success&&Ld.updateValue(ze.value);this.allSettings.set(fe,Ld)}return Ld}static getPatternInstance(fe){let Ld=this.allPatternSettings.get(fe);if(!Ld){Ld={regex:new RegExp(fe),setting:new Ed(fe)};const ze=Ed.tryGetConfigPropertyByPattern(Ed.currentConfig,Ld.regex);Ld.setting.updateValue(ze);this.allPatternSettings.set(fe,Ld)}return Ld.setting}static setNewConfig(fe){Ed.currentConfig=fe;tb.info(572837966,
Oc.CoreDefault,`New config: ${JSON.stringify(fe)}`);Ed.allSettings.forEach((Ld,ze)=>{const kf=Ed.tryGetConfigProperty(Ed.currentConfig,ze).value;Ld.updateValue(kf)&&(tb.info(572837967,Oc.CoreDefault,`Setting new value for ${ze}: ${kf instanceof Object?JSON.stringify(kf):kf}`),Ld.notifyListeners(kf))});Ed.allPatternSettings.forEach((Ld,ze)=>{const kf=Ed.tryGetConfigPropertyByPattern(fe,Ld.regex);Ld.setting.updateValue(kf)&&(tb.info(508432774,Oc.CoreDefault,`Setting new value for pattern ${ze}: ${JSON.stringify(kf)}`),
Ld.setting.notifyListeners(kf))})}static tryGetConfigProperty(fe,Ld){return fe&&fe.hasOwnProperty(Ld)?{success:!0,value:Ed.selectApplicableValue(fe[Ld])}:{success:!1,value:void 0}}static tryGetConfigPropertyByPattern(fe,Ld){const ze=[];if(fe){const kf=Object.getOwnPropertyNames(fe).filter(mg=>Ld.test(mg));for(const mg of kf)ze.push({name:mg,value:Ed.selectApplicableValue(fe[mg])})}return ze}static setGlobalFilter(fe){Ed.globalFilter=fe}static setLocalConfig(fe){Ed.localConfig=fe;tb.info(506053841,
Oc.CoreDefault,`Setting localConfig field in Setting class: ${JSON.stringify(Ed.localConfig)}`)}static clear(){Ed.currentConfig=void 0;Ed.localConfig=void 0;Ed.allSettings.clear();Ed.allPatternSettings.clear();Ed.ecsSettingsProvider=void 0}static selectApplicableValue(fe){let Ld;fe&&(fe=fe.find(ze=>!Ed.globalFilter||Ed.globalFilter(ze)))&&(Ld=fe.value);return Ld}getName(){return this.name}getValue(){var fe;if("undefined"!==typeof globalThis.process&&"true"===(null===(fe=globalThis.process.env)||void 0===
fe?void 0:fe.Bgq)&&0===this.listeners.size)throw fe=Error(`SettingInstance or ChangeGate is being used incorrectly. Make sure .getValue() or ChangeGate is called during runtime or there is a listener set up on the setting. For more info visit: ${Ed.troubleshootUrl}`),fe.name="Incorrect usage of getValue()",fe;return this.value}getValueAdvancedAsync(fe){return I(this,void 0,void 0,function*(){const Ld=(new Za({operationName:"ECSGetValueAsync"},{metricDuration:!0})).start();let ze;try{const kf=yield Ed.ecsSettingsProvider.getSettingValue(this.name,
fe);Ld.dimension0=kf.userAuthenticated?"Authenticated":"Anonymous";Ld.success=!0;let mg=kf.value;mg||(mg=Ed.tryGetConfigProperty(Ed.localConfig,this.name).value)&&kf.patchValue&&(mg=Ed.applyPatchOperationOnSetting(this.name,mg,kf.patchValue));ze=`Setting value for ${this.name} is ${JSON.stringify(mg)}.`;return mg}catch(kf){Ld.success=!1;const mg=Ed.tryGetConfigProperty(Ed.localConfig,this.name).value;ze=`Setting value for ${this.name} is ${JSON.stringify(mg)}.`;return mg}finally{tb.info(506053839,
Oc.CoreDefault,Ld.stop()),tb.info(505821320,Oc.CoreDefault,ze)}})}updateValue(fe){return yc()(this.value,fe)?!1:(tb.info(572837968,Oc.CoreDefault,`Received new property value for ${this.getName()}:`,fe),this.value=fe,!0)}static applyPatchOperationsOnConfig(fe){try{if(!Ed.ecsPatchConfigEnabled)return fe;const Ld=this.tryGetConfigProperty(fe,"patchOperations").value;if(!Ld||0===Ld.length)return fe;const ze=[];for(const [mg,Wf]of Object.entries(Ld))ze.push(ud.parseECSOperation(mg,Wf));const kf=new Map;
for(const mg of ze)if(null===fe||void 0===fe?0:fe.hasOwnProperty(mg.settingName)){const Wf=JSON.parse(JSON.stringify(fe[mg.settingName])),Kf=Ed.selectApplicableValue(Wf);ud.applyECSPatchOperation(mg,Kf)&&(kf.set(mg.settingName,Kf),fe[mg.settingName]=Wf)}0<kf.size&&tb.info(505788322,Oc.CoreDefault,`Resulting settings after PATCHes were applied: ${JSON.stringify(Object.fromEntries(kf))}`);return fe}catch(Ld){return tb.error(505788321,Oc.CoreDefault,`Exception thrown while applying ECS PATCH operations. Error: ${Ld}`),
fe}}static applyPatchOperationOnSetting(fe,Ld,ze){try{if(!Ed.ecsPatchConfigEnabled)return Ld;const kf=JSON.parse(JSON.stringify(Ld)),mg=ud.parseECSOperation(fe,ze);ud.applyECSPatchOperation(mg,kf);return kf}catch(kf){return tb.error(505788323,Oc.CoreDefault,`Exception thrown while applying ECS PATCH operation on setting. Error: ${kf}`),Ld}}}Ed.allSettings=new Map;Ed.allPatternSettings=new Map;Ed.ecsPatchConfigEnabled=!1;Ed.troubleshootUrl="https://eng.ms/docs/experiences-devices/opg/office-ai/augloop-ai-platform/augmentation-loop/documentation/server-workflow-tutorials/settings/troubleshoot";
class od extends dd{constructor(fe,Ld){super();this.listenerId=NaN;this.defaultValue=Ld;this.setting=Ed.getInstance(fe)}getDefaultValue(){return this.defaultValue}addListener(fe){Number.isNaN(this.listenerId)&&(this.listenerId=this.setting.addListener(()=>{this.notifyListeners(this.getValue())}));return super.addListener(fe)}removeListener(fe){super.removeListener(fe);0!=this.listeners.size||Number.isNaN(this.listenerId)||(this.setting.removeListener(this.listenerId),this.listenerId=NaN)}getValue(){const fe=
this.setting.getValue();return void 0===fe?this.defaultValue:fe}getValueAdvancedAsync(fe){return I(this,void 0,void 0,function*(){const Ld=yield this.setting.getValueAdvancedAsync(fe);return void 0===Ld?this.defaultValue:Ld})}}const Lc=new od("disabledChangeGates",[]),ge=(fe,Ld,...ze)=>{fe=-1===Lc.getValue().indexOf(fe);if(!Ld)return fe;if(fe)return Ld(...ze)};var pf=v(69843),Ff;(function(fe){fe[fe.ServerError=0]="ServerError";fe[fe.WorkflowDisabled=100]="WorkflowDisabled";fe[fe.TokenNotReady=101]=
"TokenNotReady";fe[fe.FlightNotReady=102]="FlightNotReady";fe[fe.ContextNotReady=103]="ContextNotReady";fe[fe.WorkflowExcluded=104]="WorkflowExcluded";fe[fe.WorkflowExecutionTimeout=105]="WorkflowExecutionTimeout";fe[fe.LambdaExecutionError=106]="LambdaExecutionError";fe[fe.UnexpectedOutput=107]="UnexpectedOutput";fe[fe.FailedToFetchInputs=108]="FailedToFetchInputs"})(Ff||(Ff={}));var kg;(function(fe){fe[fe.Unknown=0]="Unknown";fe[fe.InvalidRequest=1]="InvalidRequest";fe[fe.InvalidResponse=2]="InvalidResponse";
fe[fe.RuntimeNotInitialized=3]="RuntimeNotInitialized";fe[fe.RequestCancelled=4]="RequestCancelled";fe[fe.ResponseReceivedAfterFinalResponse=5]="ResponseReceivedAfterFinalResponse"})(kg||(kg={}));var We;(function(fe){fe[fe.Unknown=0]="Unknown";fe[fe.Found=302]="Found";fe[fe.BadRequest=400]="BadRequest";fe[fe.Unauthorized=401]="Unauthorized";fe[fe.Forbidden=403]="Forbidden";fe[fe.NotFound=404]="NotFound";fe[fe.RequestTimeout=408]="RequestTimeout";fe[fe.Conflict=409]="Conflict";fe[fe.Gone=410]="Gone";
fe[fe.RequestEntityTooLarge=413]="RequestEntityTooLarge";fe[fe.UnsupportedMediaType=415]="UnsupportedMediaType";fe[fe.UnprocessableContent=422]="UnprocessableContent";fe[fe.TooManyRequests=429]="TooManyRequests";fe[fe.SocketDisconnect=499]="SocketDisconnect";fe[fe.InternalServerError=500]="InternalServerError";fe[fe.ServiceUnavailable=503]="ServiceUnavailable";fe[fe.GatewayTimeout=504]="GatewayTimeout";fe[fe.UnsupportedMessage=1E3]="UnsupportedMessage";fe[fe.Cancelled=1001]="Cancelled";fe[fe.EgressError=
1002]="EgressError";fe[fe.SyncMessageException=2E3]="SyncMessageException";fe[fe.SyncMessageUnsupported=2001]="SyncMessageUnsupported";fe[fe.SyncMessageUnexpectedSeed=2002]="SyncMessageUnexpectedSeed";fe[fe.SyncMessageUnsupportedBatch=2003]="SyncMessageUnsupportedBatch";fe[fe.SyncMessageQueueFull=2004]="SyncMessageQueueFull";fe[fe.SyncMessageTooLateOrDuplicate=2005]="SyncMessageTooLateOrDuplicate";fe[fe.SyncMessageGroupIdMismatch=2006]="SyncMessageGroupIdMismatch";fe[fe.SyncMessageGroupStop=2007]=
"SyncMessageGroupStop";fe[fe.SyncMessageLost=2008]="SyncMessageLost";fe[fe.SyncMessageUnprocessedDuplicate=2009]="SyncMessageUnprocessedDuplicate";fe[fe.SyncMessageSessionClosed=2010]="SyncMessageSessionClosed";fe[fe.SyncMessageAbandoned=2011]="SyncMessageAbandoned";fe[fe.SyncMessageTooManyDeltaOperations=2012]="SyncMessageTooManyDeltaOperations";fe[fe.SyncMessageSessionSizeLimitExceeded=2013]="SyncMessageSessionSizeLimitExceeded";fe[fe.TokenValidationError=2100]="TokenValidationError";fe[fe.TokenDecryptError=
2101]="TokenDecryptError";fe[fe.TokenTypeError=2102]="TokenTypeError";fe[fe.TokenUserBlocked=2103]="TokenUserBlocked";fe[fe.AnnotationActivationInvalidType=2200]="AnnotationActivationInvalidType";fe[fe.AnnotationReleaseTokenNotFound=2300]="AnnotationReleaseTokenNotFound"})(We||(We={}));var zf;(function(fe){fe[fe.UnKnown=0]="UnKnown";fe[fe.Start=1]="Start";fe[fe.Regular=2]="Regular";fe[fe.CheckConnection=3]="CheckConnection";fe[fe.PostEgress=4]="PostEgress";fe[fe.TimeoutResend=5]="TimeoutResend";fe[fe.FailResend=
6]="FailResend"})(zf||(zf={}));var Wi;(function(fe){fe[fe.IdentityChange=0]="IdentityChange"})(Wi||(Wi={}));var Zf;(function(fe){fe[fe.Idle=0]="Idle";fe[fe.Pending=1]="Pending"})(Zf||(Zf={}));var Me;(function(fe){fe[fe.NotStarted=0]="NotStarted";fe[fe.Started=1]="Started";fe[fe.Incomplete=2]="Incomplete";fe[fe.Finished=3]="Finished"})(Me||(Me={}));var Ub=v(61274);class Wb{constructor(fe){this.cache=new Map;this.options=fe||{sweepInterval:100};if(void 0!=this.options.idleDurationMs&&0>=this.options.idleDurationMs)throw Error("Idle duration must be positive");
this.interval=this.options.sweepInterval||100;if(0>=this.interval)throw Error("Sweep interval must be a positive number");}static setLogIntervalError(fe){Wb.logIntervalError=fe}put(fe,Ld,ze,kf,mg,Wf,Kf){if(void 0===ze||null===ze||0>=ze)throw Error("Cache timeout must be a positive number");if(void 0===mg||null===mg||0>=mg)mg=this.options.idleDurationMs;ze={value:Ld,Ibj:mg?Date.now():void 0,WEf:ze+Date.now(),idleDurationMs:mg,m7d:kf,Nem:Wf+Date.now(),XEf:Kf};this.cache.set(fe,ze);this.timeout||(this.timeout=
setInterval(this.onInterval.bind(this),this.interval),this.timeout.UPp&&this.timeout.UPp());return Ld}del(fe){if(this.options.delCallback){const Ld=this.cache.get(fe);Ld&&this.options.delCallback(fe,Ld.value)}fe=this.cache.delete(fe);0===this.size()&&this.clear();return fe}clear(){this.timeout&&(clearInterval(this.timeout),this.timeout=void 0);this.cache.clear()}get(fe){let Ld=this.cache.get(fe);if(Ld)return this.options.idleDurationMs&&(Ld.Ibj=Date.now()),Ld.WEf<Date.now()&&(this.del(fe),Ld.m7d&&
Ld.m7d(fe,Ld.value),Ld=this.cache.get(fe),!Ld)?void 0:Ld.value}keys(){return this.cache.keys()}forEach(fe){this.cache.forEach((Ld,ze)=>{fe(Ld.value,ze)})}size(){return this.cache.size}updateExpireTime(fe,Ld){return this.cache.has(fe)&&0<=Ld?(this.cache.get(fe).WEf=Ld+Date.now(),!0):!1}onInterval(){const fe=Date.now();this.cache.forEach((Ld,ze)=>{try{Ld.idleDurationMs&&Ld.Ibj<fe-Ld.idleDurationMs?(this.del(ze),this.options.idleCallback&&this.options.idleCallback(ze,Ld.value)):(Ld.WEf<fe&&(this.del(ze),
Ld.m7d&&Ld.m7d(ze,Ld.value)),Ld.Nem<fe&&Ld.XEf&&(Ld.XEf(ze,Ld.value),Ld.XEf=void 0))}catch(kf){Wb.logIntervalError&&Wb.logIntervalError(kf)}})}}var kd;(function(fe){fe.ClientDisconnected="Client disconnected.";fe.ClientClosed="Client closed";fe.UnsupportedSyncMessage="SyncMessages with seq = -1 are not supported anymore.";fe.UnexpectedSeedMessage="Unexpected seed message";fe.SyncMessageUnsupportedBatch="SyncMessage with unsupported batching.";fe.AnnotationTokenNotFound="Token not found";fe.TooManyDeltaOperations=
"SyncMessage with too many delta operations";fe.UnsupportedSyncMessageSeq0NonSeeding="SyncMessages with seq 0 are not supported in non seeding sequencer (SenderId)."})(kd||(kd={}));var Dd;(function(fe){fe.ProvisionTokenValidationError="Token provision message didn't pass token validation.";fe.ProvisionTokenDecryptAndTransformError="Token provision message didn't pass token decrypt and transform."})(Dd||(Dd={}));class Be{constructor(fe){this.config=fe;this.nextMessageId=1;this.pendingResponseCallbacks=
new Wb({sweepInterval:5E3});this.messageCallbacks=new Map;this.messageIdPrefix=fe.messageIdPrefix;this.source="c"===fe.messageIdPrefix?Oe.ClientRuntime:Oe.Core;this.stats={sendMessageCount:0,sendMessageClientDisconnectedErrors:0,sendMessageErrors:0,sendMessageDurationMsMax:0,processMessageCount:0,processMessageProvisionTokenErrors:0,processMessageErrors:0,processMessageDurationMsMax:0}}setClientMetadata(fe){this.clientMetadata=fe}setEgress(fe){this.egress=fe;this.config.resendPendingMessagesOnReconnect&&
this.egress&&this.pendingResponseCallbacks.forEach(Ld=>{Ld.logOp.dimension1=(Ld.B9o++).toString();this.egress(Ld.message,ze=>this.onEgressError(ze,Ld))})}ingress(fe,Ld){Ub.p.typeGuard(fe)?(this.processResponse(fe),Ld()):this.processMessage(fe,Ld);Ub.s.typeGuard(fe)&&!fe.reconnectAllowed&&this.clearAllPendingResponses()}sendMessage(fe,Ld,ze,kf=0){var mg,Wf;const Kf=(new Gc({sessionHealthEventName:"SendMessage",source:this.source,reason:Re.Client,impact:this.source===Oe.ClientRuntime?sd.MissingInput:
sd.MissingOutput,success:!0,message:"",affectedWorkflows:["All"],cv:fe.cv,resourceId:M(pf.a.getTypeNameFor(fe)),dimension0:kf.toString()})).start(),Ci=()=>{Kf.setClientMetadata(this.clientMetadata);Kf.success?tb.info(572836E3,Oc.CoreDefault,Kf.stop()):(Kf.message=JSON.stringify({Sxq:"ErrorWithoutPendingResponse"===Kf.resultSignature||"ResponseCallbackException"===Kf.resultSignature||"We called into done callback"!==Kf.message}),tb.error(572836001,Oc.CoreDefault,Kf.stop()))};ge("PersistMessageId")?
fe.messageId=null!==(mg=fe.messageId)&&void 0!==mg?mg:`${this.messageIdPrefix}${this.nextMessageId++}`:fe.messageId=`${this.messageIdPrefix}${this.nextMessageId++}`;Ub.h.typeGuard(fe)&&fe.messages.forEach((di,rj)=>di.messageId=fe.messageId+"."+rj);mg=pf.a.getTypeNameFor(fe)===Ub.s.getTypeName();const cj={message:fe,logOp:Kf,logEvent:Ci,callback:void 0,B9o:1};ze||mg||(cj.callback=(di,rj)=>{var bn;di?ge("IgnoreUnsupportedMessageErrorForOldClientVersion")&&di.code===We.UnsupportedMessage?(Kf.resultSignature=
"Success",Kf.resultDescription=`Ignore error for ${pf.a.getTypeNameFor(fe)} message ${fe.messageId}${Ub.E.typeGuard(fe)?`, seq ${fe.seq}`:""}: ${di.error}`):(Kf.success=!1,Kf.resultSignature=di.error,Kf.resultDescription=`Error for ${pf.a.getTypeNameFor(fe)} message ${fe.messageId}${Ub.E.typeGuard(fe)?`, seq ${fe.seq}`:""}: ${di.error}`):Kf.resultSignature="Success";if(Ld)try{Kf.message="We called into done callback",Ld(di,rj)}catch(lo){Kf.success=!1,Kf.resultSignature="ResponseCallbackException",
Kf.resultDescription="Web"===(null===(bn=this.clientMetadata)||void 0===bn?void 0:bn.appPlatform)?JSON.stringify({message:lo.message,stack:lo.stack}):JSON.stringify({message:lo.message})}Ci();this.updateSendMessageStats(Kf.success,Kf.durationMs,di?Error(di.error):void 0)},ze=this.config.responseTimeoutMs,Ub.y.typeGuard(fe)?ze=15E3<=fe.longPollTimeoutHint&&3E5>=fe.longPollTimeoutHint?fe.longPollTimeoutHint+5E3:12E4:Ub.B.typeGuard(fe)&&(ze=null!==(Wf=fe.maxDelayMs)&&void 0!==Wf?Wf:12E4),this.pendingResponseCallbacks.put(fe.messageId,
cj,ze,()=>{cj.callback(new Ub.G({code:We.RequestTimeout,error:"Timeout waiting for response"}),void 0)}));this.egress&&this.egress(fe,di=>this.onEgressError(di,cj),kf)}onEgressError(fe,Ld){var ze,kf;if(fe){const mg=Ld.message,Wf=this.pendingResponseCallbacks.get(Ld.message.messageId);Wf?(this.pendingResponseCallbacks.del(mg.messageId),Wf.callback(new Ub.l({messageId:mg.messageId,code:We.EgressError,error:fe.message}))):(Ub.s.typeGuard(mg)?(Ld.logOp.success=null!==(kf=null===(ze=fe.message)||void 0===
ze?void 0:ze.endsWith("Client disconnected."))&&void 0!==kf?kf:!1,Ld.logOp.resultSignature="ErrorSendingSessionCloseMessage"):(Ld.logOp.success=!1,Ld.logOp.resultSignature="ErrorWithoutPendingResponse"),Ld.logOp.resultDescription=`Error for ${pf.a.getTypeNameFor(mg)} message ${mg.messageId}: ${fe.message}`,Ld.logEvent())}}queryEgressCacheSize(){return this.pendingResponseCallbacks.size()}onMessage(fe,Ld){this.messageCallbacks.set(fe,Ld)}onMessageAsync(fe,Ld){this.messageCallbacks.set(fe,(ze,kf)=>
H(this,void 0,void 0,function*(){try{const mg=yield Ld(ze);Ub.l.typeGuard(mg)?kf(mg,void 0):kf(void 0,mg)}catch(mg){kf(mg)}}))}getStats(){return this.stats}hasMessageCallback(fe){return this.messageCallbacks.has(fe)}cancelPendingResponseCallbacks(fe){this.pendingResponseCallbacks.forEach((Ld,ze)=>{Ld&&(this.pendingResponseCallbacks.del(ze),Ld.callback(new Ub.l({messageId:ze,code:We.Cancelled,error:`Cancelled. Reason: ${fe}`})))})}clearAllPendingResponses(){if(0!=this.pendingResponseCallbacks.size()){var fe=
new Za({operationName:"PurgePendingResponses",resultDescription:this.pendingResponseCallbacks.size().toString(),success:!0});tb.info(572836002,Oc.CoreDefault,fe);this.pendingResponseCallbacks.clear()}}processMessage(fe,Ld){const ze=(new Gc({sessionHealthEventName:"ProcessMessage",source:this.source,reason:Re.Client,impact:this.source===Oe.ClientRuntime?sd.MissingOutput:sd.MissingInput,success:!0,message:"",affectedWorkflows:["All"],cv:fe.cv})).start(),kf=()=>{ze.setClientMetadata(this.clientMetadata);
ze.success?tb.info(572836003,Oc.CoreDefault,ze.stop()):(ze.message=JSON.stringify({Pxq:"UnsupportedMessage"===ze.resourceId||"Timeout"===ze.resultSignature||"OnResponseInvokedMoreThanOnce"===ze.resultSignature||"MessageCallbackException"===ze.resultSignature||"We called into messageCallback"!==ze.message}),tb.error(572836032,Oc.CoreDefault,ze.stop()))};let mg=this.messageCallbacks.get(pf.a.getTypeNameFor(fe));mg?ze.resourceId=M(pf.a.getTypeNameFor(fe)):mg=(Ci,cj)=>{ze.resourceId=M(pf.a.getTypeNameFor(Ci));
"MalformedMessageName"!==ze.resourceId&&(ze.resourceId="UnsupportedMessage");cj(new Ub.l({messageId:Ci.messageId,code:We.UnsupportedMessage,error:`Message type ${pf.a.getTypeNameFor(Ci)} is not supported`}))};let Wf=!1;const Kf=(Ci,cj)=>{Wf?(ze.success=!1,ze.resultSignature="OnResponseInvokedMoreThanOnce",ze.resultDescription=`Invoked onResponse for ${pf.a.getTypeNameFor(fe)} message ${fe.messageId} more than once`):Ci?(ze.success=!1,ze.resultSignature=Ci.error,void 0!==Ci.code&&(ze.dimension0=We[Ci.code]),
ze.resultDescription=`Error for ${pf.a.getTypeNameFor(fe)} message ${fe.messageId}: ${Ci.error}`):ze.resultSignature="Success";Wf=!0;kf();Ci&&!pf.a.matchesTypesFor(Ci,[Ub.l.getTypeName()])&&(Ci=new Ub.l({error:"Internal Server Error"}));this.updateProcessMessageStats(ze.success,ze.durationMs,Ci?Error(Ci.error):void 0);Ci?(Ci.messageId=fe.messageId,Ld(Ci)):cj?(cj.messageId=fe.messageId,Ld(void 0,cj)):Ld()};try{ze.message="We called into messageCallback",mg(fe,Kf)}catch(Ci){ze.success=!1,ze.resultSignature=
"MessageCallbackException",ze.resultDescription=JSON.stringify({message:Ci.message,stack:Ci.stack}),kf(),this.updateProcessMessageStats(!1,ze.durationMs,Ci),Ld()}}processResponse(fe){var Ld;const ze=new Za({operationName:"ProcessResponse"});ze.success=!0;ze.setClientMetadata(this.clientMetadata);ze.start();if(fe.messageId){const kf=this.pendingResponseCallbacks.get(fe.messageId),mg=null===kf||void 0===kf?void 0:kf.callback;mg?(Ub.C.typeGuard(fe)&&!fe.finalResponse?this.pendingResponseCallbacks.updateExpireTime(fe.messageId,
kf.message.maxDelayMs):this.pendingResponseCallbacks.del(fe.messageId),pf.a.matchesTypesFor(fe,[Ub.l.getTypeName()])?mg(fe):mg(void 0,fe)):(ze.resultSignature="NoPendingMessage",ze.resultDescription=`${fe.messageId}`,ze.success=!1)}else ze.resultSignature="NoMessageIdSetInResponse",Ub.l.typeGuard(fe)?ze.resultDescription=fe.error:ze.resultDescription="MessageId is not available",ze.success=!1;"Production"!==(null===(Ld=this.clientMetadata)||void 0===Ld?void 0:Ld.releaseAudienceGroup)&&(ze.resourceId=
M(pf.a.getTypeNameFor(fe)),tb.info(572836034,Oc.CoreDefault,ze.stop()))}updateSendMessageStats(fe,Ld,ze){this.stats.sendMessageCount++;this.stats.sendMessageDurationMsMax=Math.max(Ld,this.stats.sendMessageDurationMsMax);fe||ze?fe&&ze&&tb.warn(572836036,Oc.CoreDefault,"Succeeded send message provided error object."):tb.warn(572836035,Oc.CoreDefault,"Failed send message did not provide error object.");fe||(ze&&ze.message===kd.ClientDisconnected?this.stats.sendMessageClientDisconnectedErrors++:this.stats.sendMessageErrors++)}updateProcessMessageStats(fe,
Ld,ze){this.stats.processMessageCount++;this.stats.processMessageDurationMsMax=Math.max(Ld,this.stats.processMessageDurationMsMax);fe||ze?fe&&ze&&tb.warn(572836038,Oc.CoreDefault,"Succeeded process message provided error object."):tb.warn(572836037,Oc.CoreDefault,"Failed process message did not provide error object.");fe||(ze&&ze.message===Dd.ProvisionTokenValidationError?this.stats.processMessageProvisionTokenErrors++:this.stats.processMessageErrors++)}}var Mf=v(74434),re;(function(fe){fe[fe.Undefined=
0]="Undefined";fe[fe.Schema=1]="Schema";fe[fe.Boolean=2]="Boolean";fe[fe.Number=3]="Number";fe[fe.String=4]="String";fe[fe.Buffer=5]="Buffer";fe[fe.Function=6]="Function"})(re||(re={}));var yg=v(71756),ii=v(99919),Ai=v(99216);class uc{static createHealthCheckRequest(fe){return{payload:{},payloadSchema:{category:re.Schema,schema:{name:"HealthCheckRequest"}},requestedSchema:{category:re.Schema,schema:{name:"HealthCheckResponse"}},clientMetadata:fe}}static isFeatureEnabled(fe,Ld,ze=!1,kf="None"){return fe&&
fe.isFeatureEnabled?fe.isFeatureEnabled("Microsoft.Office.AugLoop."+Ld,kf).catch(()=>Promise.resolve(ze)):Promise.resolve(ze)}static isChangeGateEnabled(fe,Ld){return fe&&fe.isChangeGateEnabled?fe.isChangeGateEnabled(Ld):Promise.resolve(!1)}static convertWebSocketUrlToHttp(fe){return this.convertUrl(fe,!1)}static convertServiceUrlToWebSocket(fe){return this.convertUrl(fe,!0)}static convertUrl(fe,Ld){if(!fe)return fe;const ze=fe.split(":");let kf=ze[0].toLowerCase();return 0==kf.indexOf(Ld?"http":
"ws")?(kf=Ld?kf.replace("http","ws"):kf.replace("ws","http"),ze[0]=kf,ze.join(":")):fe}static deepEquals(fe,Ld){return yc()(fe,Ld)}static collectTelemetry(fe,Ld,ze,kf,mg,Wf){var Kf,Ci,cj,di;fe.start();fe.resultSignature=null!==kf&&void 0!==kf?kf:"";fe.resultDescription=null!==mg&&void 0!==mg?mg:"";fe.success=ze;Wf?(fe.dimension0=null!==(Kf=Wf[0])&&void 0!==Kf?Kf:"",fe.dimension1=null!==(Ci=Wf[1])&&void 0!==Ci?Ci:"",fe.dimension2=null!==(cj=Wf[2])&&void 0!==cj?cj:"",fe.dimension3=null!==(di=Wf[3])&&
void 0!==di?di:""):(fe.dimension0="",fe.dimension1="",fe.dimension2="",fe.dimension3="");Ld.log(()=>tb.info(508367457,Oc.CoreDefault,fe.stop()))}}uc.getCurrentTimeMs=()=>Date.now?Date.now():(new Date).getTime();class Xc{constructor(fe){this.maxNumberOfLogs=40;this.numberOfLogs=0;this.id=fe}log(fe){this.numberOfLogs<this.maxNumberOfLogs&&(this.numberOfLogs++,fe(),this.numberOfLogs===this.maxNumberOfLogs&&(fe=new Za({operationName:"OnLastLog",success:!0,resourceId:this.id,resultDescription:`Limit for number of logs for id: ${this.id} reached - all next logs will be dropped`}),
tb.warn(572838107,Oc.CoreDefault,fe)))}}const Bd=[pf.a.getTypeName(),yg.a.getTypeName(),ii.c.getTypeName()],ae=fe=>{const Ld=new Set;for(const ze of fe)if("string"===typeof ze)-1===Bd.indexOf(ze)&&Ld.add(ze);else for(const kf of[ze.getTypeName(),...ze.getBaseTypes()])-1===Bd.indexOf(kf)&&Ld.add(kf);return Array.from(Ld)},qe=(fe,Ld=0)=>Number.isFinite(fe)?fe:Ld;var tf=v(46350),ng=v.n(tf),$f;(function(fe){fe.ArrivedBeforeReseeding="Message is dropped from queue since it arrived before reseeding is started";
fe.DroppedAsOldestInQueue="Message is dropped as oldest in full queue";fe.DroppedBecauseClientDisconnected="Message is dropped because client is disconnected from server"})($f||($f={}));class bj{constructor(fe){this.logOp=new Za({operationName:"MessageQueue",success:!0});this.queue=new (ng())(1E3);this.callbacks=fe}clear(){this.queue.clear()}size(){return this.queue.length}push(fe,Ld,ze){const kf=this.queue;if(1E3===kf.length){this.logOp.resourceId="QueueFull";this.logOp.durationMs=0;this.logOp.success=
!1;tb.warn(508843746,Oc.CoreDefault,this.logOp);const mg=kf.shift();if(mg.onResponse)mg.onResponse(new Ub.l({error:$f.DroppedAsOldestInQueue}))}kf.push({message:fe,onResponse:Ld,YHp:uc.getCurrentTimeMs(),wll:ze})}sendOnSessionInitialized(fe){const Ld=this.queue.length;let ze=0;if(0<Ld){const kf=uc.getCurrentTimeMs()-this.queue.get(0).YHp;for(;0<this.queue.length&&this.callbacks.canSendMessage();){const mg=this.queue.shift();if(fe&&this.containSequencedSyncMessage(mg)){if(ze++,mg.onResponse)mg.onResponse(new Ub.l({error:$f.ArrivedBeforeReseeding}))}else mg.message instanceof
Uint8Array?this.callbacks.sendBytes(mg.message):this.callbacks.sendMessage(mg.message,mg.onResponse,mg.wll)}this.logOp.resourceId="SendOnSessionInitialized";this.logOp.resultDescription=`Queue size before: ${Ld}, after: ${this.queue.length}. droppedSyncMessages: ${ze}`;this.logOp.durationMs=kf;this.logOp.success=!0;tb.warn(508843745,Oc.CoreDefault,this.logOp)}}containSequencedSyncMessage(fe){return fe.message instanceof Ub.E&&pf.a.matchesTypesFor(fe.message,[Ub.E.getTypeName()])&&0<=fe.message.seq||
fe.message instanceof Ub.h&&pf.a.matchesTypesFor(fe.message,[Ub.h.getTypeName()])}}var Yi;(function(fe){fe[fe.Initing=0]="Initing";fe[fe.Running=1]="Running";fe[fe.Disconnected=2]="Disconnected";fe[fe.Closed=3]="Closed"})(Yi||(Yi={}));const hh=(fe,Ld,ze,kf)=>{Ld&&(Ld.cv||(Ld.cv=fe.cvParent.newChild().toString()),fe.messageEndpoint.sendMessage(Ld,(mg,Wf)=>{mg||pf.a.getTypeNameFor(Wf)!==Ub.F.getTypeName()||(fe.stats.lastSyncMessage=Date.now());ze&&ze(mg,Wf)},void 0,kf))},kh=(fe,Ld,ze,kf)=>{Ld&&(fe.messageQueue.push(Ld,
ze,kf),fe.networkWorkerManager.init(void 0,fe.customInitPromise).catch(mg=>{mg=new Za({operationName:"WorkerManagerInit",success:!1,resultDescription:`${mg}`});tb.error(508843789,Oc.CoreDefault,mg)}))},im=(fe,Ld)=>{Ld&&(fe.messageQueue.push(Ld),fe.networkWorkerManager.init(void 0,fe.customInitPromise).catch(ze=>{tb.error(508843788,Oc.CoreDefault,`Init failed: ${ze}`)}))};class eg{constructor(fe){this.context=fe}onEnter(){}sendMessage(){}sendBytes(){}canSendMessage(){return!1}onConnectionClose(){}}
class Zi extends eg{constructor(){super(...arguments);this.stateName=Yi.Initing;this.possibleNextStates=[Yi.Running,Yi.Disconnected,Yi.Closed]}sendMessage(fe,Ld,ze){pf.a.matchesTypesFor(fe,[Ub.w.getTypeName()])?hh(this.context,fe,Ld,ze):kh(this.context,fe,Ld)}sendBytes(fe){im(this.context,fe)}onConnectionClose(){this.context.setState(Yi.Disconnected)}}class jc extends eg{constructor(){super(...arguments);this.stateName=Yi.Running;this.possibleNextStates=[Yi.Disconnected,Yi.Closed]}onEnter(fe){fe&&
fe.isSessionReseedingStarted&&this.context.resetNextSyncSequenceId();this.context.messageQueue.sendOnSessionInitialized(fe&&fe.isSessionReseedingStarted)}sendMessage(fe,Ld,ze){hh(this.context,fe,Ld,ze)}sendBytes(fe){fe&&this.context.networkWorkerManager.egressBytes(fe)}canSendMessage(){return!0}onConnectionClose(){this.context.setState(Yi.Disconnected)}}class Nb extends eg{constructor(){super(...arguments);this.stateName=Yi.Disconnected;this.possibleNextStates=[Yi.Initing,Yi.Closed]}onEnter(){this.context.messageEndpoint.cancelPendingResponseCallbacks(kd.ClientDisconnected)}sendMessage(fe,
Ld,ze,kf){pf.a.matchesTypesFor(fe,[Ub.w.getTypeName()])?(this.context.setState(Yi.Initing),hh(this.context,fe,Ld,ze)):pf.a.matchesTypesFor(fe,[Ub.s.getTypeName()])?this.context.setState(Yi.Closed):kf?Ld&&Ld(new Ub.l({messageId:fe.messageId,error:$f.DroppedBecauseClientDisconnected})):kh(this.context,fe,Ld,ze)}sendBytes(fe){im(this.context,fe)}}class bb extends eg{constructor(){super(...arguments);this.stateName=Yi.Closed;this.possibleNextStates=[]}onEnter(){this.context.messageEndpoint.cancelPendingResponseCallbacks(kd.ClientClosed)}}
const {AugLoopTextEncoder:Hg,AugLoopTextDecoder:Tf}=(()=>{if("undefined"===typeof TextEncoder||"undefined"===typeof TextDecoder){v(86227);const fe={AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder};TextDecoder=TextEncoder=void 0;return fe}return{AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder}})();var rg=v(88036).a;class ol{static extractFragments(fe){if(fe[0]!==ol.IDENTIFIERBYTE)throw Error("Invalid Binary: Incorrect Identifier");let Ld=1;const ze=[],kf=new DataView(fe.buffer,
fe.byteOffset,fe.byteLength);for(;Ld<fe.byteLength;){if(Ld+4>fe.byteLength)throw Error("Invalid Binary: Error reading fragment length");const mg=kf.getUint32(Ld);if(Ld+mg+4>fe.byteLength)throw Error("Invalid Binary: Fragment out of range");"undefined"!==typeof rg&&rg.from?ze.push(rg.from(fe.buffer,fe.byteOffset+Ld+4,mg)):ze.push(new Uint8Array(fe.buffer,fe.byteOffset+Ld+4,mg));Ld+=4+mg}if(1>ze.length)throw Error("Invalid Binary: No fragments found");return ze}static deserialize(fe,Ld=ze=>ze){const ze=
ol.extractFragments(fe);fe=ol.textDecoder.decode(ze[0]);return JSON.parse(fe,(kf,mg)=>{if("string"===typeof mg){if(mg.substring(0,ol.BINARYKEYWORD.length)===ol.BINARYKEYWORD){kf=parseInt(mg.substring(ol.BINARYKEYWORD.length),10);if("number"!==typeof kf||kf>=ze.length-1)throw Error("Invalid Binary: Binary index out of range");return Ld(ze[kf+1])}if(mg.substring(0,ol.ESCAPEKEYWORD.length)===ol.ESCAPEKEYWORD)return mg.substring(ol.ESCAPEKEYWORD.length)}return mg})}static deserializeAsync(fe,Ld=ze=>G(this,
void 0,void 0,function*(){return ze})){return G(this,void 0,void 0,function*(){const ze=ol.extractFragments(fe);var kf=ol.textDecoder.decode(ze[0]);const mg=[],Wf=cj=>{const di={[Kf]:!0,value:void 0};cj.then(rj=>{di.value=rj});return di},Kf=Symbol("placeholder"),Ci=cj=>{if(Array.isArray(cj))for(var di=0;di<cj.length;di++)cj[di]=Ci(cj[di]);else if(null!==cj&&"object"===typeof cj){if(cj[Kf])return cj.value;for(di of Object.keys(cj))cj[di]=Ci(cj[di])}return cj};kf=JSON.parse(kf,(cj,di)=>{if("string"===
typeof di){if(di.startsWith(ol.BINARYKEYWORD)){cj=parseInt(di.substring(ol.BINARYKEYWORD.length),10);if("number"!==typeof cj||cj>=ze.length-1)throw Error("Invalid Binary: Binary index out of range");cj=Ld(ze[cj+1]);mg.push(cj);return Wf(cj)}if(di.startsWith(ol.ESCAPEKEYWORD))return di.substring(ol.ESCAPEKEYWORD.length)}return di});yield Promise.all(mg);return kf=yield Ci(kf)})}static serializeInternal(fe){const Ld=[void 0];fe=JSON.stringify(fe,(mg,Wf)=>ArrayBuffer.isView(Wf)?(Ld.push(Wf),`${ol.BINARYKEYWORD}${Ld.length-
2}`):Wf&&"Buffer"===Wf.type&&Array.isArray(Wf.data)?(Ld.push(new Uint8Array(Wf.data)),`${ol.BINARYKEYWORD}${Ld.length-2}`):"string"===typeof Wf&&Wf.substring(0,ol.ESCAPEKEYWORD.length)===ol.ESCAPEKEYWORD?ol.ESCAPEKEYWORD+Wf:Wf);Ld[0]=ol.textEncoder.encode(fe);fe=Ld.reduce((mg,Wf)=>mg+4+Wf.byteLength,0);fe=new Uint8Array(fe+1);fe[0]=ol.IDENTIFIERBYTE;let ze=1;const kf=new DataView(fe.buffer,fe.byteOffset,fe.byteLength);for(const mg of Ld)kf.setUint32(ze,mg.byteLength),fe.set(mg,ze+4),ze+=4+mg.byteLength;
return fe}static serialize(fe){return ol.serializeInternal(fe)}static serializeAsync(fe){return G(this,void 0,void 0,function*(){return new Promise((Ld,ze)=>{try{Ld(ol.serializeInternal(fe))}catch(kf){ze(kf)}})})}}ol.IDENTIFIERBYTE=3;ol.BINARYKEYWORD=":b";ol.ESCAPEKEYWORD=":";ol.textDecoder=new Tf;ol.textEncoder=new Hg;class $l{constructor(fe,Ld,ze){this.requestInProgress=!1;this.queuedRequests=[];if(null==fe)throw Error("No request.");this.fetch=fe;this.fetchTimeout=Ld;this.queueTimeout=ze}tryProcessNextRequest(){this.requestInProgress=
!1;if(0<this.queuedRequests.length){const [fe,Ld,ze]=this.queuedRequests.shift();clearTimeout(ze);this.add(fe,Ld)}}add(fe,Ld){if(this.requestInProgress){const ze=setTimeout(()=>{Ld(Error("Timed out waiting in queue"),null);this.queuedRequests.shift()},this.queueTimeout);this.queuedRequests.push([fe,Ld,ze])}else this.requestInProgress=!0,(new Promise((ze,kf)=>{let mg=!1;const Wf=setTimeout(()=>{mg=!0;kf(Error("Fetch timed out"))},this.fetchTimeout);this.fetch(fe).then(Kf=>{mg||(clearTimeout(Wf),ze(Kf))}).catch(Kf=>
{mg||(clearTimeout(Wf),kf(Kf))})})).then(ze=>{Ld(null,ze);this.tryProcessNextRequest()}).catch(ze=>{Ld(ze,null);this.tryProcessNextRequest()})}}var ih=v(95474);const zj=new $l(ih.fetch,2E4,12E4);class lg{constructor(fe,Ld,ze,kf){this.lastEgressTime=this.lastPongTime=this.lastPingTime=0;this.remainingPingFailures=3;this.isPingPongSuccessful=!1;this.reducedPingPongRetryEnabled=kf;this.pingPongLogOp=(new Za({operationName:"WebSocketReliabilityManager",success:!0,resourceId:this.reducedPingPongRetryEnabled?
"reducedPingPongRetryEnabled":""})).start();this.pingPongLogOp.setClientMetadata(ze,!0);this.worker=fe;this.rateControllerClose=Ld}start(){this.reducedPingPongRetryEnabled?(this.pingPongLogOp.start(),this.pingPongLogOp.resultSignature="initial ping"):this.logOperation(!0,"ping","initial ping");this.ping();this.isPingPongSuccessful=!0;this.startInterval()}onResponse(){this.lastPongTime=Date.now();this.reducedPingPongRetryEnabled&&(this.pingPongLogOp.success=!0,tb.info(506795283,Oc.CoreDefault,this.pingPongLogOp.stop()))}isReliabilityResponse(fe){return"string"===
typeof fe&&1===fe.length&&fe===lg.pingPongMessage}close(){this.reducedPingPongRetryEnabled?(this.pingPongLogOp.start(),this.pingPongLogOp.success=!0,this.pingPongLogOp.resultSignature="close",tb.info(506795282,Oc.CoreDefault,this.pingPongLogOp.stop())):this.logOperation(!0,"ping","close");this.lastPongTime=this.lastPingTime=0;this.isPingPongSuccessful=!1;this.clearPingInterval();this.worker=void 0}checkConnection(){return this.isPingPongSuccessful}postEgress(){this.lastEgressTime=Date.now()}needsParsedResponses(){return!1}ping(){this.reducedPingPongRetryEnabled?
this.worker||(this.pingPongLogOp.success=!1,this.pingPongLogOp.resultDescription="websocket worker undefined",this.rateControllerClose(),tb.info(506795281,Oc.CoreDefault,this.pingPongLogOp.stop())):this.lastPingTime=Date.now();this.worker&&(this.reducedPingPongRetryEnabled&&(this.lastPingTime=Date.now()),this.worker.egress({obj:lg.pingPongMessage}))}startInterval(){this.pingInterval=setInterval(()=>{if(this.reducedPingPongRetryEnabled)this.lastPongTime<this.lastPingTime&&3E4>Date.now()-this.lastPingTime||
(this.isPingPongSuccessful=this.lastPongTime>=this.lastPingTime,this.pingPongLogOp.start(),this.isPingPongSuccessful?(this.pingPongLogOp.resultSignature="ping",this.ping()):(this.pingPongLogOp.success=!1,this.pingPongLogOp.resultDescription="Pong not received",tb.info(506795280,Oc.CoreDefault,this.pingPongLogOp.stop()),this.worker?this.worker.close():this.rateControllerClose()));else if(this.isPingPongSuccessful=this.lastPongTime>=this.lastPingTime&&3E4>=this.lastPongTime-this.lastPingTime,!(this.lastPongTime>
this.lastEgressTime)){var fe=this.lastPongTime-this.lastPingTime;this.isPingPongSuccessful?(this.remainingPingFailures=3,this.ping()):0<this.remainingPingFailures?(--this.remainingPingFailures,this.ping()):(this.logOperation(!1,"ping","Pong still not received after all retry attempts",[`${fe}`,`${this.remainingPingFailures}`]),this.worker?this.worker.close():this.rateControllerClose())}},3E4)}clearPingInterval(){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=void 0)}logOperation(fe,
Ld,ze,kf){var mg,Wf,Kf,Ci;this.pingPongLogOp.start();this.pingPongLogOp.success=fe;this.pingPongLogOp.resultSignature=Ld;this.pingPongLogOp.resultDescription=ze;kf&&(this.pingPongLogOp.dimension0=null!==(mg=kf[0])&&void 0!==mg?mg:"",this.pingPongLogOp.dimension1=null!==(Wf=kf[1])&&void 0!==Wf?Wf:"",this.pingPongLogOp.dimension2=null!==(Kf=kf[2])&&void 0!==Kf?Kf:"",this.pingPongLogOp.dimension3=null!==(Ci=kf[3])&&void 0!==Ci?Ci:"");tb.info(507320073,Oc.CoreDefault,this.pingPongLogOp.stop())}}lg.pingPongMessage=
"~";class gj{constructor(fe,Ld,ze){this.remainingRetryAttempts=4;this.isResponseReceived=this.isActiveLongPoll=this.isLongPollSuccessful=this.isAsleep=!1;this.lastEgressTime=0;this.longPollLogOp=new Za({operationName:"OnLongPollMessage",success:!0});this.clientMetadata=Ld;this.sessionCorrelationVector=ze;this.longPollLogOp.setClientMetadata(this.clientMetadata,!0);this.worker=fe}start(){const fe=(new Za({operationName:"StartHttpReliabilityManager",success:!0})).start();fe.setClientMetadata(this.clientMetadata,
!0);tb.info(508163399,Oc.CoreDefault,fe.stop());this.trySendLongPoll(zf.Start,!0);this.isLongPollSuccessful=!0}onResponse(fe){if(!fe||this.isResponseReceived)fe=(new Za({operationName:"HttpReliabilityManagerFailure",success:!1})).start(),fe.setClientMetadata(this.clientMetadata,!0),tb.info(508162497,Oc.CoreDefault,fe.stop());else if(this.isResponseReceived=!0,this.isActiveLongPoll=!1,fe.error)if(this.isLongPollSuccessful=!1,--this.remainingRetryAttempts,0<this.remainingRetryAttempts){this.longPollLogOp.success=
!1;this.longPollLogOp.resultDescription=`Retry attempts left : ${this.remainingRetryAttempts}`;this.longPollLogOp.resultSignature=fe.error;tb.info(508163398,Oc.CoreDefault,this.longPollLogOp.stop());const Ld="Request timed out"===fe.error?zf.TimeoutResend:zf.FailResend;"Request timed out"===fe.error||3===this.remainingRetryAttempts?this.trySendLongPoll(Ld,!0):this.enqueueSendLongPoll(Ld)}else this.longPollLogOp.success=!1,this.longPollLogOp.resultDescription="Long poll still not received after all retry attempts",
tb.info(508163397,Oc.CoreDefault,this.longPollLogOp.stop()),this.worker&&this.worker.close();else this.longPollLogOp.success=!0,this.longPollLogOp.resultDescription="Long poll received",tb.info(508163401,Oc.CoreDefault,this.longPollLogOp.stop()),this.remainingRetryAttempts=4,this.isLongPollSuccessful=!0,this.trySendLongPoll(zf.Regular)}close(){const fe=(new Za({operationName:"CloseHttpReliabilityManager",success:!0})).start();fe.setClientMetadata(this.clientMetadata,!0);tb.info(508162467,Oc.CoreDefault,
fe.stop());this.sendLongPollTimer&&(clearTimeout(this.sendLongPollTimer),this.sendLongPollTimer=void 0);this.isLongPollSuccessful=this.isActiveLongPoll=!1;this.worker=void 0}checkConnection(){if(this.isAsleep){this.isAsleep=!1;const fe=(new Za({operationName:"AwakenHttpReliabilityManager",success:!0})).start();fe.setClientMetadata(this.clientMetadata,!0);tb.info(508162496,Oc.CoreDefault,fe.stop());this.trySendLongPoll(zf.CheckConnection,!0)}return this.isLongPollSuccessful}isReliabilityResponse(fe){return"string"!==
typeof fe&&Ub.z.typeGuard(fe)}postEgress(){this.lastEgressTime=Date.now();this.trySendLongPoll(zf.PostEgress)}needsParsedResponses(){return!0}enqueueSendLongPoll(fe){this.sendLongPollTimer=setTimeout(()=>{this.trySendLongPoll(fe,!0)},2E4)}trySendLongPoll(fe,Ld){this.worker?!0===this.isActiveLongPoll?(fe=(new Za({operationName:"LongPollNoOp",success:!0})).start(),fe.setClientMetadata(this.clientMetadata,!0),fe.resultDescription="Already active long poll",tb.info(508163396,Oc.CoreDefault,fe.stop())):
(this.isActiveLongPoll=!0,6E4<Date.now()-this.lastEgressTime&&!Ld?(this.isActiveLongPoll=!1,this.isAsleep=!0,fe=(new Za({operationName:"LongPollSleep",success:!0})).start(),fe.setClientMetadata(this.clientMetadata),fe.resultDescription=`isAsleep: ${this.isAsleep}, isActiveLongPoll: ${this.isActiveLongPoll}`,tb.info(507278739,Oc.CoreDefault,fe.stop())):(this.longPollLogOp.start(),this.isResponseReceived=!1,this.worker.egress({obj:this.getLongPollMessageString(fe),isHttpSessionLongPollMessage:!0,isHttpSessionInitMessage:!1}))):
(fe=(new Za({operationName:"LongPollNoOp",success:!0})).start(),fe.setClientMetadata(this.clientMetadata,!0),fe.resultDescription="Worker is undefined",tb.info(507281438,Oc.CoreDefault,fe.stop()))}getLongPollMessageString(fe){fe=new Ub.y({longPollTimeoutHint:15E3,type:fe});this.sessionCorrelationVector&&(fe.cv=this.sessionCorrelationVector().newChild().toString());return JSON.stringify(fe)}}const $g=JSON.stringify(new Ub.z({error:"Request timed out"}));class Rg{constructor(fe){this.networkOverrideOptions=
fe;this.isClosed=!1;this.pendingEgress=[]}init(fe,Ld,ze,kf){const mg=(new Za({operationName:"HttpWorkerInit",success:!0})).start(),Wf=fe.split("/?x-origin=");2===Wf.length?(this.url=uc.convertWebSocketUrlToHttp(Wf[0]),this.origin=Wf[1]):(this.url=uc.convertWebSocketUrlToHttp(fe),this.origin=void 0);this.ingress=Ld;this.onOpen=ze;this.onClose=kf;tb.info(507839180,Oc.CoreDefault,mg.stop())}egress(fe){const Ld=(new Za({operationName:"HttpEgress",success:!0})).start();if(this.isConnectedToSession()||
fe.isHttpSessionInitMessage){var ze=this.getRequestInfo(fe,Ld);ze.url?fe.isHttpSessionLongPollMessage?this.egressLongPoll(ze,Ld):J(ze.url,ze.request,(kf,mg)=>{if(kf)this.onEgressError(Ld,"OnEgressError:"+(null===kf||void 0===kf?void 0:kf.message));else if(mg&&mg.ok)mg.text().then(Wf=>{Ld.success=!0;tb.info(508163362,Oc.CoreDefault,Ld.stop());this.ingressInternal(Wf)}).catch(Wf=>{this.onEgressError(Ld,"OnEgressParseError: "+(null===Wf||void 0===Wf?void 0:Wf.message))});else this.onEgressError(Ld,"OnEgressResponseError: "+
(null===kf||void 0===kf?void 0:kf.message)+`, Status ${null===mg||void 0===mg?void 0:mg.status}: ${null===mg||void 0===mg?void 0:mg.statusText}`)}):(Ld.success=!1,Ld.resultDescription="Could not generate HTTP request",tb.error(508163393,Oc.CoreDefault,Ld.stop()))}else this.pendingEgress.push(fe),Ld.success=!1,Ld.resultDescription="NotConnected, pendingQueueSize:  "+this.pendingEgress.length.toString(),tb.info(508163394,Oc.CoreDefault,Ld.stop())}close(){const fe=(new Za({operationName:"HttpWorkerClose",
success:!0})).start();this.isClosed?(fe.resultDescription="AlreadyClosed",tb.info(508163360,Oc.CoreDefault,fe.stop())):(tb.info(508163359,Oc.CoreDefault,fe.stop()),this.isClosed=!0,this.sessionSettings=void 0,this.onClose&&(this.onClose(void 0),this.onClose=void 0))}onEgressError(fe,Ld){fe.success=!1;fe.resultDescription=Ld;tb.error(508163358,Oc.CoreDefault,fe.stop());this.isClosed||this.close()}ingressInternal(fe,Ld){let ze=fe;Ld||(ze=this.formatServerInput(fe));fe=kf=>{if(Ub.x.typeGuard(kf))this.onSessionInitResponse(kf)};
ze&&(this.logIngressCount(ze),this.ingress(ze,fe))}onSessionInitResponse(fe){const Ld=(new Za({operationName:"HttpWorkerOpen",success:!0})).start();fe.sessionKey&&fe.origin&&fe.anonymousToken&&fe.sessionUrlBase?(tb.info(508163357,Oc.CoreDefault,Ld.stop()),this.setSessionSettings(fe.sessionKey,fe.origin,fe.anonymousToken,fe.sessionUrlBase),this.onOpen(),this.pendingEgress.forEach(ze=>{this.egress(ze)}),this.pendingEgress=[]):(Ld.success=!1,Ld.resultDescription="SessionInitResponse missing information",
tb.error(507809949,Oc.CoreDefault,Ld.stop()))}egressLongPoll(fe,Ld){O(fe.url,2E4,fe.request).then(ze=>{if(ze&&ze.ok)ze.text().then(kf=>{Ld.success=!0;Ld.resourceId="LongPoll";tb.info(508163355,Oc.CoreDefault,Ld.stop());this.ingressInternal(kf)}).catch(kf=>{this.onEgressError(Ld,"LongPollFetchParseError: "+(null===kf||void 0===kf?void 0:kf.message))});else this.onEgressError(Ld,"LongPollFetchStatusFailure: "+(null===ze||void 0===ze?void 0:ze.statusText))}).catch(ze=>{if("Request timed out"===ze.message)Ld.success=
!1,Ld.resultDescription="LongPollFetchResponseTimeout:"+(null===ze||void 0===ze?void 0:ze.message),tb.error(508163353,Oc.CoreDefault,Ld.stop()),this.ingressInternal($g,!0);else this.onEgressError(Ld,"LongPollFetchResponseError: "+(null===ze||void 0===ze?void 0:ze.message))})}getRequestInfo(fe,Ld){const ze=this.getUrl(null===fe||void 0===fe?void 0:fe.isHttpSessionInitMessage),kf=this.getHeader(fe,Ld);Ld.resultSignature=ze;return{url:ze,request:{method:"POST",headers:kf,body:fe.obj}}}getUrl(fe){const Ld=
this.sessionSettings&&this.sessionSettings.sliceUrl?this.sessionSettings.sliceUrl:this.url;return fe?Ld+"/sessioninit":this.isConnectedToSession()?Ld+"/session/"+this.sessionSettings.sessionKey:""}getHeader(fe,Ld){var ze;const kf=new ih.Headers;(null===fe||void 0===fe?0:fe.isHttpSessionInitMessage)?(kf.set("Content-Type","application/json"),this.origin&&kf.set("x-origin",this.origin)):this.isConnectedToSession()&&(fe.obj instanceof Uint8Array||fe.obj instanceof ArrayBuffer?(kf.set("Content-Type",
"application/jsond2"),Ld.dimension0=fe.obj.byteLength.toString().length.toString()):kf.set("Content-Type","application/json"),kf.append("Authorization",`Bearer ${this.sessionSettings.anonymousToken}`),kf.set("x-origin",this.sessionSettings.origin));(null===(ze=this.networkOverrideOptions)||void 0===ze?0:ze.hostHeader)&&kf.set("host",this.networkOverrideOptions.hostHeader);return kf}setSessionSettings(fe,Ld,ze,kf){kf=kf.replace("/session","");this.sessionSettings={sessionKey:fe,origin:Ld,anonymousToken:ze,
sliceUrl:kf}}isConnectedToSession(){return this.sessionSettings&&0<this.sessionSettings.sessionKey.length&&0<this.sessionSettings.anonymousToken.length&&0<this.sessionSettings.origin.length&&0<this.sessionSettings.sliceUrl.length&&!this.isClosed}formatServerInput(fe){return 1<fe.length?fe.substring(1,fe.length-1):""}logIngressCount(fe){fe=fe.length;if(1E5<fe){const Ld=(new Za({operationName:"HttpIngressByteOrderOfMagnitude",success:!0})).start();Ld.dimension2=fe.toString().length.toString();tb.info(508409622,
Oc.CoreDefault,Ld.stop())}}}const Ae=(fe,Ld,ze,kf,mg)=>fe instanceof Rg?new gj(fe,ze,kf):new lg(fe,Ld,ze,mg),Ak=fe=>{var Ld;fe=fe.ops.filter(ze=>pf.a.matchesTypesFor(ze,["AugLoop_Core_AddOperation"]));for(const ze of fe)for(const kf of ze.items)if(kf.body&&(null===(Ld=kf.body)||void 0===Ld?0:Ld.isFirstUserPerceivedResponse))return!0;return!1},Wl=fe=>{fe=fe.filter(Ld=>pf.a.matchesTypesFor(Ld,["AugLoop_Signals_SignalOperation"]));for(const Ld of fe)for(const ze of Ld.items)if(ze.body&&pf.a.matchesTypesFor(ze.body,
["AugLoop_CopilotChatHistory_CopilotChatHistorySignal","AugLoop_Copilot_CopilotInputSignal"]))return ze},wl=(fe,Ld,ze,kf,mg)=>{if(fe=Wl(fe))mg.setDataField("CurrentTimestamp",ze),mg.cv=Ld?Ld:"",mg.resultSignature=kf,mg.resourceId=pf.a.getTypeNameFor(fe.body),fe.contextId&&mg.setDataField("ContextId",fe.contextId),fe.sourceTimestamp&&mg.setDataField("SourceTimestamp",fe.sourceTimestamp),tb.info(505983429,Oc.CoreDefault,mg.stop())},Zm=(fe,Ld,ze,kf,mg)=>{if(!kf||Ak(fe))mg.setDataField("CurrentTimestamp",
Ld),mg.cv=fe.cv,mg.resultSignature=ze,mg.resourceId=fe.annotationType,tb.info(505983428,Oc.CoreDefault,mg.stop())};class Dk{constructor(fe){var Ld,ze;this.egressByteCount=this.egressMessageCount=this.emptyMessageId=0;this.prevSeq=-1;this.pendingQueue=[];this.rpsThreshold=150;this.bpsThreshold=5E8;this.isClosing=!1;this.messageQueue=void 0;this.egressRateLogOp=new Za({operationName:"NetworkEgressRate",success:!0});this.egressedCache=new Map;this.initPromise=new Promise(kf=>{this.resolveInitPromise=
kf});if(this.dynamicRateControllerEnabled=null!==(Ld=null===fe||void 0===fe?void 0:fe.dynamicRateControllerEnabled)&&void 0!==Ld?Ld:!1)this.messageQueue=new (ng());this.reducedPingPongRetryEnabled=null!==(ze=null===fe||void 0===fe?void 0:fe.reducedPingPongRetryEnabled)&&void 0!==ze?ze:!1}init(fe,Ld,ze,kf,mg,Wf){this.worker=fe;this.ingress=Ld;this.queryEgressCacheSize=ze;this.clientMetadata=mg;this.networkMode=kf;this.reliabilityManager=Ae(this.worker,this.close.bind(this),void 0,Wf,this.reducedPingPongRetryEnabled);
this.egressRateLogOp.setClientMetadata(this.clientMetadata,!0);this.dynamicRateControllerEnabled&&(this.resetRateLimiter(),this.onCloseController=new Promise(Kf=>{this.resolveCloseControllerPromise=Kf}),this.queueProcessingCompletePromise=new Promise(Kf=>{this.resolveQueueProcessingCompletePromise=Kf}));this.resolveInitPromise()}open(){const fe=(new Za({operationName:"NetworkRateControllerOpen",success:!0,dimension3:`networkMode: ${this.networkMode}`})).start();fe.setClientMetadata(this.clientMetadata,
!0);this.initPromise.then(()=>{this.reliabilityManager?(this.egressRateControlIntervalStart=Date.now(),this.reliabilityManager.start(),this.dynamicRateControllerEnabled?this.processQueue():(this.egressRateControlTimer=setInterval(()=>this.flush(),1E3),this.flush())):(fe.success=!1,fe.resultDescription="Reliability Manager is undefined")}).catch(Ld=>{var ze;fe.success=!1;fe.resultDescription="Catch: "+(null!==(ze=null===Ld||void 0===Ld?void 0:Ld.message)&&void 0!==ze?ze:"")}).finally(()=>{tb.info(507834384,
Oc.CoreDefault,fe.stop())})}ingressFromWorker(fe,Ld){if(this.reliabilityManager)if(!this.reliabilityManager.needsParsedResponses()&&this.reliabilityManager.isReliabilityResponse(fe))this.reliabilityManager.onResponse();else this.ingress(fe,ze=>{null===Ld||void 0===Ld||Ld(ze);if(this.reliabilityManager.needsParsedResponses()&&this.reliabilityManager.isReliabilityResponse(ze))this.reliabilityManager.onResponse(ze)});else this.ingress(fe,Ld)}onRateLimitErrorResponse(fe){if(this.dynamicRateControllerEnabled){const Ld=
(new Za({operationName:"NetworkRateControllerOnRateLimitResponse",success:!0})).start();Ld.setClientMetadata(this.clientMetadata,!0);Ld.resultSignature=`rateLimitAlreadyStarted: ${void 0!==this.rateLimitTimeout}`;Ld.setDataField("RetryAfterMs",fe.retryAfterMs);Ld.setDataField("QueueSize",this.messageQueue.length);this.startRateLimiting(fe.retryAfterMs);tb.info(507388684,Oc.CoreDefault,Ld.stop())}}setRpsBps(fe,Ld){const ze=(new Za({operationName:"NetworkRateControllerRateLimitsSet",success:!0})).start();
ze.setClientMetadata(this.clientMetadata,!0);fe&&(this.rpsThreshold=.8*fe,ze.resultDescription+=`maxRPS: ${fe}, rpsThreshold: ${this.rpsThreshold}; `);Ld&&(this.bpsThreshold=.8*Ld,ze.resultDescription+=`maxRPS: ${Ld}, rpsThreshold: ${this.bpsThreshold}; `);tb.info(507388683,Oc.CoreDefault,ze.stop())}close(){var fe,Ld;return B(this,void 0,void 0,function*(){const ze=(new Za({operationName:"NetworkRateControllerClose",success:!0,dimension3:`networkMode: ${this.networkMode}`})).start();ze.setClientMetadata(this.clientMetadata,
!0);this.isClosing=!0;if(this.dynamicRateControllerEnabled){null===(fe=this.resolveCloseControllerPromise)||void 0===fe||fe.call(this);const kf=null===(Ld=this.reliabilityManager)||void 0===Ld?void 0:Ld.checkConnection();ze.setDataField("QueueSizeBeforeFlush",this.messageQueue.length);0!=this.messageQueue.length&&kf&&(yield this.queueProcessingCompletePromise);ze.setDataField("QueueSizeAfterFlush",this.messageQueue.length);ze.setDataField("IsConnected",kf)}this.reliabilityManager?this.reliabilityManager.close():
ze.resultDescription="Reliability Manager is undefined";this.worker=void 0;this.prevSeq=-1;this.clearEgressControlTimeout();this.reliabilityManager=void 0;tb.info(507834381,Oc.CoreDefault,ze.stop())})}clearMessageQueues(){this.pendingQueue=[];this.egressedCache.clear();this.messageQueue=void 0}egress(fe,Ld=0){var ze,kf;if(this.reliabilityManager){var mg=this.getMessageSize(fe);if(3E6<=mg)this.logEgressActivity(!1,"Message size exceeded 3000000",`Message size: ${mg}`);else if((fe.obj instanceof ArrayBuffer||
fe.isHttpSessionInitMessage)&&this.worker)this.logEgressActivity(!0,`isArrayBuffer: ${fe.obj instanceof ArrayBuffer}, isHttpSessionInitMessage: ${fe.isHttpSessionInitMessage}`,""),this.worker.egress(fe);else if(this.validateSyncMessage(fe.messageId,fe.seqId),this.dynamicRateControllerEnabled){var Wf=null!==(ze=fe.messageId)&&void 0!==ze?ze:`id${this.emptyMessageId++}`;fe={obj:fe.obj,seqId:null===fe||void 0===fe?void 0:fe.seqId,messageId:Wf,isHttpSessionInitMessage:null===fe||void 0===fe?void 0:fe.isHttpSessionInitMessage};
Wf=0<Ld;Ld=(new Za({operationName:"NetworkRateControllerQueueItem",success:!0,dimension3:`isRetry: ${Wf}`})).start();Ld.setClientMetadata(this.clientMetadata,!0);fe={message:fe,logOp:Ld};Wf?this.messageQueue.unshift(fe):this.messageQueue.push(fe);if(1E4<this.messageQueue.length)throw fe=this.messageQueue.shift(),Wf=`NetworkRateControllerQueue max size reached. Dropping messageId: ${fe.message.messageId}`,fe.logOp.resultDescription=Wf,fe.logOp.success=!1,tb.info(506001225,Oc.CoreDefault,fe.logOp.stop()),
Error(Wf);null===(kf=this.resolveQueueNotEmptyPromise)||void 0===kf||kf.call(this)}else{kf=this.queryEgressCacheSize();Ld=this.egressMessageCount>=this.rpsThreshold;ze=this.egressByteCount>=this.bpsThreshold;mg=1E4<kf;const Kf=this.reliabilityManager.checkConnection(),Ci=0!==this.pendingQueue.length,cj=1E4<=this.pendingQueue.length;if(!Kf||Ld||ze||Ci||cj||mg){let di="";const rj=[];if(Ci||cj)di+=cj?"Pending queue max exceeded. ":"Pending queue not empty. ",rj.push(this.pendingQueue.length.toString().length.toString());
mg&&(di+=1E4<=kf?"Egressed cache max exceeded. ":"",rj.push(kf.toString().length.toString()));Ld&&(di+="RPS exceeded. ",rj.push(this.egressMessageCount.toString().length.toString()));ze&&(di+="BPS exceeded. ",rj.push(this.egressByteCount.toString().length.toString()));this.logEgressActivity(!0,`networkMode: ${this.networkMode}`,di+(Kf?"":"Not connected. "),rj);kf=null!==(Wf=fe.messageId)&&void 0!==Wf?Wf:`id${this.emptyMessageId++}`;this.pendingQueue.push({obj:fe.obj,seqId:null===fe||void 0===fe?void 0:
fe.seqId,messageId:kf,isHttpSessionInitMessage:null===fe||void 0===fe?void 0:fe.isHttpSessionInitMessage})}else this.sendToNetworkWorker(fe)}}else this.logEgressActivity(!1,"Reliability Manager is undefined","")}getMessageSize(fe){return fe.obj instanceof ArrayBuffer?fe.obj.byteLength:fe.obj.length}sendToNetworkWorker(fe){var Ld;try{if(this.worker)if(this.reliabilityManager){this.worker.egress(fe);this.onSendToNetworkWorker(fe);null===(Ld=this.reliabilityManager)||void 0===Ld||Ld.postEgress();var ze=
this.getMessageSize(fe);this.logEgressCount(ze)}else this.logEgressActivity(!1,"Reliability Manager is undefined","SendToNetworkWorkerFailure");else this.logEgressActivity(!1,"NetworkWorker is undefined","SendToNetworkWorkerFailure")}catch(kf){this.logEgressActivity(!1,"SendToNetworkWorkerFailure",kf?kf.message:"")}}onSendToNetworkWorker(fe){if("string"===typeof fe.obj)try{const kf=JSON.parse(fe.obj);if(Ub.E.typeGuard(kf)){fe=kf;var Ld=Date.now(),ze=(new Za({operationName:"AugloopClientPerfTracker",
success:!0})).setClientMetadata(this.clientMetadata).start();wl(fe.ops,fe.cv,Ld,"SendToNetwork",ze)}}catch(kf){}}flush(){if(this.reliabilityManager)for(var fe=0,Ld=0;0<this.pendingQueue.length&&1E4>this.queryEgressCacheSize()&&fe<this.rpsThreshold&&Ld<this.bpsThreshold&&this.reliabilityManager.checkConnection();){const ze=this.pendingQueue.shift();this.sendToNetworkWorker(ze);fe++;Ld+=this.getMessageSize(ze)}else fe=(new Za({operationName:"NetworkRateControllerFlushFailure",success:!1,dimension3:`networkMode: ${this.networkMode}`})).start(),
fe.setClientMetadata(this.clientMetadata,!0),fe.resultDescription="Reliability Manager is undefined",tb.info(507834373,Oc.CoreDefault,fe.stop())}processQueue(){var fe,Ld,ze;return B(this,void 0,void 0,function*(){if(this.reliabilityManager){for(var kf=(new Za({operationName:"NetworkRateControllerProcessQueue",success:!0})).start();;){if(0===this.messageQueue.length){if(this.isClosing){kf.setDataField("ExitReason","Stage#1 Closing");break}yield Promise.race([this.queueNotEmpty(),this.onCloseController])}if(this.rateLimitTimeout){var mg=
(new Za({operationName:"NetworkRateControllerRateLimitBackoff",dimension3:`networkMode: ${this.networkMode}`})).start();mg.setClientMetadata(this.clientMetadata,!0);mg.setDataField("QueueLengthBeforeBackoff",this.messageQueue.length);yield Promise.race([this.rateLimitTimeout,this.onCloseController]);mg.setDataField("QueueLengthAfterBackoff",this.messageQueue.length);mg.setDataField("IsClosing",this.isClosing);mg.success=!0;this.rateLimitTimeout=void 0;this.resetRateLimiter();tb.info(507281410,Oc.CoreDefault,
mg.stop())}if(null===(fe=this.reliabilityManager)||void 0===fe||!fe.checkConnection()){if(this.isClosing){kf.setDataField("ExitReason","Stage#2 Closing");break}yield this.checkConnectionPromise();this.connectionPromise=void 0}if(!this.reliabilityManager){kf.setDataField("ExitReason","Stage#2 ReliabilityManager null");break}for(;0<this.messageQueue.length&&this.reliabilityManager.checkConnection();){if(1E3<=Date.now()-this.egressRateControlIntervalStart)this.resetRateLimiter();else if(this.egressMessageCount>=
this.rpsThreshold||this.egressByteCount>=this.bpsThreshold){mg="";this.egressMessageCount>=this.rpsThreshold&&(mg+="RPS exceeded.");this.egressByteCount>=this.bpsThreshold&&(mg+="BPS exceeded.");const Wf=(new Za({operationName:"NetworkRateControllerEgress",dimension3:`networkMode: ${this.networkMode}`})).start();Wf.setClientMetadata(this.clientMetadata,!0);Wf.success=!0;Wf.resultDescription="rateLimitHit";Wf.resultSignature=mg;Wf.dimension0=this.messageQueue.length.toString().length.toString();Wf.dimension1=
"rateLimitHit";Wf.setDataField("QueueLength",this.messageQueue.length);Wf.setDataField("RateLimitDelayMs",1100);tb.info(507281409,Oc.CoreDefault,Wf.stop());this.startRateLimiting(1100);break}mg=this.messageQueue.shift();this.sendToNetworkWorker(mg.message);tb.info(507388682,Oc.CoreDefault,mg.logOp.stop())}this.resolveQueueNotEmptyPromise=this.onQueueNotEmpty=void 0}null===(Ld=this.resolveQueueProcessingCompletePromise)||void 0===Ld||Ld.call(this);this.resolveQueueProcessingCompletePromise=void 0;
kf.setClientMetadata(this.clientMetadata,!0);kf.setDataField("QueueSize",this.messageQueue.length);kf.setDataField("IsConnected",null===(ze=this.reliabilityManager)||void 0===ze?void 0:ze.checkConnection());kf.setDataField("IsClosing",this.isClosing);tb.info(507368671,Oc.CoreDefault,kf.stop())}else kf=(new Za({operationName:"NetworkRateControllerProcessQueueFailure",success:!1,dimension3:`networkMode: ${this.networkMode}`})).start(),kf.setClientMetadata(this.clientMetadata,!0),kf.resultDescription=
"Reliability Manager is undefined",tb.info(507573643,Oc.CoreDefault,kf.stop())})}queueNotEmpty(){this.onQueueNotEmpty||(this.onQueueNotEmpty=new Promise(fe=>{this.resolveQueueNotEmptyPromise=fe}));return this.onQueueNotEmpty}checkConnectionPromise(){this.connectionPromise||(this.connectionPromise=new Promise(fe=>{setTimeout(fe,1E3)}));return this.connectionPromise}startRateLimiting(fe){this.rateLimitTimeout||(this.rateLimitTimeout=new Promise(Ld=>{setTimeout(Ld,fe)}))}resetRateLimiter(){this.egressRateControlIntervalStart=
Date.now();this.egressByteCount=this.egressMessageCount=0}clearEgressControlTimeout(){this.egressRateControlTimer&&(clearInterval(this.egressRateControlTimer),this.egressRateControlTimer=void 0)}validateSyncMessage(fe,Ld){void 0===Ld||void 0===fe||Ld<=this.prevSeq||(Ld&&Ld!==this.prevSeq+1&&(fe=(new Za({operationName:"NetworkRateControllerAbandonedSyncMessage",success:!0,dimension3:`networkMode: ${this.networkMode}`})).start(),fe.setClientMetadata(this.clientMetadata,!0),fe.resultDescription="Gap in sync message",
fe.dimension0=`${this.prevSeq}`,fe.dimension1=`${Ld}`,fe.dimension2=`${Ld-this.prevSeq}`,tb.info(507834370,Oc.CoreDefault,fe.stop())),this.prevSeq=Ld)}logEgressActivity(fe,Ld,ze,kf){var mg,Wf,Kf,Ci;const cj=(new Za({operationName:"NetworkRateControllerEgress",dimension3:`networkMode: ${this.networkMode}`})).start();cj.setClientMetadata(this.clientMetadata,!0);cj.success=fe;cj.resultDescription=Ld;cj.resultSignature=ze;kf&&(cj.dimension0=null!==(mg=kf[0])&&void 0!==mg?mg:"",cj.dimension1=null!==(Wf=
kf[1])&&void 0!==Wf?Wf:"",cj.dimension2=null!==(Kf=kf[2])&&void 0!==Kf?Kf:"",cj.dimension3=null!==(Ci=kf[3])&&void 0!==Ci?Ci:"");tb.info(507626007,Oc.CoreDefault,cj.stop())}logEgressCount(fe){const Ld=Date.now();if(1E3<Ld-this.egressRateControlIntervalStart){if(50<this.egressMessageCount||1E5<this.egressByteCount)this.egressRateLogOp.start(),this.egressRateLogOp.resultDescription=50<this.egressMessageCount?"rps logging threshold exceeded":"",this.egressRateLogOp.resultDescription=1E5<this.egressByteCount?
"bps logging threshold exceeded":"",this.egressRateLogOp.dimension0=(Ld-this.egressRateControlIntervalStart).toString(),this.egressRateLogOp.dimension1=`${this.egressMessageCount}`,this.egressRateLogOp.dimension2=`${this.egressByteCount}`,this.egressRateLogOp.dimension3=`networkMode: ${this.networkMode}`,tb.info(508843792,Oc.CoreDefault,this.egressRateLogOp.stop());this.egressRateControlIntervalStart=Ld;this.egressByteCount=this.egressMessageCount=0}this.egressMessageCount++;this.egressByteCount+=
null!==fe&&void 0!==fe?fe:0}}var Dl;(function(fe){fe[fe.JSWebSockets=0]="JSWebSockets";fe[fe.LocalWorkflowsOnly=1]="LocalWorkflowsOnly";fe[fe.HostWebSockets=2]="HostWebSockets";fe[fe.HttpFallback=3]="HttpFallback"})(Dl||(Dl={}));var nm;(function(fe){fe.Workflow="Workflow";fe.Client="Client";fe.HttpEndpoint="HttpEndpoint"})(nm||(nm={}));const Ii=(fe,Ld,ze)=>{Ld=uc.getCurrentTimeMs()?uc.getCurrentTimeMs()-Ld:0;const kf=[1E3,2E3,5E3,1E4,6E4];fe=kf[Math.max(0,Math.min(kf.length-1,fe-1))];fe=Math.max(fe-
Ld,1E3);return fe=ze&&0<ze?Math.min(5E3,fe):fe};class Eb{constructor(fe,Ld,ze,kf,mg,Wf,Kf,Ci,cj,di){this.logCountLimiter=new Xc(Eb.className);this.permanentlyClosed=this.isWorkerReady=!1;this.lastInitializationAttemptTimeMs=this.currentReconnectAttempt=0;this.offlineInterval=void 0;this.alreadyLoggedReconnectAttempt=!1;this.httpTestsLeft=5;this.workerOpenCount=this.httpTestsSuccessCount=0;this.testHttpConnection=rj=>{const bn=uc.convertWebSocketUrlToHttp(this.globalUrl),lo=!rj,as=null!==rj&&void 0!==
rj?rj:(new Za({operationName:"HttpsTest",resourceId:Yb(bn),success:!1,resultDescription:"",resultSignature:"HttpResponse:"})).start();rj={method:"POST",headers:{"content-type":"application/json","X-CorrelationId":as.cv},body:JSON.stringify(uc.createHealthCheckRequest(this.clientMetadata))};J(bn,rj,(sk,jf)=>{sk?(as.dimension1="HttpErr",as.resultDescription+=`HttpErr: ${sk.message}`):jf&&jf.ok?(as.dimension1="HttpOK",this.leaveOfflineMode(),this.httpTestsSuccessCount++,lo&&(as.success=!0)):(as.dimension1=
"HttpNoResp",as.resultDescription+=`HttpStatus: ${null===jf||void 0===jf?void 0:jf.status}`);lo&&as.stop();this.logCountLimiter.log(()=>{tb.info(508843780,Oc.CoreDefault,as)})})};this.globalUrl=fe;this.clientMetadata=Ld;this.workerFactory=ze;this.sessionInitializer=kf;this.ingress=mg;this.queryEgressCacheSize=Wf;this.onConnectionClose=Kf;this.sessionCorrelationVector=Ci;this.dynamicRateControllerEnabled=cj.dynamicRateControllerEnabled;this.reducedPingPongRetryEnabled=cj.reducedPingPongRetryEnabled;
this.networkWorkerLogOp=new Za({operationName:"CreateNetworkWorker",success:!0});this.initNetworkMode=this.networkMode=di?di:Dl.JSWebSockets}init(fe,Ld,ze=!1){if(this.permanentlyClosed)return Promise.reject(Error("permanentlyClosed"));if(this.isWorkerReady||this.pendingInitPromise)return this.pendingInitPromise?this.pendingInitPromise:Promise.resolve();this.extensionConfigs=fe||this.extensionConfigs;const kf=()=>{if(ze||!this.alreadyLoggedReconnectAttempt){const mg=ze?Eb.initialAttemptTimeout:Eb.reconnectAttemptTimeout;
this.connTimeout=setTimeout(()=>{const Wf=new Za({operationName:"ConnectionFailingOrSlow",dimension0:ze?"Initial":"Reconnect",dimension1:mg.toString(),dimension2:this.currentReconnectAttempt.toString()});tb.info(508843787,Oc.CoreDefault,Wf);this.alreadyLoggedReconnectAttempt=!ze;this.connTimeout=void 0},mg)}};Ld?this.pendingInitPromise=Ld().catch(mg=>{mg=new Za({operationName:"WorkerManagerCustomInit",success:!1,resultDescription:`${mg}`});tb.error(508843786,Oc.CoreDefault,mg)}).then(()=>{kf();this.initInternal()}):
(this.pendingInitPromise=Promise.resolve(),kf(),this.initInternal());return this.pendingInitPromise}egress(fe,Ld){if(!this.isWorkerReady&&this.pendingInitPromise)return this.pendingInitPromise.then(()=>{this.egressInternal(fe,Ld)});this.egressInternal(fe,Ld);return Promise.resolve()}egressBytes(fe){if(!this.isWorkerReady&&this.pendingInitPromise)return this.pendingInitPromise.then(()=>{this.egressBytesInternal(fe)});this.egressBytesInternal(fe);return Promise.resolve()}getNetworkMode(){return this.networkMode}getInitNetworkMode(){return this.initNetworkMode}onRateLimitErrorResponse(fe){if(this.dynamicRateControllerEnabled)this.getNetworkRateController().onRateLimitErrorResponse(fe)}close(fe){this.isWorkerReady=
!1;this.dynamicRateControllerEnabled&&this.networkRateController&&this.getNetworkRateController().close();this.worker&&(this.worker.close(),this.worker=null);!this.dynamicRateControllerEnabled&&this.networkRateController&&this.getNetworkRateController().close();this.networkRateController=null;if(this.permanentlyClosed=fe||this.permanentlyClosed)this.leaveOfflineMode(),clearTimeout(this.connTimeout)}initInternal(){this.isWorkerReady=!1;if(this.permanentlyClosed||this.isOffline()){const fe=new Za({operationName:"WorkerManagerInitOffline",
success:!0,resultSignature:this.permanentlyClosed?"PermanentlyClosed":"Offline"});tb.info(508843785,Oc.CoreDefault,fe)}else 0<this.currentReconnectAttempt?setTimeout(()=>{this.tryToConnectAndInitializeSession()},Ii(this.currentReconnectAttempt,this.lastInitializationAttemptTimeMs,this.httpTestsSuccessCount)):this.getNetworkMode()===Dl.HttpFallback?setTimeout(()=>{this.tryToConnectAndInitializeSession()},100):this.tryToConnectAndInitializeSession()}egressInternal(fe,Ld){if(this.isWorkerReady||pf.a.matchesTypesFor(fe,
[Ub.w.getTypeName()])){if(pf.a.matchesTypesFor(fe,[Ub.m.getTypeName()])){this.castBinaryData(fe);var ze=ol.serialize(fe)}else ze=JSON.stringify(fe);if(Ub.E.typeGuard(fe))var kf=fe.seq;if(this.bypassRateController(fe))this.worker.egress({obj:ze});else{var mg=Ub.w.typeGuard(fe)&&this.getNetworkMode()===Dl.HttpFallback;this.getNetworkRateController().egress({obj:ze,isHttpSessionInitMessage:mg,messageId:fe.messageId,seqId:kf},Ld)}}else pf.a.matchesTypesFor(fe,[Ub.p.getTypeName()])||tb.error(508843784,
Oc.CoreDefault,new Za({operationName:"UnexpectedEgressCall",resultDescription:`isWorkerReady: ${this.isWorkerReady}`}))}bypassRateController(fe){return Ub.s.typeGuard(fe)}egressBytesInternal(fe){this.isWorkerReady?this.getNetworkRateController().egress({obj:fe}):tb.error(508843783,Oc.CoreDefault,new Za({operationName:"UnexpectedEgressBytesCall",resultDescription:`isWorkerReady: ${this.isWorkerReady}`}))}tryToConnectAndInitializeSession(){this.currentReconnectAttempt++;this.lastInitializationAttemptTimeMs=
uc.getCurrentTimeMs();const fe=ze=>{if(!this.permanentlyClosed&&!this.isOffline()){var kf=this.sliceUrl?this.sliceUrl:this.globalUrl;ze.setDataField("connectionUrl",Yb(kf));this.connect(kf);this.sessionInitializer.initSession({isTokenRefresh:!1,isReconnectOnSameSlice:!!this.sliceUrl,extensionConfigs:this.extensionConfigs,onResponse:(mg,Wf)=>{ze.success=!mg;ze.resourceId=Wf?Yb(Wf.sliceUrl):"";ze.dimension2=this.getNetworkModeLogString();this.getNetworkMode()===Dl.HttpFallback?(ze.resultDescription=
mg?`HTTP Error: ${mg.error}`:"",ze.dimension0=ze.success?"HTTPOK":"HTTPFail"):(ze.resultDescription=mg?`WS Error: ${mg.error}`:"",ze.dimension0=ze.success?"WSOK":"WSFail");if(mg||!this.worker)this.sliceUrl=void 0,this.close(),0<this.httpTestsLeft?(this.httpTestsLeft--,this.testHttpConnection(ze.stop())):(this.getNetworkMode()===Dl.JSWebSockets?0===this.workerOpenCount&&5<=this.httpTestsSuccessCount?(ze.dimension1="WSBlocked",ze.dimension3="HTTP Fallback",this.networkMode=Dl.HttpFallback,this.currentReconnectAttempt=
0,this.resetHttpTestsCounter()):0===this.httpTestsSuccessCount&&(this.startOfflineMode(),ze.dimension1="WSOffline"):0===this.httpTestsSuccessCount&&(this.startOfflineMode(),ze.dimension1="HTTPOffline"),this.logCountLimiter.log(()=>{tb.info(508843782,Oc.CoreDefault,ze.stop())})),this.initInternal();else{this.logCountLimiter.log(()=>{tb.info(508843781,Oc.CoreDefault,ze.stop())});if(Wf.forceReconnect){this.close();const Kf=(new Za({operationName:"ForcedReconnect"})).start();Kf.resultSignature=`globalUrl: ${this.globalUrl}. sliceUrl: ${this.sliceUrl}`;
this.sliceUrl=void 0;setTimeout(()=>{fe(Kf)},1E3)}else clearTimeout(this.connTimeout),this.sliceUrl=Wf.sliceUrl,this.dynamicRateControllerEnabled&&this.getNetworkRateController().setRpsBps(Wf.maxRPS,Wf.maxBPS),this.ready();this.resetHttpTestsCounter()}}})}},Ld=(new Za({operationName:"TryToConnectAndInitializeSession",resultSignature:`Reconnection attempt #${this.currentReconnectAttempt}`})).start();fe(Ld)}getNetworkRateController(){this.networkRateController||(this.networkRateController=new Dk({dynamicRateControllerEnabled:this.dynamicRateControllerEnabled,
reducedPingPongRetryEnabled:this.reducedPingPongRetryEnabled}));return this.networkRateController}connect(fe){const Ld=this.getNetworkMode();this.networkWorkerLogOp.start();this.networkWorkerLogOp.resultDescription=this.getNetworkModeLogString();this.networkWorkerLogOp.dimension0=Ld.toString();this.logCountLimiter.log(()=>tb.info(508372418,Oc.CoreDefault,this.networkWorkerLogOp.stop()));this.worker=this.workerFactory(Ld);this.worker.init(fe,this.getNetworkRateController().ingressFromWorker.bind(this.networkRateController),
()=>{this.workerOpenCount++;this.getNetworkRateController().open();this.leaveOfflineMode()},ze=>{this.close();this.onConnectionClose(ze)},this.clientMetadata);this.getNetworkRateController().init(this.worker,this.ingress,this.queryEgressCacheSize,Ld,this.clientMetadata,this.sessionCorrelationVector)}ready(){this.isWorkerReady=!0;this.pendingInitPromise=void 0;this.currentReconnectAttempt=0}castBinaryData(fe){if(fe){if(Array.isArray(fe.ywk))for(const Ld of fe.ywk)ArrayBuffer.isView(fe[Ld])||(fe[Ld]=
new Uint8Array(fe[Ld]));for(const Ld of Object.keys(fe))"object"===typeof fe[Ld]&&null!==fe[Ld]&&this.castBinaryData(fe[Ld])}}isOffline(){return!!this.offlineInterval}startOfflineMode(){this.offlineInterval=setInterval(()=>{this.testHttpConnection()},6E4)}leaveOfflineMode(){this.isOffline()&&(clearInterval(this.offlineInterval),this.offlineInterval=void 0,this.resetHttpTestsCounter(),this.tryToConnectAndInitializeSession())}resetHttpTestsCounter(){this.httpTestsLeft=5;this.httpTestsSuccessCount=0}getNetworkModeLogString(){return"NetworkMode: "+
(this.getNetworkMode()===Dl.JSWebSockets?"WebSocket":"HTTP")}}Eb.initialAttemptTimeout=1E5;Eb.reconnectAttemptTimeout=2E4;Eb.className="NetworkWorkerManager";class Ec{constructor(fe){pf.a.assign(Ec,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_WorkflowRegistrationMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[Ec.getTypeName()])}}Ec.H_={T_:Ec.getTypeName(),B_:Ec.getBaseTypes()};class md{constructor(fe){pf.a.assign(md,
this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowExecutionRequest"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[md.getTypeName()])}}md.H_={T_:md.getTypeName(),B_:md.getBaseTypes()};class Jd{constructor(fe){pf.a.assign(Jd,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowCancellationRequest"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,
[Jd.getTypeName()])}}Jd.H_={T_:Jd.getTypeName(),B_:Jd.getBaseTypes()};class Ge{constructor(fe){pf.a.assign(Ge,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowExecutionResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[Ge.getTypeName()])}}Ge.H_={T_:Ge.getTypeName(),B_:Ge.getBaseTypes()};class Df{constructor(fe){pf.a.assign(Df,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_RuntimeInitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,
[Df.getTypeName()])}}Df.H_={T_:Df.getTypeName(),B_:Df.getBaseTypes()};class Bg{constructor(fe){pf.a.assign(Bg,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_DiagnosticTraceMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[Bg.getTypeName()])}}Bg.H_={T_:Bg.getTypeName(),B_:Bg.getBaseTypes()};class Xb{constructor(fe){pf.a.assign(Xb,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_TelemetryMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,
[Xb.getTypeName()])}}Xb.H_={T_:Xb.getTypeName(),B_:Xb.getBaseTypes()};class li{constructor(fe){pf.a.assign(li,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_TelemetryFlushMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[li.getTypeName()])}}li.H_={T_:li.getTypeName(),B_:li.getBaseTypes()};class sf{constructor(fe){pf.a.assign(sf,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_SessionCloseResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,
[sf.getTypeName()])}}sf.H_={T_:sf.getTypeName(),B_:sf.getBaseTypes()};class bh{constructor(fe){pf.a.assign(bh,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_WorkflowDefinitionOverrideMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[bh.getTypeName()])}}bh.H_={T_:bh.getTypeName(),B_:bh.getBaseTypes()};class pi{constructor(fe){pf.a.assign(pi,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_GetAnnotationsRequestMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_StreamingRequest",
"AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[pi.getTypeName()])}}pi.H_={T_:pi.getTypeName(),B_:pi.getBaseTypes()};class eb{constructor(fe){pf.a.assign(eb,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_GetAnnotationsResponseMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_StreamingResponse","AugLoop_Session_Protocol_Response"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[eb.getTypeName()])}}eb.H_={T_:eb.getTypeName(),
B_:eb.getBaseTypes()};class Rb extends Mf.EventEmitter{constructor(fe,Ld,ze,kf,mg,Wf,Kf,Ci,cj){super();this.cvParent=new rd;this.logOp=(new Za({operationName:"SessionState",success:!0})).start();this.sessionStateChangeLogCountLimiter=new Xc("SessionState");this.shouldNotRetryOnSessionClosedError=this.isImproveRetriesChangeGateEnabled=this.logRetryTelemetry=!0;this.stats=Ld;this.allStates={[Yi.Initing]:new Zi(this),[Yi.Running]:new jc(this),[Yi.Disconnected]:new Nb(this),[Yi.Closed]:new bb(this)};
this.setState(Yi.Initing);this.messageEndpoint=new Be({messageIdPrefix:"c",responseTimeoutMs:3E4,resendPendingMessagesOnReconnect:!1});this.messageEndpoint.setClientMetadata(mg);this.messageEndpoint.setEgress(this.egress.bind(this));this.messageEndpoint.onMessage(Ub.s.getTypeName(),(di,rj)=>{this.onSessionCloseMessage(di,rj)});this.networkWorkerManager=new Eb(fe,mg,ze,kf,this.ingress.bind(this),this.messageEndpoint.queryEgressCacheSize.bind(this.messageEndpoint),this.onConnectionClose.bind(this),
this.getCorrelationVector.bind(this),Kf,cj);this.messageQueue=new bj({sendMessage:(di,rj,bn,lo)=>this.state.sendMessage(di,rj,bn,lo),sendBytes:this.sendBytes.bind(this),canSendMessage:()=>this.state.canSendMessage()});kf.on("connect",(di,rj,bn,lo,as,sk,jf)=>{this.setState(Yi.Running,"",{isSessionReseedingStarted:di&&rj});this.emit("connect",di,bn,lo,as,sk,jf)});kf.on("reconnect",()=>this.emit("reconnect"));kf.on("serverAuthenticationStateChange",di=>this.emit("serverAuthenticationStateChange",di));
this.resetNextSyncSequenceId=()=>this.emit("resetNextSyncSequenceId");this.tokenRefreshManager=Wf;if(this.gateUtils=Ci)this.gateUtils.isChangeGateEnabled("LogRetryMessageEventV2").then(di=>{this.logRetryTelemetry=di}).catch(()=>{}),this.gateUtils.isChangeGateEnabled("ImproveClientRetries").then(di=>{this.isImproveRetriesChangeGateEnabled=di}).catch(()=>{}),this.gateUtils.isChangeGateEnabled("ShouldNotRetryOnSessionClosedError").then(di=>{this.shouldNotRetryOnSessionClosedError=di}).catch(()=>{})}setState(fe,
Ld,ze){if(!this.state||fe!==this.state.stateName){var kf=this.state?Yi[this.state.stateName]:"undefined",mg=this.state?0<=this.state.possibleNextStates.indexOf(fe):fe===Yi.Initing;this.sessionStateChangeLogCountLimiter.log(()=>{this.logOp.stop();this.logOp.resourceId=`New state: ${mg?Yi[fe]:kf}`;this.logOp.resultDescription=`Previous state: ${kf}`;this.logOp.dimension0=`Attempted state: ${Yi[fe]||"undefined"}`;this.logOp.resultSignature=Ld+(this.state&&!mg?"Unexpected state change":"");this.logOp.success=
mg;tb.info(508843791,Oc.CoreDefault,this.logOp)});mg&&(this.state=this.allStates[fe],this.logOp.start(),this.state.onEnter(ze))}}init(fe,Ld){this.extensionConfigs=fe;this.customInitPromise=Ld;return this.networkWorkerManager.init(this.extensionConfigs,this.customInitPromise,!0)}sendMessage(fe,Ld,ze){this.retrySendMessage(fe,Ld,Rb.maxRetries,ze)}sendBytes(fe){this.state.sendBytes(fe)}onMessage(fe,Ld){this.messageEndpoint.onMessage(fe,Ld)}getCorrelationVector(){return this.cvParent}getNetworkWorkerManager(){return this.networkWorkerManager}forceReconnect(fe){this.extensionConfigs=
fe||this.extensionConfigs;this.networkWorkerManager.close(!1);return new Promise(Ld=>setTimeout(()=>{Ld(this.networkWorkerManager.init(this.extensionConfigs))},100))}closeSession(fe){this.sendMessage(new Ub.s);this.networkWorkerManager.close(!0);fe=fe?fe:new Ub.t({reasonDescription:"ClientRequested"});this.onSessionClose(new Ub.s({reconnectAllowed:!1,reason:fe}),"ClientRequested")}ingress(fe,Ld){let ze;try{ze=JSON.parse(fe)}catch(kf){tb.error(508843790,Oc.CoreDefault,new Za({operationName:"ProcessMessage",
resourceId:"Unknown",success:!1,resultSignature:"ParseError",resultDescription:kf.message,durationMs:0}))}if(ze)if(Ld&&Ub.p.typeGuard(ze)&&Ld(ze),this.networkWorkerManager.getNetworkMode()===Dl.HttpFallback&&Ub.z.typeGuard(ze)){if(fe=ze,fe.batch)for(const kf of fe.batch)this.messageEndpoint.ingress(kf,(mg,Wf)=>this.egress(mg||Wf,()=>{}))}else this.messageEndpoint.ingress(ze,(kf,mg)=>this.egress(kf||mg,()=>{}))}egress(fe,Ld,ze){fe&&this.networkWorkerManager.egress(fe,ze).then(()=>Ld()).catch(kf=>Ld(kf))}onSessionCloseMessage(fe,
Ld){if(fe.reconnectAllowed)this.networkWorkerManager.close();else this.onSessionClose(fe,"CloseMessageReceived");Ld()}onSessionClose(fe,Ld){this.setState(Yi.Closed,Ld);this.tokenRefreshManager.clearAllTimeouts();this.onConnectionClose(void 0);fe&&this.emit("sessionClose",fe)}onConnectionClose(fe){this.state.onConnectionClose();this.stats.lastConnectionClose=uc.getCurrentTimeMs();this.emit("disconnect",fe)}retrySendMessage(fe,Ld,ze,kf,mg){const Wf=Rb.maxRetries-ze;this.state.sendMessage(fe,(Kf,Ci)=>
{var cj,di,rj,bn,lo,as;mg&&(Kf&&0==ze?(mg.dimension0=(Wf+1).toString(),mg.success=!1,tb.info(507025311,Oc.CoreDefault,mg.stop())):Kf&&0<ze?(mg.dimension0=(Wf+1).toString(),mg.dimension1=null!==(di=null===(cj=Kf.code)||void 0===cj?void 0:cj.toString())&&void 0!==di?di:"NoErrorCode",mg.resultSignature=null!==(rj=Kf.error)&&void 0!==rj?rj:"NoErrorMessage"):(mg.success=!0,tb.info(507025310,Oc.CoreDefault,mg.stop())));if(Kf&&0<ze&&this.canBeRetried(fe)&&this.isTransientError(Kf)){this.logRetryTelemetry&&
!mg&&(mg=(new Za({operationName:"RetrySendMessage",success:!0,dimension0:(Wf+1).toString()})).start(),mg.resourceId=pf.a.getTypeNameFor(fe),mg.dimension1=null!==(lo=null===(bn=Kf.code)||void 0===bn?void 0:bn.toString())&&void 0!==lo?lo:"NoErrorCode",mg.resultSignature=null!==(as=Kf.error)&&void 0!==as?as:"NoErrorMessage",mg.resultDescription=`Retrying message with messageId: ${fe.messageId}${Ub.E.typeGuard(fe)?`, seq: ${fe.seq}`:""}`);if(pf.a.matchesTypesFor(Kf,[Ub.o.getTypeName()]))this.networkWorkerManager.onRateLimitErrorResponse(Kf);
this.retrySendMessage(fe,Ld,ze-1,kf,mg)}else Ld&&Ld(Kf,Ci)},Wf,kf)}canBeRetried(fe){return!pf.a.matchesTypesFor(fe,[Ub.w.getTypeName(),Ub.m.getTypeName(),pi.getTypeName()])}isTransientError(fe){const Ld=fe.error;fe=fe.code;return this.isImproveRetriesChangeGateEnabled&&fe===We.TokenValidationError||fe===We.TokenDecryptError||fe===We.SyncMessageTooLateOrDuplicate||this.shouldNotRetryOnSessionClosedError&&fe===We.Gone?!1:Ld!==kd.SyncMessageUnsupportedBatch&&Ld!==kd.UnexpectedSeedMessage&&Ld!==kd.UnsupportedSyncMessage&&
Ld!==kd.AnnotationTokenNotFound&&Ld!==$f.ArrivedBeforeReseeding&&Ld!==$f.DroppedAsOldestInQueue&&Ld!==$f.DroppedBecauseClientDisconnected}}Rb.maxRetries=2;var Fc=v(84725),Bc=v(43374),Nd=v(85517),Ee;(function(fe){fe[fe.Unknown=0]="Unknown";fe[fe.LiveId=1]="LiveId";fe[fe.OrgId=2]="OrgId";fe[fe.ActiveDirectory=3]="ActiveDirectory";fe[fe.ADAL=4]="ADAL";fe[fe.SSPI=5]="SSPI";fe[fe.OAuth2=6]="OAuth2";fe[fe.Badger=7]="Badger"})(Ee||(Ee={}));var df;(function(fe){fe[fe.Augloop=0]="Augloop";fe[fe.Substrate=
1]="Substrate"})(df||(df={}));var dg;(function(fe){fe[fe.Unknown=0]="Unknown";fe[fe.TokenMissingInteractionRequired=1]="TokenMissingInteractionRequired"})(dg||(dg={}));class Sf{constructor(fe,Ld,ze,kf){this.sendMessage=fe;this.annotationType=Ld;this.options=ze;this.token=`${Ld}-${Sf.nextActivationResultBatchId++}`;this.annotationDoesNotExistOnServiceEnabled=kf}activate(fe,Ld,ze){return new Promise((kf,mg)=>{this.sendMessage(new Ub.a({annotationType:this.annotationType,token:this.token,config:this.options?
this.options.config:void 0,ignoreExistingAnnotations:fe,sendStateUpdates:this.options?!!this.options.stateUpdateCallback:void 0,forceReturnCachedAnnotations:this.options?this.options.forceReturnCachedAnnotations:void 0,returnAnnotationDoesNotExist:this.annotationDoesNotExistOnServiceEnabled||!1,sendApologies:ze}),(Wf,Kf)=>{Wf?mg(Error(Wf.error)):(Ub.b.typeGuard(Kf)&&this.annotationDoesNotExistOnServiceEnabled&&(this.annotationDoesNotExistOnService=Kf.annotationNotExists),kf({token:this.token}))},
Ld)})}release(){return new Promise((fe,Ld)=>{this.annotationDoesNotExistOnService&&this.annotationDoesNotExistOnServiceEnabled?fe(!1):this.sendMessage(new Ub.d({token:this.token}),(ze,kf)=>{ze?Ld(Error(ze.error)):fe(kf.lastRelease)})})}}Sf.nextActivationResultBatchId=1;var sg;(function(fe){fe[fe.Input=0]="Input";fe[fe.Exception=1]="Exception";fe[fe.WaitOn=2]="WaitOn";fe[fe.StopAndFilterWorkflow=3]="StopAndFilterWorkflow"})(sg||(sg={}));var Eh;(function(fe){fe[fe.Unknown=0]="Unknown";fe[fe.NoOutput=
1]="NoOutput";fe[fe.Authentication=2]="Authentication";fe[fe.JoinTimedOut=3]="JoinTimedOut";fe[fe.LambdaThrow=4]="LambdaThrow";fe[fe.LambdaErrorCallback=5]="LambdaErrorCallback"})(Eh||(Eh={}));var oh;(function(fe){fe[fe.Rnk=0]="ExceedingMaxSize";fe[fe.apk=1]="GroupComplete";fe[fe.slk=2]="BatchIntervalElapsed"})(oh||(oh={}));class Kk{constructor(fe,Ld,ze,kf,mg){this.batchesByGroupingKey=new Map;this.getOrderOfMagnitudeDimension=Wf=>0>Wf?"Negative":0===Wf?"0":1===Wf?"1":`Magnitude ${Wf.toString().length}`;
this.submit=fe;this.onSummary=kf;this.reduceBatchOperationsEnabled=Ld;this.batchMessagesEnabled=ze;this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=mg}addBatchItem(fe,Ld,ze,kf,mg,Wf){var Kf=Ld.delayMs;const Ci=Ld.delayMsMax,cj=Ld.maxInputSize;var di=Ld.estimateSize;const rj=Ld.groupingKeyExtractor;di=di(fe);const bn=rj(fe);if(Ld.split&&di>cj){let as;try{as=Ld.split(fe)}catch(sk){kf=Error("Split error: "+sk.message);Wf?Wf(kf):tb.error(573366352,Oc.CoreDefault,kf);return}if(as&&Array.isArray(as.inputs)&&
1<as.inputs.length){let sk;const jf=[];fe=Wf?(yk,pq)=>{sk=sk||yk;jf.push(pq);if(jf.length===as.inputs.length){let bs;try{bs=as.join(jf)}catch(Uq){Wf(Error("Join error: "+Uq.message));return}Wf(sk,bs)}}:void 0;for(Kf=0;Kf<as.inputs.length;Kf++)this.addBatchItem(as.inputs[Kf],Ld,ze,kf,mg&&Kf===as.inputs.length-1,fe);return}}let lo=this.batchesByGroupingKey.get(bn);lo&&lo.size+di>cj&&(this.executeBatch(bn,lo,Ld,oh.Rnk),lo=void 0);lo||(lo={items:[],size:0,hasItemsWithCallbacks:!1,context:ze,creationTime:Date.now()},
this.batchesByGroupingKey.set(bn,lo));this.batchMessagesEnabled?(ze=lo.items[lo.items.length-1])&&ze.cv===kf&&ze.callback===Wf?(ze.input=[...ze.input,...fe],ze.size+=di):lo.items.push({input:fe,size:di,cv:kf,callback:Wf}):lo.items.push({input:fe,size:di,callback:Wf});lo.size+=di;lo.hasItemsWithCallbacks=lo.hasItemsWithCallbacks||!!Wf;this.batchMessagesEnabled||(lo.cv=kf);lo.groupComplete=mg;lo.groupComplete?this.executeBatch(bn,lo,Ld,oh.apk):(Date.now()-lo.creationTime+Kf<Ci&&(clearTimeout(lo.timeout),
lo.timeout=void 0),lo.timeout||(lo.timeout=setTimeout(()=>{this.executeBatch(bn,lo,Ld,oh.slk)},Kf)))}removeAllBatchedItems(){this.batchesByGroupingKey.forEach(fe=>{fe.timeout&&clearTimeout(fe.timeout)});this.batchesByGroupingKey.clear()}reduceBatchOperations(fe){const Ld=(new Za({operationName:"ReduceBatchOperations"})).start();let ze=0,kf=0,mg=0;const Wf=new Set,Kf=[];for(const Ci of fe.input.reverse()){const cj=[];for(const di of Ci.input.reverse())if(Ai.q.typeGuard(di)){const rj=[];for(const bn of di.items){mg++;
const lo=di.parentPath.toString()+"/"+di.parentRevId+"/"+bn.id;Wf.has(lo)?kf++:(rj.push(bn),Wf.add(lo),ze++)}0!==rj.length&&(di.items=rj,cj.push(di))}else{if(Ai.a.typeGuard(di))for(const rj of di.items)Wf.delete(di.parentPath.toString()+"/"+di.parentRevId+"/"+rj.id);cj.push(di)}0!==cj.length&&Kf.push({input:cj.reverse(),size:Ci.size,cv:Ci.cv,callback:Ci.callback})}fe.input=Kf.reverse();0!=mg&&(Ld.dimension0=`${this.getOrderOfMagnitudeDimension(kf)}`,Ld.dimension1=`noOp: ${0===kf}`);Ld.success=mg-
kf==ze?!0:!1;tb.info(507839488,Oc.CoreDefault,Ld.stop())}maxNumberOfDeltaUpdateOpsPerItemPerBatch(fe){let Ld=0;const ze=new Map;for(const kf of fe.input)if(Ai.d.typeGuard(kf))for(const mg of kf.items)fe=kf.parentPath.toString()+"/"+mg.id,ze.has(fe)||ze.set(fe,0),ze.set(fe,ze.get(fe)+1),Ld=Math.max(Ld,ze.get(fe));return Ld}executeBatch(fe,Ld,ze,kf){clearTimeout(Ld.timeout);Ld.timeout=void 0;this.batchesByGroupingKey.delete(fe);const mg=Ld.items,Wf=(new Za({operationName:"ExecuteBatch",cv:this.batchMessagesEnabled?
"":Ld.cv,resourceId:Ld.context.name,resultDescription:`batching duration: ${Date.now()-Ld.creationTime}ms`,dimension0:`${this.batchMessagesEnabled?"Batched items count":"Batched ops count:"} ${this.getOrderOfMagnitudeDimension(mg.length)}`,dimension1:`Size ${this.getOrderOfMagnitudeDimension(Ld.size)}`,dimension2:kf.toString()})).start(),Kf=(cj,di,rj)=>{let bn;if(di&&di.exceptionType===Eh.NoOutput)Wf.success=!0,tb.info(573366353,Oc.CoreDefault,Wf.stop());else{const lo=`${cj} error: ${di?di.message||
di:"Unknown error"}`;bn=di||Error(lo);Wf.success=!1;Wf.resultDescription=`Batch of ${mg.length} items of size ${Ld.size} with ${lo}`;Wf.resultSignature=`${cj} Error`;tb.error(573366354,Oc.CoreDefault,Wf.stop())}if(Ld.hasItemsWithCallbacks)for(const lo of mg)lo.callback&&lo.callback(bn,rj)};let Ci;try{Ci=ze.multiplex(this.batchMessagesEnabled?mg:mg.map(cj=>cj.input))}catch(cj){Kf("Multiplex",cj);return}this.reduceBatchOperationsEnabled&&this.batchMessagesEnabled&&"operations"==fe&&this.reduceBatchOperations(Ci);
!this.batchMessagesEnabled&&"operations"==fe&&this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled&&(Wf.dimension3=this.getOrderOfMagnitudeDimension(this.maxNumberOfDeltaUpdateOpsPerItemPerBatch(Ci)));this.submit(Ci.input,Ld,(cj,di)=>{if(cj||di&&("exceptionType"in di||di instanceof Error))Kf("Submit",cj||di,di);else if(Ld.hasItemsWithCallbacks||ze.summaryExtractor){let rj;if(Ld.hasItemsWithCallbacks)try{if(rj=Ci.demultiplex(di),rj.length!==mg.length)throw Error("Mismatched output length");}catch(as){Kf("Demultiplex",
as);return}let bn,lo;if(ze.summaryExtractor)try{[lo,bn]=ze.summaryExtractor(di)}catch(as){Kf("SummaryExtractor",as);return}Wf.success=!0;tb.info(573366342,Oc.CoreDefault,Wf.stop());if(Ld.hasItemsWithCallbacks)for(cj=0;cj<mg.length;cj++)mg[cj].callback&&mg[cj].callback(void 0,rj[cj]);if(bn)this.onSummary(lo,bn,Ld.context)}else Wf.success=!0,tb.info(573366343,Oc.CoreDefault,Wf.stop())})}}var jg=v(42124),Gh;(function(fe){fe[fe.SingleItem=0]="SingleItem";fe[fe.Reduce=1]="Reduce";fe[fe.Grid=2]="Grid";
fe[fe.DynamicText=3]="DynamicText";fe[fe.Join=4]="Join";fe[fe.Generic=5]="Generic"})(Gh||(Gh={}));var Nh;(function(fe){fe.Default="Default";fe.Copilot="Copilot"})(Nh||(Nh={}));var xf;(function(fe){fe[fe.None=0]="None";fe[fe.ContentFiltering_M365Copilot=1]="ContentFiltering_M365Copilot"})(xf||(xf={}));var fj;(function(fe){fe[fe.Default=0]="Default";fe[fe.LocalOnly=1]="LocalOnly";fe[fe.Exclusive=2]="Exclusive"})(fj||(fj={}));var ch;(function(fe){fe[fe.PreActivate=0]="PreActivate";fe[fe.Default=1]="Default";
fe[fe.DelayActivate=1]="DelayActivate";fe[fe.NeverActivate=2]="NeverActivate"})(ch||(ch={}));var Ig;(function(fe){fe[fe.Required=-3]="Required";fe[fe.Optional=-1]="Optional"})(Ig||(Ig={}));var Zg;(function(fe){fe[fe.Never=0]="Never";fe[fe.Always=1]="Always"})(Zg||(Zg={}));var Fj;(function(fe){fe[fe.PreSeed=1]="PreSeed";fe[fe.OnSeed=2]="OnSeed";fe[fe.PostSeed=4]="PostSeed";fe[fe.All=5]="All"})(Fj||(Fj={}));var Qe;(function(fe){fe[fe.UpstreamWorkflowsReady=0]="UpstreamWorkflowsReady";fe[fe.AnnotationMetadataUpdated=
1]="AnnotationMetadataUpdated";fe[fe.DeltaUpdate=2]="DeltaUpdate";fe[fe.NonExclusiveTriggerSignals=3]="NonExclusiveTriggerSignals"})(Qe||(Qe={}));var kc;(function(fe){fe[fe.Character=1]="Character";fe[fe.Paragraph=2]="Paragraph"})(kc||(kc={}));var Hd;(function(fe){fe.Input="Input";fe.Delta="Delta";fe.UILanguage="UILanguage";fe.MaxInputCount="MaxInputCount";fe.ExtensionLimits="ExtensionLimits"})(Hd||(Hd={}));var Ce;(function(fe){fe.SetPredefinedAnnotation="SetPredefinedAnnotation";fe.ClearAnnotations=
"ClearAnnotations"})(Ce||(Ce={}));const ue=(fe,Ld)=>{const ze=[];for(const kf of null!==fe&&void 0!==fe?fe:[])if(void 0===Ld||Ld===kf.cardinality)for(const mg of kf.contextTypes)ze.push([mg,kf.cardinality,kf.producerWaitPolicy]);return ze},Yf=(fe,Ld)=>Object.assign(Object.assign({},Ld),{parentPath:fe}),Bf=fe=>Array.isArray(fe)?5===fe.length?`${fe[0]}${"\\"}${fe[1]}${"\\"}${fe[2]}${"\\"}${fe[3]}${"\\"}${fe[4]}`:4===fe.length?`${fe[0]}${"\\"}${fe[1]}${"\\"}${fe[2]}${"\\"}${fe[3]}`:3===fe.length?`${fe[0]}${"\\"}${fe[1]}${"\\"}${fe[2]}`:
2===fe.length?`${fe[0]}${"\\"}${fe[1]}`:1===fe.length?fe[0]:fe.join("\\"):"(malformed path)";var bf;(function(fe){fe[fe.Local=0]="Local";fe[fe.External=1]="External"})(bf||(bf={}));class Jg{constructor(){this.graphNodeByLocationAndWorkflowId=new Map}getWorkflow(fe,Ld){var ze;Ld=this.getLocation(Ld);return null===(ze=this.graphNodeByLocationAndWorkflowId.get(Ld))||void 0===ze?void 0:ze.get(fe)}addWorkflow(fe,Ld=!1){if(this.getWorkflow(fe.id,Ld))fe=(new Za({operationName:"AddWorkflowToGraphFailure",
success:!1,resourceId:fe.id,resultDescription:`Adding a new with workflow with a duplicated workflowId: ${Ld}`})).start(),tb.error(524300630,Oc.CoreDefault,fe.stop());else{Ld=this.getLocation(Ld);var ze=new Lg(fe,Ld);this.addWorkflowAsDependency(ze);var kf=this.graphNodeByLocationAndWorkflowId.get(Ld);kf||(kf=new Map,this.graphNodeByLocationAndWorkflowId.set(Ld,kf));kf.set(fe.id,ze)}}getUpstreamRuntimeVisibleWorkflows(){const fe=[];for(const Ld of this.graphNodeByLocationAndWorkflowId.values()||[])for(const ze of Ld.values()||
[]){const kf=this.createWorkflowDefinition(ze.workflow);ze.workflow.visibility===fj.LocalOnly?this.compressDownstreamWorkflows(kf,ze):kf.outputTypes.push(...ze.workflow.outputTypes);0!==kf.inputTypes.length&&fe.push(kf)}return fe}removeWorkflows(fe){fe=this.getLocation(fe);fe=this.graphNodeByLocationAndWorkflowId.get(fe);const Ld=Array.from((null===fe||void 0===fe?void 0:fe.values())||[]);for(const ze of Ld){for(const kf of ze.upstreamWorkflows.values())kf.downstreamWorkflows.delete(ze);for(const kf of ze.downstreamWorkflows.values())kf.upstreamWorkflows.delete(ze);
fe.delete(ze.workflow.id)}}getWorkflowsDefinitions(){const fe=[];for(const Ld of this.graphNodeByLocationAndWorkflowId.values()||[])for(const ze of Ld.values()||[])fe.push(ze.workflow);return fe}getWorkflowNodes(){const fe=[];for(const Ld of this.graphNodeByLocationAndWorkflowId.values())for(const ze of Ld.values())fe.push(ze);return fe}getLocation(fe){return fe?bf.External:bf.Local}createWorkflowDefinition(fe){return Object.assign(Object.assign({},fe),{outputTypes:[]})}compressDownstreamWorkflows(fe,
Ld){for(const ze of Ld.downstreamWorkflows)if(ze.workflow.visibility===fj.LocalOnly)this.compressDownstreamWorkflows(fe,ze);else if(ze.workflow.kind!==Gh.Join||-1!==fe.inputTypes.indexOf(ze.workflow.collectionScopeType))for(const kf of ze.workflow.outputTypes)-1===fe.outputTypes.indexOf(kf)&&fe.outputTypes.push(kf)}addWorkflowAsDependency(fe){for(const Ld of this.graphNodeByLocationAndWorkflowId.values())for(const ze of Ld.values()){for(const kf of ze.workflow.inputTypes)-1!==fe.workflow.outputTypes.indexOf(kf)&&
this.addWorkflowChain(fe,ze);for(const kf of ze.workflow.outputTypes)-1!==fe.workflow.inputTypes.indexOf(kf)&&this.addWorkflowChain(ze,fe)}}addWorkflowChain(fe,Ld){fe.downstreamWorkflows.add(Ld);Ld.upstreamWorkflows.add(fe)}}class Lg{constructor(fe,Ld){this.isActivated=!0;this.upstreamWorkflows=new Set;this.downstreamWorkflows=new Set;this.location=Ld;this.workflow=Object.assign(Object.assign({},fe),{inputTypes:Array.isArray(fe.inputTypes)?fe.inputTypes:[],outputTypes:Array.isArray(fe.outputTypes)?
fe.outputTypes:[]})}}const qh=(fe,Ld,ze)=>{let kf=fe.get(Ld);kf||(kf=ze(),fe.set(Ld,kf));return kf},Qf=fe=>({id:fe.id,kind:fe.kind,visibility:fe.visibility,collectionScopeType:fe.collectionScopeType,inputTypes:fe.inputTypes,outputTypes:fe.outputTypes,correlatedSignals:fe.correlatedSignals}),Cf=(fe,Ld)=>void 0===fe||null===fe||void 0===Ld||null===Ld?!1:0<fe.length&&(fe===Ld||0===Ld.indexOf(fe)&&"."===Ld.charAt(fe.length));class Sg{constructor(){this.workflowDefByWorkflowAndContextId=new Map;this.workflowDefByWorkflow=
new Map}static mergeDefinitions(fe,Ld,ze){return Object.assign(Object.assign(Object.assign({},fe),Ld),ze)}mergeWorkflowDefinition(fe,Ld,ze){if(ze){const kf=qh(this.workflowDefByWorkflowAndContextId,fe.id,()=>new Map);kf.set(ze,Sg.mergeDefinitions(fe,kf.get(ze),Ld))}else this.workflowDefByWorkflow.set(fe.id,Sg.mergeDefinitions(fe,this.workflowDefByWorkflow.get(fe.id),Ld))}getWorkflowDefinition(fe,Ld){var ze;let kf;Ld&&(kf=null===(ze=this.workflowDefByWorkflowAndContextId.get(fe.id))||void 0===ze?void 0:
ze.get(Ld));kf||(kf=this.workflowDefByWorkflow.get(fe.id));kf||(kf=fe);return kf}deleteWorkflowDefinition(fe,Ld){const ze=this.workflowDefByWorkflowAndContextId.get(fe.id);ze&&(ze.delete(Ld),0===ze.size&&this.workflowDefByWorkflowAndContextId.delete(fe.id))}}const Oh=new Set([Ai.a.getTypeName(),Ai.q.getTypeName(),Ai.o.getTypeName(),Ai.d.getTypeName()]);class Ep{constructor(fe,Ld){this.nextId=1;this.runtimeKind=fe;this.workflowGraph=Ld}static isParentContextId(fe,Ld){return Cf(fe,Ld)}applyContextIdOnOperations(fe){for(const Ld of fe)if(fe=
pf.a.getTypeNameFor(Ld),this.isSupportedOperation(fe))for(const ze of Ld.items)ze.contextId?ze.source&&this.workflowGraph.getWorkflow(ze.source,!1)?ze.contextId=this.addNewContextId(ze.contextId):this.tryLogMessage((new Za({operationName:"ApplyContextIdOnOperations",success:!0})).start(),"Item with a contextId but without a workflow source atribute"):ze.contextId=this.addNewContextId()}addNewContextId(fe){const Ld=`${this.runtimeKind}${this.nextId++}`;return fe?`${fe}.${Ld}`:Ld}isSupportedOperation(fe){return Oh.has(fe)}tryLogMessage(fe,
Ld,ze=!0){fe&&(fe.success=ze,fe.resultDescription=Ld,tb.verbose(527308633,Oc.CoreDefault,fe.stop()))}}var jk;(function(fe){fe[fe.Idle=1]="Idle";fe[fe.Pending=2]="Pending";fe[fe.Running=3]="Running";fe[fe.Executed=4]="Executed"})(jk||(jk={}));class Hh{constructor(fe){this.scopeItemsByContextId=new Map;this.itemsByWorkflowAndContextId=new Map;this.workflowDefinitionManager=fe}setScopeItem(fe,Ld){var ze;const kf=fe.contextId;if(kf)if(this.itemsByWorkflowAndContextId.has(Ld.id)||this.itemsByWorkflowAndContextId.set(Ld.id,
new Map),this.itemsByWorkflowAndContextId.get(Ld.id).set(kf,[]),!this.scopeItemsByContextId.has(kf))this.scopeItemsByContextId.set(kf,fe);else if(null===(ze=this.itemsByWorkflowAndContextId.get(Ld.id))||void 0===ze?0:ze.has(kf))fe=(new Za({resultDescription:`Trying to set new scope item: ${fe.id} with already existing contextId ${kf} for workflow ${Ld.id}`,operationName:"WIS.setScopeItem",resourceId:Ld.id,success:!0})).start(),tb.verbose(527291288,Oc.CoreDefault,fe.stop())}updateScopeItemPath(fe,
Ld,ze){var kf,mg;if(fe){var Wf=this.scopeItemsByContextId.get(fe);if(Wf){var Kf=Wf.parentPath;this.scopeItemsByContextId.set(fe,Yf(Ld,Wf));ze=null!==(mg=null===(kf=this.itemsByWorkflowAndContextId.get(ze.id))||void 0===kf?void 0:kf.get(fe))&&void 0!==mg?mg:[];for(fe=0;fe<ze.length;fe++)ze[fe]=Yf([...Ld,...ze[fe].parentPath.slice(0,Kf.length)],ze[fe])}}}getScopeItem(fe,Ld){var ze;for(const kf of(null===(ze=this.itemsByWorkflowAndContextId.get(Ld.id))||void 0===ze?void 0:ze.keys())||[])if(Cf(kf,fe))return this.scopeItemsByContextId.get(kf)}addItemToWorkflowList(fe,
Ld){const ze=fe.contextId;if(ze){var kf=this.itemsByWorkflowAndContextId.get(Ld.id);if(kf)for(const [mg,Wf]of kf)Cf(mg,ze)&&(Wf.push(fe),kf=(new Za({resultDescription:`Items for contextId ${mg}: [${Wf.map(Kf=>Kf.id).join(",")}]`,operationName:"WIS.addItemOnContextIdList",resourceId:Ld.id,success:!0})).start(),tb.info(526403808,Oc.CoreDefault,kf.stop()))}}isWorkflowReady(fe,Ld){const ze=this.workflowDefinitionManager.getWorkflowDefinition(Ld,fe).maxAnnotations;return this.getGeneratedItems(fe,Ld).length>=
ze}getItemsToExecute(fe,Ld){const ze=this.getGeneratedItems(fe,Ld);this.itemsByWorkflowAndContextId.get(Ld.id).delete(fe);return ze}onWorkflowExecuted(fe,Ld){fe=fe.contextId;const ze=this.itemsByWorkflowAndContextId.get(Ld.id);ze&&(ze.delete(fe),0===ze.size&&this.itemsByWorkflowAndContextId.delete(Ld.id));this.hasWorkflowsAwaitingExecution(fe)||this.scopeItemsByContextId.delete(fe)}getGeneratedItems(fe,Ld){var ze;if(null===(ze=this.itemsByWorkflowAndContextId.get(Ld.id))||void 0===ze||!ze.get(fe))return[];
ze=this.workflowDefinitionManager.getWorkflowDefinition(Ld,fe).maxAnnotations;return this.itemsByWorkflowAndContextId.get(Ld.id).get(fe).slice(0,ze)}hasWorkflowsAwaitingExecution(fe){for(const Ld of this.itemsByWorkflowAndContextId.values())for(const ze of Ld.keys())if(ze===fe)return!0;return!1}}var Xh;(function(fe){fe.JsClient="C";fe.Server="S"})(Xh||(Xh={}));var ho=v(65175),ki=v(39384),Vk=v(35481);const Ij=/[ \u00a0\u2000-\u200a\u202f\u205f\u3000\t]/g,ik=/[.!?]/g;class Ph{constructor(){this.deltaBuilderHandlers=
new Map;this.registerDeltaBuilderHandler(ho.b.getTypeName(),U);this.registerDeltaBuilderHandler(ho.a.getTypeName(),Q)}registerDeltaBuilderHandler(fe,Ld){this.deltaBuilderHandlers.set(fe,Ld)}executeDeltaBuilderHandler(fe,Ld,ze){return(fe=this.deltaBuilderHandlers.get(fe))?fe(Ld,ze):[]}}const Pl=(fe,Ld)=>Ld?[...Ld,fe].join("\\"):fe;class Qi{constructor(fe){this.createTextTileDeltasFromItem=(Ld,ze)=>{var kf;const mg=(new Za({operationName:"CreateTextTileDeltaFromItem",success:!0})).start();try{if(Ld)if(Ld.body){var Wf=
Ld.body;if(ho.b.typeGuard(Wf)){var Kf=Pl(Ld.id,ze),Ci=null!==(kf=this.lastSeenTileByTileId.get(Kf))&&void 0!==kf?kf:new ho.b({content:""}),cj=this.createDeltas(Ci,Wf);cj&&0!==cj.length?(mg.dimension0=cj.length.toString(),this.lastSeenTileByTileId.set(Kf,Wf)):(mg.dimension0="0",mg.resultDescription="No delta differences found");tb.info(524883087,Oc.CoreDefault,mg.stop());return cj}mg.success=!1;mg.resultDescription=`Unable to create text tile delta, parent item body is not proper type: expected ${ho.b.getTypeName()}, received ${pf.a.getTypeNameFor(Wf)}`}else mg.success=
!1,mg.resultDescription="Unable to create text tile delta, parent item has undefined body",tb.info(524883086,Oc.CoreDefault,mg.stop());else mg.success=!1,mg.resultDescription="Unable to create text tile delta, parent item is undefined",tb.info(524883085,Oc.CoreDefault,mg.stop())}catch(di){mg.success=!1,mg.resultDescription=`Error creating text tile delta: ${di}`,tb.info(524883088,Oc.CoreDefault,mg.stop())}};this.lastSeenTileByTileId=null!==fe&&void 0!==fe?fe:new Map;this.deltaBuilder=new Ph}addItemToLocalMap(fe,
Ld){Ld=Pl(fe.id,Ld);fe=fe.body;ho.b.typeGuard(fe)&&!this.lastSeenTileByTileId.has(Ld)&&this.lastSeenTileByTileId.set(Ld,fe)}deleteItemFromLocalMap(fe,Ld){fe=Pl(fe.id,Ld);this.lastSeenTileByTileId.has(fe)&&this.lastSeenTileByTileId.delete(fe)}moveItemsInLocalMap(fe,Ld,ze){ze=new Set(ze);Ld=Ld.join("\\");fe=fe.join("\\");const kf=[];for(const [Wf,Kf]of this.lastSeenTileByTileId)if(Wf.startsWith(Ld)){var mg=Wf.length>Ld.length?Wf.substring(Ld.length+1).split("\\")[0]:void 0;if(void 0===mg||ze.has(mg))mg=
Wf.replace(Ld,fe),kf.push({item:Kf,bao:mg,IAo:Wf})}for(const Wf of kf)this.lastSeenTileByTileId.delete(Wf.IAo),this.lastSeenTileByTileId.set(Wf.bao,Wf.item)}createDeltas(fe,Ld){return this.deltaBuilder.executeDeltaBuilderHandler(pf.a.getTypeNameFor(Ld),fe,Ld)}}const zn=fe=>{var Ld=Number.POSITIVE_INFINITY;let ze=0;const kf=[];for(fe=[fe];0<fe.length;){const mg=fe.pop(),Wf=typeof mg;if("boolean"===Wf)ze+=4;else if("string"===Wf)ze+=2*mg.length;else if("number"===Wf)ze+=8;else if("object"===Wf&&mg&&
-1===kf.indexOf(mg))if(mg instanceof Uint8Array)ze+=mg.length;else{kf.push(mg);for(const Kf in mg)fe.push(mg[Kf])}if(ze>Ld)break}return ze},om=(fe,Ld)=>{Ld?(fe.resultDescription=Ld,fe.success=!1,tb.error(507646878,Oc.CoreDefault,fe.stop())):tb.info(507646877,Oc.CoreDefault,fe.stop())};class Hn extends Mf.EventEmitter{init(){return Promise.resolve()}sendMessage(){}onMessage(){}forceReconnect(){return Promise.resolve()}closeSession(){}sendBytes(){}getCorrelationVector(){return new rd}getNetworkWorkerManager(){}setState(){}}
var gn;(function(fe){fe[fe.LocalWorkflow=0]="LocalWorkflow";fe[fe.ServerWorkflow=1]="ServerWorkflow";fe[fe.Submitted=2]="Submitted"})(gn||(gn={}));const $p=(fe,Ld)=>{Ld?(fe.resultDescription=Ld,fe.success=!1,tb.error(509203144,Oc.CoreDefault,fe.stop())):tb.info(509203143,Oc.CoreDefault,fe.stop())},cp=fe=>!fe.items.some(Ld=>Ld.source&&0===Ld.source.indexOf("ThirdParty"));class Lk{constructor(fe){var Ld;this.annotationActivationTrackers=new Map;this.annotationCallbacks=new Map;this.apologyCallbacks=
new Map;this.annotationResultStates=new Map;this.tokensByAnnotationType=new Map;this.registeredContextTypes=new Set;this.availableContexts=new Map;this.nextSyncSequenceId=1;this.allowGroupSeed=this.allowSeed=!0;this.batchedSeedMessageGroupSize=this.seedGroupSize=0;this.isSessionClosed=this.hasSessionConnected=!1;this.serverAuthenticationState=Fc.a.NotAuthenticated;this.sessionCloseCallbacks=new Map;this.connectCallbacks=new Map;this.reconnectCallbacks=new Map;this.disconnectCallbacks=new Map;this.sessionStateCallbackToken=
0;this.workflowGraph=new Jg;this.workflowDefinitionManager=new Sg;this.contextIdManager=new Ep(Xh.JsClient,this.workflowGraph);this.workflowItemStorage=new Hh(this.workflowDefinitionManager);this.pendingConnectCallbacks=[];this.batchMessagesEnabled=this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=this.reduceBatchOperationsEnabled=this.onAnnotationsSubmittedEnabled=!1;this.seedingStatus=Me.NotStarted;this.isChangeGateForceUserInteractiveAuth=void 0;this.cachedClaimsChallenge={claimsVersion:0,SVd:!1};
this.tokenMessageVersion=1;this.hostCallbacks=fe.hostCallbacks;this.sessionManager=fe.sessionManager;this.batchMessagesEnabled=fe.batchMessagesEnabled||!1;this.reduceBatchOperationsEnabled=fe.reduceBatchOperationsEnabled||!1;this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=fe.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled||!1;this.operationBatchConfig=fe.batchOptions?this.getOperationBatchConfig(fe.batchOptions):void 0;this.extensionConfigs=fe.extensionConfigs;this.clientMetadata=fe.clientMetadata;
this.userContext=fe.userContext;this.localWorkflowManager=fe.localWorkflowManager;this.annotationResultsProcessor=fe.annotationResultsProcessor;this.gateUtils=fe.gateUtils;this.localRegisteredWorkflows=fe.localRegisteredWorkflows||[];this.enableRemoteExecutionNotification=fe.enableRemoteExecutionNotification||!1;this.networkMode=fe.networkMode;this.egress=fe.egress;this.serverAuthenticationStateChangeCallback=[];this.claimsChallengeCallback=[];this.seedingStatusChangeCallbacks=[];this.onAnnotationsSubmittedEnabled=
fe.onAnnotationsSubmittedEnabled||!1;this.annotationDoesNotExistOnServiceEnabled=fe.annotationDoesNotExistOnServiceEnabled||!1;this.sessionManager.on("sessionClose",this.onSessionClose.bind(this));this.sessionManager.on("reconnect",this.onReconnect.bind(this));this.sessionManager.on("connect",this.onConnect.bind(this));this.sessionManager.on("disconnect",this.onDisconnect.bind(this));this.sessionManager.on("resetNextSyncSequenceId",this.resetNextSyncSequenceId.bind(this));this.sessionManager.on("serverAuthenticationStateChange",
this.onServerAuthenticationStateChange.bind(this));this.sessionManager.onMessage(Ub.g.getTypeName(),this.onAnnotationResultsFromServer.bind(this));this.sessionManager.onMessage(Ub.f.getTypeName(),this.onAnnotationResultStateMessage.bind(this));this.sessionManager.onMessage(Ub.s$b.getTypeName(),this.onWorkflowExecutionCompleteMessage.bind(this));this.sessionManager.onMessage(Ub.k.getTypeName(),this.onClaimsChallengeMessage.bind(this));this.sessionManager.onMessage(Ub.q.getTypeName(),this.onSeedingStatusChangeMessage.bind(this));
fe.isDeltaGeneratorEnabled&&(this.enableSyncDeltaSending=!fe.disableSyncDeltaSending,this.syncDeltaTimeout=null!==(Ld=fe.syncDeltaTimeout)&&void 0!==Ld?Ld:700,this.enableDeltaGenerator());this.setServerAuthenticationStateChangeCallback(this.updateGraphOnAuthStateChange.bind(this));this.setClaimsChallengeCallback(this.requestAuthTokenWithClaims.bind(this))}getSessionReconnectParams(){if(!this.connectParams)throw Error("Session has not been established yet.");return{sessionUrl:this.connectParams.sessionUrl,
origin:this.connectParams.origin,authToken:this.connectParams.authToken,nextSyncSequenceId:this.nextSyncSequenceId}}setNextSequenceId(fe){this.nextSyncSequenceId=fe}tryGetDocSessionId(){if(this.clientMetadata&&this.clientMetadata.docSessionId)return this.clientMetadata.docSessionId}getSessionStateCallbackToken(fe){var Ld;return fe+"-callback-"+(null!==(Ld=this.tryGetDocSessionId())&&void 0!==Ld?Ld:"unknown")+"-"+this.sessionStateCallbackToken++}updateGraphOnAuthStateChange(){this.tryActivateWorkflows()}tryActivateWorkflows(){if(this.enableRemoteExecutionNotification){const fe=
(new Za({operationName:"GraphServerWorkflowActivation",success:!0})).setClientMetadata(this.clientMetadata).start(),Ld=[];this.workflowGraph.getWorkflowNodes().filter(ze=>ze.location===bf.External).forEach(ze=>{this.localWorkflowManager.canActivateWorkflow(ze,this)?ze.isActivated=!0:(this.localWorkflowManager.deactivateServerWorkflow(ze,this),Ld.push(ze.workflow.id))});fe.resultDescription=`deactivated workflows: [${Ld.join()}]`;tb.info(508879493,Oc.CoreDefault,fe.stop())}}initialize(){this.localWorkflowManager&&
this.localWorkflowManager.addSession(this);this.registerLocalWorkflowsWithoutGraphInit(this.localRegisteredWorkflows);return this.sessionManager.init(this.extensionConfigs,this.hostCallbacks.onInitSession?this.hostCallbacks.onInitSession:void 0,this.egress).then(()=>{this.localWorkflowManager&&this.localWorkflowManager.setTokenCallback(this.getAuthToken.bind(this));return this})}isLocalWorkflowRegistered(fe){return this.getLocalRegisteredWorkflows().some(Ld=>fe===Ld.id)}get isConnected(){return!!this.connectParams}get hasConnected(){return this.hasSessionConnected}get isClosed(){return this.isSessionClosed}getServerAuthenticationState(){return this.serverAuthenticationState}getContextIdManager(){return this.contextIdManager}getWorkflowItemStorage(){return this.workflowItemStorage}getWorkflowDefinition(fe,
Ld){return this.workflowDefinitionManager.getWorkflowDefinition(fe,Ld)}registerLocalWorkflows(fe){this.registerLocalWorkflowsWithoutGraphInit(fe);this.trySendWorkflowGraphInitMessage()}registerLocalWorkflowsWithoutGraphInit(fe){if(fe.length&&this.localWorkflowManager)for(const Ld of fe)this.localWorkflowManager.registerLocalWorkflow(Ld,this)}registerLocalWorkflow(fe){this.registerLocalWorkflows([fe]);fe=(new Za({operationName:"SessionRegisterLocalWorkflow",resourceId:fe.id,success:!0})).setClientMetadata(this.clientMetadata).start();
$p(fe)}activateAnnotation(fe,Ld){var ze;const kf=new Sf(this.sendMessageToSession.bind(this),fe,Ld,this.annotationDoesNotExistOnServiceEnabled);var mg=(Wf,Kf)=>{let Ci=Wf.get(fe);Ci||(Ci=new Map,Wf.set(fe,Ci));Ci.set(kf.token,Kf)};(null===Ld||void 0===Ld?0:Ld.callback)&&mg(this.annotationCallbacks,null===Ld||void 0===Ld?void 0:Ld.callback);(null===Ld||void 0===Ld?0:Ld.apologyCallback)&&mg(this.apologyCallbacks,null===Ld||void 0===Ld?void 0:Ld.apologyCallback);mg=null!==(ze=this.tokensByAnnotationType.get(fe))&&
void 0!==ze?ze:[];-1===mg.indexOf(kf.token)&&mg.push(kf.token);this.tokensByAnnotationType.set(fe,mg);this.annotationActivationTrackers.set(kf.token,kf);return this.activateAnnotationForTracker(kf,{ignoreExistingAnnotations:!1,YAe:!1,sendApologies:void 0!==(null===Ld||void 0===Ld?void 0:Ld.apologyCallback)})}activateAnnotationForTracker(fe,Ld){const ze=(new Za({operationName:"ActivateAnnotation",resourceId:fe.annotationType,success:!0})).setClientMetadata(this.clientMetadata).start();return fe.activate(Ld.ignoreExistingAnnotations,
Ld.YAe,Ld.sendApologies).then(kf=>{ze.resultSignature="Ok";ze.resultDescription=`Activated annotation ${fe.annotationType} with token ${fe.token}; sendOnlyIfConnected: ${Ld.YAe}`;$p(ze);return kf}).catch(kf=>{$p(ze,`error on activate annotation type ${fe.annotationType}: ${kf}; sendOnlyIfConnected: ${Ld.YAe}`);throw kf;})}updateAnnotationConfig(fe,Ld){const ze=new Ub.c({token:fe,config:Ld});this.sendMessageToSession(ze);(fe=this.annotationActivationTrackers.get(fe))&&fe.options&&(fe.options.config=
Ld)}releaseAnnotation(fe){const Ld=this.annotationActivationTrackers.get(fe);if(Ld){this.annotationActivationTrackers.delete(fe);const ze=kf=>{const mg=kf.get(Ld.annotationType);mg&&(mg.delete(fe),0==mg.size&&kf.delete(Ld.annotationType))};ze(this.annotationCallbacks);ze(this.apologyCallbacks);return Ld.release()}return Promise.resolve(!1)}setAnnotationState(fe,Ld,ze){this.submitOperation(new Ai.p({parentPath:fe,items:[{id:Ld}],M_:{state:ze}}))}setAnnotationMetadata(fe,Ld,ze){this.submitOperation(new Ai.p({parentPath:fe,
items:[{id:Ld}],M_:ze}))}submitOperation(fe,Ld){this.submitOperations([fe],Ld)}submitOperations(fe,Ld){var ze,kf;Ld||(Ld=this.generateCorrelationId());wl(fe,Ld,Date.now(),"SubmitInRuntimeClient",(new Za({operationName:"AugloopClientPerfTracker",success:!0})).setClientMetadata(this.clientMetadata).start());this.contextIdManager.applyContextIdOnOperations(fe);this.updateWorkflowExecutionStates(fe);if(!this.onAnnotationsSubmittedEnabled){var [mg]=this.partitionAnnotationOperations(fe);this.executeCallbacksOnAnnotationSubmitted(mg,
Ld)}mg=fe.filter(this.filterOperationsForSession.bind(this)).filter(cp);const Wf=[];if(this.deltaGenerator){const Kf=(new Za({operationName:"ExecuteDeltaGenerator",success:!0})).setClientMetadata(this.clientMetadata).start();for(const Ci of mg)if(Ai.q.typeGuard(Ci))Wf.push(...this.createDeltasFromUpdateOperation(Ci));else{const cj=Ci;for(const di of cj.items)Ai.a.typeGuard(Ci)?this.deltaGenerator.addItemToLocalMap(di,cj.parentPath):Ai.c.typeGuard(Ci)?this.deltaGenerator.deleteItemFromLocalMap(di,
cj.parentPath):Ai.i.typeGuard(Ci)&&this.deltaGenerator.moveItemsInLocalMap(Ci.parentPath,Ci.prevParentPath,null!==(kf=null===(ze=Ci.items)||void 0===ze?void 0:ze.map(rj=>rj.id))&&void 0!==kf?kf:[]);Wf.push(Ci)}$p(Kf)}if(this.onAnnotationsSubmittedEnabled){const [Kf,Ci]=this.partitionAnnotationOperations(Wf.length?Wf:mg);this.onAnnotationsSubmitted(Kf,Ld);this.submitOperationsToSession(Ci,Ld)}else this.submitOperationsToSession(Wf.length?Wf:mg,Ld);this.localWorkflowManager&&this.localWorkflowManager.runLocalWorkflows(fe,
this,!0)}submitSeedOperations(fe,Ld){if(!this.allowSeed)throw Error("Cannot submit seed operations more than once per session");if(this.networkMode===Dl.LocalWorkflowsOnly&&this.localWorkflowManager)this.localWorkflowManager.runLocalWorkflows(fe,this);else{Ld||(Ld=this.generateCorrelationId());this.allowGroupSeed=this.allowSeed=!1;var [ze,kf]=this.partitionAnnotationOperations(fe);if(this.onAnnotationsSubmittedEnabled)this.onAnnotationsSubmitted(ze,Ld);else this.executeCallbacksOnAnnotationSubmitted(ze,
Ld);this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(this.onAnnotationsSubmittedEnabled?kf:fe,!0,Ld):this.sendMessageToSession(new Ub.E({cv:Ld,seq:0,ops:this.onAnnotationsSubmittedEnabled?kf:fe}))}}submitSeedGroupOperations(fe,Ld,ze){if(!this.allowGroupSeed)throw Error("Seed operations are not allowed for this session");if(this.networkMode===Dl.LocalWorkflowsOnly&&this.localWorkflowManager)this.localWorkflowManager.runLocalWorkflows(fe,this);else{ze||(ze=this.generateCorrelationId());
Ld&&(this.allowGroupSeed=!1);this.allowSeed=!1;var [kf,mg]=this.partitionAnnotationOperations(fe);this.executeCallbacksOnAnnotationSubmitted(kf,ze);if(this.onAnnotationsSubmittedEnabled)this.onAnnotationsSubmitted(kf,ze);else this.executeCallbacksOnAnnotationSubmitted(kf,ze);this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(this.onAnnotationsSubmittedEnabled?mg:fe,!!Ld,ze):(this.seedGroupSize++,this.sendMessageToSession(new Ub.E({cv:ze,seq:0,ops:this.onAnnotationsSubmittedEnabled?mg:
fe,groupId:"Seed",groupSize:Ld?this.seedGroupSize:void 0,groupComplete:Ld?Ld:void 0})))}}submitCustomMessage(fe){return new Promise((Ld,ze)=>{this.sendMessageToSession(fe,(kf,mg)=>{kf?ze(Error(`${kf.error}; for message type: ${pf.a.getTypeNameFor(fe)}`)):Ld(mg)})})}submitLargeBinaryDataMessage(fe){return new Promise((Ld,ze)=>{this.sendMessageToSessionPostEndpoint(fe,(kf,mg)=>{kf?ze(Error(kf.error)):Ld(mg)})})}submitBinaryStreamUploadMessage(fe){return new Promise((Ld,ze)=>{const kf=(new Za({operationName:"sendBinaryStreamUploadMessage",
success:!0})).setClientMetadata(this.clientMetadata).start();if(this.connectParams)da(this.connectParams,fe,kf,(mg,Wf)=>{mg?ze(Error(mg.error)):Ld(Wf)});else{const mg=(Wf=>da(Wf,fe,kf,(Kf,Ci)=>{Kf?ze(Error(Kf.error)):Ld(Ci)})).bind(this);this.pendingConnectCallbacks.push(mg)}})}requestBinaryDataForBlob(fe){return fe.data?Promise.resolve(fe.data):fe.dataPointer&&fe.dataPointer.refType!==Bc.a.None?new Promise((Ld,ze)=>{this.requestBinaryDataFromSessionBlobEndpoint(fe.dataPointer,(kf,mg)=>{kf?ze(kf):
Ld(mg)})}):Promise.reject(Error("Blob does not have a data pointer"))}requestCacheDump(fe){if(fe)throw Error("NYI");return this.submitCustomMessage(new Ub.j)}forceReconnect(fe){this.extensionConfigs=fe;return this.sessionManager.forceReconnect(fe)}close(fe){this.isSessionClosed=!0;this.sessionManager.closeSession(fe);this.localWorkflowManager&&this.localWorkflowManager.closeSession(this);this.graphInitMessageTimer&&(clearTimeout(this.graphInitMessageTimer),this.graphInitMessageTimer=void 0)}authenticateInteractive(fe){return w(this,
void 0,void 0,function*(){this.gateUtils&&!this.isChangeGateForceUserInteractiveAuth&&(this.isChangeGateForceUserInteractiveAuth=yield this.gateUtils.isChangeGateEnabled("CGForceUserInteractiveAuth"));if(this.isChangeGateForceUserInteractiveAuth&&fe&&fe.forceUserPrompt||!(0<this.cachedClaimsChallenge.claimsVersion)||this.cachedClaimsChallenge.SVd){var Ld=yield this.requestAuthTokenInteractive(this.cachedClaimsChallenge,{rZi:!0});if(Ub.f7a.typeGuard(Ld))throw Error(Ld.reason);}})}getClientMetadata(){return this.clientMetadata}getUserContext(){return this.userContext}setSessionCloseCallback(fe){const Ld=
this.getSessionStateCallbackToken("close");fe&&this.sessionCloseCallbacks.set(Ld,fe);return Ld}setConnectCallback(fe){const Ld=this.getSessionStateCallbackToken("connect");fe&&this.connectCallbacks.set(Ld,fe);return Ld}setDisconnectCallback(fe){const Ld=this.getSessionStateCallbackToken("disconnect");fe&&this.disconnectCallbacks.set(Ld,fe);return Ld}setReconnectCallback(fe){const Ld=this.getSessionStateCallbackToken("reconnect");fe&&this.reconnectCallbacks.set(Ld,fe);return Ld}removeSessionStateCallback(fe){function Ld(ze){return ze.has(fe)?
(ze.delete(fe),!0):!1}return Ld(this.sessionCloseCallbacks)||Ld(this.reconnectCallbacks)||Ld(this.disconnectCallbacks)||Ld(this.connectCallbacks)}setServerAuthenticationStateChangeCallback(fe){this.serverAuthenticationStateChangeCallback.push(fe);fe(this.serverAuthenticationState)}setClaimsChallengeCallback(fe){this.cachedClaimsChallenge.SVd&&fe(this.cachedClaimsChallenge);this.claimsChallengeCallback.push(fe)}setSeedingStatusChangeCallback(fe){fe(new Ub.q({newStatus:this.seedingStatus}));this.seedingStatusChangeCallbacks.push(fe)}getConnectParams(){return this.connectParams}setOfflineMode(){this.sessionManager=
new Hn}onAnnotationResults(fe,Ld,ze){tb.info(508916486,Oc.CoreDefault,new Za({operationName:"OnAnnotationResultsEgress",dimension0:null===fe||void 0===fe?void 0:fe.annotationType,success:!0,cv:fe.cv}));ze(void 0,new Ub.p);Ld===gn.LocalWorkflow&&this.contextIdManager.applyContextIdOnOperations(fe.ops);this.updateWorkflowExecutionStates(fe.ops);this.egress&&this.egress(fe,()=>{});this.annotationResultsProcessor.process(fe,(kf,mg)=>{this.applyOperationForContext(kf,mg,Ld)},(kf,mg)=>{const Wf=Date.now();
this.triggerRegisteredAnnotationCallbacks(kf,fe.annotationType,mg,fe.areApologies);Ld===gn.ServerWorkflow&&Zm(fe,Wf,"CallbackInRuntimeClient",!0,(new Za({operationName:"AugloopClientPerfTracker",success:!0})).setClientMetadata(this.clientMetadata).start())},kf=>{if(Ld!==gn.ServerWorkflow){const mg=kf.ops.filter(this.filterOperationsForSession.bind(this)).filter(cp);this.submitOperationsToSession(mg,kf.cv)}this.localWorkflowManager&&this.localWorkflowManager.runLocalWorkflows(kf.ops,this)})}onAnnotationResultStateMessage(fe,
Ld){var ze;Ld(void 0,new Ub.p);for(const mg of fe.updates){var kf=mg.annotationType;fe=mg.state;if(this.tokensByAnnotationType.has(kf)){Ld=this.annotationResultStates.has(kf)?this.annotationResultStates.get(kf):fe===Zf.Idle?Zf.Pending:Zf.Idle;for(const Wf of this.tokensByAnnotationType.get(kf))kf=this.annotationActivationTrackers.get(Wf),(null===(ze=kf.options)||void 0===ze?0:ze.stateUpdateCallback)&&kf.options.stateUpdateCallback(Ld,fe)}}}submitOperationsToSession(fe,Ld){Ld||(Ld=this.generateCorrelationId());
var ze=fe.filter(kf=>Ai.o.typeGuard(kf));fe=fe.filter(kf=>!Ai.o.typeGuard(kf));0<ze.length&&this.sendMessageToSession(new Ub.E({cv:Ld,ops:ze}));0<fe.length&&(this.operationBatchConfig?(this.batchedOperationsManager||(ze=void 0,ze=this.batchMessagesEnabled?(kf,mg,Wf)=>{if(kf.length){const Kf=new Ub.h;Kf.messages=[];kf.forEach(Ci=>{Kf.messages.push(new Ub.E({cv:Ci.cv,seq:this.nextSyncSequenceId++,ops:Ci.input}))});this.sendMessageToSession(Kf,Ci=>{Wf(Ci?Error(Ci.error):void 0)})}}:(kf,mg,Wf)=>{this.sendMessageToSession(new Ub.E({cv:mg.cv,
seq:this.nextSyncSequenceId++,ops:kf}),Kf=>{Wf(Kf?Error(Kf.error):void 0)})},this.batchedOperationsManager=new Kk(ze,this.reduceBatchOperationsEnabled,this.batchMessagesEnabled,void 0,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled)),this.batchedOperationsManager.addBatchItem(fe,this.operationBatchConfig,{name:"SubmitOperations"},Ld)):this.sendMessageToSession(new Ub.E({cv:Ld,seq:this.nextSyncSequenceId++,ops:fe})))}sendMessageToSession(fe,Ld){this.sessionManager.sendMessage(fe,Ld);Ub.s.typeGuard(fe)&&
this.close()}sendMessageToSessionPostEndpoint(fe,Ld){const ze=(new Za({operationName:"SendLargeBinaryDataMessage",success:!0,cv:fe.cv})).setClientMetadata(this.clientMetadata).start();if(this.connectParams)Ga(this.connectParams,fe,ze,Ld);else{const kf=(mg=>Ga(mg,fe,ze,Ld)).bind(this);this.pendingConnectCallbacks.push(kf)}}requestBinaryDataFromSessionBlobEndpoint(fe,Ld){const ze=(new Za({operationName:"RequestBinaryData",success:!0,cv:(new rd).toString()})).setClientMetadata(this.clientMetadata).start();
if(this.connectParams)ra(this.connectParams,fe,Ld,ze);else{const kf=(mg=>ra(mg,fe,Ld,ze)).bind(this);this.pendingConnectCallbacks.push(kf)}}registerContextTypes(fe){for(const Ld of fe)this.activateAnnotation(Ld),this.registeredContextTypes.add(Ld)}applyOperationForContext(fe,Ld,ze){var kf=pf.a.getTypeNameFor(fe);if(kf==Ai.a.getTypeName()||kf==Ai.k.getTypeName()||kf==Ai.q.getTypeName()||kf==Ai.c.getTypeName()){kf==Ai.k.getTypeName()&&(kf=Ai.a.getTypeName());var mg=Yf(this.resolvePlaceholdersInOperationParentPath(fe.parentPath),
Ld),Wf=Bf(mg.parentPath);if(kf==Ai.a.getTypeName()||kf==Ai.q.getTypeName()){if(mg.body&&(Ld=pf.a.getTypeNameFor(mg.body),this.registeredContextTypes.has(Ld)))if(fe=this.availableContexts.get(Ld),fe||(fe=new Map,this.availableContexts.set(Ld,fe)),Ld=fe.get(ze),Ld||(Ld=[],fe.set(ze,Ld)),!mg.id&&this.localWorkflowManager&&(mg.id=this.localWorkflowManager.getNextClientAnnotationId()),kf==Ai.a.getTypeName())0==Ld.filter(Kf=>Bf(Kf.parentPath)==Wf&&Kf.id==mg.id).length?Ld.push(mg):tb.info(540848911,Oc.CoreDefault,
`AddOperation for (${ze}, ${mg.id}, ${mg.source}) can't be applied as the context item with matching path and ID already exists. Use UpdateOperation instead.`);else for(kf=0;kf<Ld.length;kf++)if(Ld[kf].id==mg.id&&Bf(Ld[kf].parentPath)==Wf)if(Ld[kf].source==mg.source){Ld[kf]=mg;break}else tb.warn(540848912,Oc.CoreDefault,`UpdateOperation for (${ze}, ${mg.id}, ${mg.source}) can't be applied as the context item with provided path and ID has different source: ${Ld[kf].source}`);else tb.warn(540848913,
Oc.CoreDefault,`UpdateOperation for (${ze}, ${mg.id}, ${mg.source}) can't be applied as the context item with matching path and ID was not found. AddOperation should be used instead`)}else kf==Ai.c.getTypeName()&&mg.id&&this.availableContexts.forEach((Kf,Ci)=>{let cj=Kf.get(ze);cj&&(cj=cj.filter(di=>!(Bf(di.parentPath)==Wf&&di.id==mg.id)),0==cj.length?Kf.delete(ze):Kf.set(ze,cj),0==Kf.size?this.availableContexts.delete(Ci):this.availableContexts.set(Ci,Kf))})}}updateWorkflowExecutionStates(fe){if(this.localWorkflowManager){const Ld=
this.enableRemoteExecutionNotification?this.workflowGraph.getWorkflowNodes().map(ze=>ze.workflow):this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this);for(const ze of fe)if(Oh.has(pf.a.getTypeNameFor(ze)))for(const kf of ze.items)for(const mg of Ld||[])this.localWorkflowManager.preProcessItemToWorkflow(mg,kf,this)}}resolveRequestedContexts(fe){const Ld=[];for(const [ze,kf]of ue(fe.requestedContextTypesRules))if(this.availableContexts.has(ze)){fe=Array.from(this.availableContexts.get(ze).values()).reduce((mg,
Wf)=>mg.concat(Wf),[]);if(0==fe.length)throw Error(`Assert: availableContexts have the entry for ${ze} which does not contain any context annotation.`);Ld.push(...fe)}else if(kf==Ig.Required)return[!1,[]];return[!0,this.removeDuplicatedContextItems(Ld)]}removeDuplicatedContextItems(fe){return fe.filter((Ld,ze,kf)=>kf.findIndex(mg=>uc.deepEquals(mg,Ld))===ze)}getContextAnnotations(fe,Ld,ze,kf){var mg,Wf;const Kf=ze?Bf(ze):void 0;return null===(Wf=null===(mg=this.availableContexts.get(fe))||void 0===
mg?void 0:mg.get(Ld))||void 0===Wf?void 0:Wf.filter(Ci=>(!Kf||Bf(Ci.parentPath)==Kf)&&(!kf||Ci.source==kf))}onWorkflowDefinitionOverrideMessage(fe){const Ld=(new Za({operationName:"WorkflowDefinitionOverride",success:!0})).setClientMetadata(this.clientMetadata).start(),ze=Wf=>{$p(Ld,Wf);throw Error(`WorkflowDefinitionOverride: ${Wf}`);};if(this.localWorkflowManager){var kf=this.localWorkflowManager.getWorkflowDefinitionsByName(this),mg=kf.get(fe.sourceWorkflowId);if(mg){if(Ld.resourceId=mg.id,kf=
kf.get(fe.targetWorkflowId))kf.allowDefinitionOverride?mg.definitionOverrideTargetWorkflows&&-1!==mg.definitionOverrideTargetWorkflows.indexOf(kf.id)?(this.workflowDefinitionManager.mergeWorkflowDefinition(kf,fe.definition,fe.contextId),Ld.resultDescription=`Updated config for workflow: ${fe.targetWorkflowId}, context id: ${fe.contextId}`,$p(Ld)):ze(`Workflow '${mg.id}' does not allow workflow definition for workflow '${kf.id}'.`):ze(`Workflow '${kf.id}' does not allow workflow definition override.`)}else ze(`Workflow registration for source workflow '${fe.targetWorkflowId}' was not found.`)}else ze("Not supported by this local SessionProxy instance.")}applyContextIdOnOperations(fe){this.contextIdManager.applyContextIdOnOperations(fe)}attachToWorkflowGraph(fe){this.addToWorkflowGraph(fe);
this.attachExecutionTrackerToEachWorkflow()}triggerRegisteredAnnotationCallbacks(fe,Ld,ze,kf){this.callAnnotationCallbacks(fe,Ld,ze,kf);if(this.hostCallbacks.onAnnotationResult)try{if(kf){if(this.hostCallbacks.onApologyResult)this.hostCallbacks.onApologyResult(fe,ze)}else this.hostCallbacks.onAnnotationResult(fe,ze)}catch(mg){tb.error(540301151,Oc.CoreDefault,new Za({operationName:"HostCallbackOnAnnotationResultError",dimension0:Ld,resultDescription:`onAnnotationResult error: ${mg}`}))}}attachExecutionTrackerToEachWorkflow(){this.localWorkflowManager&&
this.localWorkflowManager.attachExecutionTrackerToEachWorkflow(this.workflowGraph,this,this.onWorkflowExecutionComplete.bind(this))}onWorkflowExecutionCompleteMessage(fe,Ld){Ld(void 0,new Ub.p);if(this.localWorkflowManager)this.localWorkflowManager.onExternalWorkflowExecuted(fe.contextId,fe.workflowId,this)}onWorkflowExecutionComplete(){}enableDeltaGenerator(){var fe,Ld;this.deltaGenerator=null!==(fe=this.deltaGenerator)&&void 0!==fe?fe:new Qi;this.syncDeltaTimers=null!==(Ld=this.syncDeltaTimers)&&
void 0!==Ld?Ld:new Map}createDeltasFromUpdateOperation(fe){var Ld,ze;const kf=[];tb.info(523776396,Oc.CoreDefault,`Calling delta create for UpdateOperation under parent path [${fe.parentPath}] (${null===(Ld=fe.items)||void 0===Ld?void 0:Ld.length} item(s), first item id: ${0<(null===(ze=fe.items)||void 0===ze?void 0:ze.length)?fe.items[0].id:"(no items)"})`);Ld=[...fe.parentPath];for(const Wf of fe.items){ze=[];var mg=this.deltaGenerator.createTextTileDeltasFromItem(Wf,fe.parentPath);if(null!==mg&&
void 0!==mg&&mg.length){for(const Kf of mg)mg=qa(),Ld=[...fe.parentPath,Wf.id],ze.push({id:mg,revId:Wf.revId,body:Kf,contextId:Wf.contextId,source:Wf.source});0<ze.length&&(kf.push(new Ai.d({parentPath:Ld,items:ze})),this.enableSyncDeltaSending&&this.setupSyncDeltaAfterDelay(Wf,Ld,ze))}else tb.info(523329632,Oc.CoreDefault,`Failed to create delta on item ${Wf.id}`)}return kf}setupSyncDeltaAfterDelay(fe,Ld,ze){var kf,mg,Wf,Kf=this.syncDeltaTimers.get(fe.id);Kf&&(clearTimeout(Kf),this.syncDeltaTimers.delete(fe.id));
if(ze=ze.find(Ci=>{var cj;return(null===(cj=Ci.body)||void 0===cj?void 0:cj.unit)===ki.b.Chars}))ze=ze.body,Kf={content:"",deltaType:ki.a.Update,length:0,position:(null!==(kf=null===ze||void 0===ze?void 0:ze.position)&&void 0!==kf?kf:0)+(null!==(Wf=null===(mg=null===ze||void 0===ze?void 0:ze.content)||void 0===mg?void 0:mg.length)&&void 0!==Wf?Wf:0),unit:ki.b.Sentence},kf=ho.a.typeGuard(fe.body)?new Vk.a(Kf):new Vk.b(Kf),kf={id:qa(),revId:fe.revId,body:kf,contextId:fe.contextId,source:fe.source},
Ld=new Ai.d({parentPath:Ld,items:[kf]}),Ld=setTimeout((Ci,cj)=>{this.submitOperation(Ci);this.syncDeltaTimers.delete(cj)},this.syncDeltaTimeout,Ld,fe.id),this.syncDeltaTimers.set(fe.id,Ld)}addToWorkflowGraph(fe){this.workflowGraph.addWorkflow(Qf(fe))}getAnnotations(fe,Ld){var ze,kf,mg;const Wf=(new Za({operationName:"GetAnnotations",success:!0,dimension1:null===(ze=fe.annotationType)||void 0===ze?void 0:ze.toString(),dimension2:null===(kf=fe.maxDelayMs)||void 0===kf?void 0:kf.toString(),cv:fe.cv})).setClientMetadata(this.clientMetadata).start();
ze=this.sessionManager.getCorrelationVector();fe=new pi({annotationTypes:fe.annotationType,transientItems:fe.transientItems,configs:fe.configs,maxDelayMs:fe.maxDelayMs,sourceInfo:fe.sourceInfo,caller:nm.Client,tryResolveUpstreamDependencies:fe.tryResolveUpstreamDependencies,correlationInfo:{cvString:null!==(mg=fe.cv)&&void 0!==mg?mg:ze.newChild().toString()}});const Kf=[];let Ci;this.sendMessageToSession(fe,(bn,lo)=>{null!==Ld&&void 0!==Ld&&Ld.IsCancellationRequested||(Kf.push({error:bn,response:lo}),
null===Ci||void 0===Ci||Ci(!0))});const cj=this;let di=!1;const rj=new Promise((bn,lo)=>{null===Ld||void 0===Ld||Ld.onCancel(()=>{di?bn():lo(Error(Lk.requestCancelledError))})});return{[Symbol.asyncIterator](){var bn,lo,as,sk,jf,yk,pq;return x(this,arguments,function*(){for(;!di;)try{0===Kf.length&&(yield u(Promise.race([new Promise(nq=>Ci=nq),rj])));var bs=Kf.shift();if(null===Ld||void 0===Ld?0:Ld.IsCancellationRequested)throw Error(Lk.requestCancelledError);di=(null===(bn=bs.response)||void 0===
bn?void 0:bn.finalResponse)||void 0!==bs.error;Wf.dimension3=`final response: ${di}`;let Uq,Fo,Di=void 0;if(bs.error)Wf.setDataField("ServerError",`ErrorCode: ${bs.error.code}, Error: ${bs.error.error}, Retryable: ${bs.error.retryable}`),Di=bs.error.error,Uq={serviceError:[{code:Ff.ServerError,error:bs.error.error,retryable:null===cj||void 0===cj?void 0:cj.canBeRetried(bs.error)}]};else if(0<(null===(as=null===(lo=bs.response)||void 0===lo?void 0:lo.errorInfo)||void 0===as?void 0:as.length)){const nq=
bs.response.errorInfo.map(rl=>`ErrorCode: ${rl.code}, Error: ${rl.error}, Retryable: ${rl.retryable}, ResourceId: ${rl.resourceId}`).join("\n");Wf.setDataField("WorkflowErrors",nq);Di="Workflow execution error";Uq={serviceError:bs.response.errorInfo}}else Wf.resultDescription="OK";if(0<(null===(jf=null===(sk=bs.response)||void 0===sk?void 0:sk.warningInfo)||void 0===jf?void 0:jf.length)){Fo={serviceError:bs.response.warningInfo};const nq=bs.response.warningInfo.map(rl=>`ErrorCode: ${rl.code}, Error: ${rl.error}, Retryable: ${rl.retryable}, ResourceId: ${rl.resourceId}`).join("\n");
Wf.setDataField("WorkflowWarnings",nq)}$p(Wf,Di);yield yield u({content:null===(yk=bs.response)||void 0===yk?void 0:yk.content,error:null!==Uq&&void 0!==Uq?Uq:void 0,warning:null!==Fo&&void 0!==Fo?Fo:void 0,finalResponse:null===(pq=bs.response)||void 0===pq?void 0:pq.finalResponse})}catch(Uq){bs=Uq.message===Lk.requestCancelledError?kg.RequestCancelled:kg.Unknown;Wf.setDataField("ClientError",`ErrorCode: ${bs}, Error: ${Uq.message}`);$p(Wf,null===Uq||void 0===Uq?void 0:Uq.message);yield yield u({content:void 0,
error:{clientError:{code:bs,error:null===Uq||void 0===Uq?void 0:Uq.message}}});di=!0;break}})}}}isHttpFallback(){const fe=this.sessionManager.getNetworkWorkerManager();return fe&&fe.getInitNetworkMode()===Dl.JSWebSockets&&fe.getNetworkMode()===Dl.HttpFallback?!0:!1}canBeRetried(fe){return(null===fe||void 0===fe?void 0:fe.code)===We.TooManyRequests||(null===fe||void 0===fe?void 0:fe.code)===We.RequestTimeout||fe.error.includes(kd.ClientDisconnected)}getAuthToken(fe,Ld){const ze={Tickets:[]};this.clientMetadata.docSessionId&&
(ze.DocSessionId=this.clientMetadata.docSessionId);var kf=fe===jg.a.Substrate?df.Substrate:void 0;kf&&(ze.TokenType=kf);this.hostCallbacks.requestAuthToken(ze).then(mg=>{var Wf;if(!mg)throw Error("Missing AuthTokenResponse from requestAuthToken");if(!mg.Token)throw Error("Missing Token from requestAuthToken");Ld(void 0,mg.Token,{returnedTokenType:fe,timeToLiveSec:null===(Wf=mg.TokenProperties)||void 0===Wf?void 0:Wf.timeToLiveSec})}).catch(mg=>{Ld(mg)})}resetNextSyncSequenceId(){this.nextSyncSequenceId=
1}onReconnect(){this.annotationActivationTrackers.forEach(fe=>{var Ld;this.activateAnnotationForTracker(fe,{ignoreExistingAnnotations:!0,YAe:!0,sendApologies:void 0!==(null===(Ld=fe.options)||void 0===Ld?void 0:Ld.apologyCallback)}).catch(()=>{})});this.reconnectCallbacks.forEach(fe=>{fe()});if(!this.connectParams)throw Error("Expected onConnect before onReconnect");}onSessionClose(fe){this.isSessionClosed=!0;this.connectParams=void 0;this.sessionCloseCallbacks.forEach(Ld=>{Ld(fe)})}onConnect(fe,
Ld,ze,kf,mg,Wf){this.hasSessionConnected?fe&&(this.allowGroupSeed=this.allowSeed=!0,this.changeSeedingStatus(Me.NotStarted,"ReconnectReset"),this.batchedSeedMessageGroupSize=this.seedGroupSize=0,this.seedBatchedOperationsManager&&(this.seedBatchedOperationsManager.removeAllBatchedItems(),this.seedBatchedOperationsManager=void 0),this.batchedOperationsManager&&(this.batchedOperationsManager.removeAllBatchedItems(),this.batchedOperationsManager=void 0),this.cachedClaimsChallenge=Object.assign(Object.assign({},
this.cachedClaimsChallenge),{claimsVersion:0})):this.enableRemoteExecutionNotification&&this.addDownstreamWorkflowsIntoClientGraph(Wf);this.connectParams={isSeedingRequired:fe,sessionUrl:Ld,origin:ze,authToken:kf};this.hasSessionConnected=!0;this.tryActivateWorkflows();for(const Kf of this.pendingConnectCallbacks)Kf(this.connectParams);this.connectCallbacks.forEach(Kf=>{Kf(fe,Ld,ze,kf)});this.serverInputTypes=mg}onDisconnect(fe){this.connectParams=void 0;this.disconnectCallbacks.forEach(Ld=>{Ld(fe)})}onSeedingStatusChangeMessage(fe,
Ld){Ld(void 0,new Ub.p);this.changeSeedingStatus(fe.newStatus,"SeedingStatusChangeMessage")}changeSeedingStatus(fe,Ld){const ze=(new Za({operationName:"SeedingStatusChange",success:!0})).setClientMetadata(this.clientMetadata).start();ze.setDataField("Status",Me[fe]);ze.setDataField("Reason",Ld);$p(ze);this.seedingStatus!=fe&&(this.seedingStatus=fe,this.seedingStatusChangeCallbacks.forEach(kf=>{kf(new Ub.q({newStatus:this.seedingStatus}))}))}onServerAuthenticationStateChange(fe){if(fe!=this.serverAuthenticationState&&
(this.serverAuthenticationState!=Fc.a.Authenticated||fe!=Fc.a.Pending)){var Ld=(new Za({operationName:"ServerAuthStateChange",dimension0:fe.toString(),dimension1:this.serverAuthenticationState.toString(),success:!0})).setClientMetadata(this.clientMetadata).start();Ld.resultDescription=`Changing Server Authentication State newState: ${fe}`;$p(Ld);this.serverAuthenticationState=fe;for(const ze of this.serverAuthenticationStateChangeCallback)ze(this.serverAuthenticationState)}}callAnnotationCallbacks(fe,
Ld,ze,kf){(0!==this.annotationCallbacks.size||0!==this.apologyCallbacks.size)&&(Ld=kf?this.apologyCallbacks.get(Ld):this.annotationCallbacks.get(Ld))&&Ld.forEach(mg=>{mg(fe,ze)})}getOperationBatchConfig(fe){let Ld=void 0;Ld=this.batchMessagesEnabled?ze=>({input:ze,demultiplex:()=>[[]]}):ze=>({input:ze.filter(kf=>kf.length).reduce((kf,mg)=>kf.concat(mg),[]),demultiplex:()=>[[]]});return{delayMs:fe.delayMs,delayMsMax:fe.delayMsMax,maxInputSize:fe.maxInputSize,estimateSize:zn,groupingKeyExtractor:()=>
"operations",multiplex:Ld,split:ze=>{if(!(1>=ze.length))return{inputs:ze.reduce((kf,mg)=>{kf.push([mg]);return kf},[]),join:()=>[]}}}}sendSeedMessagesViaBatchManager(fe,Ld,ze){if(!this.seedBatchedOperationsManager){let kf=void 0;kf=this.batchMessagesEnabled?(mg,Wf,Kf)=>{this.batchedSeedMessageGroupSize+=mg.length;if(mg.length){const Ci=new Ub.h;Ci.messages=[];mg.forEach(cj=>{Ci.messages.push(new Ub.E({cv:cj.cv,seq:0,ops:cj.input,groupId:"Seed",groupSize:Wf.groupComplete?this.batchedSeedMessageGroupSize:
void 0,groupComplete:Wf.groupComplete?Wf.groupComplete:void 0}))});this.sendMessageToSession(Ci,cj=>{Kf(cj?Error(cj.error):void 0)})}}:(mg,Wf,Kf)=>{this.seedGroupSize++;this.sendMessageToSession(new Ub.E({cv:Wf.cv,seq:0,ops:mg,groupId:"Seed",groupSize:Wf.groupComplete?this.seedGroupSize:void 0,groupComplete:Wf.groupComplete?Wf.groupComplete:void 0}),Ci=>{Kf(Ci?Error(Ci.error):void 0)})};this.seedBatchedOperationsManager=new Kk(kf,this.reduceBatchOperationsEnabled,this.batchMessagesEnabled,void 0,
this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled)}this.seedBatchedOperationsManager.addBatchItem(fe,this.operationBatchConfig,{name:"SubmitSeedOperations"},ze,Ld)}onAnnotationResultsFromServer(fe,Ld){Zm(fe,Date.now(),"ReceiveFromNetwork",!0,(new Za({operationName:"AugloopClientPerfTracker",success:!0})).setClientMetadata(this.clientMetadata).start());this.onAnnotationResults(fe,gn.ServerWorkflow,Ld)}getLocalRegisteredWorkflows(){return this.localWorkflowManager?this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this).map(fe=>
Qf(fe)):[]}sendWorkflowGraphInitMessage(){const fe=this.getLocalRegisteredWorkflows(),Ld=(new Za({operationName:"WorkflowGraphInit",success:!0})).setClientMetadata(this.clientMetadata).start(),ze=new Ub.jBd({upstreamRuntimeWorkflows:fe});this.sendMessageToSession(ze,(kf,mg)=>{kf?$p(Ld,kf.error):(Ld.resultDescription=`local workflows: ${fe.map(Wf=>Wf.id)}, remote workflows: ${mg.downstreamRuntimeWorkflows.map(Wf=>Wf.id)}`,$p(Ld),this.onWorkflowGraphInitResponse(mg))})}trySendWorkflowGraphInitMessage(){!this.graphInitMessageTimer&&
this.enableRemoteExecutionNotification&&(this.graphInitMessageTimer=setTimeout(()=>{this.graphInitMessageTimer=void 0;this.sendWorkflowGraphInitMessage()},10))}onWorkflowGraphInitResponse(fe){this.addDownstreamWorkflowsIntoClientGraph(fe.downstreamRuntimeWorkflows);this.tryActivateWorkflows()}addDownstreamWorkflowsIntoClientGraph(fe){this.workflowGraph.removeWorkflows(!0);for(const Ld of fe||[])this.workflowGraph.addWorkflow(Ld,!0);this.attachExecutionTrackerToEachWorkflow()}resolvePlaceholdersInOperationParentPath(fe){let Ld=
fe;3==Ld.length&&"session"==Ld[0]&&"user"==Ld[1]&&Ld[2].startsWith("user_")&&(tb.info(540848914,Oc.CoreDefault,`Replacing user context placeholder for: ${Bf(fe)}.`),Ld=["session","#userContext#"]);3==Ld.length&&"session"==Ld[0]&&"user"==Ld[1]&&Ld[2].startsWith("tenant_")&&(tb.info(540848915,Oc.CoreDefault,`Replacing tenant context placeholder for: ${Bf(fe)}.`),Ld=["session","#tenantContext#"]);return Ld}filterOperationsForSession(fe){a:{var Ld=this.serverInputTypes;if(!Array.isArray(Ld)||0===Ld.length||
Ai.d.typeGuard(fe)||Ai.p.typeGuard(fe))fe=!0;else{for(const ze of fe.items)if(!ze.body||pf.a.matchesTypesFor(ze.body,Ld)){fe=!0;break a}fe=!1}}return fe}executeCallbacksOnAnnotationSubmitted(fe,Ld){const {qXh:ze,zXh:kf}=this.getAnnotationOperationsByType(fe);ze.forEach((mg,Wf)=>{Array.from(mg).forEach(Kf=>this.triggerRegisteredAnnotationCallbacks(Kf,Wf,Ld,!1))});kf.forEach((mg,Wf)=>{Array.from(mg).forEach(Kf=>this.triggerRegisteredAnnotationCallbacks(Kf,Wf,Ld,!0))})}partitionAnnotationOperations(fe){return fe.reduce(([Ld,
ze],kf)=>kf.items.some(mg=>mg.body&&yg.a.typeGuard(mg.body))?[[...Ld,kf],ze]:[Ld,[...ze,kf]],[[],[]])}onAnnotationsSubmitted(fe,Ld){const {qXh:ze,zXh:kf}=this.getAnnotationOperationsByType(fe);ze.forEach((mg,Wf)=>{mg=Array.from(mg);this.onAnnotationResults(new Ub.g({annotationType:Wf,ops:mg,cv:Ld,areApologies:!1}),gn.Submitted,()=>{})});kf.forEach((mg,Wf)=>{mg=Array.from(mg);this.onAnnotationResults(new Ub.g({annotationType:Wf,ops:mg,cv:Ld,areApologies:!0}),gn.Submitted,()=>{})})}getAnnotationOperationsByType(fe){const Ld=
new Map,ze=new Map;for(const kf of fe)for(const mg of kf.items)mg.body&&yg.a.typeGuard(mg.body)&&(fe=(Wf,Kf)=>{const Ci=Wf.get(Kf)||new Set;Ci.add(kf);Wf.set(Kf,Ci)},Nd.a.typeGuard(mg.body)?fe(ze,mg.body.annotationTypeName):fe(Ld,pf.a.getTypeNameFor(mg.body)));return{qXh:Ld,zXh:ze}}onClaimsChallengeMessage(fe,Ld){const ze=(new Za({operationName:"OnClaimsChallengeMessage",dimension0:fe.claimsVersion.toString(),dimension1:fe.error,success:!0})).setClientMetadata(this.clientMetadata).start();ze.resultSignature=
`HasClaims: ${fe.claims?0<fe.claims.length:!1}`;ze.resultDescription="Received Claims Challenge Message from Server";$p(ze);fe.claimsVersion>this.cachedClaimsChallenge.claimsVersion&&(this.cachedClaimsChallenge=Object.assign(Object.assign({},fe),{SVd:!0}));for(const kf of this.claimsChallengeCallback)kf(this.cachedClaimsChallenge);Ld(void 0,new Ub.p)}generateCorrelationId(){return this.sessionManager.getCorrelationVector().newChild().toString()}onTokenProvisionResponse(fe,Ld){if(!fe&&Ld)this.onServerAuthenticationStateChange(Ld.tokenType&&
Ld.tokenType==jg.a.WacUserInfo?Fc.a.WacUserInfoAuthenticated:Fc.a.Authenticated)}requestAuthTokenWithClaims(fe){this.requestAuthTokenInteractive(fe).catch(()=>{})}requestAuthTokenInteractive(fe,Ld){var ze;const kf=(new Za({operationName:"RequestAuthTokenInteractive",success:!0,dimension0:`isInteractive: ${null!==(ze=null===Ld||void 0===Ld?void 0:Ld.rZi)&&void 0!==ze?ze:!1}`})).start();kf.dimension1=`HasClaims: ${fe.claims?0<fe.claims.length:!1}`;return this.hostCallbacks.requestAuthToken({Tickets:[],
DocSessionId:this.clientMetadata.docSessionId,TokenType:df.Augloop,ConnectParams:this.connectParams,Claims:fe.claims,Interactive:null===Ld||void 0===Ld?void 0:Ld.rZi}).then(mg=>{if(!mg)throw Error("Missing AuthTokenResponse from requestAuthToken claims");if(!mg.Token)throw Error("Missing Token from requestAuthToken claims");kf.resultSignature="Token";return new Ub.I({authToken:mg.Token,version:++this.tokenMessageVersion,claimsVersion:fe.claimsVersion})}).catch(mg=>{kf.resultSignature="NoToken";kf.dimension2=
mg.message;return new Ub.f7a({reason:mg.message,version:++this.tokenMessageVersion,claimsVersion:fe.claimsVersion,clientHandlesResponse:!0})}).then(mg=>new Promise((Wf,Kf)=>{this.sendMessageToSession(mg,(Ci,cj)=>{$p(kf,null===Ci||void 0===Ci?void 0:Ci.error);this.onTokenProvisionResponse(Ci,cj);Ci?Kf(Error(Ci.error)):(Ub.I.typeGuard(mg)&&(this.cachedClaimsChallenge.SVd=!1),Wf(mg))})}))}}Lk.requestCancelledError="Request cancelled";class Yr{}var lh;(function(fe){fe[fe.Anonymous=0]="Anonymous";fe[fe.Host=
1]="Host"})(lh||(lh={}));class io{constructor(){this.timers=new Map}scheduleRefresh(fe,Ld,ze,kf){let mg=this.timers.get(fe);mg||(mg={numberOfAttempts:0},this.timers.set(fe,mg));mg.refreshTimeoutId&&(clearTimeout(mg.refreshTimeoutId),mg.refreshTimeoutId=void 0);mg.expiredTimeoutId&&(clearTimeout(mg.expiredTimeoutId),mg.expiredTimeoutId=void 0);fe=1E3*Ld-io.tokenRefreshBufferMs;Ld=1E3*Ld-io.tokenExpirationBufferMs;0<fe?mg.numberOfAttempts=0:(++mg.numberOfAttempts,fe=io.tokenRefreshBackoffIntervalMs,
Ld=io.tokenExpirationBufferMs);mg.numberOfAttempts<=io.tokenRefreshMaximumAttempts&&(mg.refreshTimeoutId=setTimeout(()=>{ze()},fe));kf&&(mg.expiredTimeoutId=setTimeout(()=>{kf()},Ld))}clearRefreshTimeouts(){this.clearTimeouts(!1)}clearAllTimeouts(){this.clearTimeouts(!0)}clearTimeouts(fe){this.timers.forEach((Ld,ze)=>{Ld.refreshTimeoutId&&(clearTimeout(Ld.refreshTimeoutId),Ld.refreshTimeoutId=void 0);fe&&Ld.expiredTimeoutId&&(clearTimeout(Ld.expiredTimeoutId),Ld.expiredTimeoutId=void 0);Ld.expiredTimeoutId||
this.timers.delete(ze)})}}io.tokenRefreshBufferMs=24E4;io.tokenExpirationBufferMs=12E4;io.tokenRefreshBackoffIntervalMs=3E4;io.tokenRefreshMaximumAttempts=3;class xl extends Mf.EventEmitter{constructor(fe,Ld,ze,kf,mg){super();this.getSessionStats=fe;this.clientMetadata=Ld;this.tokenRefreshManager=ze;this.sendMessage=kf;this.options=mg?mg:{};this.options.overrideSessionInitMessage=this.options.overrideSessionInitMessage||(Wf=>Wf);if(this.clientMetadata&&!this.clientMetadata.userSystemTimezone)try{this.clientMetadata.userSystemTimezone=
Intl.DateTimeFormat().resolvedOptions().timeZone}catch(Wf){}}initSession(fe){fe.onResponse=fe.onResponse||(()=>{});var Ld=uc.getCurrentTimeMs(),ze=this.getSessionStats().lastConnectionClose&&Ld-this.getSessionStats().lastConnectionClose;Ld=this.getSessionStats().lastSyncMessage&&Ld-this.getSessionStats().lastSyncMessage;const kf=(new Za({operationName:"SessionInit"})).start(),mg={sessionKey:this.sessionKey,sessionId:this.clientMetadata.sessionId,obu:ze,pbu:Ld,isTokenRefresh:fe.isTokenRefresh,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification,
error:void 0};ze=this.options.overrideSessionInitMessage(new Ub.w({protocolVersion:2,clientMetadata:this.clientMetadata,sessionKey:this.sessionKey,origin:this.origin,authToken:this.anonymousToken,extensionConfigs:fe.extensionConfigs,returnWorkflowInputTypes:!0,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification}));this.sendMessage(ze,(Wf,Kf)=>{kf.success=!Wf;kf.resultSignature=this.getSessionStats().lastConnectionClose?"Reconnect":"FirstConnect";kf.resourceId=Yb(null===
Kf||void 0===Kf?void 0:Kf.sliceUrl);kf.setClientMetadata(this.clientMetadata);(null===Kf||void 0===Kf?0:Kf.sessionKey)&&mg.sessionKey!==Kf.sessionKey&&(mg.sessionKey=Kf.sessionKey);Wf&&(mg.error=Wf.error);kf.resultDescription=JSON.stringify(mg);tb.info(508843779,Oc.CoreDefault,kf.stop());fe.onResponse(Wf,Kf);Wf?this.emit("serverAuthenticationStateChange",Fc.a.NotAuthenticated):fe.isReconnectOnSameSlice&&Kf.forceReconnect?this.emit("serverAuthenticationStateChange",Fc.a.NotAuthenticated):Kf.anonymousToken&&
Kf.tokenExpirationSeconds?(this.anonymousToken=Kf.anonymousToken,this.onSuccessfulSessionInitOnServerSide(Kf)):(this.emit("serverAuthenticationStateChange",Fc.a.NotAuthenticated),tb.error(508843778,Oc.CoreDefault,"AL Anonymous token was not generated for the session"))})}onSuccessfulSessionInitOnServerSide(fe){var Ld,ze;this.tokenRefreshManager.scheduleRefresh(lh.Anonymous,fe.tokenExpirationSeconds,this.initSession.bind(this,{isTokenRefresh:!0}),()=>{this.anonymousToken=void 0});this.connectParams=
{isSeedingRequired:this.sessionKey!==fe.sessionKey,sessionUrl:`${fe.sessionUrlBase}/${fe.sessionKey}`,origin:fe.origin,authToken:this.anonymousToken};(null===(Ld=this.options)||void 0===Ld?0:Ld.dontSendTokenOnReconnectChangeGate)&&fe.existingTokenProvisionResponse&&(null===(ze=fe.existingTokenProvisionResponse)||void 0===ze?void 0:ze.tokenType)===jg.a.AugLoopLowPrivilege||(this.options.sendTokenFailureMessageChangeGate?this.initHostAuthTokenNew().catch(()=>{}):this.initHostAuthToken());Ld=!!this.sessionKey;
this.sessionKey=fe.sessionKey;this.origin=fe.origin;this.emit("connect",this.connectParams.isSeedingRequired,Ld,this.connectParams.sessionUrl,this.connectParams.origin,this.connectParams.authToken,fe.workflowInputTypes,fe.downstreamRuntimeWorkflows);Ld&&this.emit("reconnect")}getAuthToken(){return this.options.requestAuthToken({Tickets:[],DocSessionId:this.clientMetadata.docSessionId,TokenType:df.Augloop,ConnectParams:this.connectParams}).then(fe=>fe).catch(()=>{})}getAuthTokenNew(){return this.options.requestAuthToken({Tickets:[],
DocSessionId:this.clientMetadata.docSessionId,TokenType:df.Augloop,ConnectParams:this.connectParams}).then(fe=>fe)}getAuthTokenTimeoutPromise(){const fe=this.options.authTokenTimeoutMs;return new Promise((Ld,ze)=>{setTimeout(()=>{ze(Error(`Host auth token provision took longer than ${fe} ms`))},fe)})}initHostAuthToken(){const fe=this.getAuthToken.bind(this);if(this.options.requestAuthToken&&fe){const Ld=(new Za({operationName:"RefreshAuthToken",success:!0})).setClientMetadata(this.clientMetadata).start();
fe().then(ze=>{ze?ze.Token?(tb.info(508843776,Oc.CoreDefault,Ld.stop()),this.sendTokenProvisionMessage(ze.Token)):(ze.TokenError==dg.TokenMissingInteractionRequired?(this.emit("serverAuthenticationStateChange",Fc.a.TokenMissingInteractionRequired),Ld.resultDescription="Host auth token provision failed interaction required"):(this.emit("serverAuthenticationStateChange",Fc.a.NotAuthenticated),Ld.resultDescription="Host auth token provision failed"),Ld.success=!1,tb.info(508843777,Oc.CoreDefault,Ld.stop())):
Ld.resultDescription="TokenResponse is not set"}).catch(ze=>{this.emit("serverAuthenticationStateChange",Fc.a.NotAuthenticated);Ld.success=!1;Ld.resultDescription=`Error happened while attempting to fetch host token: ${ze}`;tb.error(508843747,Oc.CoreDefault,Ld.stop())})}}initHostAuthTokenNew(){return r(this,void 0,void 0,function*(){const fe=this.getAuthTokenNew.bind(this);if(this.options.requestAuthToken&&fe){const Ld=(new Za({operationName:"RefreshAuthToken",success:!0})).setClientMetadata(this.clientMetadata).start();
let ze,kf,mg=Fc.a.NotAuthenticated;try{ze=0<this.options.authTokenTimeoutMs?yield Promise.race([fe(),this.getAuthTokenTimeoutPromise()]):yield fe();if(!ze)throw Error("TokenResponse is not set");if(!ze.Token){if(ze.TokenError==dg.TokenMissingInteractionRequired)throw mg=Fc.a.TokenMissingInteractionRequired,Error("Host auth token provision failed interaction required");throw Error("Host auth token provision failed");}}catch(Wf){kf=Wf.message,this.emit("serverAuthenticationStateChange",mg),Ld.success=
!1,Ld.resultDescription=`Error happened while attempting to fetch host token: ${Wf}`}try{kf?this.sendMessage(new Ub.f7a({reason:kf,version:xl.initialTokenVersion,clientHandlesResponse:!0})):this.sendTokenProvisionMessage(ze.Token)}catch(Wf){kf||(kf=Wf.message,this.emit("serverAuthenticationStateChange",mg),Ld.success=!1,Ld.resultDescription=`Error happened while attempting to send host token: ${Wf}`)}finally{kf?tb.error(506074845,Oc.CoreDefault,Ld.stop()):tb.info(506074846,Oc.CoreDefault,Ld.stop())}}})}sendTokenProvisionMessage(fe){fe=
new Ub.I({authToken:fe,version:xl.initialTokenVersion});this.emit("serverAuthenticationStateChange",Fc.a.Pending);this.sendMessage(fe,this.onTokenProvisionResponse.bind(this),!0)}onTokenProvisionResponse(fe,Ld){!fe&&Ld&&Ld.tokenExpirationSeconds?(this.emit("serverAuthenticationStateChange",Ld.tokenType&&Ld.tokenType==jg.a.WacUserInfo?Fc.a.WacUserInfoAuthenticated:Fc.a.Authenticated),this.tokenRefreshManager.scheduleRefresh(lh.Host,Ld.tokenExpirationSeconds,this.initHostAuthToken.bind(this))):this.emit("serverAuthenticationStateChange",
Fc.a.NotAuthenticated)}}xl.initialTokenVersion=1;var gg=v(68019),jm=v(99421),$m;(function(fe){fe[fe.JoinContext=0]="JoinContext";fe[fe.Session=1]="Session"})($m||($m={}));var Go={default:{}};Go["default"]||(Go["default"]={});var qn=function(){function fe(Ld){if(Ld)for(var ze in Ld)null!=Ld[ze]&&(this[ze]=Ld[ze])}fe.prototype.sessionKey="";fe.prototype.annotationType="";fe.prototype.annotationState=0;fe.prototype.workflowId="";fe.prototype.traceId="";fe.getTypeUrl=function(Ld){void 0===Ld&&(Ld="type.googleapis.com");
return Ld+"/AnnotationMetaDataChangeEvent"};return fe}();class kr extends qn{constructor(fe){super(fe);this.eventName="AnnotationMetaDataChange"}}class Fp{constructor(fe){this.item=fe;this.operation=fe.op;this.delta=fe.delta;this.deltas=fe.deltas;this.id=Bf(this.itemPath);this.revId=fe.revId}get itemPath(){return[...this.item.parentPath,this.item.id]}getModelIterator(){throw Error("Method not implemented.");}getBody(){return this.item.body}getItemReference(){throw Error("Method not implemented.");
}getParentItem(){throw Error("Method not implemented.");}getParentItemBody(){throw Error("Method not implemented.");}getPrevItem(){throw Error("Method not implemented.");}getPrevItemBody(){throw Error("Method not implemented.");}getNextItem(){throw Error("Method not implemented.");}getNextItemBody(){throw Error("Method not implemented.");}getChildItem(){throw Error("Method not implemented.");}getChildItemBody(){throw Error("Method not implemented.");}getChildItems(){throw Error("Method not implemented.");
}getChildItemBodies(){throw Error("Method not implemented.");}getSubtreeItem(){throw Error("Method not implemented.");}getSubtreeItemBody(){throw Error("Method not implemented.");}getSubtreeItems(){throw Error("Method not implemented.");}getSubtreeItemBodies(){throw Error("Method not implemented.");}getContextItem(){throw Error("Method not implemented.");}getContextItemBody(){throw Error("Method not implemented.");}getContextItems(){throw Error("Method not implemented.");}getContextItemBodies(){throw Error("Method not implemented.");
}addAnnotation(){throw Error("Method not implemented.");}updateAnnotation(){throw Error("Method not implemented.");}deleteAnnotation(){throw Error("Method not implemented.");}loadSubtree(){throw Error("Method not implemented.");}getSourceTimestamp(){return this.item.sourceTimestamp}getContextId(){return this.item.contextId}}class Eq{constructor(fe,Ld=[]){this.rootItem=this.scopeItem=void 0;this.normalizeFilter=ze=>{if(!ze)return kf=>void 0!==kf;if("function"===typeof ze)throw Error("Not implemented yet");
if(1!==(ze.id?1:0)+(ze.ids?1:0)+(ze.itemType?1:0)+(ze.itemTypes?1:0))throw Error("Exactly one condition expected on IItemFilter");if(ze.itemType)return kf=>kf&&pf.a.matchesTypesFor(kf.body,[ze.itemType]);if(ze.itemTypes)return kf=>kf&&pf.a.matchesTypesFor(kf.body,ze.itemTypes);throw Error("Not implemented yet");};this.items=[...Ld,fe];this.scopeItem=new Fp(fe)}getItem(){throw Error("Method not implemented.");}getItems(){throw Error("Method not implemented.");}getItemBody(fe){return this.getItemBodies(fe)[0]}getItemBodies(fe){fe=
this.normalizeFilter(fe);return this.items.filter(fe).map(Ld=>Ld.body)}getItemByReference(){throw Error("Method not implemented.");}getItemBodyByReference(){throw Error("Method not implemented.");}}const Dr=[ki.a.CursorUpdate,ki.a.FormattingUpdate,ki.a.OtherNonContentUpdate,ki.a.AttributionUpdate];class vf{constructor(fe,Ld,ze,kf){this.originalFlights=fe;this.normalizedFlights=Ld;this.keyValueFlightsMap=ze;this.parsedFlightsMap=kf}static normalizeName(fe){return null===fe||void 0===fe?void 0:fe.toLowerCase()}static parseName(fe){return(fe=
null===fe||void 0===fe?void 0:fe.split("."))?fe[fe.length-1]:void 0}hasFlight(fe){var Ld=vf.normalizeName(fe);fe=this.normalizedFlights.has(Ld);const ze=this.keyValueFlightsMap.has(Ld);Ld=this.parsedFlightsMap.has(Ld);return fe||ze||Ld}getBooleanValue(fe,Ld){var ze,kf;const mg=null===(ze=this.getStringValue(fe))||void 0===ze?void 0:ze.toLowerCase();fe=null===(kf=this.getStringValue(this.parsedFlightsMap.get(vf.normalizeName(fe))))||void 0===kf?void 0:kf.toLowerCase();return"true"===mg||"true"===fe?
!0:"false"===mg||"false"===fe?!1:Ld}getIntValue(fe,Ld){fe=this.getStringValue(fe);fe=Number.parseInt(fe,10);return Number.isNaN(fe)?Ld:fe}getStringValue(fe,Ld){var ze;return null!==(ze=this.keyValueFlightsMap.get(vf.normalizeName(fe)))&&void 0!==ze?ze:Ld}getAll(){return this.originalFlights}getAllParsed(){const fe=[];this.keyValueFlightsMap.forEach((Ld,ze)=>{var kf=null===Ld||void 0===Ld?void 0:Ld.toLowerCase();switch(kf){case "true":fe.push({name:ze,value:!0});break;case "false":fe.push({name:ze,
value:!1});break;default:kf=Number.parseInt(kf,10),Number.isNaN(kf)?fe.push({name:ze,value:Ld}):fe.push({name:ze,value:kf})}});return fe}}class $h{constructor(fe){this.model=fe.model;this.clientMetadata=fe.clientMetadata;this.userContext=fe.userContext;this.site=fe.site;this.getTokenCallback=fe.getTokenCallback}get flights(){var fe;null!==(fe=this._flights)&&void 0!==fe?fe:this._flights=ta(this.clientMetadata.flights);return this._flights}getToken(fe,Ld){return this.getTokenCallback(fe,Ld)}getTokenAsync(fe){return new Promise((Ld,
ze)=>{this.getToken(fe,(kf,mg,Wf)=>{kf?ze(kf):Ld(Object.assign(Object.assign({},Wf),{token:mg}))})})}}class $s{constructor(fe,Ld,ze){this.itemsContextId=new Set;this.executionState=new Map;this.graphNode=fe;this.onContextIdWorkflowExecutionComplete=Ld;ze&&(this.itemsContextId=ze.itemsContextId,this.executionState=ze.executionState)}addInputItemToProcess(fe){this.itemsContextId.add(fe)}removeProcessedInputItem(fe){this.itemsContextId.delete(fe)}countItemsToProcess(fe){let Ld=0;for(const ze of this.itemsContextId)0===
ze.indexOf(fe)&&(Ld+=1);return Ld}getExecutionState(){return this.executionState}setExecutionState(fe,Ld){if(!this.graphNode.isActivated)return tb.info(508883415,Oc.CoreDefault,new Za({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,joinContextId:fe,resultDescription:`Trying to set state ${Ld} for a not activated workflow`})),!1;if(!fe)return tb.info(520217546,Oc.CoreDefault,new Za({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,joinContextId:fe,
resultDescription:`Trying to set state ${Ld} for a undefined contextId (setExecutionState)`})),!1;this.executionState.set(fe,Ld);return!0}beforeWorkflowExecution(fe){this.setExecutionState(fe,jk.Pending)}afterWorkflowExecution(fe){this.setExecutionState(fe,jk.Executed)&&this.tryToCompleteWorkflowExecution(fe)}clearWorkflowExecutions(){this.executionState.forEach((fe,Ld)=>this.afterWorkflowExecution(Ld))}tryToCompleteWorkflowExecution(fe){if(this.executionState.get(fe)===jk.Executed&&this.canCompleteExecution(fe)){this.executionState.delete(fe);
if(this.onContextIdWorkflowExecutionComplete)this.onContextIdWorkflowExecutionComplete(this.graphNode.workflow.id,fe);for(const Ld of this.downstreamWorkflowExecutionTrackers)for(const [ze,kf]of Ld.getExecutionState())kf===jk.Executed&&Ep.isParentContextId(fe,ze)&&Ld.tryToCompleteWorkflowExecution(ze)}}canCompleteExecution(fe){for(const Ld of this.upstreamWorkflowExecutionTrackers)for(const ze of Ld.getExecutionState().keys())if(Ep.isParentContextId(ze,fe))return!1;return!0}}var Xj;(function(fe){fe.Unknown=
"";fe.Epk="input";fe.cVg="maxAnnotation";fe.aqk="maxTimeout";fe.bVg="earlyCompletion"})(Xj||(Xj={}));class Ql{constructor(fe,Ld,ze){this.executionTrackersByWorkflowNameBySession=new Map;this.workflowsWithSessionAffinity=new Map;this.workflowDefinitionsWithSessionAffinity=[];this.workflowsWithoutSessionAffinity=[];this.pendingScopeExecutionNotificationsByWorkflow=new Map;this.sweepIntervalMs=200;this.sweepTimers=new Map;this.getResourceAsArrayBuffer=(kf,mg,Wf)=>this.modelDownloader?this.modelDownloader.getResourceAsArrayBuffer(kf,
mg,Wf):Promise.reject(Error("Resource Downloader never created"));this.getResourceAsURL=(kf,mg,Wf)=>this.modelDownloader?this.modelDownloader.getResourceAsURL(kf,mg,Wf):Promise.reject(Error("Resource Downloader never created"));this.createModel=kf=>{!this.inferenceService&&this.inferenceServiceFactory&&(this.inferenceService=this.inferenceServiceFactory());return this.inferenceService?this.inferenceService.then(mg=>mg.createModel(kf)):Promise.reject(Error("Inference Service never created"))};this.createModelInputs=
()=>{!this.inferenceService&&this.inferenceServiceFactory&&(this.inferenceService=this.inferenceServiceFactory());if(this.inferenceService)return this.inferenceService.then(kf=>kf.createInputs());throw Error("Inference Service never created");};this.nextSignalId=this.nextAnnotationId=1;this.modelDownloader=fe;this.inferenceServiceFactory=Ld;ze.enableDeltas&&(this.deltaHandlers=(new Map).set(pf.a.getTypeNameFor(Vk.b),Ka).set(pf.a.getTypeNameFor(Vk.a),Ra),this.itemsForDelta=new Map);this.enableEarlyJoin=
ze.enableEarlyJoin||!1;this.site={getResourceAsArrayBuffer:this.getResourceAsArrayBuffer,getResourceAsURL:this.getResourceAsURL,createModel:this.createModel,createModelInputs:this.createModelInputs}}getNextClientAnnotationId(){return"#AC"+this.nextAnnotationId++}getNextClientSignalId(){return"#SC"+this.nextSignalId++}registerLocalWorkflow(fe,Ld){const ze=(new Za({operationName:"WorkflowRegistration",resourceId:fe.id})).start();if(0===fe.inputTypes.length)throw Error("Invalid workflow params");Ld?
(this.workflowsWithSessionAffinity.get(Ld).push(this.createWorkflowImplementation(fe,Ld)),Ld.registerContextTypes(ue(fe.requestedContextTypesRules).map(([kf])=>kf)),Ld.attachToWorkflowGraph(fe),ze.setClientMetadata(Ld.getClientMetadata())):(fe.isStateful?(this.workflowDefinitionsWithSessionAffinity.push(fe),this.workflowsWithSessionAffinity.forEach((kf,mg)=>{kf.push(this.createWorkflowImplementation(fe,mg))})):this.workflowsWithoutSessionAffinity.push(this.createWorkflowImplementation(fe)),this.workflowsWithSessionAffinity.forEach((kf,
mg)=>{mg.registerContextTypes(ue(fe.requestedContextTypesRules).map(([Wf])=>Wf));mg.attachToWorkflowGraph(fe)}));ze.success=!0;tb.info(572838110,Oc.CoreDefault,ze.stop())}getAllRegisteredWorkflowsFromSession(fe){const Ld=[];Ld.push(...(this.workflowsWithoutSessionAffinity||[]));Ld.push(...(this.workflowsWithSessionAffinity.get(fe)||[]));return Ld.map(ze=>ze.workflow)}getWorkflowDefinitionsByName(fe){var Ld;const ze=new Map;null===(Ld=this.workflowsWithSessionAffinity.get(fe))||void 0===Ld||Ld.forEach(kf=>
ze.set(kf.workflow.id,kf.workflow));return ze}getWorkflowDefinitionsWithSessionAffinity(){return this.workflowDefinitionsWithSessionAffinity}attachExecutionTrackerToEachWorkflow(fe,Ld,ze){var kf=fe.getWorkflowNodes();fe=this.executionTrackersByWorkflowNameBySession.get(Ld);const mg=(Wf,Kf)=>{ze&&ze(Wf,Kf);this.enableEarlyJoin&&(()=>{for(const Ci of this.executionTrackersByWorkflowNameBySession.get(Ld).values())if(Ci.graphNode.workflow.kind===Gh.Join)for(const cj of Ci.getExecutionState().keys())if(Ep.isParentContextId(cj,
Kf))return!0;return!1})()&&(this.cancelSweepTimer(Ld),this.ensureSweepTimer(Ld),this.sweepScopeExecutionNotifications())};for(const Wf of kf)kf=fe.get(Wf.workflow.id),kf=new $s(Wf,mg.bind(this),kf),fe.set(Wf.workflow.id,kf);for(const Wf of fe.values())this.setDownstreamWorkflowExecutionTrackers(Wf,fe),this.setUpstreamWorkflowExecutionTrackers(Wf,fe)}canActivateWorkflow(fe,Ld){var ze;return fe.location===bf.Local?!0:!Ld.hasConnected||0<(null===(ze=fe.workflow.requiredTokenTypes)||void 0===ze?void 0:
ze.length)&&Ld.getServerAuthenticationState()===Fc.a.NotAuthenticated?!1:!0}setDownstreamWorkflowExecutionTrackers(fe,Ld){if(void 0===fe.downstreamWorkflowExecutionTrackers){fe.downstreamWorkflowExecutionTrackers=new Set;var ze=fe.graphNode;for(const kf of ze.downstreamWorkflows||[])ze=Ld.get(kf.workflow.id),this.setDownstreamWorkflowExecutionTrackers(ze,Ld),fe.downstreamWorkflowExecutionTrackers.add(ze)}}setUpstreamWorkflowExecutionTrackers(fe,Ld){if(void 0===fe.upstreamWorkflowExecutionTrackers){fe.upstreamWorkflowExecutionTrackers=
new Set;var ze=fe.graphNode;for(const kf of ze.upstreamWorkflows||[])ze=Ld.get(kf.workflow.id),this.setUpstreamWorkflowExecutionTrackers(ze,Ld),fe.upstreamWorkflowExecutionTrackers.add(ze)}}deactivateServerWorkflow(fe,Ld){var ze;fe.location!==bf.Local&&(null===(ze=this.executionTrackersByWorkflowNameBySession.get(Ld))||void 0===ze||ze.get(fe.workflow.id).clearWorkflowExecutions(),fe.isActivated=!1)}addSession(fe){this.executionTrackersByWorkflowNameBySession.set(fe,new Map);const Ld=[];for(const ze of this.workflowDefinitionsWithSessionAffinity)Ld.push(this.createWorkflowImplementation(ze)),
fe.attachToWorkflowGraph(ze);this.workflowsWithSessionAffinity.set(fe,Ld);for(const ze of this.workflowsWithoutSessionAffinity)fe.attachToWorkflowGraph(ze.workflow)}closeSession(fe){this.cancelSweepTimer(fe);for(const Ld of this.workflowsWithSessionAffinity.get(fe)||[])Ld.Kjk.dispose();this.workflowsWithSessionAffinity.delete(fe)}setTokenCallback(fe){this.getAuthTokenCallback=fe}preProcessItemToWorkflow(fe,Ld,ze){ze=this.executionTrackersByWorkflowNameBySession.get(ze).get(fe.id);fe.kind===Gh.Join&&
pf.a.matchesTypesFor(Ld.body,fe.inputTypes)&&ze.addInputItemToProcess(Ld.contextId);(fe.kind===Gh.SingleItem&&pf.a.matchesTypesFor(Ld.body,fe.inputTypes)||fe.kind===Gh.Join&&pf.a.matchesTypesFor(Ld.body,[fe.collectionScopeType]))&&ze.beforeWorkflowExecution(Ld.contextId)}isReadyToEarlyJoin(fe,Ld,ze){const kf=Ci=>{var cj;const di=Array.from(null!==(cj=Ci.P5a)&&void 0!==cj?cj:[]).map(rj=>`${rj[0]}: ${rj[1].map(bn=>bn.join())}`).join();cj=(new Za({operationName:"EarlyJoinCompletion",resourceId:fe.graphNode.workflow.id,
joinContextId:Ld,success:!0})).start();cj.setClientMetadata(ze);cj.resultDescription=`isReadyToEarlyJoin (${this.enableEarlyJoin}) -> hasProcessedAllInputItems: ${Ci.ITi}, allUpstreamComplete: ${Ci.GXd}, states: ${di}`;tb.info(512550800,Oc.CoreDefault,cj.stop())},mg=0===fe.countItemsToProcess(Ld);if(!mg)return this.enableEarlyJoin||kf({ITi:mg}),!1;const {GXd:Wf,P5a:Kf}=this.areAllUpstreamWorkflowComplete(fe,Ld);return this.enableEarlyJoin?Wf:(kf({ITi:mg,GXd:Wf,P5a:Kf}),!1)}areAllUpstreamWorkflowComplete(fe,
Ld){const ze=new Map;for(const kf of fe.upstreamWorkflowExecutionTrackers){fe=[];for(const [mg,Wf]of kf.getExecutionState())if(fe.push([mg,Wf]),Ep.isParentContextId(Ld,mg))return ze.set(kf.graphNode.workflow.id,fe),{GXd:!1,P5a:ze};0<fe.length&&ze.set(kf.graphNode.workflow.id,fe)}return{GXd:!0,P5a:ze}}runLocalWorkflows(fe,Ld,ze=!1){var kf,mg,Wf;const Kf=(cj,di,rj)=>{var bn,lo;const as=Ld.getWorkflowItemStorage(),sk=cj.workflow,jf=null===(bn=this.executionTrackersByWorkflowNameBySession.get(Ld))||void 0===
bn?void 0:bn.get(sk.id);bn=sk.inputTypes.concat(sk.kind===Gh.Join?sk.collectionScopeType:[]);const yk=(new Za({operationName:"RunLocalWorkflows",success:!0,resourceId:sk.id,joinContextId:di.contextId})).start();yk.setClientMetadata(Ld.getClientMetadata());if(pf.a.matchesTypesFor(di.body,bn)){const pq=Yf(rj.parentPath,di);if(sk.kind===Gh.Join){if(pf.a.matchesTypesFor(pq.body,[sk.collectionScopeType])){as.setScopeItem(pq,sk);yk.resultDescription=`Scope item: ${di.id} (${pf.a.getTypeNameFor(di.body)})`;
tb.info(524126153,Oc.CoreDefault,yk.stop());this.setScopeExecutionNotification(Ld,cj,pq);return}jf.removeProcessedInputItem(pq.contextId);rj=as.getScopeItem(pq.contextId,sk);if(!rj){yk.resultDescription=`Filtered out join invalidation: out of scope type (${sk.collectionScopeType}), item id: ${pq.id}`;tb.info(541173894,Oc.CoreDefault,yk.stop());return}as.addItemToWorkflowList(pq,sk);yk.joinContextId=rj.contextId;yk.resultDescription=`Input item: ${di.id} (${pf.a.getTypeNameFor(di.body)})`}if(0<=pf.a.getBaseTypesFor(pq.body).indexOf(gg.c.getTypeName())){rj=
[...pq.parentPath,pq.id];bn=!0;for(const Uq of null!==(lo=sk.outputTypes)&&void 0!==lo?lo:[])if(!Ld.getContextAnnotations(Uq,gn.LocalWorkflow,rj,sk.id)){bn=!1;break}if(bn)return}const bs=()=>{var Uq;const [Fo,Di]=Ld.resolveRequestedContexts(sk);if(!Fo)yk.resultDescription=`Required contexts are not ready for ${sk.id}. Retrying execution in ${500} milliseconds...`,tb.info(545837259,Oc.CoreDefault,yk.stop()),setTimeout(bs,500);else if(sk.kind===Gh.SingleItem)this.queueWorkflow({vKe:cj,scopeItem:pq,
inputItems:[pq],requestedContexts:Di,session:Ld,vlb:Xj.Epk,Ere:this.onWorkflowExecuted.bind(this,pq,sk,Ld)}).then(()=>{tb.info(509154263,Oc.WorkflowDefault,yk.stop())}).catch(Ea=>{yk.resultDescription=Ea;tb.error(572838111,Oc.CoreDefault,yk.stop())});else if(sk.kind===Gh.Join){var nq=di.contextId;const Ea=as.getScopeItem(nq,cj.workflow);if(Ea){var rl=this.isReadyToEarlyJoin(jf,Ea.contextId,Ld.getClientMetadata());nq=rl?Xj.bVg:Xj.cVg;if(as.isWorkflowReady(Ea.contextId,sk)||rl)null!==(Uq=this.pendingScopeExecutionNotificationsByWorkflow.get(sk.id))&&
void 0!==Uq&&Uq.get(Ea.contextId)?(Uq=as.getItemsToExecute(Ea.contextId,sk),this.queueWorkflow({vKe:cj,scopeItem:Ea,inputItems:Uq,requestedContexts:Di,session:Ld,vlb:nq,Ere:this.onWorkflowExecuted.bind(this,Ea,sk,Ld)}).then(()=>{tb.info(509154262,Oc.WorkflowDefault,yk.stop())}).catch(Pb=>{yk.resultDescription=Pb;tb.error(541173895,Oc.CoreDefault,yk.stop())}),this.pendingScopeExecutionNotificationsByWorkflow.get(sk.id).delete(Ea.contextId),0===this.pendingScopeExecutionNotificationsByWorkflow.get(sk.id).size&&
this.pendingScopeExecutionNotificationsByWorkflow.delete(sk.id)):(yk.resultDescription=`Workflow ${sk.id}, contextId ${Ea.contextId}, already queued, skipping new scope execution`,tb.info(528048977,Oc.CoreDefault,yk.stop()))}else yk.resultDescription=`No scope item for ${sk.id} workflow from contextId ${nq}`,tb.info(526758475,Oc.CoreDefault,yk.stop())}};bs()}};let Ci=fe;ze&&(Ci=[new Ai.a({parentPath:["session"],items:[{id:"#userContext#",body:new gg.o}]}),new Ai.a({parentPath:["session"],items:[{id:"#tenantContext#",
body:new gg.l}]})],Ld.getContextIdManager().applyContextIdOnOperations(Ci),Ci=Ci.concat(fe));for(const cj of Ci){fe=pf.a.getTypeNameFor(cj);for(const di of cj.items)if(Ld.applyOperationForContext(cj,di,gn.Submitted),fe===Ai.c.getTypeName())null===(kf=this.itemsForDelta)||void 0===kf||kf.delete(cj.parentPath.concat(di.id).toString());else if(di.body)if(fe===Ai.d.getTypeName()&&this.deltaHandlers&&this.itemsForDelta)this.handleLocalDeltaUpdate(di,cj,Ld);else{null===(mg=this.itemsForDelta)||void 0===
mg||mg.set(cj.parentPath.concat(di.id).toString(),di);for(const rj of this.workflowsWithoutSessionAffinity)Kf(rj,di,cj);for(const rj of null!==(Wf=this.workflowsWithSessionAffinity.get(Ld))&&void 0!==Wf?Wf:[])Kf(rj,di,cj)}}}handleLocalDeltaUpdate(fe,Ld,ze){const kf=new Za({operationName:"LocalDeltaUpdate",dimension0:pf.a.getTypeNameFor(fe.body),success:!0});kf.start();try{const mg=this.deltaHandlers.get(pf.a.getTypeNameFor(fe.body)),Wf=this.itemsForDelta.get(Ld.parentPath.toString());if(mg&&Wf){const Kf=
0<Ld.parentPath.length?Ld.parentPath.slice(0,Ld.parentPath.length-1):Ld.parentPath,Ci=mg(fe.body,Wf.body);if(Ci){const cj={id:Wf.id,revId:fe.revId,body:Ci,parentPath:Kf,delta:fe.body,contextId:fe.contextId},di=new Ai.k({parentPath:cj.parentPath,items:[cj]});tb.info(539637591,Oc.CoreDefault,kf.stop());this.runLocalWorkflows([di],ze)}else kf.success=!1,kf.resultDescription="Failed because the handler did not produce valid updated item",tb.info(539637592,Oc.CoreDefault,kf.stop())}else kf.success=!1,
kf.resultDescription="Failed due to lack of handler or parent item",tb.info(539637593,Oc.CoreDefault,kf.stop())}catch(mg){kf.success=!1,kf.resultDescription=`Failed to apply delta, error: ${mg}`,tb.info(539637594,Oc.CoreDefault,kf.stop())}}createWorkflowImplementation(fe,Ld){const ze=fe.factory();return{workflow:fe,Kjk:ze,initPromise:this.initWorkflow(fe.kind,ze,Ld)}}initWorkflow(fe,Ld,ze){ze=new $h({model:void 0,clientMetadata:ze?ze.getClientMetadata():void 0,userContext:ze?ze.getUserContext():void 0,
site:this.site,getTokenCallback:this.getAuthTokenCallback});return fe===Gh.SingleItem?Ld.init(this.site,ze):fe===Gh.Join?Ld.init(this.site,ze):Promise.resolve()}queueWorkflow(fe){this.executionTrackersByWorkflowNameBySession.get(fe.session).get(fe.vKe.workflow.id).setExecutionState(fe.scopeItem.contextId,jk.Running);return this.executeLocalWorkflow(fe.vKe,fe.scopeItem,fe.inputItems,fe.session,fe.requestedContexts,fe.vlb).then(Ld=>{this.processAnnotationResults(Ld,fe.session);fe.Ere()}).catch(Ld=>
{fe.Ere();throw Ld;})}processAnnotationResults(fe,Ld){for(const ze of fe)Ld.onAnnotationResults(ze,gn.LocalWorkflow,()=>{})}executeLocalWorkflow(fe,Ld,ze,kf,mg,Wf){return new Promise((Kf,Ci)=>{var cj,di,rj;const bn=[],lo=fe.workflow,as=(new Za({operationName:"ExecuteWorkflow",resourceId:lo.id,joinContextId:null!==(cj=null===Ld||void 0===Ld?void 0:Ld.contextId)&&void 0!==cj?cj:"",resultDescription:null!==Wf&&void 0!==Wf?Wf:"",success:!0})).setClientMetadata(kf.getClientMetadata());as.start();const sk=
null!==(di=null===Ld||void 0===Ld?void 0:Ld.contextId)&&void 0!==di?di:ze[0].contextId,jf=null!==(rj=null===Ld||void 0===Ld?void 0:Ld.revId)&&void 0!==rj?rj:ze[0].revId,yk=(()=>{const Di=new Map;Ld&&(Ld.parentPath||tb.error(525382231,Oc.CoreDefault,`Missing scope item parent. Workflow: ${lo.id}. Type: ${pf.a.getTypeNameFor(Ld.body)}`),Di.set(Ld.body,Ld));if(Array.isArray(ze))for(const nq of ze)nq&&nq.body&&(nq.parentPath||tb.error(525382232,Oc.CoreDefault,`Missing parent. Workflow: ${lo.id}. Type: ${pf.a.getTypeNameFor(nq.body)}`),
Di.set(nq.body,nq));return Di})(),pq=(Di,nq=as)=>{if(Di)return nq.success=!1,nq.resultDescription+="string"===typeof Di?Di:Di.message,nq.resultSignature="Exception",tb.error(572838112,Oc.CoreDefault,nq.stop()),"string"===typeof Di?Error(Di):Di;tb.info(572838113,Oc.CoreDefault,nq.stop())},bs=new $h({model:new Eq(ze[0],mg),clientMetadata:kf.getClientMetadata(),userContext:kf.getUserContext(),site:this.site,getTokenCallback:this.getAuthTokenCallback});cj=Di=>{pq(Di?Di.message:void 0);Di?Ci(Di):Kf(bn)};
const Uq={setAnnotations:(Di,nq,rl,Ea)=>{var Pb;const Dc=(new Za({operationName:"SetAnnotations",resourceId:nq,joinContextId:null!==(Pb=null===Ld||void 0===Ld?void 0:Ld.contextId)&&void 0!==Pb?Pb:"",success:!0})).setClientMetadata(kf.getClientMetadata());Dc.start();const Gd=Fe=>{tb.info(555866112,Oc.CoreDefault,new kr({annotationType:nq,annotationState:Fe,workflowId:fe.workflow.id}))};for(var qd of rl)qd.metadata=Object.assign(Object.assign({},qd.metadata),{state:jm.a.Created}),Gd(jm.a.Created);const cf=
yk.get(Di);Pb=pf.a.getTypeNameFor(cf.body);if(qd=(()=>{if(lo.kind===Gh.SingleItem&&ze[0].body!==Di){var Fe=`Expected obj to be ${ze[0].body} but instead it was ${Di}`;pq(Fe,Dc);Ci(pq(Fe))}else{if(Array.isArray(rl))if(!lo.outputTypes||0>lo.outputTypes.indexOf(nq))var vg=`Workflow said it would output one of [${lo.outputTypes}] but instead output ${nq}`;else if(cf)for(var sj of rl)pf.a.matchesTypesFor(sj,[yg.a.getTypeName()])?pf.a.getTypeNameFor(sj)!==nq&&(vg=`Workflow produced inconsistent annotation types in setAnnotations call (${pf.a.getTypeNameFor(sj)} did not match expected ${nq})`):
vg=`Workflow produced an output that is not an annotation ${pf.a.getTypeNameFor(sj)}`;else vg="No item provided";else vg="Workflow produced an invalid annotation array";if(vg)pq(vg,Dc),Ci(pq(vg));else{vg=Ea&&Ea.isSessionAnnotation?["session"]:Ea&&Ea.ancestorType?cf.parentPath:cf.parentPath.concat(cf.id);sj=[];var uh=[];for(const oj of rl){oj.metadata=Object.assign(Object.assign({},oj.metadata),{state:jm.a.Sent});Gd(jm.a.Sent);const bm=oj.id,Un=bm?null===(Fe=kf.getContextAnnotations(nq,gn.LocalWorkflow,
vg,lo.id))||void 0===Fe?void 0:Fe.filter(Om=>{var qq;return(null===(qq=Om.body)||void 0===qq?void 0:qq.id)==bm}):void 0;1==(null===Un||void 0===Un?void 0:Un.length)?1==Un.length?uh.push({id:Un[0].id,source:lo.id,revId:jf,body:oj,contextId:sk}):tb.error(545837260,Oc.CoreDefault,`Assert: Multiple existing context annotations with body id ${bm} found for ${nq} and local workflow ${lo.id}).`):sj.push({id:this.getNextClientAnnotationId(),source:lo.id,revId:jf,body:oj,contextId:sk})}Fe=[];0<sj.length&&
Fe.push(new Ai.a({parentPath:vg,items:sj,parentRevId:jf}));0<uh.length&&Fe.push(new Ai.q({parentPath:vg,items:uh,parentRevId:jf}));return new Ub.g({annotationType:nq,ops:Fe})}}})()){if(Ea&&Ea.immediate)kf.onAnnotationResults(qd,gn.LocalWorkflow,()=>{});else bn.push(qd);(Pb==gg.o.getTypeName()||Pb==gg.l.getTypeName()||pf.a.matchesTypesFor(cf.body,[gg.d.getTypeName(),gg.k.getTypeName()]))&&kf.submitOperationsToSession(qd.ops);tb.info(509644822,Oc.CoreDefault,Dc.stop())}else tb.info(509644823,Oc.CoreDefault,
Dc.stop())},submitSignals:Di=>{const nq=(new Za({operationName:"submitSignalsAction",resourceId:lo.id,success:!0})).setClientMetadata(kf.getClientMetadata());for(const rl of Di){const Ea=pf.a.getTypeNameFor(rl);pf.a.matchesTypesFor(rl,[ii.c.getTypeName()])||(nq.resultDescription=`Workflow produced an output that is not an signal (${pf.a.getTypeNameFor(rl)})`,tb.info(521413954,Oc.CoreDefault,nq));lo.outputTypes&&-1!==lo.outputTypes.indexOf(Ea)||(nq.resultDescription=`Workflow said it would output one of [${lo.outputTypes}] but instead output ${Ea}`,
tb.info(521413953,Oc.CoreDefault,nq));rl.timestamp&&!Ql.logTimestampUsageByWorkflowId.has(lo.id)&&(Ql.logTimestampUsageByWorkflowId.add(lo.id),nq.resultDescription=`Workflow "${lo.id}" sets signal.timeStamp`,tb.info(509212803,Oc.CoreDefault,nq))}Di=Di.map(rl=>({id:this.getNextClientSignalId(),source:lo.id,revId:jf,body:rl,contextId:sk}));Di=new Ai.o({parentPath:["session"],parentRevId:jf,items:Di});kf.submitOperations([Di])},done:cj,overrideWorkflowDefinition:(Di,nq,rl)=>{switch(rl){case $m.JoinContext:if(!Ld.contextId)throw tb.error(527472289,
Oc.CoreDefault,"ContextId is not defined for this scope item."),Error("ContextId is not defined for this scope item.");rl=Ld.contextId;break;case $m.Session:rl=void 0;break;default:throw Di="Defined scope is not supported. "+rl,tb.error(527472290,Oc.CoreDefault,Di),Error(Di);}Di=new bh({definition:nq,contextId:rl,sourceWorkflowId:lo.id,targetWorkflowId:Di});kf.onWorkflowDefinitionOverrideMessage(Di)},getDynamicAnnotations:void 0,setBillingDomain:void 0},Fo=fe.Kjk;if(lo.kind===Gh.SingleItem){1!==ze.length&&
cj(Error("Single item workflows expect a single input"));bs.delta=ze[0].delta;bs.deltas=ze[0].deltas;try{fe.initPromise||(fe.initPromise=Fo.init(this.site,bs)),fe.initPromise.then(()=>{Fo.execute(ze[0].body,bs,Uq)}).catch(Di=>{pq(Di)})}catch(Di){pq(Di)}}else if(lo.kind===Gh.Join){0===ze.length&&cj(Error("Join workflows expect an inputs array"));bs.delta=Ld.delta;bs.deltas=Ld.deltas;try{fe.initPromise||(fe.initPromise=Fo.init(this.site,bs)),fe.initPromise.then(()=>{Fo.execute(Ld.body,ze.map(Di=>Di.body),
bs,Uq)}).catch(Di=>{pq(Di)})}catch(Di){pq(Di)}}else pq(`Workflow kind ${lo.kind} not supported`)})}ensureSweepTimer(fe){if(!this.sweepTimers.get(fe)){const Ld=setInterval(this.onSweep.bind(this),this.sweepIntervalMs);this.sweepTimers.set(fe,Ld)}}cancelSweepTimer(fe){const Ld=this.sweepTimers.get(fe);this.sweepTimers.get(fe)&&(clearInterval(Ld),this.sweepTimers.delete(fe))}onSweep(){this.sweepScopeExecutionNotifications()}setScopeExecutionNotification(fe,Ld,ze){var kf,mg,Wf=Date.now(),Kf=Wf+qe(Ld.workflow.minDelayMs,
1E3);const Ci=Wf+qe(Ld.workflow.maxDelayMs,5E3);Wf={session:fe,QSg:Ld,scopeItem:ze,startTime:Wf,minTime:Kf,maxTime:Ci};Kf=Ld.workflow.kind===Gh.Join?ze.contextId:Wf.scopeItem.parentPath.concat(ze.id).join("\\");this.pendingScopeExecutionNotificationsByWorkflow.get(Ld.workflow.id)||this.pendingScopeExecutionNotificationsByWorkflow.set(Ld.workflow.id,new Map);this.pendingScopeExecutionNotificationsByWorkflow.get(Ld.workflow.id).get(Kf)?(Ld=(new Za({resultDescription:`Duplicated pending scope execution for ${Ld.workflow.id} at ${Kf}`,
operationName:"LocalScopeExecutionNotification",resourceId:Ld.workflow.id,joinContextId:null!==(mg=null===ze||void 0===ze?void 0:ze.contextId)&&void 0!==mg?mg:"",success:!0})).setClientMetadata(fe.getClientMetadata()).start(),tb.info(509727899,Oc.CoreDefault,Ld.stop())):(mg=(new Za({resultDescription:`New pending scope execution for ${Ld.workflow.id} at ${Kf}`,operationName:"LocalScopeExecutionNotification",resourceId:Ld.workflow.id,joinContextId:null!==(kf=null===ze||void 0===ze?void 0:ze.contextId)&&
void 0!==kf?kf:"",success:!0})).setClientMetadata(fe.getClientMetadata()).start(),tb.info(539883075,Oc.CoreDefault,mg.stop()),this.pendingScopeExecutionNotificationsByWorkflow.get(Ld.workflow.id).set(Kf,Wf));this.ensureSweepTimer(fe)}sweepScopeExecutionNotifications(){var fe,Ld;const ze=new Set(Array.from(this.sweepTimers.keys()));for(const [kf,mg]of Array.from(this.pendingScopeExecutionNotificationsByWorkflow.entries()))for(const [Wf,Kf]of Array.from(mg.entries())){const Ci=Kf.session,cj=Kf.QSg.workflow,
di=Ci.getWorkflowItemStorage(),rj=(new Za({operationName:"LocalScopeExecutionNotification",resourceId:cj.id,joinContextId:null!==(Ld=null===(fe=Kf.scopeItem)||void 0===fe?void 0:fe.contextId)&&void 0!==Ld?Ld:"",success:!0})).setClientMetadata(Ci.getClientMetadata()).start(),bn=()=>{if(cj.kind===Gh.Join){const lo=Date.now(),as=Kf.QSg.workflow,sk=Kf.scopeItem.contextId,jf=Ci.getWorkflowDefinition(as,sk).maxDelayMs;return di.isWorkflowReady(sk,as)?(rj.resultDescription=`Join Workflow: ${as.id} queuing by maxAnnotation, contextId: ${sk}`,
tb.info(528048978,Oc.CoreDefault,rj.stop()),{isValid:!0,vlb:Xj.cVg}):Kf.startTime+jf<lo?(rj.resultDescription=`Join Workflow: ${as.id} queuing by maxTimeout, contextId: ${sk}`,tb.info(528048979,Oc.CoreDefault,rj.stop()),{isValid:!0,vlb:Xj.aqk}):this.isReadyToEarlyJoin(this.executionTrackersByWorkflowNameBySession.get(Ci).get(as.id),sk,Ci.getClientMetadata())?(tb.info(512550856,Oc.CoreDefault,`Workflow: ${as.id} queuing by early completion, contextId: ${sk}, timeout: ${jf}`),{isValid:!0,vlb:Xj.bVg}):
{isValid:!1,vlb:Xj.Unknown}}return{isValid:!0,vlb:Xj.Unknown}};(()=>{const {isValid:lo,vlb:as}=bn();if(!lo)return!1;const [sk,jf]=Ci.resolveRequestedContexts(cj);if(!sk)return!1;try{if(cj.kind===Gh.Join){const yk=Kf.scopeItem.contextId,pq=di.getScopeItem(yk,cj);if(pq){const bs=di.getItemsToExecute(pq.contextId,cj);if(0===bs.length)return rj.resultDescription=`Failed to retrieve items for workflow: ${cj.id}, contextId: ${yk}, skipping execution`,tb.info(527472291,Oc.CoreDefault,rj.stop()),this.onWorkflowExecuted(pq,
cj,Ci),!0;this.queueWorkflow({vKe:Kf.QSg,scopeItem:pq,inputItems:bs,requestedContexts:jf,session:Ci,vlb:as,Ere:this.onWorkflowExecuted.bind(this,pq,cj,Ci)}).catch(Uq=>{rj.success=!1;rj.resultDescription=Uq.message;tb.error(509092189,Oc.CoreDefault,rj.stop())})}else rj.resultDescription="ContextId no longer exists, skipping workflow execution",tb.info(539883076,Oc.CoreDefault,rj.stop())}else rj.resultDescription=`Workflow in type ${cj.kind} is not supported`,tb.error(539883077,Oc.CoreDefault,rj.stop())}catch(yk){rj.resultDescription=
`Trying to execute ${cj.id} caused an exception: ${yk}`,tb.warn(539883078,Oc.CoreDefault,rj.stop())}return!0})()?(this.pendingScopeExecutionNotificationsByWorkflow.get(kf).delete(Wf),0===this.pendingScopeExecutionNotificationsByWorkflow.get(kf).size&&this.pendingScopeExecutionNotificationsByWorkflow.delete(kf)):ze.delete(Ci)}if(0!==ze.size)for(const kf of Array.from(ze))fe=(new Za({resultDescription:"No pending scope notifications left, cancelling sweep timer",operationName:"LocalScopeExecutionNotification",
success:!0})).start(),tb.debug(539883079,Oc.CoreDefault,fe.stop()),this.cancelSweepTimer(kf)}onExternalWorkflowExecuted(fe,Ld,ze){this.onWorkflowExecuted({id:"",parentPath:[],contextId:fe},{id:Ld},ze,!1)}onWorkflowExecuted(fe,Ld,ze,kf=!0){var mg;null===(mg=this.executionTrackersByWorkflowNameBySession.get(ze).get(Ld.id))||void 0===mg||mg.afterWorkflowExecution(fe.contextId);if(kf&&Ld.kind===Gh.Join)ze.getWorkflowItemStorage().onWorkflowExecuted(fe,Ld)}}class ut{constructor(fe=500,Ld=!1){this.prevSeq=
-1;this.bufferingTimeMs=fe;this.rejectOutdatedSequenceNumbers=Ld}sequence(fe){return new Promise((Ld,ze)=>{if(fe<this.prevSeq){if(this.rejectOutdatedSequenceNumbers){Ld=Error(`BufferingSequencer: Item out of order. Expecting seqId > ${this.prevSeq}. Actual seqId ${fe}`);Ld.name=ut.Rejected;ze(Ld);return}this.prevSeq=-1}fe!=this.prevSeq+1&&tb.warn(542712385,Oc.CoreDefault,`BufferingSequencer: got out of order sequence number. Got ${fe}, expected ${this.prevSeq+1}`);ze={seq:fe,resolve:Ld};this.insertItem(ze);
this.runInOrder(ze,!0,!1)})}insertItem(fe){if(this.firstQueueItem){var Ld=this.lastQueueItem,ze=null;do{if(fe.seq>Ld.seq){fe.$n=Ld;Ld.next=fe;ze?(ze.$n=fe,fe.next=ze):this.lastQueueItem=fe;return}ze=Ld;Ld=Ld.$n}while(Ld);ze&&(ze.$n=fe);fe.next=ze;this.firstQueueItem=fe}else this.lastQueueItem=this.firstQueueItem=fe}runInOrder(fe,Ld,ze){let kf=this.prevSeq,mg=!1;const Wf=[];for(;this.firstQueueItem;){const Kf=this.firstQueueItem;if(kf+1!=Kf.seq&&(!ze||Kf.seq>fe.seq))break;kf=Kf.seq;Kf.timeout&&clearTimeout(Kf.timeout);
Wf.push(Kf);fe==Kf&&(mg=!0);if(this.firstQueueItem=this.firstQueueItem.next)this.firstQueueItem.$n=null}0<Wf.length&&setTimeout(()=>{for(const Kf of Wf)Kf.resolve(Kf.seq)},0);this.prevSeq=kf;!mg&&Ld&&(fe.timeout=setTimeout(()=>{this.runInOrder(fe,!1,!0)},this.bufferingTimeMs))}}ut.Rejected="SequenceItemRejected";class lu{constructor(fe=500){this.bufferingTimeMs=500;this.workflowIdToSequencersMap=new Map;this.bufferingTimeMs=fe}create(fe){if(!fe.ownerId)return null;let Ld=this.workflowIdToSequencersMap.get(fe.ownerId);
Ld||(Ld=new ut(this.bufferingTimeMs),this.workflowIdToSequencersMap.set(fe.ownerId,Ld));return Ld}}class Nm{constructor(fe=500,Ld){this.sequencerFactory=null!==Ld&&void 0!==Ld?Ld:new lu(fe)}sequence(fe){var Ld;return k(this,void 0,void 0,function*(){var ze=null===(Ld=null===fe||void 0===fe?void 0:fe.M_)||void 0===Ld?void 0:Ld.seq;null!==ze&&void 0!==ze&&(ze=this.sequencerFactory.create(fe))&&(yield ze.sequence(fe.M_.seq))})}}class Mi{constructor(fe){this.annotationSequencer=null!==fe&&void 0!==fe?
fe:new Nm}process(fe,Ld,ze,kf){const mg=[];for(const Wf of fe.ops){const Kf=[];if(null===Wf||void 0===Wf?0:Wf.items)for(const Ci of Wf.items){const cj=this.annotationSequencer.sequence(Ci.body).then(()=>{Ld(Wf,Ci)});Kf.push(cj)}mg.push(Promise.all(Kf).then(()=>{ze(Wf,fe.cv)}))}Promise.all(mg).then(()=>kf(fe))}}class Qp{process(fe,Ld,ze,kf){for(const mg of fe.ops){if(null===mg||void 0===mg?0:mg.items)for(const Wf of mg.items)Ld(mg,Wf);ze(mg,fe.cv)}kf(fe)}}class vs{constructor(fe,Ld,ze){this.isOrderingEnabled=
fe;this.orderedAnnotationResultsProcessor=null!==Ld&&void 0!==Ld?Ld:new Mi;this.unorderedAnnotationResultsProcessor=null!==ze&&void 0!==ze?ze:new Qp}process(fe,Ld,ze,kf){this.isOrderingEnabled()?this.orderedAnnotationResultsProcessor.process(fe,Ld,ze,kf):this.unorderedAnnotationResultsProcessor.process(fe,Ld,ze,kf)}}class ni{constructor(fe,Ld){this.changeGatesInitialized=!1;this.hostCallbacks=fe;this.changeGateMap=Ld||new Map}init(){return t(this,void 0,void 0,function*(){const fe=[];this.hostCallbacks&&
this.hostCallbacks.isChangeGateEnabled&&this.changeGateMap.forEach((Ld,ze)=>{fe.push(this.hostCallbacks.isChangeGateEnabled(ze).then(kf=>{this.changeGateMap.set(ze,kf)}))});yield Promise.all(fe).then(()=>{this.changeGatesInitialized=!0}).catch(()=>{})})}isFeatureEnabled(fe,Ld=!1,ze="None"){return this.hostCallbacks&&this.hostCallbacks.isFeatureEnabled?this.hostCallbacks.isFeatureEnabled(fe,ze).catch(()=>Promise.resolve(Ld)):Promise.resolve(Ld)}isChangeGateEnabled(fe){return t(this,void 0,void 0,function*(){return this.changeGateMap?
this.changeGatesInitialized&&this.changeGateMap.has(fe)?this.changeGateMap.get(fe):!this.changeGatesInitialized&&this.hostCallbacks?yield this.hostCallbacks.isChangeGateEnabled(fe):!0:!0})}isChangeGatesInitialized(){return this.changeGatesInitialized}getChangeGateMap(){return this.changeGateMap}}class nd{constructor(fe,Ld,ze){this.sessionsByDocSessionId=new Map;this.hasBeenInitialized=this.disableSyncDeltaSending=this.isDeltaGeneratorEnabled=!1;this.telemetryLogger=null;this.changeGateList=new Map([["SkipCheckingCachedClaimsChallenge",
!0],["LogRetryMessageEvent",!0],["ImproveClientRetries",!0],["ShouldNotRetryOnSessionClosedError",!0],["CloseSessionsOnRuntimeUninit",!0],["ShouldAppendClientFeatureFlights",!0],["DontSendNewTokenOnReconnect",!0]]);this.settings={annotationsOrderingEnabled:!0,deltaOperationsEnabled:!1,defaultBatchingEnabled:!0,batchingWith20msIntervalEnabled:!0,onAnnotationsSubmittedEnabled:!1,reduceBatchOperationsEnabled:!1,batchMessagesEnabled:!1,dynamicRateControllerEnabled:!1,removeDuplicateFlights:!0,annotationDoesNotExistOnService:!0,
reducedPingPongRetryEnabled:!1,maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled:!1,sendTokenFailureMessage:!0,closeSessionsOnRuntimeUninit:!1,shouldAppendClientFeatureFlights:!0,authTokenTimeoutMs:0,doNotSendNewTokenOnReconnect:!1};this.isDownloaderCompatible=()=>"undefined"!==typeof Array&&"undefined"!==typeof Array.from&&"undefined"!==typeof URL&&"undefined"!==typeof URL.createObjectURL?!0:!1;this.workerFactory=fe||(mg=>mg&&mg===Dl.HttpFallback?new Rg:new $c);const kf=this.createDefaultSessionManagerFactory();
this.sessionManagerFactory=(...mg)=>(null===Ld||void 0===Ld?void 0:Ld(...mg))||kf(...mg);this.sessionFactory=ze||(mg=>new Lk(mg))}init(fe,Ld,ze,kf){var mg,Wf,Kf,Ci,cj,di,rj,bn,lo,as;const sk=new Za({operationName:"InitRuntime",resourceId:Yb(fe),dimension1:this.hasBeenInitialized.toString()});sk.start();this.hasBeenInitialized=!0;this.hostCallbacks=ze;this.gateUtils=new ni(this.hostCallbacks,this.changeGateList);if(this.clientMetadata=Ld)this.clientMetadata.runtimeVersion=v(88407).a;this.telemetryLogger=
new bc(this.hostCallbacks);this.shouldAddLogger(sk)?(tb.addLogger(this.telemetryLogger),this.addLoggingAggregator(kf)):(tb.clearLoggers(),tb.addLogger(this.telemetryLogger));nd.haveCalledInit=!0;this.annotationResultsProcessor=new vs(()=>this.settings.annotationsOrderingEnabled);this.inferenceServiceFactory=kf.inferenceServiceFactory;sk.dimension2=Ic(wb.info).length.toString();ze=[];fe&&(this.defaultServiceUrl=uc.convertServiceUrlToWebSocket(fe),this.serviceProtocol=this.defaultServiceUrl.split(":")[0].toLowerCase());
ze.push(this.gateUtils.init().then(()=>d(this,void 0,void 0,function*(){yield Promise.all([this.gateUtils.isChangeGateEnabled("CloseSessionsOnRuntimeUninit").then(yk=>{this.settings.closeSessionsOnRuntimeUninit=yk}).catch(()=>this.settings.closeSessionsOnRuntimeUninit=!1),this.gateUtils.isChangeGateEnabled("ShouldAppendClientFeatureFlights").then(yk=>{this.settings.shouldAppendClientFeatureFlights=yk}).catch(()=>this.settings.shouldAppendClientFeatureFlights=!1),this.gateUtils.isChangeGateEnabled("DontSendNewTokenOnReconnect").then(yk=>
{this.settings.doNotSendNewTokenOnReconnect=yk}).catch(()=>this.settings.doNotSendNewTokenOnReconnect=!1)])})));ze.push(this.isFeatureEnabled("AnnotationsOrderingEnabled",!0).then(yk=>{this.settings.annotationsOrderingEnabled=yk}));ze.push(this.isFeatureEnabled("DefaultBatchingDisabled").then(yk=>{var pq;(pq=this.settings).defaultBatchingEnabled&&(pq.defaultBatchingEnabled=!yk)}));ze.push(this.isFeatureEnabled("BatchingWith20msIntervalDisabled").then(yk=>{var pq;(pq=this.settings).batchingWith20msIntervalEnabled&&
(pq.batchingWith20msIntervalEnabled=!yk)}));ze.push(this.isFeatureEnabled("OnAnnotationsSubmittedDisabled").then(yk=>{var pq;(pq=this.settings).onAnnotationsSubmittedEnabled&&(pq.onAnnotationsSubmittedEnabled=!yk)}));ze.push(this.isFeatureEnabled("ReduceBatchOperationsEnabled").then(yk=>{var pq;(pq=this.settings).reduceBatchOperationsEnabled||(pq.reduceBatchOperationsEnabled=yk)}));ze.push(this.isFeatureEnabled("BatchMessagesEnabled").then(yk=>{var pq;(pq=this.settings).batchMessagesEnabled||(pq.batchMessagesEnabled=
yk)}));ze.push(uc.isChangeGateEnabled(this.hostCallbacks,"DynamicRateControllerEnabled").then(yk=>{this.settings.dynamicRateControllerEnabled=yk}));ze.push(uc.isChangeGateEnabled(this.hostCallbacks,"AnnotationDoesNotExistOnService").then(yk=>{this.settings.annotationDoesNotExistOnService=yk}));ze.push(uc.isFeatureEnabled(this.hostCallbacks,"ReducedPingPongRetryEnabled").then(yk=>{var pq;(pq=this.settings).reducedPingPongRetryEnabled||(pq.reducedPingPongRetryEnabled=yk)}));ze.push(this.isFeatureEnabled("MaxNumberOfDeltaUpdateOpsPerItemPerBatch").then(yk=>
{var pq;(pq=this.settings).maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled||(pq.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=yk)}));ze.push(uc.isChangeGateEnabled(this.hostCallbacks,"SendTokenFailureMessage").then(yk=>{this.settings.sendTokenFailureMessage=yk}));const jf={enableDeltas:!1,enableEarlyJoin:!1};ze.push(Promise.all([this.isFeatureEnabled("DeltaOperationsEnabled").then(yk=>jf.enableDeltas=yk).catch(()=>jf.enableDeltas=!1),this.isFeatureEnabled("EarlyJoinCompletionEnabled").then(yk=>
jf.enableEarlyJoin=yk).catch(()=>jf.enableEarlyJoin=!1)]).then(()=>{this.localWorkflowManager=new Ql(kf.modelDownloader&&this.isDownloaderCompatible()?kf.modelDownloader:void 0,this.inferenceServiceFactory,jf)}));fe=ta(null!==(mg=Ld.flights)&&void 0!==mg?mg:"");this.isDeltaGeneratorEnabled=fe.getBooleanValue("Microsoft.Office.WordOnline.AugloopDeltas",null!==(Wf=kf.isDeltaGeneratorEnabled)&&void 0!==Wf?Wf:!1);this.disableSyncDeltaSending=fe.getBooleanValue("Microsoft.Office.WordOnline.DisableSyncDeltaSending",
null!==(Kf=kf.disableSyncDeltaSending)&&void 0!==Kf?Kf:!1);this.syncDeltaTimeout=fe.getIntValue("Microsoft.Office.WordOnline.SyncDeltaTimeout",kf.syncDeltaTimeout);(Ci=this.settings).defaultBatchingEnabled&&(Ci.defaultBatchingEnabled=!fe.getBooleanValue("DefaultBatchingDisabled",!1));(cj=this.settings).batchingWith20msIntervalEnabled&&(cj.batchingWith20msIntervalEnabled=!fe.getBooleanValue("BatchingWith20msIntervalDisabled",!1));(di=this.settings).reduceBatchOperationsEnabled||(di.reduceBatchOperationsEnabled=
fe.getBooleanValue("ReduceBatchOperationsEnabled",!1));(rj=this.settings).batchMessagesEnabled||(rj.batchMessagesEnabled=fe.getBooleanValue("BatchMessagesEnabled",!1));(bn=this.settings).removeDuplicateFlights&&(bn.removeDuplicateFlights=fe.getBooleanValue("RemoveDuplicateFlights",!0));(lo=this.settings).reducedPingPongRetryEnabled||(lo.reducedPingPongRetryEnabled=fe.getBooleanValue("ReducedPingPongRetryEnabled",!1));(as=this.settings).maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled||(as.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=
fe.getBooleanValue("maxNumberOfDeltaUpdateOpsPerItemPerBatch",!1));this.settings.authTokenTimeoutMs=fe.getIntValue("AuthTokenTimeoutMs",0);sk.setDataField("Flights",JSON.stringify(this.settings));kf&&kf.loggableUrls&&ed.push(...kf.loggableUrls);return Promise.all(ze).then(()=>{this.batchOptions=kf.batchOptions;!this.batchOptions&&this.settings.defaultBatchingEnabled&&(this.batchOptions={delayMs:1,maxInputSize:1E6,delayMsMax:50},this.settings.batchingWith20msIntervalEnabled&&(this.batchOptions.delayMs=
20));this.batchOptions&&!this.batchOptions.delayMsMax&&(this.batchOptions.delayMsMax=50);kf&&kf.networkMode&&(this.networkMode=kf.networkMode,kf.networkMode===Dl.LocalWorkflowsOnly&&(this.sessionManagerFactory=()=>new Hn));sk.dimension0=JSON.stringify(this.batchOptions);this.logOperation(sk,!0)}).catch(yk=>{this.logOperation(sk,!1,"Error",yk?yk.message:"(no error)")})}getServiceProtocol(){return this.serviceProtocol}registerLocalWorkflow(fe){this.localWorkflowManager.registerLocalWorkflow(fe)}flushTelemetry(fe){tb.flushAggregators(fe)}createSession(fe){var Ld;
const ze=fe&&fe.docSessionId?fe.docSessionId:qa();var kf=fe&&fe.documentId?fe.documentId:void 0,mg=this.sessionsByDocSessionId.get(ze);const Wf=new Za({operationName:"CreateSession",resourceId:ze,dimension1:this.hasBeenInitialized.toString()});Wf.start();if(mg&&!1===mg.isClosed)throw this.logOperation(Wf,!1,"Error","docSessionId already exists"),Error("docSessionId already exists");mg=fe?null!==(Ld=fe.serviceUrl)&&void 0!==Ld?Ld:this.defaultServiceUrl:this.defaultServiceUrl;mg=uc.convertServiceUrlToWebSocket(mg);
mg||(fe=fe||{},fe.networkMode=Dl.LocalWorkflowsOnly);!this.networkMode||void 0!==(null===fe||void 0===fe?void 0:fe.networkMode)&&null!==(null===fe||void 0===fe?void 0:fe.networkMode)||(fe=fe||{},fe.networkMode=this.networkMode);void 0!==(null===fe||void 0===fe?void 0:fe.networkMode)&&null!==(null===fe||void 0===fe?void 0:fe.networkMode)&&(null===fe||void 0===fe?void 0:fe.networkMode)!==Dl.JSWebSockets||!this.hasHttpFallbackSession()||(fe=fe||{},fe.networkMode=Dl.HttpFallback);Ld=Object.assign({},
this.clientMetadata);Ld.docSessionId=ze;kf&&(Ld.documentId=kf);fe&&fe.flights&&(Ld.flights=Ld.flights?Ld.flights+";"+fe.flights:fe.flights);this.settings.shouldAppendClientFeatureFlights&&(Ld.flights=Ld.flights?`${Ld.flights};${"_acceptsClaimsChallengeMessages;_acceptsSeedingStatusChangeMessages"}`:"_acceptsClaimsChallengeMessages;_acceptsSeedingStatusChangeMessages");if(this.settings.removeDuplicateFlights&&Ld.flights){var Kf=Ld.flights;if(Kf){kf=new Set;var Ci=[];for(cj of Kf.split(";").reverse())Kf=
cj.split(":")[0],Kf=vf.normalizeName(Kf),kf.has(Kf)||(kf.add(Kf),Ci.push(cj));var cj=Ci.reverse().join(";")}else cj="";Ld.flights=cj}Wf.setDataField("Flights",Ld.flights||"");mg=this.sessionFactory({hostCallbacks:this.hostCallbacks,sessionManager:this.sessionManagerFactory(Ld,mg,fe),batchOptions:this.batchOptions,extensionConfigs:(null===fe||void 0===fe?void 0:fe.extensionConfigs)||[],clientMetadata:Ld,userContext:fe?fe.userContext:void 0,localWorkflowManager:this.localWorkflowManager,annotationResultsProcessor:this.annotationResultsProcessor,
localRegisteredWorkflows:(null===fe||void 0===fe?void 0:fe.localRegisteredWorkflows)||[],enableRemoteExecutionNotification:(null===fe||void 0===fe?void 0:fe.enableRemoteExecutionNotification)||!1,networkMode:null===fe||void 0===fe?void 0:fe.networkMode,egress:fe?fe.egress:void 0,isDeltaGeneratorEnabled:this.isDeltaGeneratorEnabled,onAnnotationsSubmittedEnabled:this.settings.onAnnotationsSubmittedEnabled,disableSyncDeltaSending:this.disableSyncDeltaSending,syncDeltaTimeout:this.syncDeltaTimeout,reduceBatchOperationsEnabled:this.settings.reduceBatchOperationsEnabled,
batchMessagesEnabled:this.settings.batchMessagesEnabled,annotationDoesNotExistOnServiceEnabled:this.settings.annotationDoesNotExistOnService,maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled:this.settings.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled,gateUtils:this.gateUtils});this.sessionsByDocSessionId.set(ze,mg);fe&&(fe.onSessionConnect&&mg.setConnectCallback(fe.onSessionConnect),fe.onSessionDisconnect&&mg.setDisconnectCallback(fe.onSessionDisconnect),fe.onSessionReconnect&&mg.setReconnectCallback(fe.onSessionReconnect),
fe.onSessionClose&&mg.setSessionCloseCallback(fe.onSessionClose),fe.onServerAuthenticationStateChangeCallback&&mg.setServerAuthenticationStateChangeCallback(fe.onServerAuthenticationStateChangeCallback),fe.onClaimsChallengeCallback&&mg.setClaimsChallengeCallback(fe.onClaimsChallengeCallback),fe.onSeedingStatusChangeCallback&&mg.setSeedingStatusChangeCallback(fe.onSeedingStatusChangeCallback));this.logOperation(Wf,!0);return mg.initialize?mg.initialize():Promise.resolve(mg)}getSessionManagerFactory(){return this.sessionManagerFactory}shouldAddLogger(fe){if(nd.haveCalledInit){const Ld=
Error("Runtime already initialized");fe.dimension3=Ld.stack;fe.dimension2=Ic(wb.info).length.toString();this.logOperation(fe,!1,"Error",Ld.message);return!1}return!0}createDefaultSessionManagerFactory(){return(fe,Ld,ze)=>{if(ze&&ze.networkMode==Dl.LocalWorkflowsOnly)return new Hn;const kf=new io,mg=new Yr;let Wf=()=>{tb.error(573321615,Oc.CoreDefault,"Unexpectedly not set sendMessage")};const Kf=new xl(()=>mg,fe,kf,(Ci,cj,di)=>{Wf(Ci,cj,di)},{requestAuthToken:this.hostCallbacks.requestAuthToken,overrideSessionInitMessage:this.hostCallbacks.overrideSessionInitMessage,
enableRemoteExecutionNotification:(null===ze||void 0===ze?void 0:ze.enableRemoteExecutionNotification)||!1,sendTokenFailureMessageChangeGate:this.settings.sendTokenFailureMessage,authTokenTimeoutMs:this.settings.authTokenTimeoutMs,dontSendTokenOnReconnectChangeGate:this.settings.doNotSendNewTokenOnReconnect});fe=new Rb(uc.convertServiceUrlToWebSocket(Ld),mg,this.workerFactory,Kf,fe,kf,this.settings,this.gateUtils,null===ze||void 0===ze?void 0:ze.networkMode);Wf=fe.sendMessage.bind(fe);fe.on("disconnect",
()=>kf.clearRefreshTimeouts());fe.on("connect",(Ci,cj,di,rj)=>{Ci&&this.hostCallbacks.setSessionData&&this.hostCallbacks.setSessionData(cj,di,rj);Ci=cj.substring(cj.lastIndexOf("/")+1);this.telemetryLogger.setServerSessionKey(Ci)});return fe}}isFeatureEnabled(fe,Ld=!1,ze="None"){return uc.isFeatureEnabled(this.hostCallbacks,fe,Ld,ze)}hasHttpFallbackSession(){let fe=!1;this.sessionsByDocSessionId.forEach(Ld=>{Ld.isHttpFallback()&&(fe=!0)});return fe}logOperation(fe,Ld,ze,kf){fe.stop();fe.success=Ld;
fe.resultSignature=ze;fe.resultDescription=kf;tb.info(573321622,Oc.CoreDefault,fe)}addLoggingAggregator(fe){var Ld,ze,kf,mg;"Dogfood"!==this.clientMetadata.releaseAudienceGroup&&(tb.addAggregator(le("Operation","operationName","ExecuteBatch ReduceBatchOperations ProcessResponse LocalDeltaUpdate ApplyFormattedTextTileDeltaForLocalWorkflows ApplyTextTileDeltaForLocalWorkflows FindRangeForDelta RunModelForInferencing GetResource CreateTextTileDeltaFromItem NetworkEgressControl HttpEgress LongPollNoOp NetworkRateControllerAbandonedSyncMessage NetworkRateControllerEgress NetworkRateControllerQueueItem NetworkRateControllerOnRateLimitResponse NetworkRateControllerOnRateLimitError NetworkRateControllerRateLimitsSet OnSubmitOperations".split(" "),
null!==(Ld=fe.telemetryAggregationIntervalSec)&&void 0!==Ld?Ld:30)),tb.addAggregator(le("Operation","operationName",["ExecuteWorkflow","ExecuteLambda","EarlyJoinCompletion","OnLongPollMessage","OnAnnotationResultsEgress"],null!==(ze=fe.telemetryAggregationIntervalSec)&&void 0!==ze?ze:60)),tb.addAggregator(le("Operation","operationName","LocalScopeExecutionNotification RunLocalWorkflows EarlyJoinCompletion SetAnnotations WIS.addItemOnContextIdList WIS.setScopeItem".split(" "),null!==(kf=fe.telemetryAggregationIntervalSec)&&
void 0!==kf?kf:120)),tb.addAggregator(le("SessionHealth","sessionHealthEventName",["SendMessage","ProcessMessage"],null!==(mg=fe.telemetryAggregationIntervalSec)&&void 0!==mg?mg:60)))}uninitialize(){this.settings.closeSessionsOnRuntimeUninit&&(this.sessionsByDocSessionId.forEach(fe=>{fe.close()}),this.sessionsByDocSessionId.clear());this.flushTelemetry(!0);this.hostCallbacks=null;this.hasBeenInitialized=!1;this.telemetryLogger=null;nd.haveCalledInit=!1;tb.clearAggregators();tb.clearLoggers()}}const lr=
new nd,Vq={category:re.Schema,schema:{name:"Exception",path:"message-schema.proto"}},Wq=(fe,Ld=!1)=>{if(null==fe)return"Invalid message passed";if(null==fe.payload)return`${Eh[Eh.NoOutput]}: Payload is null`;if(null==fe.payload.exceptionType)return"Payload is not an exception";let ze=Eh[fe.payload.exceptionType];ze+=fe.payload.message?`: ${fe.payload.message}`:": No description";return ze+=Ld&&fe.payload.data?`\n${fe.payload.data.toString()}`:""},oe=(fe,Ld)=>{if(null==fe)throw Error("Cannot set exception on null message");
fe.payload=Ld;fe.payloadSchema=Vq;fe.messageType=sg.Exception};var Ji;(function(fe){(function(Ld){Ld[Ld.Unknown=0]="Unknown";Ld[Ld.Text=1]="Text";Ld[Ld.Slide=2]="Slide"})(fe.TileType||(fe.TileType={}));(function(Ld){Ld[Ld.Generic=0]="Generic";Ld[Ld.Title=1]="Title";Ld[Ld.SmartArt=2]="SmartArt";Ld[Ld.TableCell=3]="TableCell";Ld[Ld.TextBox=4]="TextBox";Ld[Ld.Notes=5]="Notes"})(fe.TextTileType||(fe.TextTileType={}));(function(Ld){Ld[Ld.Undefined=0]="Undefined";Ld[Ld.Word=1]="Word";Ld[Ld.Phrase=2]="Phrase";
Ld[Ld.Sentence=3]="Sentence";Ld[Ld.Paragraph=4]="Paragraph"})(fe.TextTileElementUnit||(fe.TextTileElementUnit={}));(function(Ld){Ld[Ld.Undefined=0]="Undefined";Ld[Ld.Bullet=1]="Bullet";Ld[Ld.Numbered=2]="Numbered"})(fe.ListType||(fe.ListType={}));(function(Ld){Ld[Ld.Undefined=0]="Undefined";Ld[Ld.AlphaLcParenBoth=1]="AlphaLcParenBoth";Ld[Ld.AlphaUcParenBoth=2]="AlphaUcParenBoth";Ld[Ld.AlphaLcParenR=3]="AlphaLcParenR";Ld[Ld.AlphaUcParenR=4]="AlphaUcParenR";Ld[Ld.AlphaLcPeriod=5]="AlphaLcPeriod";Ld[Ld.AlphaUcPeriod=
6]="AlphaUcPeriod";Ld[Ld.ArabicParenBoth=7]="ArabicParenBoth";Ld[Ld.ArabicParenR=8]="ArabicParenR";Ld[Ld.ArabicPeriod=9]="ArabicPeriod";Ld[Ld.ArabicPlain=10]="ArabicPlain";Ld[Ld.RomanLcParenBoth=11]="RomanLcParenBoth";Ld[Ld.RomanUcParenBoth=12]="RomanUcParenBoth";Ld[Ld.RomanLcParenR=13]="RomanLcParenR";Ld[Ld.RomanUcParenR=14]="RomanUcParenR";Ld[Ld.RomanLcPeriod=15]="RomanLcPeriod";Ld[Ld.RomanUcPeriod=16]="RomanUcPeriod";Ld[Ld.CircleNumDbPlain=17]="CircleNumDbPlain";Ld[Ld.CircleNumWdBlackPlain=18]=
"CircleNumWdBlackPlain";Ld[Ld.CircleNumWdWhitePlain=19]="CircleNumWdWhitePlain";Ld[Ld.ArabicDbPeriod=20]="ArabicDbPeriod";Ld[Ld.ArabicDbPlain=21]="ArabicDbPlain";Ld[Ld.Ea1ChsPeriod=22]="Ea1ChsPeriod";Ld[Ld.Ea1ChsPlain=23]="Ea1ChsPlain";Ld[Ld.Ea1ChtPeriod=24]="Ea1ChtPeriod";Ld[Ld.Ea1ChtPlain=25]="Ea1ChtPlain";Ld[Ld.Ea1JpnChsDbPeriod=26]="Ea1JpnChsDbPeriod";Ld[Ld.Ea1JpnKorPlain=27]="Ea1JpnKorPlain";Ld[Ld.Ea1JpnKorPeriod=28]="Ea1JpnKorPeriod";Ld[Ld.Arabic1Minus=29]="Arabic1Minus";Ld[Ld.Arabic2Minus=
30]="Arabic2Minus";Ld[Ld.Hebrew2Minus=31]="Hebrew2Minus";Ld[Ld.ThaiAlphaPeriod=32]="ThaiAlphaPeriod";Ld[Ld.ThaiAlphaParenR=33]="ThaiAlphaParenR";Ld[Ld.ThaiAlphaParenBoth=34]="ThaiAlphaParenBoth";Ld[Ld.ThaiNumPeriod=35]="ThaiNumPeriod";Ld[Ld.ThaiNumParenR=36]="ThaiNumParenR";Ld[Ld.ThaiNumParenBoth=37]="ThaiNumParenBoth";Ld[Ld.HindiAlphaPeriod=38]="HindiAlphaPeriod";Ld[Ld.HindiNumPeriod=39]="HindiNumPeriod";Ld[Ld.HindiNumParenR=40]="HindiNumParenR";Ld[Ld.HindiAlpha1Period=41]="HindiAlpha1Period"})(fe.ListNumeration||
(fe.ListNumeration={}));(function(Ld){Ld[Ld.Undefined=0]="Undefined";Ld[Ld.Delete=1]="Delete";Ld[Ld.Add=2]="Add";Ld[Ld.Change=3]="Change";Ld[Ld.Refresh=4]="Refresh"})(fe.TextTileEventType||(fe.TextTileEventType={}))})(Ji||(Ji={}));var dp;(function(fe){fe=fe.SlideTileEventType||(fe.SlideTileEventType={});fe[fe.Undefined=0]="Undefined";fe[fe.Delete=1]="Delete";fe[fe.Add=2]="Add";fe[fe.Change=3]="Change";fe[fe.Refresh=4]="Refresh"})(dp||(dp={}));class mr{constructor(){this.cache=new Map}setReduceTimer(fe,
Ld,ze,kf=500,mg=()=>!1,Wf=5E3){this.cache.has(fe)||this.cache.set(fe,new Map);const Kf=this.cache.get(fe);Kf.has(Ld)&&clearTimeout(Kf.get(Ld).timer);const Ci=()=>{const cj=Kf.get(Ld),di=Date.now()-cj.start;mg()&&di<Wf?cj.timer=setTimeout(cj.jIp,Math.min(kf,Wf-di)):(1<Kf.size?Kf.delete(Ld):this.cache.delete(fe),ze())};Kf.set(Ld,{start:Date.now(),jIp:Ci,timer:setTimeout(Ci,kf)})}clear(fe,Ld){this.cache.forEach((ze,kf)=>{fe&&fe!==kf||ze.forEach((mg,Wf)=>{Ld&&Ld!==Wf||clearTimeout(mg.timer)})});this.cache.clear()}}
class Wk{constructor(fe=33E5){this.tokenCache=new Map;this.requestMap=new Map;this.requestRecordMap=new Map;this.tokenExpirationMs=fe}updateAuthToken(fe,Ld){const ze=JSON.stringify(Ld);let kf=this.requestRecordMap.get(ze);if(void 0===kf||this.isTokenExpired(kf))kf={L_o:fe.requestAuthToken(Ld).then(mg=>{if(!mg||!mg.Token)throw Error(`No token available for request ${ze}`);this.tokenCache.set(ze,mg.Token)}),requestTime:uc.getCurrentTimeMs()},this.requestRecordMap.set(ze,kf);return kf.L_o}getAuthTokenEntries(fe,
Ld){return Array.from(this.tokenCache.keys()).map(ze=>{let kf=this.requestMap.get(ze);void 0===kf&&(kf=JSON.parse(ze),this.requestMap.set(ze,kf));return{requestKey:ze,request:kf}}).filter(({request:ze})=>Ld?ze.DocId===Ld:!0).map(({requestKey:ze,request:kf})=>{this.isTokenExpired(this.requestRecordMap.get(ze))&&this.updateAuthToken(fe,kf);return{ticket:kf.Tickets[0],token:this.tokenCache.get(ze)}})}isTokenExpired(fe){return uc.getCurrentTimeMs()>fe.requestTime+this.tokenExpirationMs}}let vt;const rn=
()=>{vt=new Wk};vt=new Wk;const Er=(fe,Ld,ze,kf,mg,Wf,Kf,Ci,cj,di)=>{const rj={method:"POST",headers:{"content-type":"application/json","X-CorrelationId":mg},body:JSON.stringify({payload:Ld.payload,payloadSchema:ze,requestedSchema:kf,clientMetadata:Wf,tokens:vt.getAuthTokenEntries(Kf,cj.docId)})};J(fe,rj,(bn,lo)=>{bn?di(Error(`Fetch error in remote lambda request to ${fe}: ${bn}`)):401===lo.status?0<Ci?(tb.info(572838109,Oc.CoreDefault,"Auth token required for remote lambda request"),lo.json().then(as=>
vt.updateAuthToken(Kf,{Tickets:[as],DocId:cj.docId})).then(()=>{Er(fe,Ld,ze,kf,mg,Wf,Kf,Ci-1,cj,di)}).catch(as=>{di({exceptionType:Eh.Authentication,message:as.message})})):di({exceptionType:Eh.Authentication,message:"Remote lambda request retry with authentication token failed"}):lo.ok?lo.json().then(as=>{if(Array.isArray(as))if(0<as.length){let sk=0;for(const jf of as)Ld.moreResults=++sk<as.length,di(null,jf)}else di(Error("No output"));else di(Error("Did not receive a valid response for remote lambda request"))}).catch(as=>
{di({exceptionType:Eh.LambdaThrow,message:as.message})}):di(Error(`Remote lambda request failed with status ${lo.status}`))})},Zr=(fe,Ld,ze,kf,mg,Wf,Kf,Ci,cj)=>{Array.isArray(Ci.authTickets)?vt.updateAuthToken(Kf,{Tickets:Ci.authTickets,DocId:Ci.docId}).then(()=>{Er(fe,Ld,ze,kf,mg.id,Wf,Kf,1,Ci,cj)}).catch(di=>{cj({exceptionType:Eh.Authentication,message:di.message})}):Er(fe,Ld,ze,kf,mg.id,Wf,Kf,1,Ci,cj)};class aq{constructor(){this.hadEgressError=this.hasBeenOpened=!1;this.lastPongTime=this.lastEgressTime=
0;this.remainingPingFailures=3;this.egressByteCount=this.egressMessageCount=0;this.isClosing=!1;this.pendingEgress=[]}init(fe,Ld,ze,kf){this.ws=new Vb(fe);this.logOp=(new Za({operationName:aq.className,success:!0,dimension1:"V1"})).start();this.egressTimer=Date.now();this.egressMessageCountOp=new Za({operationName:"WSEgressMessageCount",success:!0,dimension1:"V1"});this.egressByteCountOp=new Za({operationName:"WSEgressByteOrderOfMagnitude",success:!0,dimension1:"V1"});this.ingressByteCountOp=new Za({operationName:"WSIngressByteOrderOfMagnitude",
success:!0,dimension1:"V1"});const mg=Wf=>{this.logPingLatencyOp&&(this.logPingLatencyOp.success=Wf,tb.info(507789790,Oc.CoreDefault,this.logPingLatencyOp.stop()),this.logPingLatencyOp=void 0)};this.ws.addEventListener("open",()=>{ze();aq.logCountLimiter.log(()=>{this.logOp.resourceId="OnOpen";this.logOp.resultDescription="";this.logOp.success=!0;this.logOp.dimension0=this.pendingEgress.length.toString();tb.info(507789789,Oc.CoreDefault,this.logOp.stop())});this.hasBeenOpened=!0;this.pendingEgress.forEach(Wf=>
{this.egress({obj:Wf})});this.pendingEgress=[];this.pingInterval=setInterval(()=>{this.logPingLatencyOp&&(--this.remainingPingFailures,mg(!1));0<this.remainingPingFailures&&this.hasBeenOpened&&this.lastPongTime<this.lastEgressTime&&(this.logPingLatencyOp=(new Za({operationName:"Ping",success:!0,dimension0:0<=this.ws.bufferedAmount?this.ws.bufferedAmount.toString().length.toString():void 0,dimension1:"V1"})).start(),this.ws.send(aq.pingPongMessage,Wf=>{Wf&&(--this.remainingPingFailures,mg(!1))}))},
3E4)});this.ws.addEventListener("message",Wf=>{this.logPingLatencyOp&&"string"===typeof Wf.data&&1===Wf.data.length&&Wf.data[0]===aq.pingPongMessage?(mg(!0),this.lastPongTime=Date.now()):(this.logIngressCount(Wf.data),Ld(Wf.data))});this.ws.addEventListener("error",Wf=>{this.errorMessage=Wf.message;aq.logCountLimiter.log(()=>{this.logOp.resourceId="OnError";this.logOp.resultDescription=this.errorMessage;this.logOp.success=!1;tb.info(507789788,Oc.CoreDefault,this.logOp.stop())});this.ws.close()});
this.ws.addEventListener("close",Wf=>{aq.logCountLimiter.log(()=>{this.logOp.resourceId="OnClose";this.logOp.resultDescription=Wf?`code: ${Wf.code}. reason: ${Wf.reason}`:"";this.logOp.success=!0;tb.info(507789787,Oc.CoreDefault,this.logOp.stop())});this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=void 0);kf(this.errorMessage);this.isClosing=!1})}egress(fe){fe=fe.obj;this.logEgressCount(fe instanceof ArrayBuffer||fe instanceof Uint8Array?fe.byteLength:fe.length);this.lastEgressTime=
Date.now();this.hasBeenOpened?this.ws.send(fe,Ld=>{Ld&&!this.hadEgressError&&(this.hadEgressError=!0,aq.logCountLimiter.log(()=>{this.logOp.resourceId="OnFirstEgressError";this.logOp.resultDescription=Ld.message;this.logOp.success=!1;tb.info(507789786,Oc.CoreDefault,this.logOp.stop())}))}):this.pendingEgress.push(fe)}close(){this.isClosing||(this.isClosing=!0,this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=void 0),this.ws.close())}logEgressCount(fe){const Ld=Date.now(),ze=Ld-
this.egressTimer;1E3<ze&&(50<this.egressMessageCount&&(this.egressMessageCountOp.start(),this.egressMessageCountOp.resultDescription="Egress message count: "+this.egressMessageCount.toString()+", Buffered amount: "+(0<=this.ws.bufferedAmount?this.ws.bufferedAmount.toString():"-")+", Time elapsed: "+ze.toString(),tb.info(507789785,Oc.CoreDefault,this.egressMessageCountOp.stop())),1E5<this.egressByteCount&&(this.egressByteCountOp.start(),this.egressByteCountOp.dimension2=this.egressByteCount.toString().length.toString(),
this.egressMessageCountOp.resultDescription="Buffered amount: "+(0<=this.ws.bufferedAmount?this.ws.bufferedAmount.toString():"-")+", Time elapsed: "+ze.toString(),tb.info(507789784,Oc.CoreDefault,this.egressByteCountOp.stop())),this.egressTimer=Ld,this.egressByteCount=this.egressMessageCount=0);this.egressMessageCount++;this.egressByteCount+=null!==fe&&void 0!==fe?fe:0}logIngressCount(fe){fe=fe.length;1E5<fe&&(this.ingressByteCountOp.start(),this.ingressByteCountOp.dimension2=fe.toString().length.toString(),
tb.info(507789783,Oc.CoreDefault,this.ingressByteCountOp.stop()))}}aq.className="WebSocketWorker";aq.logCountLimiter=new Xc(aq.className);aq.pingPongMessage="~";class sm{constructor(fe,Ld,ze,kf,mg,Wf){this.requestId=fe;this.correlationId=Ld;this.schemaName=ze;this.data=kf;this.callback=mg;this.requestTimeoutInMs=Wf;this.ended=!1;this.startTime=0}xAp(){this.startTime=uc.getCurrentTimeMs()}QHi(){const fe=uc.getCurrentTimeMs()-this.startTime;return this.requestTimeoutInMs-fe}j6d(fe){this.ended||(this.KZb(null,
fe,!0),this.ended=!0)}Q8k(fe){this.KZb(fe,null,!1)}KZb(fe,Ld,ze){(new Promise(()=>this.callback(fe,Ld,ze))).catch(()=>{})}}class Xq{constructor(fe,Ld,ze){this.requestCounter=0;this.activeRequests=[];this.pendingRequests=[];this.requestTimeoutInMs=fe;this.workerFactory=Ld;this.maxActiveRequests=ze}testConnection(fe,Ld){let ze=!1;const kf=(new Za({cv:(new rd).toString(),operationName:"WebSocketTest",resourceId:Yb(fe),success:!0})).start();return new Promise(mg=>{const Wf=uc.createHealthCheckRequest(Ld);
fe?this.addRequest(fe,Wf,kf.cv,"HealthCheckRequest",(Kf,Ci,cj)=>{Ci&&(kf.success=!1,kf.resultSignature="Error",kf.resultDescription=Ci.message||Ci);Kf&&"OK"===Kf.status&&(ze=!0);cj&&(kf.success&&!ze&&(kf.success=!1,kf.resultSignature="NoResponseData"),tb.info(556617949,Oc.CoreDefault,kf.stop()),mg(kf.success))}):(kf.success=!1,kf.resultSignature="EmptyUrl",tb.info(557641870,Oc.CoreDefault,kf.stop()),mg(kf.success))})}addRequest(fe,Ld,ze,kf,mg){const Wf=(this.requestCounter++).toString();Ld=new sm(Wf,
ze,kf,Ld,mg,this.requestTimeoutInMs);this.getWorker(fe);this.pendingRequests.push(Ld);this.egressPendingRequests()}egressPendingRequests(){for(;0<this.pendingRequests.length&&this.activeRequests.length<this.maxActiveRequests;){const fe=this.pendingRequests.shift();this.activeRequests.push(fe);if(1===this.activeRequests.length){const Ld=fe.QHi();setTimeout(this.onTimeout.bind(this),Ld)}fe.xAp();this.worker&&this.worker.egress({obj:this.createRequestMessage(fe.data,fe.requestId,fe.correlationId)})}}createRequestMessage(fe,
Ld,ze){return JSON.stringify({correlationId:ze,requestId:Ld,body:fe})}onTimeout(){for(;0<this.activeRequests.length;){const fe=this.activeRequests[0],Ld=fe.QHi();if(0>=Ld)fe.j6d(Error("Request timed out")),this.activeRequests.shift(),this.egressPendingRequests();else{setTimeout(this.onTimeout.bind(this),Ld);break}}}onMessage(fe){try{const Ld=JSON.parse(fe);for(fe=0;fe<this.activeRequests.length;fe++){const ze=this.activeRequests[fe];if(ze.requestId===Ld.requestId){Ld.end?(this.activeRequests.splice(fe,
1),ze.j6d(Ld.error),this.egressPendingRequests()):Ld.body&&ze.Q8k(Ld.body);break}}}catch(Ld){tb.error(557641871,Oc.CoreDefault,Ld)}}onClose(fe){fe=Error(`Connection closed: ${fe}`);for(const Ld of this.activeRequests)Ld.j6d(fe);this.activeRequests=[];for(const Ld of this.pendingRequests)Ld.j6d(fe);this.pendingRequests=[];this.worker=void 0}getWorker(fe){this.worker||(this.worker=this.workerFactory(),this.worker.init(fe,this.onMessage.bind(this),()=>{},this.onClose.bind(this)));return this.worker}}
let qg;const pl=()=>{qg=new Wk};qg=new Wk;const Ek=new Xq(3E4,()=>new aq,50),ws=(fe,Ld,ze,kf,mg,Wf,Kf,Ci,cj,di)=>{const rj={payload:Ld.payload,payloadSchema:ze,requestedSchema:kf,clientMetadata:Wf,tokens:qg.getAuthTokenEntries(Kf,cj.docId)};let bn="";kf&&kf.schema&&(bn=kf.schema.name);let lo=!1;Ek.addRequest(fe,rj,mg,bn,(as,sk)=>{if(!lo)if(lo=!0,null!=sk)if(sk.exceptionType===Eh.Authentication)try{const jf=JSON.parse(sk.data);0<Ci?(tb.info(572838108,Oc.CoreDefault,"Auth token required for remote lambda WebSocket request"),
qg.updateAuthToken(Kf,{Tickets:[jf],DocId:cj.docId}).then(()=>{ws(fe,Ld,ze,kf,mg,Wf,Kf,Ci-1,cj,di)}).catch(yk=>{di({exceptionType:Eh.Authentication,message:yk.message})})):di({exceptionType:Eh.Authentication,message:"Remote lambda request retry with authentication token failed"})}catch(jf){di({exceptionType:Eh.Authentication,message:jf.message})}else di(Error(`Error in remote lambda WebSocket request to ${fe}: ${sk}`));else Ld.moreResults=!1,di(null,as)})},sl=(fe,Ld,ze,kf,mg,Wf,Kf,Ci,cj)=>{Array.isArray(Ci.authTickets)?
qg.updateAuthToken(Kf,{Tickets:Ci.authTickets,DocId:Ci.docId}).then(()=>{ws(fe,Ld,ze,kf,mg.id,Wf,Kf,1,Ci,cj)}).catch(di=>{cj({exceptionType:Eh.Authentication,message:di.message})}):ws(fe,Ld,ze,kf,mg.id,Wf,Kf,1,Ci,cj)};class Fr{constructor(){this.cache=new Map;this.bucketSizes=new Map}setBucketSize(fe,Ld){this.bucketSizes.set(fe,Ld)}setResult(fe,Ld,ze){if(Ld.primary){var kf=this.cache.get(fe);kf||(kf=new Map,this.cache.set(fe,kf));var mg=kf.get(Ld.primary);mg||(mg=Ld.secondary?new Map:[],kf.set(Ld.primary,
mg));Ld.secondary?mg.set(Ld.secondary,ze):(Ld=mg,Ld.length==this.getBucketSize(fe)&&Ld.shift(),Ld.push(ze))}}getResults(fe,Ld){if(fe=this.cache.get(fe))if(fe=fe.get(Ld.primary)){if(!Ld.secondary)return fe;Ld=Array.from(fe.values());if(0<Ld.length)return Ld}return[]}clear(fe,Ld){Ld?this.cache.forEach((ze,kf)=>{fe&&fe!==kf||(Ld.secondary?(ze=ze.get(Ld.primary))&&ze.delete(Ld.secondary):ze.delete(Ld.primary))}):fe?this.cache.delete(fe):this.cache.clear()}getBucketSize(fe){return this.bucketSizes.get(fe)||
10}}var Pj;(function(fe){fe[fe.Unknown=0]="Unknown";fe[fe.Local=1]="Local";fe[fe.Custom=2]="Custom";fe[fe.Remote=3]="Remote";fe[fe.BatchedRemote=4]="BatchedRemote"})(Pj||(Pj={}));class Aj{constructor(){this.throttleInfoMap=new Map}execute(fe,Ld,ze){if(Ld.throttleSettings.shouldBeThrottled&&0<Ld.throttleSettings.throttlingInterval){const kf=this.getWorkflowThrottleInfo(Ld.name);if(void 0==kf.O3d)kf.O3d=fe,kf.rxd=uc.getCurrentTimeMs(),ze();else if(kf.O3d===fe){fe=uc.getCurrentTimeMs();const mg=this.delayTime(kf,
fe,Ld.throttleSettings.throttlingInterval);0<mg?(kf.B7f=ze,void 0==kf.gxc&&(kf.gxc=setTimeout(()=>{const Wf=this.getWorkflowThrottleInfo(Ld.name);Wf.gxc=void 0;Wf.rxd=uc.getCurrentTimeMs();Wf.B7f()},mg))):(kf.rxd=fe,ze())}else void 0!=kf.gxc&&(clearTimeout(kf.gxc),kf.B7f(),kf.gxc=void 0),kf.O3d=fe,kf.rxd=uc.getCurrentTimeMs(),ze()}else ze()}delayTime(fe,Ld,ze){return Math.max(ze-(Ld-fe.rxd),0)}getWorkflowThrottleInfo(fe){let Ld=this.throttleInfoMap.get(fe);Ld||(Ld={O3d:void 0,rxd:-1,B7f:()=>{},gxc:void 0},
this.throttleInfoMap.set(fe,Ld));return Ld}}var dl;(function(fe){fe[fe.Restricted=0]="Restricted";fe[fe.Unrestricted=1]="Unrestricted";fe[fe.Suppressed=2]="Suppressed"})(dl||(dl={}));class bq{constructor(){this.canaryTextTileEventSubmittedByDocSessionId=new Set;this.stateByDocSessionId=new Map;this.executionQueueByDocSessionId=new Map;this.executionCountByDocSessionId=new Map}getOutputSchema(){return this.lambdas[this.lambdas.length-1].outputSchema}scheduleExecution(fe,Ld){fe=this.docSessionIdExtractor?
this.docSessionIdExtractor(fe):void 0;const ze=this.getStateForDocSessionId(fe);ze===dl.Restricted?(fe=this.getExecutionQueueForDocSessionId(fe),fe.push(Ld),1===fe.length&&Ld()):ze===dl.Unrestricted&&Ld()}onStart(fe){this.incrementExecutionCountForDocSessionId(fe)}onFinish(fe,Ld){this.decrementExecutionCountForDocSessionId(fe);if(Ld===Eh.Authentication)this.stateByDocSessionId.set(fe,dl.Suppressed),this.executionQueueByDocSessionId.delete(fe);else if(this.stateByDocSessionId.get(fe)===dl.Restricted){const ze=
this.getExecutionQueueForDocSessionId(fe);ze.shift();if(void 0===Ld){this.stateByDocSessionId.set(fe,dl.Unrestricted);this.executionQueueByDocSessionId.delete(fe);for(const kf of ze)kf()}else if(0<ze.length)(0,ze[0])()}}onRefresh(fe){this.stateByDocSessionId=new Map;this.triggerOnRefresh&&(fe?(this.executionQueueByDocSessionId.delete(fe),this.executionCountByDocSessionId.delete(fe)):(this.executionQueueByDocSessionId=new Map,this.executionCountByDocSessionId=new Map));this.canaryTextTileEventSubmittedByDocSessionId.delete(fe)}getStateForDocSessionId(fe){let Ld=
this.stateByDocSessionId.get(fe);void 0===Ld&&(Ld=bq.executionQueuesEnabled?dl.Restricted:dl.Unrestricted,this.stateByDocSessionId.set(fe,Ld));return Ld}getExecutionQueueForDocSessionId(fe){let Ld=this.executionQueueByDocSessionId.get(fe);void 0===Ld&&(Ld=[],this.executionQueueByDocSessionId.set(fe,Ld));return Ld}incrementExecutionCountForDocSessionId(fe){const Ld=this.executionCountByDocSessionId.get(fe)||0;this.executionCountByDocSessionId.set(fe,Ld+1)}decrementExecutionCountForDocSessionId(fe){const Ld=
this.executionCountByDocSessionId.get(fe)||0;1>=Ld?this.executionCountByDocSessionId.delete(fe):this.executionCountByDocSessionId.set(fe,Ld-1)}}bq.executionQueuesEnabled=!0;const Zh=fe=>({category:re.Schema,schema:{name:fe}}),bk=(fe,Ld)=>"Tiling.TextTileEvent"===fe&&Ld&&Ld.type==Ji.TextTileEventType.Refresh||"ClpSlideTile"===fe&&Ld&&Ld.eventType==dp.SlideTileEventType.Refresh,$r=(fe,Ld)=>{var ze,kf;return"Tiling.TextTileEvent"===fe&&Ld&&Ld.type==Ji.TextTileEventType.Refresh?null===(kf=null===(ze=
Ld.tile)||void 0===ze?void 0:ze.metadata)||void 0===kf?void 0:kf.SSj:-1},Fq=(fe,Ld)=>{var ze,kf;if("Tiling.TextTileEvent"===fe)return null===(kf=null===(ze=Ld.tile)||void 0===ze?void 0:ze.metadata)||void 0===kf?void 0:kf.docSessionId;if("ClpSlideTile"===fe)return Ld.docId};class jo{constructor(){this.inputSchemasToWorkflows=new Map;this.inputSchemasToReduceWorkflows=new Map;this.reduceWorkflowsGroupingKeyExtractors=new Map;this.defaultWorkflowOptions={canProduceNullResult:!1,shouldSendResultsToHost:!0,
enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!1},triggerOnRefresh:!1};this.resultCache=new Fr;this.reduceTimerCache=new mr;this.lookupTableCache=new Map;this.throttling=new Aj;this.lastTileRefreshSeq=-1;this.lastTileRefreshSeqByDocSessionId=new Map;this.tileRefreshByDocSessionIdEnabled=!0}init(fe,Ld,ze){const kf=new Za({operationName:"InitRuntimeALv1",resourceId:Yb(fe)});kf.start();if(this.clientMetadata=Ld)this.clientMetadata.runtimeVersion=v(88407).a;this.hostCallbacks=ze;ze=[];ze.push(this.isFeatureEnabled("DisableWebSocket").then(mg=>
{mg?mg=!1:0<="Outlook Mac;Outlook Win32;PowerPoint Mac;PowerPoint Web;PowerPoint Win32;Word Mac;Word Win32".split(";").indexOf(`${Ld.appName} ${Ld.appPlatform}`)?(mg=uc.convertServiceUrlToWebSocket(fe),mg=Ek.testConnection(mg,this.clientMetadata)):mg=!0;return mg}).then(mg=>{fe&&(this.serviceUrl=mg?uc.convertServiceUrlToWebSocket(fe):fe,this.executeRemoteLambda=mg?sl:Zr,this.clearRemoteLambdaTokenCache=mg?pl:rn,this.serviceProtocol=this.serviceUrl.split(":")[0].toLowerCase())}));ze.push(this.isFeatureEnabled("WorkflowQueuesDisabled").then(mg=>
{bq.executionQueuesEnabled=!mg}));ze.push(this.isFeatureEnabled("TileRefreshByDocSessionIdDisabled").then(mg=>{this.tileRefreshByDocSessionIdEnabled=!mg}));return Promise.all(ze).then(()=>{this.logOperation(kf,!0)}).catch(mg=>{this.logOperation(kf,!1,"Error",mg?mg.message:"(no error)")})}getServiceProtocol(){return this.serviceProtocol}registerSchemas(){return Promise.resolve()}registerSimpleLocalWorkflow(fe,Ld,ze=this.defaultWorkflowOptions){Ld.source=Ld.source||Pj.Custom;return this.registerHardcodedWorkflow(fe,
[Ld],this.inputSchemasToWorkflows,ze)}registerSimpleRemoteWorkflow(fe,Ld,ze,kf,mg=this.defaultWorkflowOptions){const Wf=[];Ld&&(Ld.source=Pj.Custom,Wf.push(Ld));ze.source=ze.func?Pj.Custom:Pj.Remote;Wf.push(ze);kf&&(kf.source=Pj.Custom,Wf.push(kf));return this.registerHardcodedWorkflow(fe,Wf,this.inputSchemasToWorkflows,mg)}registerMultipleLambdasWorkflow(fe,Ld,ze=this.defaultWorkflowOptions){return this.registerHardcodedWorkflow(fe,Ld,this.inputSchemasToWorkflows,ze)}registerReduceWorkflow(fe,Ld,
ze,kf=10,mg=this.defaultWorkflowOptions){this.reduceWorkflowsGroupingKeyExtractors.set(Ld.inputSchema,ze);this.resultCache.setBucketSize(Ld.inputSchema,kf);Ld.source=Ld.source||Pj.Custom;return this.registerHardcodedWorkflow(fe,[Ld],this.inputSchemasToReduceWorkflows,mg)}registerMultipleLambdasReduceWorkflow(fe,Ld,ze,kf=10,mg=this.defaultWorkflowOptions){this.reduceWorkflowsGroupingKeyExtractors.set(Ld[0].inputSchema,ze);this.resultCache.setBucketSize(Ld[0].inputSchema,kf);return this.registerHardcodedWorkflow(fe,
Ld,this.inputSchemasToReduceWorkflows,mg)}submit(fe,Ld,ze){this.submitToWorkflows(fe,Ld,ze,this.inputSchemasToWorkflows)}getGroupingKey(fe,Ld,ze){ze=this.reduceWorkflowsGroupingKeyExtractors.get(ze);if(void 0==ze)throw Error("Reduce workflow does not have a grouping extractor");return ze(Ld,fe)}submitToWorkflows(fe,Ld,ze,kf=this.inputSchemasToWorkflows){if(this.hostCallbacks){ze=ze?rd.fromString(ze):new rd;this.handleTileRefresh(fe,Ld,ze);var mg=kf.get(fe)||[];for(const Wf of mg)if(!bk(fe,Ld)||Wf.triggerOnRefresh)Wf.useCanaryTextTile&&
"Tiling.TextTileEvent"===fe&&!Wf.canaryTextTileEventSubmittedByDocSessionId.has(Fq(fe,Ld))&&(this.submitToWorkflow("Tiling.TextTileEvent",{type:Ld.type,tile:{metadata:{docSessionId:Ld.tile.metadata.docSessionId,docId:Ld.tile.metadata.docId,SSj:Ld.tile.metadata.SSj,tileId:"A56B3127DBDFD0D6"},elements:[{text:"B91153AE828B4E48"}]}},ze,Wf,kf),Wf.canaryTextTileEventSubmittedByDocSessionId.add(Fq(fe,Ld))),this.submitToWorkflow(fe,Ld,ze,Wf,kf)}}submitToWorkflow(fe,Ld,ze,kf,mg){const Wf={messageType:sg.Input,
correlationVector:ze.newChild(),payload:Ld,payloadSchema:Zh(kf.lambdas[0].inputSchema),clientMetadata:this.clientMetadata},Kf=new Za({cv:Wf.correlationVector.toString(),operationName:"ExecuteWorkflow",resourceId:kf.name});Kf.setClientMetadata(this.clientMetadata);Kf.start();kf.scheduleExecution(Ld,()=>{try{Wf.payload&&Wf.payload.tile&&Wf.payload.tile.metadata&&Wf.payload.tile.metadata.tileId?this.throttling.execute(Wf.payload.tile.metadata.tileId,kf,()=>this.executeWorkflow(Kf,Wf,Ld,kf,fe,mg)):this.executeWorkflow(Kf,
Wf,Ld,kf,fe,mg)}catch(Ci){Kf.success=!1,Kf.resultSignature="ExecuteException",Kf.resultDescription=Ci?Ci.message:"(no error)",tb.error(559290447,Oc.CoreDefault,Kf.stop())}})}handleTileRefresh(fe,Ld,ze){if(bk(fe,Ld)){var kf=this.tileRefreshByDocSessionIdEnabled?Fq(fe,Ld):void 0;fe=$r(fe,Ld);if(this.tileRefreshByDocSessionIdEnabled){if(Ld=this.lastTileRefreshSeqByDocSessionId.get(kf),0<=Ld&&fe<=Ld)return}else if(fe<=this.lastTileRefreshSeq)return;var mg=new Za({cv:ze.toString(),operationName:"TileRefresh",
resultDescription:"",success:!0});mg.start();if(this.tileRefreshByDocSessionIdEnabled&&!kf)mg.success=!1,mg.resultDescription="NoDocSessionId",tb.info(559290448,Oc.CoreDefault,mg.stop());else{this.inputSchemasToReduceWorkflows.forEach((Kf,Ci)=>{Kf.some(cj=>cj.triggerOnRefresh)&&(this.tileRefreshByDocSessionIdEnabled?(this.resultCache.clear(Ci,{primary:kf}),this.resultCache.clear(this.getForcedDocLevelSchema(Ci),{primary:kf}),this.reduceTimerCache.clear(Ci,kf)):(this.resultCache.clear(Ci),this.resultCache.clear(this.getForcedDocLevelSchema(Ci)),
this.reduceTimerCache.clear(Ci)),Kf.some(cj=>!cj.triggerOnRefresh)&&(mg.resultDescription+="X_"),mg.resultDescription+=Ci+" ")});this.clearRemoteLambdaTokenCache();var Wf=[];this.inputSchemasToWorkflows.forEach(Kf=>Wf.push(...Kf));this.inputSchemasToReduceWorkflows.forEach(Kf=>Wf.push(...Kf));for(const Kf of Wf)if(this.tileRefreshByDocSessionIdEnabled)Kf.onRefresh(kf);else Kf.onRefresh();this.tileRefreshByDocSessionIdEnabled?this.lastTileRefreshSeqByDocSessionId.set(kf,fe):this.lastTileRefreshSeq=
fe;tb.info(559290449,Oc.CoreDefault,mg.stop())}}}executeWorkflow(fe,Ld,ze,kf,mg,Wf){const Kf=kf.docIdExtractor?kf.docIdExtractor(Ld.payload):void 0,Ci=kf.docSessionIdExtractor(ze),cj=this.tileRefreshByDocSessionIdEnabled?this.lastTileRefreshSeqByDocSessionId.get(Ci):this.lastTileRefreshSeq;kf.onStart(Ci);const di=rj=>{var bn=this.tileRefreshByDocSessionIdEnabled?this.lastTileRefreshSeqByDocSessionId.get(Ci):this.lastTileRefreshSeq;if(kf.triggerOnRefresh&&bn!==cj)fe.success=!0,fe.resultSignature="TileRefreshIgnore",
tb.info(559290450,Oc.CoreDefault,fe.stop());else{var lo=(bn=rj.messageType==sg.Exception&&rj.payload.exceptionType==Eh.NoOutput)&&kf.canProduceNullResult,as=lo?kf.lambdas[kf.lambdas.length-1].outputSchema:rj.payloadSchema.schema.name,sk=lo?null:rj.payload;if(rj.messageType===sg.Input||lo){if(kf.shouldSendResultsToHost)if(Wf===this.inputSchemasToReduceWorkflows)this.hostCallbacks.onResult("Reduce.Input",ze,as,sk);else this.hostCallbacks.onResult(mg,ze,as,sk);fe.success=!0;fe.resultSignature=bn?"NoOutput":
"ValidOutput"}else bn?(fe.success=!0,fe.resultSignature="NoOutput"):(fe.success=!1,fe.resultSignature="Exception",fe.resultDescription=Wq(rj));Wf!==this.inputSchemasToReduceWorkflows&&this.updateResultCacheForReduceWorkflows(mg,ze,as,sk,rj.correlationVector.toString());rj.moreResults||(fe.stop(),tb.info(559290451,Oc.CoreDefault,fe),kf.onFinish(Ci,rj.payload&&rj.payload.exceptionType?null==rj||null==rj.payload||null==rj.payload.exceptionType?Eh.Unknown:rj.payload.exceptionType:void 0))}};kf.preExecutionPromise.then(()=>
{const rj={lookupTable:this.lookupTableCache.get(kf.name),docId:Kf,docSessionId:Ci};let bn=di;for(let lo=kf.lambdas.length-1;0<=lo;lo--)bn=this.createLambdaExecutionStep(kf.name,kf.lambdas[lo],rj,bn,di);bn(Ld)})}getForcedDocLevelSchema(fe){return`~${fe}`}updateResultCacheForReduceWorkflows(fe,Ld,ze,kf,mg){const Wf=this.inputSchemasToReduceWorkflows.get(ze);if(Wf){let Kf;"docSessionId"===fe?(Kf=this.getGroupingKey(fe,Ld,ze),this.resultCache.setResult(this.getForcedDocLevelSchema(ze),Kf,kf),Kf.secondary=
"*"):(Kf=this.getGroupingKey(fe,Ld,ze),("Tiling.TextTileEvent"===fe&&Ld&&Ld.type==Ji.TextTileEventType.Delete||"ClpSlideTile"===fe&&Ld&&Ld.eventType==dp.SlideTileEventType.Delete)&&void 0!=Kf.primary&&void 0!=Kf.secondary?this.resultCache.clear(void 0,Kf):this.resultCache.setResult(ze,Kf,kf));const Ci=Wf.some(di=>di.deferReduceUntilIdle),cj=[];this.inputSchemasToWorkflows.forEach(di=>cj.push(...di.filter(rj=>rj.getOutputSchema()===ze)));fe=Wf.map(di=>di.deferReduceUntilIdleMaxDelayMs||0).reduce((di,
rj)=>Math.max(di,rj));this.reduceTimerCache.setReduceTimer(ze,Kf.primary,()=>{const di=this.resultCache.getResults(ze,Kf);di.push(...this.resultCache.getResults(this.getForcedDocLevelSchema(ze),{primary:Kf.primary}));Array.isArray(di)?this.submitToWorkflows(ze,{id:Kf.primary,values:di,RHn:!0},mg,this.inputSchemasToReduceWorkflows):tb.error(559290452,Oc.CoreDefault,`Cached results have unexpected type "${typeof di}"`)},500,()=>Ci&&cj.some(di=>0<di.executionCountByDocSessionId.get(Kf.primary)),fe)}}isFeatureEnabled(fe,
Ld=!1,ze="None"){return this.hostCallbacks&&this.hostCallbacks.isFeatureEnabled?this.hostCallbacks.isFeatureEnabled("Microsoft.Office.AugLoop."+fe,ze).catch(()=>Promise.resolve(Ld)):Promise.resolve(Ld)}areLicenseFeaturesEnabled(fe){return this.hostCallbacks&&this.hostCallbacks.areLicenseFeaturesEnabled?this.hostCallbacks.areLicenseFeaturesEnabled(fe).catch(()=>Promise.resolve(!1)):Promise.resolve(!1)}isWorkflowEnabled(fe,Ld,ze,kf,mg){if(Ld.some(Wf=>Wf.source===Pj.Remote||Wf.source===Pj.BatchedRemote)){if(!this.serviceUrl)return mg.resultDescription=
"Disabled because no service URL available for remote workflow",Promise.resolve(!1);if(this.clientMetadata&&this.clientMetadata.privateMode&&Ld.some(Wf=>(Wf.source===Pj.Remote||Wf.source===Pj.BatchedRemote)&&!Wf.canRunInPrivateMode))return mg.resultDescription="Disabled because we are running in private mode",Promise.resolve(!1)}if(!this.clientMetadata||"Mac"!==this.clientMetadata.appPlatform&&"Win32"!==this.clientMetadata.appPlatform)kf=!0,mg.resultDescription="Enabled by default due to platform name";
return(kf?Promise.resolve(!0):this.isFeatureEnabled("WorkflowEnabled."+fe)).then(Wf=>{if(Wf)return this.isFeatureEnabled("WorkflowDisabled."+fe).then(Kf=>Kf?(mg.resultDescription="Disabled because explicitly disabled",!1):ze?this.areLicenseFeaturesEnabled(ze).then(Ci=>{Ci||(mg.resultDescription="Disabled because license check failed");return Ci}):!0);mg.resultDescription="Disabled because not explicitly enabled";return!1})}registerHardcodedWorkflow(fe,Ld,ze=this.inputSchemasToWorkflows,kf){if(!fe||
40<fe.length)throw Error("Workflow name has invalid length");if(!1===(new RegExp(/^[A-Z][a-zA-Z0-9_]+$/)).test(fe))throw Error("Workflow name has invalid format");ze.forEach(Wf=>{if(Wf.some(Kf=>Kf.name===fe))throw Error("Workflow name already registered.");});const mg=new Za({operationName:"WorkflowRegistration",resourceId:fe,success:!0});mg.setClientMetadata(this.clientMetadata);mg.start();return this.isWorkflowEnabled(fe,Ld,kf.licenseFeatures,kf.enabledByDefault,mg).then(Wf=>{mg.resultSignature=
Wf?"Enabled":"Disabled";mg.stop();tb.info(559290453,Oc.CoreDefault,mg);if(Wf){const Kf=Ld[0].inputSchema;Wf=ze.get(Kf);Wf||(Wf=[],ze.set(Kf,Wf));let Ci=Promise.resolve();kf.lookupTableLambda&&(Ci=new Promise(di=>{var rj=new rd;rj={messageType:sg.Input,correlationVector:rj,payloadSchema:Zh(kf.lookupTableLambda.inputSchema),clientMetadata:this.clientMetadata,payload:{}};const bn=lo=>{lo.messageType===sg.Input&&lo.payload&&this.lookupTableCache.set(fe,lo.payload);di()};this.createLambdaExecutionStep("",
kf.lookupTableLambda,{},bn,bn)(rj)}));const cj=new bq;cj.name=fe;cj.lambdas=Ld;cj.canProduceNullResult=kf.canProduceNullResult;cj.shouldSendResultsToHost=kf.shouldSendResultsToHost;cj.triggerOnRefresh=kf.triggerOnRefresh;cj.throttleSettings=kf.throttleSettings||this.defaultWorkflowOptions.throttleSettings;cj.docIdExtractor=kf.docIdExtractor;cj.docSessionIdExtractor=di=>di.RHn?di.id:Fq(Kf,di);cj.deferReduceUntilIdle=kf.deferReduceUntilIdle;cj.deferReduceUntilIdleMaxDelayMs=kf.deferReduceUntilIdleMaxDelayMs;
cj.useCanaryTextTile=kf.useCanaryTextTile;cj.preExecutionPromise=Ci;Wf.push(cj)}})}logOperation(fe,Ld,ze,kf){fe.stop();fe.success=Ld;fe.resultSignature=ze;fe.resultDescription=kf;tb.info(559290454,Oc.CoreDefault,fe)}handleLambdaError(fe,Ld,ze,kf,mg){void 0!=fe.exceptionType?oe(Ld,fe):fe instanceof Error?oe(Ld,{exceptionType:kf,message:fe.message}):oe(Ld,{exceptionType:Eh.Unknown,message:fe?fe.toString():void 0});this.logOperation(ze,!1,"Exception",Wq(Ld));mg(Ld)}handleLambdaOutput(fe,Ld,ze,kf,mg,
Wf){fe&&fe.exceptionType!==Eh.NoOutput?void 0!=fe.exceptionType?this.handleLambdaError(fe,Ld,ze,fe.exceptionType,Wf):fe instanceof Error?this.handleLambdaError(fe,Ld,ze,Eh.LambdaErrorCallback,Wf):(Ld.payload=fe,Ld.payloadSchema=Zh(kf),this.logOperation(ze,!0),mg(Ld)):(oe(Ld,{exceptionType:Eh.NoOutput}),this.logOperation(ze,!0,"NoOutput"),Wf(Ld))}executeCustomLambdaStep(fe,Ld,ze,kf,mg,Wf){if(null==ze.func)oe(fe,{exceptionType:Eh.LambdaThrow,message:"No lambda function set"}),this.logOperation(Ld,!1,
"Error",Wq(fe)),Wf(fe);else{const Kf=cj=>{this.handleLambdaOutput(cj,fe,Ld,ze.outputSchema,mg,Wf)},Ci=(cj,di)=>{this.handleLambdaOutput(cj,fe,Ld,di,Wf,Wf)};try{ze.func(fe.payload,ze.config,kf,Kf,Ci)}catch(cj){this.handleLambdaError(cj,fe,Ld,Eh.LambdaThrow,Wf)}}}executeLocalLambdaStep(fe,Ld,ze,kf,mg){void 0==this.hostCallbacks.executeLocalLambda?(oe(fe,{exceptionType:Eh.LambdaThrow,message:"No local lambda host callback set"}),this.logOperation(Ld,!1,"Error",Wq(fe)),mg(fe)):this.hostCallbacks.executeLocalLambda(ze.inputSchema,
fe.payload,ze.outputSchema).then(Wf=>{this.handleLambdaOutput(Wf,fe,Ld,ze.outputSchema,kf,mg)}).catch(Wf=>{this.handleLambdaError(Wf,fe,Ld,Eh.LambdaThrow,mg)})}executeRemoteLambdaStep(fe,Ld,ze,kf,mg,Wf){if(this.serviceUrl){Ld.resourceId+=`.${this.serviceProtocol}`;const Kf=(Ci,cj)=>{Ci?this.handleLambdaError(Ci,fe,Ld,Ci.exceptionType||Eh.LambdaErrorCallback,Wf):this.handleLambdaOutput(cj,fe,Ld,ze.outputSchema,mg,Wf)};kf.authTickets=ze.authTickets;if(ze.source===Pj.Remote)this.executeRemoteLambda(this.serviceUrl,
fe,Zh(ze.inputSchema),Zh(ze.outputSchema),fe.correlationVector,this.clientMetadata,this.hostCallbacks,kf,Kf);else{this.batchedRemoteLambdaManager||(this.batchedRemoteLambdaManager=new Kk((di,rj,bn)=>{const lo=rj.context.ZSo,as=rj.context.Waj;this.executeRemoteLambda(this.serviceUrl,{messageType:sg.Input,correlationVector:{id:rj.cv},payload:di,payloadSchema:Zh(lo.inputSchema),clientMetadata:this.clientMetadata},Zh(lo.remoteInputSchema),Zh(lo.remoteOutputSchema),{id:rj.cv},this.clientMetadata,this.hostCallbacks,
as,bn)},!1,!1,(di,rj,bn)=>{var lo;bn=bn.Waj;this.updateResultCacheForReduceWorkflows("docSessionId",null!==(lo=bn.docSessionId)&&void 0!==lo?lo:bn.docId,di,rj)}));const Ci=this.normalizeBatchOptions(ze.batchOptions),cj=Ci.groupingKeyExtractor;Ci.groupingKeyExtractor=di=>`${ze.name}-${cj(di)}`;this.batchedRemoteLambdaManager.addBatchItem(fe.payload,Ci,{name:ze.name,ZSo:ze,Waj:kf},127<fe.correlationVector.id.length?fe.correlationVector.id.substring(0,127)+"!":fe.correlationVector.id,void 0,Kf)}}else oe(fe,
{exceptionType:Eh.LambdaThrow,message:"No URL for remote lambda"}),this.logOperation(Ld,!1,"Error",Wq(fe)),Wf(fe)}createLambdaExecutionStep(fe,Ld,ze,kf,mg){return Wf=>{const Kf=new Za({cv:Wf.correlationVector.toString(),operationName:"ExecuteLambda",resourceId:Ld.name,dimension0:fe});Kf.start();Ld.source===Pj.Custom?this.executeCustomLambdaStep(Wf,Kf,Ld,ze,kf,mg):Ld.source===Pj.Local?this.executeLocalLambdaStep(Wf,Kf,Ld,kf,mg):Ld.source===Pj.Remote||Ld.source===Pj.BatchedRemote?this.executeRemoteLambdaStep(Wf,
Kf,Ld,ze,kf,mg):(oe(Wf,{exceptionType:Eh.LambdaThrow,message:"Unknown/No lambda location set"}),this.logOperation(Kf,!1,"Error",Wq(Wf)),mg(Wf))}}normalizeBatchOptions(fe){if(!fe)throw Error("Expected batchConfig");const Ld=Object.assign({},fe);fe.estimateSize||(Ld.estimateSize=zn);return Ld}}const xs=new jo,qp=(fe,Ld)=>Ld.some(ze=>fe instanceof ze);let Yq,af;const Gp=new WeakMap,cq=new WeakMap,dq=new WeakMap,$n=new WeakMap,an=new WeakMap;let eq={get(fe,Ld,ze){if(fe instanceof IDBTransaction){if("done"===
Ld)return cq.get(fe);if("objectStoreNames"===Ld)return fe.objectStoreNames||dq.get(fe);if("store"===Ld)return ze.objectStoreNames[1]?void 0:ze.objectStore(ze.objectStoreNames[0])}return sa(fe[Ld])},set(fe,Ld,ze){fe[Ld]=ze;return!0},has(fe,Ld){return fe instanceof IDBTransaction&&("done"===Ld||"store"===Ld)?!0:Ld in fe}};const Uj=["get","getKey","getAll","getAllKeys","count"],rp=["put","add","delete","clear"],Ih=new Map;eq=(fe=>({...fe,get:(Ld,ze,kf)=>ka(Ld,ze)||fe.get(Ld,ze,kf),has:(Ld,ze)=>!!ka(Ld,
ze)||fe.has(Ld,ze)}))(eq);var Ei;(function(fe){fe.URL="URL";fe.ArrayBuffer="ArrayBuffer"})(Ei||(Ei={}));class Ho{constructor(fe,Ld,ze,kf){this.dbName="ALModels_db";this.osName="ALModels_os";this.dbVersion=2;this.modelPathsCache=new Map;this.isPolymerSupported=!!ze;this.baseURL=`https://${Ld}/web/${fe}`;this.polymerBaseURL=this.isPolymerSupported?`https://${ze}`:"";this.fetchResource=null!==kf&&void 0!==kf?kf:"undefined"!==typeof fetch?fetch:ih.fetch;const mg=new Za({operationName:"CreateModelDownloader",
success:!0,resultDescription:""});mg.start();this.isBrowserIdbCompatible().then(Wf=>{if(Wf){let Kf=0,Ci=0,cj=0,di;Wf=new Promise((bn,lo)=>{di=setTimeout(()=>{lo(Error("Took longer than 10000 ms"))},1E4)});const rj=this.accessDB().then(bn=>{const lo=bn.transaction(this.osName,"readwrite");return lo.objectStore(this.osName).openCursor().then(function jf(sk){cj++;if(sk){var yk=sk.value;yk.zGe||(yk.zGe=0);yk.zGe++;5<yk.zGe?(Ci++,yk=sk.delete()):(Kf++,yk=sk.update(yk));return yk.then(()=>sk.continue()).then(jf)}return lo.done})});
this.initPromise=Promise.race([Wf,rj]).catch(bn=>{mg.success=!1;mg.resultDescription+=`${bn.message} `}).then(()=>{mg.dimension0=`${cj}`;mg.dimension1=`${Kf}`;mg.dimension2=`${Ci}`;clearTimeout(di);this.closeDBAndEndLog(mg,"initializing idb storage")})}else mg.resultDescription="Incompatible browser for IDB",tb.info(538706242,Oc.CoreDefault,mg.stop())}).catch(()=>{mg.resultDescription="Issue determining idb compatibility";tb.info(536966936,Oc.CoreDefault,mg.stop())})}getResourceAsArrayBuffer(fe,Ld,
ze){const kf=new Za({operationName:"GetResource",success:!0,resultDescription:"",dimension0:Ei.ArrayBuffer,dimension1:fe,dimension2:Ld});kf.start();const mg={};return this.getResource(fe,Ld,ze,Ei.ArrayBuffer,kf,Wf=>Promise.all(Array.from(Wf.keys()).map(Kf=>{const Ci=Wf.get(Kf);return Ci.arrayBuffer?Ci.arrayBuffer().then(cj=>{mg[Kf]=cj}):new Promise((cj,di)=>{const rj=new FileReader;rj.readAsArrayBuffer(Ci);rj.onload=bn=>{bn=bn.target.result;bn instanceof ArrayBuffer?(mg[Kf]=bn,cj()):di(Error("Unable to obtain ArrayBuffer"))}})}))).then(()=>
mg)}getKey(fe,Ld,ze){return ze?`${fe}_${Ld}_${JSON.stringify(Array.from(ze.entries()))}`:`${fe}_${Ld}`}updateCache(fe,Ld,ze,kf){this.modelPathsCache.set(this.getKey(fe,Ld,ze),kf)}getCache(fe,Ld,ze){return this.modelPathsCache.get(this.getKey(fe,Ld,ze))}getResourceAsURL(fe,Ld,ze){const kf=new Za({operationName:"GetResource",success:!0,resultDescription:"",dimension0:Ei.URL,dimension1:fe,dimension2:Ld});kf.start();const mg={},Wf=this.getCache(fe,Ld,ze);return Wf?Promise.resolve(Wf):this.getResource(fe,
Ld,ze,Ei.URL,kf,Kf=>Promise.all(Array.from(Kf.keys()).map(Ci=>{mg[Ci]=URL.createObjectURL(Kf.get(Ci))}))).then(()=>{const Kf=this.getCache(fe,Ld,ze);if(Kf)return Kf;this.updateCache(fe,Ld,ze,mg);return mg})}getResource(fe,Ld,ze,kf,mg,Wf){return this.getFiles(fe,Ld,ze,mg).then(Kf=>Wf(Kf)).then(()=>{this.closeDBAndEndLog(mg,`retrieving ${fe}`)}).catch(Kf=>{0<=mg.resultDescription.indexOf(Kf.message)&&(mg.success=!1,mg.resultDescription+=`${Kf.message} `);mg.resultSignature=`Issue retrieving from CDN or translating to ${kf}`;
this.closeDBAndEndLog(mg,`retrieving ${fe}`);throw Kf;})}checkFirefoxCompatibility(fe){fe=globalThis.navigator.userAgent.substring(fe+8,fe+11);fe.replace(".","");return 70>=parseInt(fe,10)?new Promise(function(Ld,ze){const kf=globalThis.indexedDB.open(this.dbName,this.dbVersion);kf.onsuccess=function(){Ld(!0)};kf.onerror=function(mg){ze(mg);return!0}}):Promise.resolve(!0)}isBrowserIdbCompatible(){var fe,Ld;return"undefined"===typeof Array||"undefined"===typeof Array.from||"undefined"===typeof Proxy||
"undefined"===typeof URL||"undefined"===typeof URL.createObjectURL?Promise.resolve(!1):"undefined"!==typeof globalThis&&(null===(fe=globalThis.navigator)||void 0===fe?0:fe.userAgent)?-1<globalThis.navigator.userAgent.toLowerCase().indexOf("firefox")?globalThis.indexedDB?this.checkFirefoxCompatibility(globalThis.navigator.userAgent.toLowerCase().indexOf("firefox")):Promise.resolve(!1):-1<globalThis.navigator.userAgent.toLowerCase().indexOf("safari")&&-1>=globalThis.navigator.userAgent.toLowerCase().indexOf("chrome")?
(null===(Ld=globalThis.document)||void 0===Ld?0:Ld.hasStorageAccess)?globalThis.document.hasStorageAccess().then(()=>!0).catch(()=>!1):Promise.resolve(!1):Promise.resolve(!0):Promise.resolve(!1)}accessDB(){return this.accessDBPromise?this.accessDBPromise.then(fe=>fe.transaction(this.osName).done).then(()=>this.accessDBPromise).catch(()=>this.callOpenDB()):this.callOpenDB()}callOpenDB(){return this.accessDBPromise=Aa(this.dbName,this.dbVersion,{upgrade:fe=>{fe.objectStoreNames.contains(this.osName)&&
fe.deleteObjectStore(this.osName);fe.createObjectStore(this.osName,{keyPath:"id",autoIncrement:!0})}})}endLog(fe,Ld){fe.success?(fe.resultDescription=`Success ${Ld}`,tb.info(573329487,Oc.CoreDefault,fe.stop())):(fe.resultDescription+=`error ${Ld}`,tb.error(573329488,Oc.CoreDefault,fe.stop()))}closeDBAndEndLog(fe,Ld){this.accessDBPromise?this.accessDBPromise.then(ze=>{ze.close()}).catch(ze=>{0<=fe.resultDescription.indexOf(ze.message)&&(fe.success=!1,fe.resultDescription+=`${ze.message?ze.message:
"Error closing db"} `,fe.resultSignature="Issue closing db")}).then(()=>{this.accessDBPromise=void 0;this.endLog(fe,Ld)}):this.endLog(fe,Ld)}getFiles(fe,Ld,ze,kf){return this.isBrowserIdbCompatible().catch(mg=>{kf.success=!1;kf.resultDescription+=`${mg.message} `;kf.resultSignature="Issue determining idb compatibility";return!1}).then(mg=>{const Wf=()=>{if(ze){if(this.isPolymerSupported)return this.downloadFiles1CDN(fe,Ld,ze,kf,mg);throw Error("Missing polymerBaseURL provided at host level for queries with modelFilters");
}return this.downloadFiles(fe,Ld,kf,mg)};return mg?this.getFilesFromIDB(fe,Ld,ze,kf).catch(Kf=>{Kf&&(0<=kf.resultDescription.indexOf(Kf.message)&&(kf.success=!1,kf.resultDescription+=`${Kf.message} `),kf.resultSignature="Issue retrieving from DB");return Wf()}):Wf()})}getFilesFromIDB(fe,Ld,ze,kf){return this.initPromise.catch(mg=>{kf.success=!1;kf.resultDescription+=`${mg.message} `;kf.resultSignature="Issue initializing"}).then(()=>this.getModelOptions(fe)).then(mg=>{for(const Wf of mg)if(Wf&&Wf.model&&
Wf.version==Ld&&this.checkModelFiltersPass(ze,Wf.filters))return this.putModel(fe,Wf.model,Ld,Wf.filters,kf,Wf.id),Promise.resolve(Wf.model);return Promise.reject()})}checkModelFiltersPass(fe,Ld){var ze;for(const kf of fe){fe=null===(ze=Ld.get(kf[0]))||void 0===ze?void 0:ze.map(mg=>mg.toLocaleLowerCase());if(!fe)throw Error(`Expected filter ${kf[0]} to exist in metadata file`);if(0>fe.indexOf(kf[1].toLocaleLowerCase()))return!1}return!0}downloadFiles1CDN(fe,Ld,ze,kf,mg){kf.dimension3="Polymer";let Wf;
ze||(ze=new Map);return this.fetchResource(`${this.polymerBaseURL}/${fe}/${Ld}/metadata.json`).then(Kf=>{if(Kf.ok)return Kf.text();throw Error(`CDN download response status: ${Kf.status}`);}).then(Kf=>{var Ci,cj;Kf=JSON.parse(Kf);if(Kf.name!==fe||Kf.version!==Ld)throw Error(`Expected: ${fe} version ${Ld}, received: ${Kf.name} version ${Kf.version}`);for(const di of Kf.variants)if(Wf=new Map(Object.entries(di)),this.checkModelFiltersPass(ze,Wf)){if(Kf.t_d?ze.size+2:ze.size+1!==Wf.size)kf.success=!1,
kf.resultDescription+=`Expected ${null===(Ci=Wf.keys)||void 0===Ci?void 0:Ci.length} # of filters, received ${null===(cj=ze.keys)||void 0===cj?void 0:cj.length}`;return di.MMq}throw Error("No model found with given filters");}).then(Kf=>Promise.all(Kf.map(Ci=>this.fetchResource(`${this.polymerBaseURL}/${fe}/${Ld}/${Ci}`).then(cj=>{if(cj.ok)return cj.blob();throw Error(`CDN download response status: ${cj.status}`);}).then(cj=>[Ci,cj])))).then(Kf=>{Kf=new Map(Kf);return mg?this.putModel(fe,Kf,Ld,Wf,
kf):Kf})}downloadFiles(fe,Ld,ze,kf){ze.dimension3="FS";return this.fetchResource(`${this.baseURL}/catalog_${fe}_${Ld}.json`).then(mg=>{if(mg.ok)return mg.text();throw Error(`CDN download response status: ${mg.status}`);}).then(mg=>{mg=JSON.parse(mg);const Wf=`${mg.MajorVersion}.${mg.MinorVersion}/ModelResources`,Kf=`${fe}/${Ld}/`;return Promise.all(mg.Qdq.map(Ci=>{Ci.Name.length>Kf.length&&Ci.Name.substring(0,Kf.length)===Kf&&(Ci.Name=Ci.Name.substring(Kf.length));return this.fetchResource(`${this.baseURL}/${Wf}/${Kf}${Ci.Name}.${Ci.Type}`).then(cj=>
{if(cj.ok)return cj.blob();throw Error(`CDN download response status: ${cj.status}`);}).then(cj=>[`${Ci.Name}.${Ci.Type}`,cj])}))}).then(mg=>{mg=new Map(mg);return kf?this.putModel(fe,mg,Ld,new Map,ze):mg})}getModelOptions(fe){return this.accessDB().then(Ld=>{const ze=[],kf=Ld.transaction(this.osName,"readonly");return kf.objectStore(this.osName).openCursor().then(function Kf(Wf){if(Wf){const Ci=Wf.value;Ci.modelId==fe&&ze.push(Ci);return Wf.continue().then(Kf)}return kf.done}).then(()=>ze)})}putModel(fe,
Ld,ze,kf,mg,Wf){kf||(kf=new Map);return this.accessDB().then(Kf=>Kf.put(this.osName,{modelId:fe,model:Ld,version:ze,filters:kf,zGe:0},Wf)).catch(Kf=>{0<=mg.resultDescription.indexOf(Kf.message)&&(mg.success=!1,mg.resultDescription+=`${Kf.message} `);mg.resultSignature="Issue adding to DB"}).then(()=>Ld)}}var Rp;(function(fe){fe[fe.None=0]="None";fe[fe.Booleans=1]="Booleans";fe[fe.Float32s=2]="Float32s";fe[fe.Float64s=3]="Float64s";fe[fe.Int8s=4]="Int8s";fe[fe.Int16s=5]="Int16s";fe[fe.Int32s=6]="Int32s";
fe[fe.Strings=7]="Strings";fe[fe.UnsignedInt8s=8]="UnsignedInt8s";fe[fe.UnsignedInt16s=9]="UnsignedInt16s";fe[fe.UnsignedInt32s=10]="UnsignedInt32s"})(Rp||(Rp={}));class qk{constructor(fe,Ld,ze){this.session=fe;this.onnxObject=ze;this.modelName=Ld}static create(fe,Ld,ze){return D(this,void 0,void 0,function*(){const kf=new Za({operationName:"CreateModelForInferencing",success:!0,resourceId:Ld});kf.start();return ze[fe]?(kf.resultDescription="Model already existed",tb.info(509699716,Oc.CoreDefault,
kf.stop()),ze[fe]):ze[fe]=this.getInferenceSession(ze).create(fe).then(mg=>{tb.info(540406807,Oc.CoreDefault,kf.stop());return new qk(mg,Ld,ze)}).catch(mg=>{kf.resultDescription=`Error: ${mg}`;tb.info(540406808,Oc.CoreDefault,kf.stop());throw mg;})})}static getInferenceSession(fe){if(null===fe||void 0===fe?0:fe.UUg)return fe.UUg;throw Error("InferenceSession is not defined");}run(fe){var Ld;return D(this,void 0,void 0,function*(){const ze=new Za({operationName:"RunModelForInferencing",success:!0,
resourceId:this.modelName});ze.start();if(null===(Ld=this.onnxObject)||void 0===Ld?0:Ld.Tensor){const kf=fe.getInputs(),mg={};Object.keys(kf).forEach(Wf=>{const Kf=kf[Wf];if(Array.isArray(Kf.values)&&0<Kf.values.length&&"boolean"===typeof Kf.values[0]){const Ci=new Uint8Array(Kf.values);mg[Wf]=new this.onnxObject.Tensor(Ci,Kf.dimensions)}else mg[Wf]=new this.onnxObject.Tensor(Kf.values,Kf.dimensions)});return this.session.run(mg).then(Wf=>{tb.info(540406809,Oc.CoreDefault,ze.stop());return new hn(Wf)}).catch(Wf=>
{ze.resultDescription=`Problem running model. ${Wf.message}`;tb.info(540406810,Oc.CoreDefault,ze.stop())})}ze.resultDescription="Unable to run model. Tensor not defined";tb.info(540406811,Oc.CoreDefault,ze.stop());throw Error("Tensor is not defined");})}}class An{constructor(){this.map={}}static create(){return new An}getInputs(){return this.map}add(fe,Ld,ze){this.map[fe]={dimensions:Ld,values:ze};return this}}class hn{constructor(fe){for(const Ld of Object.keys(fe))this[Ld]=new Hf(Ld,fe[Ld])}}class Hf{constructor(fe,
Ld){this.x5b=fe;this.result=Ld}name(){return this.x5b}outputType(){switch(this.result.type){case "string":return Rp.Strings;case "int8":return Rp.Int8s;case "int16":return Rp.Int16s;case "int32":return Rp.Int32s;case "bool":return Rp.Booleans;case "uint8":return Rp.UnsignedInt8s;case "uint16":return Rp.UnsignedInt16s;case "uint32":return Rp.UnsignedInt32s;case "float32":return Rp.Float32s;case "float64":return Rp.Float64s;default:throw Error(`The output type ${this.result.type} is not supported.`);
}}dimensions(){return this.result.fvq}asBooleans(){if(this.outputType()===Rp.Booleans)return this.result.data.map(fe=>!!fe);throw Error(`asBooleans() was called; however, outputType() is ${this.outputType()}, not Type.Booleans.`);}asFloat32s(){if(this.outputType()===Rp.Float32s)return this.result.data;throw Error(`asFloat32s() was called; however, outputType() is ${this.outputType()}, not Type.Float32s.`);}asFloat64s(){if(this.outputType()===Rp.Float64s)return this.result.data;throw Error(`asFloat64s() was called; however, outputType() is ${this.outputType()}, not Type.Float64s.`);
}asInt8s(){if(this.outputType()===Rp.Int8s)return this.result.data;throw Error(`asInt8s() was called; however, outputType() is ${this.outputType()}, not Type.Int8s.`);}asInt16s(){if(this.outputType()===Rp.Int16s)return this.result.data;throw Error(`asInt16s() was called; however, outputType() is ${this.outputType()}, not Type.Int16s.`);}asInt32s(){if(this.outputType()===Rp.Int32s)return this.result.data;throw Error(`asInt32s() was called; however, outputType() is ${this.outputType()}, not Type.Int32s.`);
}asStrings(){if(this.outputType()===Rp.Strings)return this.result.data;throw Error(`asStrings() was called; however, outputType() is ${this.outputType()}, not Type.Strings.`);}asUnsignedInt8s(){if(this.outputType()===Rp.UnsignedInt8s)return this.result.data;throw Error(`asUnsignedInt8s() was called; however, outputType() is ${this.outputType()}, not Type.UnsignedInt8s.`);}asUnsignedInt16s(){if(this.outputType()===Rp.UnsignedInt16s)return this.result.data;throw Error(`asUnsignedInt16s() was called; however, outputType() is ${this.outputType()}, not Type.UnsignedInt16s.`);
}asUnsignedInt32s(){if(this.outputType()===Rp.UnsignedInt32s)return this.result.data;throw Error(`asUnsignedInt32s() was called; however, outputType() is ${this.outputType()}, not Type.UnsignedInt32s.`);}}class Ve{static createFactory(fe,Ld,ze,kf,mg){return Wf=>{var Kf;const Ci=kf?kf:mb;return!Ve.onnxRetrievalPromise||Wf?fe&&Ld?((null===(Kf=Ci())||void 0===Kf?0:Kf.Eqo)&&!Wf?Promise.resolve():va(this.createCdnUrl(fe,Ld),Ci,"ort",ze,mg)).then(()=>{Ve.onnxRetrievalPromise=Promise.resolve(new Ve(Ci))}).catch(cj=>
{Ve.onnxRetrievalPromise=Promise.reject(cj)}).then(()=>Ve.onnxRetrievalPromise):Promise.reject(Error("Error: appName and/or version not provided")):Ve.onnxRetrievalPromise}}static createCdnUrl(fe,Ld){return`https://${fe}${Ld}`}constructor(fe){this.getCache=null;this.getCache=fe}createModel(fe,Ld){var ze;const kf=null===(ze=this.getCache())||void 0===ze?void 0:ze.Eqo;return qk.create(fe,Ld?Ld:"",kf)}createInputs(){return An.create()}}class xd{constructor(fe){pf.a.assign(xd,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_SetClaimsChallengeCallbackMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,
[xd.getTypeName()])}}xd.H_={T_:xd.getTypeName(),B_:xd.getBaseTypes()};class qf{constructor(fe){pf.a.assign(qf,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_FireClaimsChallengeCallbackResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[qf.getTypeName()])}}qf.H_={T_:qf.getTypeName(),B_:qf.getBaseTypes()};class Rd{constructor(fe){pf.a.assign(Rd,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_SetSeedingStatusChangeCallbackMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,
[Rd.getTypeName()])}}Rd.H_={T_:Rd.getTypeName(),B_:Rd.getBaseTypes()};class Ie{constructor(fe){pf.a.assign(Ie,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_FireSeedingStatusChangeCallbackResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[Ie.getTypeName()])}}Ie.H_={T_:Ie.getTypeName(),B_:Ie.getBaseTypes()};class cg{constructor(fe){pf.a.assign(cg,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_InteractiveAuthMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,
[cg.getTypeName()])}}cg.H_={T_:cg.getTypeName(),B_:cg.getBaseTypes()};class fk{constructor(fe){pf.a.assign(fk,this,fe)}static getTypeName(){return"AugLoop_Session_Protocol_GetAnnotationsResponseBridgeMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[fk.getTypeName()])}}fk.H_={T_:fk.getTypeName(),B_:fk.getBaseTypes()};class hj{sendTraceTag(){}shipAssertTag(){}debugAssertTag(){}setCorrelationId(){}}class El{constructor(){this.jxa=
new hj}setCorrelationId(fe){this.jxa.setCorrelationId(fe)}gDg(fe){this.jxa=fe}sendTraceTag(fe,Ld,ze,kf){this.jxa.sendTraceTag(fe,Ld,ze,kf)}debugAssertTag(fe,Ld,ze,kf){this.jxa.debugAssertTag(fe,Ld,ze,kf)}shipAssertTag(fe,Ld,ze,kf){this.jxa.shipAssertTag(fe,Ld,ze,kf)}}const Io=new El;var ep;(function(fe){fe[fe.hqe=0]="msoulscat_ES_EWAJS";fe[fe.olj=1]="msoulscat_ES_EWAJSGrid";fe[fe.nlj=6]="msoulscat_ES_EWAJSChart";fe[fe.plj=202]="msoulscat_MSOSP_FileMenuCommands";fe[fe.o9n=220]="msoulscat_MSOSP_AddInCommands";
fe[fe.qlj=225]="msoulscat_MSOSP_OTelJS";fe[fe.Uhb=227]="msoulscat_MSOSP_OTelJSInWebWoker";fe[fe.rlj=228]="msoulscat_MSOSP_OTelJSWebWorkerPrototype";fe[fe.Y9n=301]="msoulscat_Wac_WordViewer";fe[fe.Nh=306]="msoulscat_Wac_BrowserGeneral";fe[fe.M9n=320]="msoulscat_Wac_TaskPane";fe[fe.ylj=339]="msoulscat_Wac_OneNoteGeneral";fe[fe.Hlj=340]="msoulscat_Wac_Ribbon";fe[fe.O9n=356]="msoulscat_Wac_WacFeedback";fe[fe.V9n=379]="msoulscat_Wac_WopiPendingApplication";fe[fe.msoulscat_Wac_Telemetry=383]="msoulscat_Wac_Telemetry";
fe[fe.Klj=391]="msoulscat_Wac_WacCatchUpActivities";fe[fe.mfg=394]="msoulscat_Wac_Dictation";fe[fe.zlj=395]="msoulscat_Wac_OneNoteSync";fe[fe.N9n=700]="msoulscat_Wac_VisioApp";fe[fe.slj=1601]="msoulscat_OneNoteOnline_EditableCache";fe[fe.Alj=800]="msoulscat_Wac_PptAnimation";fe[fe.Blj=833]="msoulscat_Wac_PptLive";fe[fe.Clj=834]="msoulscat_Wac_PptMWeb";fe[fe.G9n=835]="msoulscat_Wac_PptGc2General";fe[fe.H9n=836]="msoulscat_Wac_PptGc2GraphicHost";fe[fe.I9n=837]="msoulscat_Wac_PptGc2Operation";fe[fe.F9n=
852]="msoulscat_Wac_PptGc2EditCanvas";fe[fe.D9n=844]="msoulscat_Wac_PptDataSync";fe[fe.E9n=848]="msoulscat_Wac_PptFluidRuntime";fe[fe.Elj=815]="msoulscat_Wac_PptShape";fe[fe.Dlj=817]="msoulscat_Wac_PptSession";fe[fe.Flj=830]="msoulscat_Wac_PptSlideshow";fe[fe.Glj=822]="msoulscat_Wac_PptView";fe[fe.J9n=846]="msoulscat_Wac_PptVideos";fe[fe.s9n=1303]="msoulscat_Uci_Insights";fe[fe.Jlj=2300]="msoulscat_Wac_VersionHistory";fe[fe.Mlj=302]="msoulscat_Wac_WordPresence";fe[fe.C9n=3E3]="msoulscat_Wac_OAuth";
fe[fe.Nlj=3005]="msoulscat_Wac_WordVersionHistory";fe[fe.wlj=3006]="msoulscat_Wac_LivePersonaCard";fe[fe.vlj=3012]="msoulscat_Wac_CatchUpFlyout";fe[fe.Llj=3016]="msoulscat_Wac_WordDesigner";fe[fe.xlj=3021]="msoulscat_Wac_ModernFontPicker";fe[fe.Ilj=3027]="msoulscat_Wac_UnifiedUiHost";fe[fe.vfa=3033]="msoulscat_Wac_EquationTools";fe[fe.p9n=1401]="msoulscat_Osf_Latency";fe[fe.q9n=1402]="msoulscat_Osf_Notification";fe[fe.r9n=1403]="msoulscat_Osf_Runtime";fe[fe.u9n=3041]="msoulscat_Wac_AiMaker";fe[fe.v9n=
3043]="msoulscat_Wac_AiRewrite";fe[fe.t9n=3044]="msoulscat_Wac_AiInsert";fe[fe.w9n=3047]="msoulscat_Wac_AiSummarize";fe[fe.x9n=3048]="msoulscat_Wac_CopilotCompose";fe[fe.K9n=3049]="msoulscat_Wac_Skittles";fe[fe.y3a=3050]="msoulscat_Wac_CopilotChat";fe[fe.L9n=3051]="msoulscat_Wac_Syntex";fe[fe.U9n=3052]="msoulscat_Wac_WireGraph";fe[fe.B9n=3053]="msoulscat_Wac_CshCopilot";fe[fe.A9n=3055]="msoulscat_Wac_CopilotProactiveSummary";fe[fe.z9n=3056]="msoulscat_Wac_CopilotProactiveShared";fe[fe.y9n=3057]="msoulscat_Wac_CopilotCursor";
fe[fe.Q9n=3059]="msoulscat_Wac_WasmGeneral";fe[fe.T9n=3060]="msoulscat_Wac_WasmTextLayout";fe[fe.S9n=3061]="msoulscat_Wac_WasmSmartArt";fe[fe.P9n=3062]="msoulscat_Wac_WasmClient";fe[fe.R9n=3063]="msoulscat_Wac_WasmNative"})(ep||(ep={}));var gf;(function(fe){fe[fe.Error=10]="Error";fe[fe.Warning=15]="Warning";fe[fe.r$b=20]="Important";fe[fe.Info=50]="Info";fe[fe.Verbose=100]="Verbose";fe[fe.Spam=200]="Spam"})(gf||(gf={}));class km{constructor(fe){pf.a.assign(km,this,fe)}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelServerSessionExtensionConfig"}static getBaseTypes(){return[]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,
[km.getTypeName()])}}km.H_={T_:km.getTypeName(),B_:km.getBaseTypes()};class Jj{constructor(fe){pf.a.assign(Jj,this,fe)}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelWorkbookUpdated"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[Jj.getTypeName()])}}Jj.H_={T_:Jj.getTypeName(),B_:Jj.getBaseTypes()};class el{constructor(fe){pf.a.assign(el,this,fe)}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelAccessTokenRefreshed"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,
[el.getTypeName()])}}el.H_={T_:el.getTypeName(),B_:el.getBaseTypes()};class lm{constructor(fe){pf.a.assign(lm,this,fe)}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelKeepAlive"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[lm.getTypeName()])}}lm.H_={T_:lm.getTypeName(),B_:lm.getBaseTypes()};class Yj{constructor(fe){pf.a.assign(Yj,this,fe)}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelRetrieveModelRequest"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,
[Yj.getTypeName()])}}Yj.H_={T_:Yj.getTypeName(),B_:Yj.getBaseTypes()};class am{constructor(fe){pf.a.assign(am,this,fe)}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelRetrieveModelResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[am.getTypeName()])}}am.H_={T_:am.getTypeName(),B_:am.getBaseTypes()};class lj{constructor(fe){pf.a.assign(lj,this,fe)}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelSessionDiagnosticsRequest"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,
[lj.getTypeName()])}}lj.H_={T_:lj.getTypeName(),B_:lj.getBaseTypes()};class ko{constructor(fe){pf.a.assign(ko,this,fe)}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelSessionDiagnosticsResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[ko.getTypeName()])}}ko.H_={T_:ko.getTypeName(),B_:ko.getBaseTypes()};class Is{constructor(fe){pf.a.assign(Is,this,fe)}static getTypeName(){return"AugLoop_Excel_Session_Protocol_AdvanceMockGridState"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,
[Is.getTypeName()])}}Is.H_={T_:Is.getTypeName(),B_:Is.getBaseTypes()};class Tn{constructor(fe){pf.a.assign(Tn,this,fe)}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelSessionCloseReason"}static getBaseTypes(){return[]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[Tn.getTypeName()])}}Tn.H_={T_:Tn.getTypeName(),B_:Tn.getBaseTypes()};class Ta{get metadata(){return this.M_}set metadata(fe){this.M_=fe}constructor(fe){pf.a.assign(Ta,this,fe)}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ObserverStatusAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,
[Ta.getTypeName()])}}Ta.H_={T_:Ta.getTypeName(),B_:Ta.getBaseTypes()};class Ib{get metadata(){return this.M_}set metadata(fe){this.M_=fe}constructor(fe){pf.a.assign(Ib,this,fe)}static getTypeName(){return"AugLoop_Excel_Session_Protocol_FullSeedingAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[Ib.getTypeName()])}}Ib.H_={T_:Ib.getTypeName(),B_:Ib.getBaseTypes()};class Jb{get metadata(){return this.M_}set metadata(fe){this.M_=
fe}constructor(fe){pf.a.assign(Jb,this,fe)}static getTypeName(){return"AugLoop_Excel_Session_Protocol_WorkflowProgressAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[Jb.getTypeName()])}}Jb.H_={T_:Jb.getTypeName(),B_:Jb.getBaseTypes()};class Wc{constructor(fe){pf.a.assign(Wc,this,fe)}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelServerSessionInitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_SessionInitMessage",
"AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[Wc.getTypeName()])}}Wc.H_={T_:Wc.getTypeName(),B_:Wc.getBaseTypes()};class Md{constructor(fe){pf.a.assign(Md,this,fe)}static getTypeName(){return"AugLoop_Powerpoint_Session_Protocol_PowerPointSessionInitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_SessionInitMessage","AugLoop_Session_Protocol_Message"]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[Md.getTypeName()])}}Md.H_={T_:Md.getTypeName(),
B_:Md.getBaseTypes()};class Mb{constructor(fe){pf.a.assign(Mb,this,fe)}static getTypeName(){return"AugLoop_Powerpoint_Session_Protocol_PowerPointSessionExtensionConfig"}static getBaseTypes(){return[]}static typeGuard(fe){return pf.a.matchesTypesFor(fe,[Mb.getTypeName()])}}Mb.H_={T_:Mb.getTypeName(),B_:Mb.getBaseTypes()};const pe=(fe,Ld)=>{const ze=[];for(const mg of Object.keys(fe))if(void 0!==fe[mg]&&null!==fe[mg]){var kf=fe[mg];"string"===typeof kf?kf=0:"boolean"===typeof kf?kf=1:"number"===typeof kf?
kf=2:(Io.sendTraceTag(572838285,ep.Nh,gf.Warning,"Unsupported data field type"),kf=void 0);ze.push({name:Ld?`${Ld}.${mg}`:mg,dataType:kf,value:fe[mg],classification:4})}return ze},td=()=>Promise.resolve(!1);class Xd{constructor(){this._telemetryAggregationIntervalSec=30;this._eventHandlerDictionary={};this._changeGateEnabledCallback=void 0;this._sessionConnectParams=this._sessionCloseReason=this._bridgeInterceptor=this._bridge=null;this._serverAuthenticationState=Fc.a.NotAuthenticated;this._connectCallbacks=
new Map;this._connectionStateCallbackToken=0;this._claimsChallengeCallbacks=[];this._seedingStatusChangeCallbacks=[];this._bridgeMessageSequenceId=0;this.initialize=fe=>{if(this._runtimeInitPromise)Io.sendTraceTag(572838286,ep.Nh,gf.Info,"Runtime already initialized");else{Io.sendTraceTag(572838287,ep.Nh,gf.Info,"Start and initialize augloop runtime ...");this.checkParametersAndThrow("initialize",fe);var Ld=[];Ld.push(this.isFeatureEnabled("ModelDownloaderEbrake","None").then(as=>{as?Io.sendTraceTag(556376070,
ep.Nh,gf.Info,"Resource downloader not created due to feature gate"):this.modelDownloaderFromCDN=fe.appName&&fe.downloadBaseUrl||fe.downloadPolymerBaseUrl?new Ho(fe.appName,fe.downloadBaseUrl,fe.downloadPolymerBaseUrl):void 0}));this.inferenceServiceFactory=fe.appName&&fe.inferenceServiceVersion?Ve.createFactory(fe.appName,fe.inferenceServiceVersion):void 0;this.excelServerParameters=fe.excelServer;this.powerpointParameters=fe.powerpoint;var ze={appName:fe.appName,appPlatform:"Web",appVersion:fe.appVersion,
uiLanguage:fe.uiLanguage,releaseAudienceGroup:fe.releaseAudienceGroup,releaseChannel:fe.releaseChannel,releaseCustomAudience:fe.releaseCustomAudience,releaseFork:fe.releaseFork,sessionId:fe.sessionId,flights:fe.flights,privateMode:fe.privateMode,disabledServiceGroups:fe.disabledServiceGroups,userSystemTimezone:fe.userSystemTimezone,isClientTelemetrySampled:fe.isClientTelemetrySampled},kf={onResult:this.onResult.bind(this),onAnnotationResult:this.onAnnotationResult.bind(this),sendTelemetryEvent:this.sendTelemetryEvent.bind(this),
sendDiagnosticTrace:this.sendDiagnosticTrace.bind(this),requestAuthToken:this.requestAuthToken.bind(this),isFeatureEnabled:this.isFeatureEnabled.bind(this),isChangeGateEnabled:this.isChangeGateEnabled.bind(this),setSessionData:this.setSessionData.bind(this),areLicenseFeaturesEnabled:td,onInitSession:this.onInitSession.bind(this),overrideSessionInitMessage:this.overrideSessionInitMessage.bind(this)},mg=Promise.all(Ld).then(()=>lr.init(fe.serviceUrl,ze,kf,{telemetryAggregationIntervalSec:this._telemetryAggregationIntervalSec,
modelDownloader:this.modelDownloaderFromCDN,inferenceServiceFactory:this.inferenceServiceFactory,isDeltaGeneratorEnabled:fe.isDeltaGeneratorEnabled,disableSyncDeltaSending:fe.disableSyncDeltaSending,syncDeltaTimeout:fe.syncDeltaTimeout})).then(()=>xs.init(fe.serviceUrl,ze,kf)),Wf=fe.sessionCreationOptions;Wf||(Wf={});var Kf=Wf.onServerAuthenticationStateChangeCallback;Wf.onServerAuthenticationStateChangeCallback=as=>{this._serverAuthenticationState=as;Kf&&Kf(as);this._bridge&&this.sendBridgeMessage({bridgeId:"*",
docSessionId:"*",message:new Ub.r({serverAuthenticationState:as})})};var Ci=Wf.onSessionClose;Wf.onSessionClose=as=>{this._sessionCloseReason=as.reason;Ci&&Ci(as);this._bridge&&this.sendBridgeMessage({bridgeId:"*",docSessionId:"*",message:as})};var cj=Wf.onSessionConnect;Wf.onSessionConnect=(as,sk,jf,yk)=>{cj&&cj(as,sk,jf,yk);this._connectCallbacks.forEach(pq=>{pq(as,sk,jf,yk)});this._bridge&&(this._sessionConnectParams||(this._sessionConnectParams={authToken:yk,isSeedingRequired:as,sessionUrl:sk,
origin:jf},this.sendSessionInitResponseToBridge("*","*")),this.sendBridgeMessage({bridgeId:"*",docSessionId:"*",message:new Ub.u({isSeedingRequired:as,sessionUrl:sk,origin:jf,authToken:yk})}))};var di=Wf.onSessionReconnect;Wf.onSessionReconnect=()=>{di&&di();this._bridge&&this.sendBridgeMessage({bridgeId:"*",docSessionId:"*",message:new Ub.A})};var rj=Wf.onSessionDisconnect;Wf.onSessionDisconnect=as=>{rj&&rj(as);this._bridge&&(this._sessionConnectParams=void 0,this.sendBridgeMessage({bridgeId:"*",
docSessionId:"*",message:new Ub.v({error:as})}))};var bn=Wf.onClaimsChallengeCallback;Wf.onClaimsChallengeCallback=as=>{bn&&bn(as);this._claimsChallengeCallbacks.forEach(sk=>{sk(as)})};var lo=Wf.onSeedingStatusChangeCallback;Wf.onSeedingStatusChangeCallback=as=>{lo&&lo(as);this._seedingStatusChangeCallbacks.forEach(sk=>{sk(as)})};this.createSession=()=>{this._runtimeInitPromise=mg.then(()=>{const as=Wf&&Wf.docSessionId||fe.sessionId;return lr.createSession(Object.assign(Object.assign({},Wf),{docSessionId:as}))})};
this.createSession()}};this.getSession=()=>this._runtimeInitPromise;this.setULSLogger=fe=>{this.checkParametersAndThrow("setULSLogger",fe&&fe.ulsLogger);Io.gDg(fe.ulsLogger)};this.setSendOTelEventCallback=fe=>{this.checkParametersAndPropertyAndThrow("setSendOTelEventCallback",fe&&fe.sendOTelEvent,this._sendOTelEventCallback);this._sendOTelEventCallback=fe.sendOTelEvent};this.setSendDiagnosticTraceCallback=fe=>{this.checkParametersAndPropertyAndThrow("setSendDiagnosticTraceCallback",fe&&fe.sendDiagnosticTraceCallback,
this._sendDiagnosticTraceCallback);this._sendDiagnosticTraceCallback=fe.sendDiagnosticTraceCallback};this.setRequestAuthTokenCallback=fe=>{this.checkParametersAndPropertyAndThrow("setRequestAuthTokenCallback",fe&&fe.requestAuthTokenCallback,this._requestAuthTokenCallback);this._requestAuthTokenCallback=fe.requestAuthTokenCallback};this.setIsFeatureEnabledCallback=fe=>{this.checkParametersAndPropertyAndThrow("setIsFeatureEnabledCallback",fe&&fe.featureEnabledCallback,this._featureEnabledCallback);
this._featureEnabledCallback=fe.featureEnabledCallback};this.setIsChangeGateEnabledCallback=fe=>{this.checkParametersAndPropertyAndThrow("setIsChangeGateEnabledCallback",fe&&fe.changeGateEnabledCallback,this._changeGateEnabledCallback);this._changeGateEnabledCallback=fe.changeGateEnabledCallback};this.registerLocalWorkflow=fe=>{this.checkParametersAndThrow("registerLocalWorkflow",fe&&fe.workflow);this.checkRuntimeInitAndThrow("registerLocalWorkflow");this._runtimeInitPromise.then(Ld=>{Ld.registerLocalWorkflow(fe.workflow)})};
this.activateAnnotation=fe=>{const Ld=this.checkParameters("activateAnnotation",fe&&fe.annotationType)||this.checkRuntimeInit("activateAnnotation");return Ld?Promise.reject(Ld):this._runtimeInitPromise.then(ze=>{let kf;if(fe.config||fe.handler||fe.stateUpdateHandler)kf={config:fe.config,callback:fe.handler,apologyCallback:fe.apologyHandler,stateUpdateCallback:fe.stateUpdateHandler,forceReturnCachedAnnotations:fe.forceReturnCachedAnnotations};return ze.activateAnnotation(fe.annotationType,kf)})};this.updateAnnotationConfig=
fe=>{const Ld=this.checkParameters("updateAnnotationConfig",fe&&fe.token&&fe.config)||this.checkRuntimeInit("updateAnnotationConfig");return Ld?Promise.reject(Ld):this._runtimeInitPromise.then(ze=>{ze.updateAnnotationConfig(fe.token,fe.config)})};this.releaseAnnotation=fe=>{const Ld=this.checkParameters("releaseAnnotation",fe&&fe.token)||this.checkRuntimeInit("releaseAnnotation");return Ld?Promise.reject(Ld):this._runtimeInitPromise.then(ze=>ze.releaseAnnotation(fe.token))};this.submitOperation=fe=>
{this.checkParametersAndThrow("submitOperation",fe&&fe.operation);this.checkRuntimeInit("submitOperation");this._runtimeInitPromise.then(Ld=>{Ld.submitOperation(fe.operation,fe.cv)})};this.setSessionDataCallback=fe=>{this.checkParametersAndPropertyAndThrow("setSessionDataCallback",fe&&(fe.sessionDataCallback||fe.handler),this._setSessionDataCallback);fe.sessionDataCallback?this._setSessionDataCallback=fe.sessionDataCallback:fe.handler&&(this._setSessionDataCallback=(Ld,ze)=>fe.handler(Ld,ze))};this.setAnnotationResultCallback=
fe=>{this.checkParametersAndThrow("setAnnotationResultCallback",fe&&fe.handler);this._annotationResultCallback&&Io.sendTraceTag(537401028,ep.Nh,gf.Error,"setAnnotationResultCallback already called");this._annotationResultCallback=fe.handler};this.setAnnotationState=fe=>{this.checkParametersAndThrow("setAnnotationState",fe&&fe.parentPath&&fe.id&&fe.value);this.checkRuntimeInitAndThrow("setAnnotationState");this._runtimeInitPromise.then(Ld=>{Ld.setAnnotationState(fe.parentPath,fe.id,fe.value)})};this.setAnnotationMetadata=
fe=>{this.checkParametersAndThrow("setAnnotationMetadata",fe&&fe.parentPath&&fe.id&&fe.value);this.checkRuntimeInitAndThrow("setAnnotationMetadata");this._runtimeInitPromise.then(Ld=>{Ld.setAnnotationMetadata(fe.parentPath,fe.id,fe.value)})};this.setInitSessionCallback=fe=>{this.checkParametersAndPropertyAndThrow("setInitSessionCallback",fe&&fe.initSessionCallback,this._initSessionCallback);this._initSessionCallback=fe.initSessionCallback};this.setSessionInitOverrideCallback=fe=>{this.checkParametersAndPropertyAndThrow("setSessionInitOverrideCallback",
fe&&fe.handler,this._sessionInitOverrideCallback);this._sessionInitOverrideCallback=fe.handler};this.setMessageBridge=fe=>{this.checkParametersAndPropertyAndThrow("setMessageBridge",fe&&fe.bridge,this._bridge);this._bridge=fe.bridge;this._bridge.registerMessageReceivedCallback(this.onBridgeMessage.bind(this))};this.setMessageBridgeToALInterceptor=fe=>{this.checkParametersAndPropertyAndThrow("setMessageBridgeToALInterceptor",fe&&fe.bridge,this._bridgeInterceptor);this._bridgeInterceptor=fe.bridge;
this._bridgeInterceptor.registerMessageReceivedCallback(this.onBridgeMessageFromInterceptor.bind(this))};this.forceReconnectSession=fe=>{const Ld=this.checkParameters("forceReconnectSession",fe)||this.checkRuntimeInit("forceReconnectSession");return Ld?Promise.reject(Ld):this._runtimeInitPromise.then(ze=>{fe.excelServerParameters&&(this.excelServerParameters=fe.excelServerParameters);return ze.forceReconnect()})};this.setSessionCloseCallback=fe=>{const Ld=this.checkParameters("setSessionCloseCallback",
fe&&fe.callback)||this.checkRuntimeInit("setSessionCloseCallback");return Ld?Promise.reject(Ld):this._runtimeInitPromise.then(ze=>{ze.setSessionCloseCallback(fe.callback)})};this.setConnectCallback=fe=>{const Ld=this.getSessionStateCallbackToken("connect");fe.callback&&this._connectCallbacks.set(Ld,fe.callback);return Ld};this.removeConnectionStateCallback=fe=>this._connectCallbacks.has(fe.token)?(this._connectCallbacks.delete(fe.token),!0):!1;this.setSeedingStatusChangeCallback=fe=>{this._seedingStatusChangeCallbacks.push(fe.callback)};
this.submitCustomMessage=fe=>{const Ld=this.checkParameters("submitCustomMessage",fe&&fe.message)||this.checkRuntimeInit("submitCustomMessage");return Ld?Promise.reject(Ld):this._runtimeInitPromise.then(ze=>ze.submitCustomMessage(fe.message))};this.submitLargeBinaryDataMessage=fe=>{const Ld=this.checkParameters("submitLargeBinaryDataMessage",fe&&fe.message)||this.checkRuntimeInit("submitLargeBinaryDataMessage");return Ld?Promise.reject(Ld):Ub.m.typeGuard(fe.message)?this._runtimeInitPromise.then(ze=>
ze.submitLargeBinaryDataMessage(fe.message)):Promise.reject("submitLargeBinaryDataMessage only supports MicroSyncMessage")};this.requestBinaryDataForBlob=fe=>{const Ld=this.checkParameters("requestBinaryDataForBlob",fe&&fe.blob)||this.checkRuntimeInit("requestBinaryDataForBlob");return Ld?Promise.reject(Ld):this._runtimeInitPromise.then(ze=>ze.requestBinaryDataForBlob(fe.blob))};this.closeSession=()=>{const fe=this.checkRuntimeInit("closeSession");return fe?Promise.reject(fe):this._runtimeInitPromise.then(Ld=>
{Ld.close()})};this.startNewSession=()=>{if(!this.createSession)throw Io.sendTraceTag(537408074,ep.Nh,gf.Error,"startNewSession called before runtime init"),Error("startNewSession called before runtime init");this.createSession();this._sessionConnectParams=this._sessionCloseReason=null};this.authenticateInteractive=()=>{const fe=this.checkRuntimeInit("authenticateInteractive");return fe?Promise.reject(fe):this._runtimeInitPromise.then(Ld=>Ld.authenticateInteractive())};this.getAnnotations=fe=>{const Ld=
this.checkParameters("getAnnotations",fe&&fe.request),ze=this.checkRuntimeInit("getAnnotations"),kf=Ld||ze;return kf?Promise.resolve({[Symbol.asyncIterator](){return ja(this,arguments,function*(){const mg=Ld?kg.InvalidRequest:kg.RuntimeNotInitialized;Io.sendTraceTag(505952348,ep.Nh,gf.Error,`ClientError. Code: ${mg}, Error: ${null===kf||void 0===kf?void 0:kf.message}`);yield yield oa({content:void 0,error:{clientError:{code:mg,error:null===kf||void 0===kf?void 0:kf.message}}})})}}):this._runtimeInitPromise.then(mg=>
mg.getAnnotations(fe.request,fe.cancellationToken))};this.submit=fe=>{this.checkParametersAndThrow("submit",fe&&fe.inputSchema&&fe.input);this.checkRuntimeInitAndThrow("submit");this._runtimeInitPromise.then(()=>{xs.submit(fe.inputSchema,fe.input,fe.correlationVector)})};this.addEventHandler=fe=>{this.checkParametersAndThrow("addEventHandler",fe&&fe.schemaName&&fe.handler);const Ld=this._eventHandlerDictionary[fe.schemaName]||[];Ld.push(fe.handler);this._eventHandlerDictionary[fe.schemaName]=Ld};
this.removeEventHandler=fe=>{this.checkParametersAndThrow("removeEventHandler",fe&&fe.schemaName&&fe.handler);const Ld=this._eventHandlerDictionary[fe.schemaName];Array.isArray(Ld)&&(fe=Ld.indexOf(fe.handler),0<=fe&&Ld.splice(fe,1))};this.registerSimpleRemoteWorkflow=fe=>{const Ld=this.checkParameters("registerSimpleRemoteWorkflow",fe&&fe.name&&fe.lambdaRemote)||this.checkRuntimeInit("registerSimpleRemoteWorkflow");return Ld?Promise.reject(Ld):this._runtimeInitPromise.then(()=>xs.registerSimpleRemoteWorkflow(fe.name,
fe.lambdaBefore,fe.lambdaRemote,fe.lambdaAfter))};this.registerSimpleLocalWorkflow=fe=>{const Ld=this.checkParameters("registerSimpleLocalWorkflow",fe&&fe.name&&fe.lambda)||this.checkRuntimeInit("registerSimpleLocalWorkflow");return Ld?Promise.reject(Ld):this._runtimeInitPromise.then(()=>xs.registerSimpleLocalWorkflow(fe.name,fe.lambda))};this.registerReduceWorkflow=()=>Promise.resolve();this.registerSchemas=()=>Promise.resolve();this.onResult=(fe,Ld,ze,kf)=>{const mg=this._eventHandlerDictionary[ze];
if(mg)for(const Wf of mg)Wf&&Wf({inputSchema:fe,input:Ld,outputSchema:ze,output:kf})};this.onAnnotationResult=(fe,Ld)=>{this._annotationResultCallback&&this._annotationResultCallback(fe,Ld)};this.requestAuthToken=fe=>this._requestAuthTokenCallback?(this._requestAuthTokenCallback(fe)||Promise.resolve("")).then(Ld=>Promise.resolve({Token:Ld||""})):Promise.resolve({Token:""});this.sendTelemetryEvent=(fe,Ld,ze,kf,mg,Wf,Kf,Ci)=>{this._sendOTelEventCallback&&(Wf=this._sendOTelEventCallback,fe={telemetryProperties:{ariaTenantToken:fe,
nexusTenantToken:-1},eventName:Ld.split("_").join("."),dataFields:pe(ze),eventFlags:{dataCategories:Kf,diagnosticLevel:Ci,samplingPolicy:1}},kf&&(fe.eventContract={name:kf,dataFields:pe(mg,kf.split(".").slice(-1)[0])}),Wf.call(this,fe))};this.sendDiagnosticTrace=(fe,Ld,ze)=>{this._sendDiagnosticTraceCallback&&this._sendDiagnosticTraceCallback(fe,Ld,ze)};this.isFeatureEnabled=fe=>{if(!fe)return Promise.resolve(!1);if(0===fe.indexOf("Microsoft.Office.AugLoop.")&&this._featureEnabledCallback){const Ld=
fe.slice(25);return Promise.resolve(this._featureEnabledCallback(Ld)||this._featureEnabledCallback(fe))}return Promise.resolve(!1)};this.isChangeGateEnabled=fe=>fe&&this._changeGateEnabledCallback?Promise.resolve(this._changeGateEnabledCallback(fe)):Promise.resolve(!1);this.setSessionData=(fe,Ld,ze)=>{this._setSessionDataCallback&&this._setSessionDataCallback(fe,Ld,ze)};this.overrideSessionInitMessage=fe=>this._sessionInitOverrideCallback?this._sessionInitOverrideCallback(fe):0===fe.clientMetadata.appName.indexOf("Excel")&&
this.excelServerParameters?this.overrideExcelSessionInitMessage(fe):0===fe.clientMetadata.appName.indexOf("PowerPoint")&&this.powerpointParameters?this.overridePowerPointSessionInitMessage(fe):fe;this.overrideExcelSessionInitMessage=fe=>{const Ld={cluster:this.excelServerParameters.wacCluster,restUrl:this.excelServerParameters.ecsRestUrl,ecsId:this.excelServerParameters.ecsSessionId,ecsOperationUrl:this.excelServerParameters.ecsOperationUrl,workbookMetadataVersion:this.excelServerParameters.metadataVersion,
serverEventVersion:this.excelServerParameters.serverEventVersion,permissionFlags:this.excelServerParameters.permissionFlags,configurations:this.excelServerParameters.configurations,collabUserListVersion:this.excelServerParameters.userListVersion,collabStateId:this.excelServerParameters.collabStateId,accessToken:this.excelServerParameters.accessToken,accessTokenTTL:this.excelServerParameters.accessTokenTTL,supportCustomMessages:this.excelServerParameters.supportCustomMessages};for(const ze of Object.keys(fe))Ld[ze]=
fe[ze];return new Wc(Ld)};this.overridePowerPointSessionInitMessage=fe=>{const Ld={downloadUrl:this.powerpointParameters.downloadUrl,getItemsEndPoint:this.powerpointParameters.getItemsEndPoint,documentOpenType:this.powerpointParameters.documentOpenType};for(const ze of Object.keys(fe))Ld[ze]=fe[ze];return new Md(Ld)};this.onInitSession=()=>this._initSessionCallback?this._initSessionCallback():Promise.resolve();this.checkParameters=(fe,Ld)=>{if(!Ld)return fe=`${fe} called with invalid parameters`,
Io.sendTraceTag(537408075,ep.Nh,gf.Error,fe),Error(fe)};this.checkParametersAndThrow=(fe,Ld)=>{if(fe=this.checkParameters(fe,Ld))throw fe;};this.checkParametersAndPropertyAndThrow=(fe,Ld,ze)=>{this.checkParametersAndThrow(fe,Ld);if(ze)throw fe=`${fe} already called`,Io.sendTraceTag(537408076,ep.Nh,gf.Error,fe),Error(fe);};this.checkRuntimeInit=fe=>{if(!this._runtimeInitPromise)return fe=`${fe} called before runtime init`,Io.sendTraceTag(537408077,ep.Nh,gf.Error,fe),Error(fe)};this.checkRuntimeInitAndThrow=
fe=>{if(fe=this.checkRuntimeInit(fe))throw fe;};this.sendBridgeMessage=fe=>{this._bridge&&(fe.seq=this._bridgeMessageSequenceId++,this._bridge.sendMessage(JSON.stringify(new Ub.i(fe))))};this.onBridgeMessage=fe=>{null!=this._bridgeInterceptor?this._bridgeInterceptor.sendMessage(fe):this.handleReceivedBridgeMessage(fe)};this.sendSessionInitResponseToBridge=(fe,Ld)=>{if(this._sessionConnectParams){const ze=this._sessionConnectParams.sessionUrl;this.sendBridgeMessage({bridgeId:fe,docSessionId:Ld,message:new Ub.x({origin:this._sessionConnectParams.origin,
sessionKey:ze.split("/").pop(),sessionUrlBase:ze.split("/").slice(0,-1).join("/"),anonymousToken:this._sessionConnectParams.authToken})})}};this.handleReceivedBridgeMessage=fe=>{try{const {bridgeId:Ld,docSessionId:ze,message:kf}=JSON.parse(fe),mg=pf.a.getTypeNameFor(kf);Io.sendTraceTag(509092291,ep.Nh,gf.Info,`Received ${mg}`);null!=this._sessionCloseReason&&this.sendBridgeMessage({bridgeId:"*",docSessionId:"*",message:new Ub.s({reason:this._sessionCloseReason})});if(Ub.a.typeGuard(kf)){const Wf=
this.activateAnnotation({annotationType:kf.annotationType,config:kf.config,handler:(Kf,Ci)=>{this.sendBridgeMessage({bridgeId:Ld,docSessionId:ze,message:new Ub.g({annotationType:kf.annotationType,ops:[Kf],cv:Ci})})},forceReturnCachedAnnotations:kf.forceReturnCachedAnnotations}).then(Kf=>new Ub.b({messageId:kf.messageId,token:Kf.token}));this.sendResponseAcrossBridge(Wf,kf,Ld,ze)}else if(pi.typeGuard(kf))this.handleGetAnnotationsRequestMessage(Ld,ze,kf);else if(Ub.E.typeGuard(kf)){for(const Wf of kf.ops)this.submitOperation({operation:Wf,
cv:kf.cv});this.sendBridgeMessage({bridgeId:Ld,docSessionId:ze,response:new Ub.p({messageId:kf.messageId})});Io.sendTraceTag(509092288,ep.Nh,gf.Info,`Responded to ${mg}`)}else if(Ub.d.typeGuard(kf)){const Wf=this.releaseAnnotation({token:kf.token}).then(Kf=>new Ub.e({messageId:kf.messageId,lastRelease:Kf}));this.sendResponseAcrossBridge(Wf,kf,Ld,ze)}else if(Ub.D.typeGuard(kf))this.submitCustomMessage({message:kf.customMessage}).then(Wf=>{Ub.p.typeGuard(Wf)?(Wf.messageId=kf.messageId,Io.sendTraceTag(508432467,
ep.Nh,gf.Info,`Responded to ${mg}`)):Io.sendTraceTag(508420946,ep.Nh,gf.Error,"Unexpeced response type from SubmitCustomMessage");this.sendBridgeMessage({bridgeId:Ld,docSessionId:ze,response:Wf})}).catch(Wf=>{Io.sendTraceTag(508436636,ep.Nh,gf.Error,Wf.message);this.sendBridgeMessage({bridgeId:Ld,docSessionId:ze,response:new Ub.l({messageId:kf.messageId,error:Wf.message})})});else if(Ub.w.typeGuard(kf))this.sendSessionInitResponseToBridge(Ld,ze),this.sendBridgeMessage({bridgeId:Ld,docSessionId:ze,
message:new Ub.r({serverAuthenticationState:this._serverAuthenticationState})});else if(pf.a.matchesTypesFor(kf,[cg.getTypeName()])){const Wf=this._runtimeInitPromise.then(Kf=>Kf.authenticateInteractive()).then(()=>new Ub.p({messageId:kf.messageId}));this.sendResponseAcrossBridge(Wf,kf,Ld,ze)}else if(pf.a.matchesTypesFor(kf,[Rd.getTypeName()])){const Wf=(Kf=>{this.sendBridgeMessage({bridgeId:Ld,docSessionId:ze,message:new Ie({messageId:kf.messageId,seedingStatusChangeMessage:Kf})})}).bind(this);this._runtimeInitPromise.then(Kf=>
{Kf.setSeedingStatusChangeCallback(Wf)}).catch(()=>{Io.sendTraceTag(506474634,ep.Nh,gf.Warning,`RuntimeInitPromiseException for message with Id ${kf.messageId}`)})}else if(pf.a.matchesTypesFor(kf,[xd.getTypeName()])){const Wf=(Kf=>{this.sendBridgeMessage({bridgeId:Ld,docSessionId:ze,message:new qf({messageId:kf.messageId,claimsChallengeMessage:Kf})})}).bind(this);this._runtimeInitPromise.then(Kf=>{Kf.setClaimsChallengeCallback(Wf)}).catch(()=>{Io.sendTraceTag(506987159,ep.Nh,gf.Warning,`RuntimeInitPromiseException for message with Id ${kf.messageId}`)})}else Io.sendTraceTag(509092259,
ep.Nh,gf.Warning,`Did not respond to ${mg} with Id ${kf.messageId}`)}catch(Ld){Io.sendTraceTag(509092363,ep.Nh,gf.Error,Ld.message),this.sendBridgeMessage({bridgeId:"unknown",docSessionId:"unknown",response:new Ub.l({messageId:"unknown",error:Ld.message})})}};this.handleGetAnnotationsRequestMessage=(fe,Ld,ze)=>{this.getAnnotations({request:{annotationType:ze.annotationTypes,sourceInfo:ze.sourceInfo,configs:ze.configs,transientItems:ze.transientItems,maxDelayMs:ze.maxDelayMs,tryResolveUpstreamDependencies:ze.tryResolveUpstreamDependencies,
cv:ze.cv}}).then(kf=>{var mg,Wf,Kf;return z(this,void 0,void 0,function*(){var Ci,cj,di,rj,bn;try{for(mg=!0,Wf=ya(kf);Kf=yield Wf.next(),Ci=Kf.done,!Ci;mg=!0){var lo=Kf.value;mg=!1;const sk=lo,jf=new eb({content:sk.content,errorInfo:null===(di=sk.error)||void 0===di?void 0:di.serviceError,warningInfo:null===(rj=sk.warning)||void 0===rj?void 0:rj.serviceError}),yk=new fk({messageId:ze.messageId,serverResponse:JSON.stringify(jf),clientError:null===(bn=sk.error)||void 0===bn?void 0:bn.clientError,finalResponse:sk.finalResponse});
this.sendResponseAcrossBridge(Promise.resolve(yk),ze,fe,Ld)}}catch(sk){var as={error:sk}}finally{try{mg||Ci||!(cj=Wf.return)||(yield cj.call(Wf))}finally{if(as)throw as.error;}}})})};this.sendResponseAcrossBridge=(fe,Ld,ze,kf)=>{fe.catch(mg=>new Ub.l({messageId:Ld.messageId,error:mg.message})).then(mg=>{this.sendBridgeMessage({bridgeId:ze,docSessionId:kf,response:mg});Io.sendTraceTag(508937624,ep.Nh,gf.Info,`Responded to ${pf.a.getTypeNameFor(Ld)}`)}).catch(mg=>{Io.sendTraceTag(508937623,ep.Nh,gf.Error,
mg.message)})};this.onBridgeMessageFromInterceptor=fe=>{this.handleReceivedBridgeMessage(fe)}}getSessionStateCallbackToken(fe){return fe+"-callback-"+this._connectionStateCallbackToken++}}class jh{constructor(fe,Ld){var ze,kf,mg,Wf,Kf,Ci;this.kind=Gh.SingleItem;this.isStateful=!1;this.id=fe;Ld&&(this.inputTypes=null!==(ze=Ld.inputTypes)&&void 0!==ze?ze:this.inputTypes,this.outputTypes=null!==(kf=Ld.outputTypes)&&void 0!==kf?kf:this.outputTypes,this.isStateful=null!==(mg=Ld.isStateful)&&void 0!==mg?
mg:this.isStateful,this.requestedContextTypesRules=null!==(Wf=Ld.requestedContextTypesRules)&&void 0!==Wf?Wf:this.requestedContextTypesRules,this.definitionOverrideTargetWorkflows=null!==(Kf=Ld.definitionOverrideTargetWorkflows)&&void 0!==Kf?Kf:this.definitionOverrideTargetWorkflows,this.correlatedSignals=0!==(null===(Ci=Ld.correlatedSignals)||void 0===Ci?void 0:Ci.length)?Ld.correlatedSignals:this.correlatedSignals)}static create(fe){return new jh(fe)}setInputTypes(fe){this.inputTypes=ae(fe);return this}setOutputTypes(fe){this.outputTypes=
ae(fe);return this}setStateful(){this.isStateful=!0;return this}setRequestedContexts(fe){var Ld;this.requestedContextTypesRules=(null!==(Ld=this.requestedContextTypesRules)&&void 0!==Ld?Ld:this.requestedContextTypesRules=[]).concat(fe);return this}setLambdaType(fe){this.factory=fe;return this}setDefinitionOverrideTargetWorkflows(fe){this.definitionOverrideTargetWorkflows=fe;return this}setCorrelatedSignals(fe){0!==fe.length&&(this.correlatedSignals=fe);return this}setLambda(fe,Ld){this.factory=()=>
({init:Ld?Ld:()=>Promise.resolve(),execute:fe,dispose:()=>{}});return this}validateOptions(){return{isValid:!0}}}var Th=v(17896);class he{static create(fe){const Ld=new he(fe);return Ld.activateAnnotation(fe.responseType).then(()=>Ld)}constructor(fe){this.config=fe;this.nextMessageId=0;this.responseCallbacks=new Map;const Ld=["session","chats"],ze=qa(),kf=[...Ld,ze];this.messagesPath=[...kf,"messages"];this.config.session.submitOperations([new Ai.a({parentPath:Ld,items:[{id:ze,body:fe.chat}]}),new Ai.a({parentPath:kf,
items:[{id:"messages",body:new Th.a}]})])}send(fe,Ld){const ze=`${this.nextMessageId++}`;this.responseCallbacks.set(ze,Ld);this.config.session.submitOperations([new Ai.a({parentPath:this.messagesPath,items:[{id:ze,body:fe}]})])}close(){return this.config.session.releaseAnnotation(this.activatedAnnotationToken)}activateAnnotation(fe){return this.config.session.activateAnnotation(fe,{callback:Ld=>{if(Ai.a.typeGuard(Ld)&&this.isUnderSubtree(Ld.parentPath,this.messagesPath))for(const ze of Ld.items){const kf=
Ld.parentPath[Ld.parentPath.length-1],mg=this.responseCallbacks.get(kf);mg&&(mg(ze.body),this.responseCallbacks.delete(kf))}}}).then(({token:Ld})=>{this.activatedAnnotationToken=Ld})}isUnderSubtree(fe,Ld){if(fe.length<Ld.length)return!1;for(let ze=0;ze<Ld.length;ze++)if(fe[ze]!==Ld[ze])return!1;return!0}}class Id{constructor(){this._augLoopRuntimeManager=new Xd}getAugLoopRuntimeManager(){return this._augLoopRuntimeManager}createSingleItemWorkflow(fe){return jh.create(fe)}createChatHelper(fe){return this.getAugLoopRuntimeManager().getSession().then(Ld=>
he.create(Object.assign({session:Ld},fe)))}createAugLoopRuntimeManager(){return new Xd}}const Xk=new Id;class mh extends pf.a{constructor(fe){super();this.Id=null;this.Id=fe}}class Rl extends mh{constructor(fe,Ld){super(fe);this.Content=null;this.Content=Ld}}var rk;(function(fe){fe[fe.Unknown=0]="Unknown";fe[fe.Text=1]="Text";fe[fe.Slide=2]="Slide"})(rk||(rk={}));class nf{constructor(fe,Ld,ze,kf,mg,Wf,Kf,Ci,cj){this.Length=this.Start=0;this.FontWeight=Z.DontCare;this.Italic=!1;this.Underline=Bi.None;
this.Capitalization=bi.NoCaps;this.Color=this.FontSize=0;this.StyleName=null;this.Start=fe;this.Length=Ld;this.FontWeight=ze;this.Italic=kf;this.Underline=mg;this.Capitalization=Wf;this.FontSize=Kf;this.Color=Ci;this.StyleName=cj}}class Pf extends Rl{constructor(fe,Ld,ze){super(fe,Ld);this.RevisionId=this.Language=null;this.OutlineLevel=this.Indentation=this.RevisionSequence=0;this.ListType=$a.Number;this.Alignment=zb.Left;this.FormattedRanges=null;this.Language=ze}}var bi;(function(fe){fe[fe.NoCaps=
0]="NoCaps";fe[fe.SmallCaps=1]="SmallCaps";fe[fe.AllCaps=2]="AllCaps";fe[fe.AllPetiteCaps=3]="AllPetiteCaps";fe[fe.PetiteCaps=4]="PetiteCaps";fe[fe.Unicase=5]="Unicase";fe[fe.Titling=6]="Titling";fe[fe.Other=7]="Other"})(bi||(bi={}));var Bi;(function(fe){fe[fe.None=0]="None";fe[fe.Words=1]="Words";fe[fe.SingleLine=2]="SingleLine";fe[fe.DoubleLine=3]="DoubleLine";fe[fe.HeavyLine=4]="HeavyLine";fe[fe.DottedLine=5]="DottedLine";fe[fe.DottedHeavyLine=6]="DottedHeavyLine";fe[fe.DashLine=7]="DashLine";
fe[fe.DashHeavyLine=8]="DashHeavyLine";fe[fe.DashLongLine=9]="DashLongLine";fe[fe.DashLongHeavyLine=10]="DashLongHeavyLine";fe[fe.DotDashLine=11]="DotDashLine";fe[fe.DotDashHeavyLine=12]="DotDashHeavyLine";fe[fe.DotDotDashLine=13]="DotDotDashLine";fe[fe.DotDotDashHeavyLine=14]="DotDotDashHeavyLine";fe[fe.WavyLine=15]="WavyLine";fe[fe.WavyHeavyLine=16]="WavyHeavyLine";fe[fe.WavyDoubleLine=17]="WavyDoubleLine"})(Bi||(Bi={}));var Z;(function(fe){fe[fe.DontCare=0]="DontCare";fe[fe.Thin=1]="Thin";fe[fe.ExtraLight=
2]="ExtraLight";fe[fe.Light=3]="Light";fe[fe.Normal=4]="Normal";fe[fe.Medium=5]="Medium";fe[fe.SemiBold=6]="SemiBold";fe[fe.Bold=7]="Bold";fe[fe.ExtraBold=8]="ExtraBold";fe[fe.Heavy=9]="Heavy"})(Z||(Z={}));var $a;(function(fe){fe[fe.Number=0]="Number";fe[fe.Bullet=1]="Bullet";fe[fe.Lim=13]="Lim";fe[fe.Nil=14]="Nil";fe[fe.Any=15]="Any";fe[fe.NoList=16]="NoList";fe[fe.Invalid=42]="Invalid"})($a||($a={}));var zb;(function(fe){fe[fe.Left=0]="Left";fe[fe.Right=1]="Right";fe[fe.Center=2]="Center";fe[fe.Justified=
3]="Justified";fe[fe.Other=4]="Other";fe[fe.None=5]="None"})(zb||(zb={}));class Qb{}class mc{constructor(fe,Ld){this.type=fe;this.data=Ld}}class gc{constructor(fe,Ld,ze){this.exceptionType=fe;this.message=Ld;this.data=ze}static exceptionTypeToString(fe){switch(fe){case 0:return"Unknown";case 1:return"NoOutput";case 2:return"Authentication";case 3:return"JoinTimedOut";case 4:return"LambdaThrow";case 5:return"LambdaErrorCallback";default:return"Invalid Error Type"}}static parseExceptionData(fe){let Ld=
"";try{Ld=String.fromCharCode.apply(null,fe)}catch(ze){return"Failed to decode exception data:"+ze.toString()}return Ld}}class Zc{constructor(fe,Ld){this._proto=fe;this._schemas=Ld}get proto(){return this._proto}get schemas(){return this._schemas}registerSchemas(fe){return fe.registerSchemas({proto:this.proto,schemaNames:this.schemas})}}class Yd{constructor(fe,Ld){this._tileName=fe;this._tileSchema=Ld;this._addedSchemaName=fe+"Added";this._attachedSchemaName=fe+"Attached";this._changedSchemaName=
fe+"Changed";this._deletedSchemaName=fe+"Deleted"}get tileName(){return this._tileName}get tileSchema(){return this._tileSchema}get addedSchemaName(){return this._addedSchemaName}get attachedSchemaName(){return this._attachedSchemaName}get changedSchemaName(){return this._changedSchemaName}get deletedSchemaName(){return this._deletedSchemaName}registerSchemas(fe){return fe.registerSchemas({proto:'syntax="proto3";message '+this.addedSchemaName+" "+this.tileSchema+"; message "+this.changedSchemaName+
" "+this.tileSchema+"; message "+this.attachedSchemaName+" "+this.tileSchema+"; message "+this.deletedSchemaName+" "+this.tileSchema+"; ",schemaNames:[this.addedSchemaName,this.changedSchemaName,this.attachedSchemaName,this.deletedSchemaName]})}}},95474:function(ia,Ua){var v="undefined"!==typeof self?self:this,ya=function(){function ja(){this.fetch=!1;this.DOMException=v.DOMException}ja.prototype=v;return new ja}();(function(ja){(function(oa){function z(E){"string"!==typeof E&&(E=String(E));if(/[^a-z0-9\-#$%&'*+.^_`|~]/i.test(E))throw new TypeError("Invalid character in header field name");
return E.toLowerCase()}function D(E){"string"!==typeof E&&(E=String(E));return E}function d(E){var X={next:function(){var U=E.shift();return{done:void 0===U,value:U}}};M.oRa&&(X[Symbol.iterator]=function(){return X});return X}function t(E){this.map={};E instanceof t?E.forEach(function(X,U){this.append(U,X)},this):Array.isArray(E)?E.forEach(function(X){this.append(X[0],X[1])},this):E&&Object.getOwnPropertyNames(E).forEach(function(X){this.append(X,E[X])},this)}function k(E){if(E.bodyUsed)return Promise.reject(new TypeError("Already read"));
E.bodyUsed=!0}function r(E){return new Promise(function(X,U){E.onload=function(){X(E.result)};E.onerror=function(){U(E.error)}})}function x(E){var X=new FileReader,U=r(X);X.readAsArrayBuffer(E);return U}function u(E){if(E.slice)return E.slice(0);var X=new Uint8Array(E.byteLength);X.set(new Uint8Array(E));return X.buffer}function w(){this.bodyUsed=!1;this.huh=function(E){(this.HIb=E)?"string"===typeof E?this.CKc=E:M.blob&&Blob.prototype.isPrototypeOf(E)?this.GIb=E:M.formData&&FormData.prototype.isPrototypeOf(E)?
this.Vgh=E:M.searchParams&&URLSearchParams.prototype.isPrototypeOf(E)?this.CKc=E.toString():M.arrayBuffer&&M.blob&&E&&DataView.prototype.isPrototypeOf(E)?(this.Vmb=u(E.buffer),this.HIb=new Blob([this.Vmb])):M.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(E)||O(E))?this.Vmb=u(E):this.CKc=E=Object.prototype.toString.call(E):this.CKc="";this.headers.get("content-type")||("string"===typeof E?this.headers.set("content-type","text/plain;charset=UTF-8"):this.GIb&&this.GIb.type?this.headers.set("content-type",
this.GIb.type):M.searchParams&&URLSearchParams.prototype.isPrototypeOf(E)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))};M.blob&&(this.blob=function(){var E=k(this);if(E)return E;if(this.GIb)return Promise.resolve(this.GIb);if(this.Vmb)return Promise.resolve(new Blob([this.Vmb]));if(this.Vgh)throw Error("could not read FormData body as blob");return Promise.resolve(new Blob([this.CKc]))},this.arrayBuffer=function(){return this.Vmb?k(this)||Promise.resolve(this.Vmb):
this.blob().then(x)});this.text=function(){var E=k(this);if(E)return E;if(this.GIb){E=this.GIb;var X=new FileReader,U=r(X);X.readAsText(E);return U}if(this.Vmb){E=Promise;X=E.resolve;U=new Uint8Array(this.Vmb);for(var Q=Array(U.length),la=0;la<U.length;la++)Q[la]=String.fromCharCode(U[la]);U=Q.join("");return X.call(E,U)}if(this.Vgh)throw Error("could not read FormData body as text");return Promise.resolve(this.CKc)};M.formData&&(this.formData=function(){return this.text().then(B)});this.json=function(){return this.text().then(JSON.parse)};
return this}function C(E,X){X=X||{};var U=X.body;if(E instanceof C){if(E.bodyUsed)throw new TypeError("Already read");this.url=E.url;this.credentials=E.credentials;X.headers||(this.headers=new t(E.headers));this.method=E.method;this.mode=E.mode;this.signal=E.signal;U||null==E.HIb||(U=E.HIb,E.bodyUsed=!0)}else this.url=String(E);this.credentials=X.credentials||this.credentials||"same-origin";if(X.headers||!this.headers)this.headers=new t(X.headers);E=X.method||this.method||"GET";var Q=E.toUpperCase();
this.method=-1<K.indexOf(Q)?Q:E;this.mode=X.mode||this.mode||null;this.signal=X.signal||this.signal;this.referrer=null;if(("GET"===this.method||"HEAD"===this.method)&&U)throw new TypeError("Body not allowed for GET or HEAD requests");this.huh(U)}function B(E){var X=new FormData;E.trim().split("&").forEach(function(U){if(U){var Q=U.split("=");U=Q.shift().replace(/\+/g," ");Q=Q.join("=").replace(/\+/g," ");X.append(decodeURIComponent(U),decodeURIComponent(Q))}});return X}function G(E){var X=new t;E.replace(/\r?\n[\t ]+/g,
" ").split(/\r?\n/).forEach(function(U){var Q=U.split(":");if(U=Q.shift().trim())Q=Q.join(":").trim(),X.append(U,Q)});return X}function H(E,X){X||(X={});this.type="default";this.status=void 0===X.status?200:X.status;this.ok=200<=this.status&&300>this.status;this.statusText="statusText"in X?X.statusText:"OK";this.headers=new t(X.headers);this.url=X.url||"";this.huh(E)}function I(E,X){return new Promise(function(U,Q){function la(){W.abort()}var h=new C(E,X);if(h.signal&&h.signal.aborted)return Q(new oa.DOMException("Aborted",
"AbortError"));var W=new XMLHttpRequest;W.onload=function(){var ba={status:W.status,statusText:W.statusText,headers:G(W.getAllResponseHeaders()||"")};ba.url="responseURL"in W?W.responseURL:ba.headers.get("X-Request-URL");U(new H("response"in W?W.response:W.responseText,ba))};W.onerror=function(){Q(new TypeError("Network request failed"))};W.ontimeout=function(){Q(new TypeError("Network request failed"))};W.onabort=function(){Q(new oa.DOMException("Aborted","AbortError"))};W.open(h.method,h.url,!0);
"include"===h.credentials?W.withCredentials=!0:"omit"===h.credentials&&(W.withCredentials=!1);"responseType"in W&&M.blob&&(W.responseType="blob");h.headers.forEach(function(ba,ma){W.setRequestHeader(ma,ba)});h.signal&&(h.signal.addEventListener("abort",la),W.onreadystatechange=function(){4===W.readyState&&h.signal.removeEventListener("abort",la)});W.send("undefined"===typeof h.HIb?null:h.HIb)})}var M={searchParams:"URLSearchParams"in ja,oRa:"Symbol"in ja&&"iterator"in Symbol,blob:"FileReader"in ja&&
"Blob"in ja&&!0,formData:"FormData"in ja,arrayBuffer:"ArrayBuffer"in ja};if(M.arrayBuffer)var J="[object Int8Array];[object Uint8Array];[object Uint8ClampedArray];[object Int16Array];[object Uint16Array];[object Int32Array];[object Uint32Array];[object Float32Array];[object Float64Array]".split(";"),O=ArrayBuffer.isView||function(E){return E&&-1<J.indexOf(Object.prototype.toString.call(E))};t.prototype.append=function(E,X){E=z(E);X=D(X);var U=this.map[E];this.map[E]=U?U+", "+X:X};t.prototype["delete"]=
function(E){delete this.map[z(E)]};t.prototype.get=function(E){E=z(E);return this.has(E)?this.map[E]:null};t.prototype.has=function(E){return this.map.hasOwnProperty(z(E))};t.prototype.set=function(E,X){this.map[z(E)]=D(X)};t.prototype.forEach=function(E,X){for(var U in this.map)this.map.hasOwnProperty(U)&&E.call(X,this.map[U],U,this)};t.prototype.keys=function(){var E=[];this.forEach(function(X,U){E.push(U)});return d(E)};t.prototype.values=function(){var E=[];this.forEach(function(X){E.push(X)});
return d(E)};t.prototype.entries=function(){var E=[];this.forEach(function(X,U){E.push([U,X])});return d(E)};M.oRa&&(t.prototype[Symbol.iterator]=t.prototype.entries);var K="DELETE GET HEAD OPTIONS POST PUT".split(" ");C.prototype.clone=function(){return new C(this,{body:this.HIb})};w.call(C.prototype);w.call(H.prototype);H.prototype.clone=function(){return new H(this.HIb,{status:this.status,statusText:this.statusText,headers:new t(this.headers),url:this.url})};H.error=function(){var E=new H(null,
{status:0,statusText:""});E.type="error";return E};var R=[301,302,303,307,308];H.redirect=function(E,X){if(-1===R.indexOf(X))throw new RangeError("Invalid status code");return new H(null,{status:X,headers:{location:E}})};oa.DOMException=ja.DOMException;try{new oa.DOMException}catch(E){oa.DOMException=function(X,U){this.message=X;this.name=U;this.stack=Error(X).stack},oa.DOMException.prototype=Object.create(Error.prototype),oa.DOMException.prototype.constructor=oa.DOMException}I.hxo=!0;ja.fetch||(ja.fetch=
I,ja.Headers=t,ja.Request=C,ja.Response=H);oa.Headers=t;oa.Request=C;oa.Response=H;oa.fetch=I;Object.defineProperty(oa,"__esModule",{value:!0});return oa})({})})(ya);ya.fetch.dwr=!0;delete ya.fetch.hxo;Ua=ya.fetch;Ua["default"]=ya.fetch;Ua.fetch=ya.fetch;Ua.Headers=ya.Headers;Ua.Request=ya.Request;Ua.Response=ya.Response;ia.exports=Ua},46350:function(ia){function Ua(ja){this.pR=v(ja);this.dN=this.VI=0;if(ya(ja)){for(var oa=ja.length,z=0;z<oa;++z)this[z]=ja[z];this.VI=oa}}function v(ja){if("number"!==
typeof ja)if(ya(ja))ja=ja.length;else return 16;ja=Math.min(Math.max(16,ja),1073741824);ja=(ja>>>0)-1;ja|=ja>>1;ja|=ja>>2;ja|=ja>>4;ja|=ja>>8;return(ja|ja>>16)+1}Ua.prototype.toArray=function(){for(var ja=this.VI,oa=Array(ja),z=this.dN,D=this.pR,d=0;d<ja;++d)oa[d]=this[z+d&D-1];return oa};Ua.prototype.push=function(ja){var oa=arguments.length,z=this.VI;if(1<oa){var D=this.pR;if(z+oa>D){for(var d=0;d<oa;++d){this.EDd(z+1);var t=this.dN+z&this.pR-1;this[t]=arguments[d];z++;this.VI=z}return z}t=this.dN;
for(d=0;d<oa;++d)this[t+z&D-1]=arguments[d],t++;this.VI=z+oa;return z+oa}if(0===oa)return z;this.EDd(z+1);d=this.dN+z&this.pR-1;this[d]=ja;this.VI=z+1;return z+1};Ua.prototype.pop=function(){var ja=this.VI;if(0!==ja){var oa=this.dN+ja-1&this.pR-1,z=this[oa];this[oa]=void 0;this.VI=ja-1;return z}};Ua.prototype.shift=function(){var ja=this.VI;if(0!==ja){var oa=this.dN,z=this[oa];this[oa]=void 0;this.dN=oa+1&this.pR-1;this.VI=ja-1;return z}};Ua.prototype.unshift=function(ja){var oa=this.VI,z=arguments.length;
if(1<z){var D=this.pR;if(oa+z>D){for(var d=z-1;0<=d;d--){this.EDd(oa+1);D=this.pR;var t=(this.dN-1&D-1^D)-D;this[t]=arguments[d];oa++;this.VI=oa;this.dN=t}return oa}t=this.dN;for(d=z-1;0<=d;d--)t=(t-1&D-1^D)-D,this[t]=arguments[d];this.dN=t;this.VI=oa+z;return oa+z}if(0===z)return oa;this.EDd(oa+1);D=this.pR;d=(this.dN-1&D-1^D)-D;this[d]=ja;this.VI=oa+1;this.dN=d;return oa+1};Ua.prototype.get=function(ja){if(ja===(ja|0)){var oa=this.VI;0>ja&&(ja+=oa);if(!(0>ja||ja>=oa))return this[this.dN+ja&this.pR-
1]}};Ua.prototype.isEmpty=function(){return 0===this.VI};Ua.prototype.clear=function(){for(var ja=this.VI,oa=this.dN,z=this.pR,D=0;D<ja;++D)this[oa+D&z-1]=void 0;this.dN=this.VI=0};Ua.prototype.toString=function(){return this.toArray().toString()};Ua.prototype.valueOf=Ua.prototype.toString;Ua.prototype.enqueue=Ua.prototype.push;Ua.prototype.dequeue=Ua.prototype.shift;Ua.prototype.toJSON=Ua.prototype.toArray;Object.defineProperty(Ua.prototype,"length",{get:function(){return this.VI},set:function(){throw new RangeError("");
}});Ua.prototype.EDd=function(ja){this.pR<ja&&this.xVk(v(1.5*this.pR+16))};Ua.prototype.xVk=function(ja){var oa=this.pR;this.pR=ja;ja=this.dN;var z=this.VI;if(ja+z>oa)for(ja=ja+z&oa-1,z=0;z<ja;++z)this[z+oa]=this[z+0],this[z+0]=void 0};var ya=Array.isArray;ia.exports=Ua},74434:function(ia){function Ua(){}function v(D,d,t){this.oJ=D;this.context=d;this.once=t||!1}function ya(D,d,t,k,r){if("function"!==typeof t)throw new TypeError("The listener must be a function");t=new v(t,k||D,r);d=z?z+d:d;D.gg[d]?
D.gg[d].oJ?D.gg[d]=[D.gg[d],t]:D.gg[d].push(t):(D.gg[d]=t,D.xKb++);return D}function ja(D,d){0===--D.xKb?D.gg=new Ua:delete D.gg[d]}function oa(){this.gg=new Ua;this.xKb=0}var z="~";Object.create&&(Ua.prototype=Object.create(null),(new Ua).__proto__||(z=!1));oa.prototype.listeners=function(D){D=this.gg[z?z+D:D];if(!D)return[];if(D.oJ)return[D.oJ];for(var d=0,t=D.length,k=Array(t);d<t;d++)k[d]=D[d].oJ;return k};oa.prototype.emit=function(D,d,t,k,r,x){var u=z?z+D:D;if(!this.gg[u])return!1;u=this.gg[u];
var w=arguments.length,C;if(u.oJ){u.once&&this.removeListener(D,u.oJ,void 0,!0);switch(w){case 1:return u.oJ.call(u.context),!0;case 2:return u.oJ.call(u.context,d),!0;case 3:return u.oJ.call(u.context,d,t),!0;case 4:return u.oJ.call(u.context,d,t,k),!0;case 5:return u.oJ.call(u.context,d,t,k,r),!0;case 6:return u.oJ.call(u.context,d,t,k,r,x),!0}var B=1;for(C=Array(w-1);B<w;B++)C[B-1]=arguments[B];u.oJ.apply(u.context,C)}else{var G=u.length;for(B=0;B<G;B++)switch(u[B].once&&this.removeListener(D,
u[B].oJ,void 0,!0),w){case 1:u[B].oJ.call(u[B].context);break;case 2:u[B].oJ.call(u[B].context,d);break;case 3:u[B].oJ.call(u[B].context,d,t);break;case 4:u[B].oJ.call(u[B].context,d,t,k);break;default:if(!C){var H=1;for(C=Array(w-1);H<w;H++)C[H-1]=arguments[H]}u[B].oJ.apply(u[B].context,C)}}return!0};oa.prototype.on=function(D,d,t){return ya(this,D,d,t,!1)};oa.prototype.once=function(D,d,t){return ya(this,D,d,t,!0)};oa.prototype.removeListener=function(D,d,t,k){D=z?z+D:D;if(!this.gg[D])return this;
if(!d)return ja(this,D),this;var r=this.gg[D];if(r.oJ)r.oJ!==d||k&&!r.once||t&&r.context!==t||ja(this,D);else{for(var x=0,u=[],w=r.length;x<w;x++)(r[x].oJ!==d||k&&!r[x].once||t&&r[x].context!==t)&&u.push(r[x]);u.length?this.gg[D]=1===u.length?u[0]:u:ja(this,D)}return this};oa.prototype.off=oa.prototype.removeListener;oa.prototype.addListener=oa.prototype.on;oa.EventEmitter=oa;ia.exports=oa},67798:function(ia){ia.exports=function ja(v,ya){if(v===ya)return!0;if(v&&ya&&"object"==typeof v&&"object"==
typeof ya){if(v.constructor!==ya.constructor)return!1;var oa;if(Array.isArray(v)){var z=v.length;if(z!=ya.length)return!1;for(oa=z;0!==oa--;)if(!ja(v[oa],ya[oa]))return!1;return!0}if(v.constructor===RegExp)return v.source===ya.source&&v.flags===ya.flags;if(v.valueOf!==Object.prototype.valueOf)return v.valueOf()===ya.valueOf();if(v.toString!==Object.prototype.toString)return v.toString()===ya.toString();var D=Object.keys(v);z=D.length;if(z!==Object.keys(ya).length)return!1;for(oa=z;0!==oa--;)if(!Object.prototype.hasOwnProperty.call(ya,
D[oa]))return!1;for(oa=z;0!==oa--;)if(z=D[oa],!ja(v[z],ya[z]))return!1;return!0}return v!==v&&ya!==ya}},86227:function(ia,Ua,v){var ya=v(88036).a;(function(ja){function oa(H,I,M){if(H)throw Error("".concat("Failed to ").concat(I,": the '").concat(M,"' option is unsupported."));}function z(H){return ya.from(H)}function D(H,I){var M;return H instanceof ya?M=H:M=ya.from(H.buffer,H.byteOffset,H.byteLength),M.toString(I)}function d(H){for(var I=0,M=Math.min(65536,H.length+1),J=new Uint16Array(M),O=[],
K=0;;){var R=I<H.length;if(!R||K>=M-1){if(O.push(String.fromCharCode.apply(null,J.subarray(0,K))),!R)return O.join("");H=H.subarray(I);K=I=0}R=H[I++];if(0===(R&128))J[K++]=R;else if(192===(R&224)){var E=H[I++]&63;J[K++]=(R&31)<<6|E}else if(224===(R&240)){E=H[I++]&63;var X=H[I++]&63;J[K++]=(R&31)<<12|E<<6|X}else if(240===(R&248)){E=H[I++]&63;X=H[I++]&63;var U=H[I++]&63;R=(R&7)<<18|E<<12|X<<6|U;65535<R&&(R-=65536,J[K++]=R>>>10&1023|55296,R=56320|R&1023);J[K++]=R}}}function t(H){for(var I=0,M=H.length,
J=0,O=Math.max(32,M+(M>>>1)+7),K=new Uint8Array(O>>>3<<3);I<M;){var R=H.charCodeAt(I++);if(55296<=R&&56319>=R){if(I<M){var E=H.charCodeAt(I);56320===(E&64512)&&(++I,R=((R&1023)<<10)+(E&1023)+65536)}if(55296<=R&&56319>=R)continue}J+4>K.length&&(O+=8,O*=1+I/H.length*2,O=O>>>3<<3,E=new Uint8Array(O),E.set(K),K=E);if(0===(R&4294967168))K[J++]=R;else{if(0===(R&4294965248))K[J++]=R>>>6&31|192;else if(0===(R&4294901760))K[J++]=R>>>12&15|224,K[J++]=R>>>6&63|128;else if(0===(R&4292870144))K[J++]=R>>>18&7|
240,K[J++]=R>>>12&63|128,K[J++]=R>>>6&63|128;else continue;K[J++]=R&63|128}}return K.slice?K.slice(0,J):K.subarray(0,J)}function k(){this.encoding="utf-8"}function r(H,I){oa(I&&I.fatal,"construct 'TextDecoder'","fatal");H=H||"utf-8";var M;if(x?M=ya.y1f(H):M=-1!==C.indexOf(H.toLowerCase()),!M)throw new RangeError("".concat(G," encoding label provided ('").concat(H,"') is invalid."));this.encoding=H;this.ignoreBOM=this.fatal=!1}var x="function"==typeof ya&&ya.from,u=x?z:t;k.prototype.encode=function(H,
I){return oa(I&&I.stream,"encode","stream"),u(H)};var w=!x&&"function"==typeof Blob&&"function"==typeof URL&&"function"==typeof URL.createObjectURL,C=["utf-8","utf8","unicode-1-1-utf-8"],B=d;x?B=D:w&&(B=function(H){try{a:{try{var I=URL.createObjectURL(new Blob([H],{type:"text/plain;charset=UTF-8"}));var M=new XMLHttpRequest;var J=(M.open("GET",I,!1),M.send(),M.responseText);break a}finally{I&&URL.revokeObjectURL(I)}J=void 0}return J}catch(O){return d(H)}});var G="".concat("Failed to "," ").concat("construct 'TextDecoder'",
": the ");r.prototype.decode=function(H,I){oa(I&&I.stream,"decode","stream");var M;return H instanceof Uint8Array?M=H:H.buffer instanceof ArrayBuffer?M=new Uint8Array(H.buffer):M=new Uint8Array(H),B(M,this.encoding)};ja.TextEncoder=ja.TextEncoder||k;ja.TextDecoder=ja.TextDecoder||r})("undefined"!==typeof window?window:"undefined"!==typeof v.g?v.g:this)},88407:function(ia){ia.exports={a:"2.35.2022"}}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/WordEditorDS.augloop.js.map/54d7e42bb861e5193ecf46cd869cd443/WordEditorDS.augloop.js.map